<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › queries › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span><span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">FieldError</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">connections</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span>
<span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="kn">import</span> <span class="n">Q</span><span class="p">,</span> <span class="n">ITER_CHUNK_SIZE</span><span class="p">,</span> <span class="n">EmptyQuerySet</span>
<span class="kn">from</span> <span class="nn">django.db.models.sql.where</span> <span class="kn">import</span> <span class="n">WhereNode</span><span class="p">,</span> <span class="n">EverythingNode</span><span class="p">,</span> <span class="n">NothingNode</span>
<span class="kn">from</span> <span class="nn">django.db.models.sql.datastructures</span> <span class="kn">import</span> <span class="n">EmptyResultSet</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">skipUnlessDBFeature</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">str_prefix</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">unittest</span>
<span class="kn">from</span> <span class="nn">django.utils.datastructures</span> <span class="kn">import</span> <span class="n">SortedDict</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Annotation</span><span class="p">,</span> <span class="n">Article</span><span class="p">,</span> <span class="n">Author</span><span class="p">,</span> <span class="n">Celebrity</span><span class="p">,</span> <span class="n">Child</span><span class="p">,</span> <span class="n">Cover</span><span class="p">,</span>
    <span class="n">Detail</span><span class="p">,</span> <span class="n">DumbCategory</span><span class="p">,</span> <span class="n">ExtraInfo</span><span class="p">,</span> <span class="n">Fan</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">LeafA</span><span class="p">,</span> <span class="n">LoopX</span><span class="p">,</span> <span class="n">LoopZ</span><span class="p">,</span>
    <span class="n">ManagedModel</span><span class="p">,</span> <span class="n">Member</span><span class="p">,</span> <span class="n">NamedCategory</span><span class="p">,</span> <span class="n">Note</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Plaything</span><span class="p">,</span> <span class="n">PointerA</span><span class="p">,</span>
    <span class="n">Ranking</span><span class="p">,</span> <span class="n">Related</span><span class="p">,</span> <span class="n">Report</span><span class="p">,</span> <span class="n">ReservedName</span><span class="p">,</span> <span class="n">Tag</span><span class="p">,</span> <span class="n">TvChef</span><span class="p">,</span> <span class="n">Valid</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Food</span><span class="p">,</span> <span class="n">Eaten</span><span class="p">,</span>
    <span class="n">Node</span><span class="p">,</span> <span class="n">ObjectA</span><span class="p">,</span> <span class="n">ObjectB</span><span class="p">,</span> <span class="n">ObjectC</span><span class="p">,</span> <span class="n">CategoryItem</span><span class="p">,</span> <span class="n">SimpleCategory</span><span class="p">,</span>
    <span class="n">SpecialCategory</span><span class="p">,</span> <span class="n">OneToOneCategory</span><span class="p">,</span> <span class="n">NullableName</span><span class="p">,</span> <span class="n">ProxyCategory</span><span class="p">,</span>
    <span class="n">SingleObject</span><span class="p">,</span> <span class="n">RelatedObject</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseQuerysetTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">assertValueQuerysetEqual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qs</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Queries1Tests</span><span class="p">(</span><span class="n">BaseQuerysetTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">generic</span> <span class="o">=</span> <span class="n">NamedCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Generic&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t2&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t3</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">t4</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t5</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t5&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n2&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n3</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n3&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">ann1</span> <span class="o">=</span> <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">ann1</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">ann2</span> <span class="o">=</span> <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a2&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">t4</span><span class="p">)</span>
        <span class="n">ann2</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Create these out of order so that sorting by 'id' will be different to sorting
by 'info'. Helps detect some problems later.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">e2</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e2&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1001</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a2&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">2002</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a3&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3003</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a4</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a4&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">4004</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">time1</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time2</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">time3</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">time4</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i1</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time1</span><span class="p">,</span> <span class="n">modified</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time1</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time2</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">n2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t3</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i3</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">time3</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)</span>
        <span class="n">i4</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;four&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">time4</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a4</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)</span>
        <span class="n">i4</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t4</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;r1&#39;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;r2&#39;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="n">a3</span><span class="p">)</span>
        <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;r3&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Ordering by 'rank' gives us rank2, rank1, rank3. Ordering by the Meta.ordering
will be rank3, rank2, rank1.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">rank1</span> <span class="o">=</span> <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">)</span>

        <span class="n">Cover</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;first&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="n">i4</span><span class="p">)</span>
        <span class="n">Cover</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;second&quot;</span><span class="p">,</span> <span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket1050</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__id__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket1801</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i3</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i3</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket2306</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Checking that no join types are "left outer" joins.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">query</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">LOUTER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__name</span><span class="o">=</span><span class="s">&#39;fred&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Each filter call is processed "at once" against a single table, so this is
different from the previous example as it tries to find tags that are two
things at once (rather than two tags).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)),</span>
            <span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">),</span> <span class="n">Q</span><span class="p">(</span><span class="n">creator__name</span><span class="o">=</span><span class="s">&#39;fred&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)),</span>
            <span class="p">[]</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ranking__rank</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ranking__id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count_active_tables</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ranking__rank</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ranking__id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rank1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">count_active_tables</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket4464</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">])</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t3</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Make sure .distinct() works with slicing (this was broken in Oracle).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)[:</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_2080_3592</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item__name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a3&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">item__name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a3&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a3&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">item__name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">item__name</span><span class="o">=</span><span class="s">&#39;three&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">report__name</span><span class="o">=</span><span class="s">&#39;r3&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket6074</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Merging two empty result sets shouldn't leave a queryset with no constraints
(which would match everything).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])),</span>
            <span class="p">[]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_1878_2939</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;creator&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">3</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Create something with a duplicate 'name' so that we can test multi-column
cases (which require some tricky SQL transformations under the covers).</p></td><td class="code"><div class="highlight"><pre>        <span class="n">xx</span> <span class="o">=</span> <span class="n">Item</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;four&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time1</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">xx</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;creator&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">4</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;creator&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">4</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;creator&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">4</span>
        <span class="p">)</span>
        <span class="n">xx</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_ticket7323</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;creator&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket2253</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">q1</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q2</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="p">(</span><span class="n">q1</span> <span class="o">|</span> <span class="n">q2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">((</span><span class="n">q1</span> <span class="o">&amp;</span> <span class="n">q2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">])</span>

        <span class="n">q1</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="p">((</span><span class="n">q1</span> <span class="o">&amp;</span> <span class="n">q2</span><span class="p">)</span> <span class="o">|</span> <span class="n">q3</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order_by_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">q2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">((</span><span class="n">q1</span> <span class="o">&amp;</span> <span class="n">q2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">tables</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order_by_join_unref</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This test is related to the above one, testing that there aren&#39;t</span>
<span class="sd">        old JOINs in the query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Celebrity</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;greatest_fan__fan_of&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;OUTER JOIN&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotIn</span><span class="p">(</span><span class="s">&#39;OUTER JOIN&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_tickets_4088_4306</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="mi">1001</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Report: r1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator__num</span><span class="o">=</span><span class="mi">1001</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Report: r1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator__id</span><span class="o">=</span><span class="mi">1001</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator__id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Report: r1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">creator__name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Report: r1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket4510</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">report__name</span><span class="o">=</span><span class="s">&#39;r1&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7378</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="o">.</span><span class="n">report_set</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;&lt;Report: r1&gt;&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_tickets_5324_6704</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">reverse</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">item__name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a4&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Excluding across a m2m relation when there is more than one related
object associated was problematic.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Excluding from a relation that cannot be NULL should not use outer joins.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">query</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">creator__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">])</span><span class="o">.</span><span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">LOUTER</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Similarly, when one of the joins cannot possibly, ever, involve NULL
values (Author -> ExtraInfo, in the following), it should never be
promoted to a left outer join. So the following query should only
involve one "left outer" join (Author -> Item is 0-to-many).</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">extra__note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">item__note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">query</span><span class="o">.</span><span class="n">LOUTER</span> <span class="ow">and</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]),</span>
            <span class="mi">1</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>The previous changes shouldn't affect nullable foreign key joins.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">parent__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">parent__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">parent__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">parent__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">parent__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">parent__parent__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">parent__parent__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket2091</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__in</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_heterogeneous_qs_combination</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Combining querysets built on different models should behave in a well-defined
fashion. We raise an error.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="ne">AssertionError</span><span class="p">,</span>
            <span class="s">&#39;Cannot combine queries on two different base models.&#39;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="ne">AssertionError</span><span class="p">,</span>
            <span class="s">&#39;Cannot combine queries on two different base models.&#39;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket3141</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;1&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,))</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">4</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket2400</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket2496</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;queries_author&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)[:</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_2076_7256</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Ordering on related tables should be possible, even if the table is
not otherwise involved.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;note__note&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Ordering on a related field should use the remote model's default
ordering as a final step.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;extra&#39;</span><span class="p">,</span> <span class="s">&#39;-name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Using remote model default ordering can span multiple models (in this
case, Cover is ordered by Item's default, which uses Note's default).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Cover</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Cover: first&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Cover: second&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>If the remote model does not have a default ordering, we order by its 'id'
field.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;creator&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Ordering by a many-valued attribute (e.g. a many-to-many or reverse
ForeignKey) is legal, but the results might not make sense. That
isn't Django's problem. Garbage in, garbage out.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">tags__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;tags&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>If we replace the default ordering, Django adjusts the required
tables automatically. Item normally requires a join with Note to do
the default ordering, but that isn't needed here.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">tables</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_2874_3002</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;note__note&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>This is also a good select_related() test because there are multiple
Note entries in the SQL. The two Note items should be different.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">note</span><span class="p">),</span> <span class="s">&#39;&lt;Note: n2&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">creator</span><span class="o">.</span><span class="n">extra</span><span class="o">.</span><span class="n">note</span><span class="p">),</span> <span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket3037</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__name</span><span class="o">=</span><span class="s">&#39;a3&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__name</span><span class="o">=</span><span class="s">&#39;a4&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;four&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_5321_7070</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Ordering columns must be included in the output columns. Note that
this means results that might otherwise be distinct are not (if there
are multiple values in the ordering cols), as in this example. This
isn't a bug; it's a warning to be careful with the selection of
ordering columns.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertValueQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;misc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;note&#39;</span><span class="p">,</span> <span class="s">&#39;-misc&#39;</span><span class="p">),</span>
            <span class="p">[{</span><span class="s">&#39;misc&#39;</span><span class="p">:</span> <span class="s">&#39;foo&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;misc&#39;</span><span class="p">:</span> <span class="s">&#39;bar&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;misc&#39;</span><span class="p">:</span> <span class="s">&#39;foo&#39;</span><span class="p">}]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket4358</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>If you don't pass any fields to values(), relation fields are
returned as "foo<em>id" keys, not "foo". For consistency, you should be
able to pass "foo</em>id" in the fields list and have it work, too. We
actually allow both "foo" and "foo_id".</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>The *_id version is returned by default.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;note_id&#39;</span> <span class="ow">in</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>You can also pass it in explicitly.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertValueQuerysetEqual</span><span class="p">(</span>
            <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;note_id&#39;</span><span class="p">),</span>
            <span class="p">[{</span><span class="s">&#39;note_id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;note_id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>...or use the field name.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertValueQuerysetEqual</span><span class="p">(</span>
            <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;note&#39;</span><span class="p">),</span>
            <span class="p">[{</span><span class="s">&#39;note&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;note&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket2902</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Parameters can be given to extra_select, <em>if</em> you use a SortedDict.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>(First we need to know which order the keys fall in "naturally" on
your system, so we can put things in the wrong way around from
normal. A normal dict would thus fail.)</p></td><td class="code"><div class="highlight"><pre>        <span class="n">s</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">)]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;two&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="p">[</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">]:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">params</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>This slightly odd comparison works around the fact that PostgreSQL will
return 'one' and 'two' as strings, not Unicode objects. It's a side-effect of
using constants here and not a real concern.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">d</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">select_params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="s">&#39;two&#39;</span><span class="p">})</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Order by the number of tags attached to an item.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">l</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;count&#39;</span><span class="p">:</span> <span class="s">&#39;select count(*) from queries_item_tags where queries_item_tags.item_id = queries_item.id&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-count&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">count</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">l</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_ticket6154</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Multiple filter statements are joined using "AND" all the time.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">extra__note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">item__note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
                <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">extra__note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">item__note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket6981</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;parent&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket9926</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&quot;parent&quot;</span><span class="p">,</span> <span class="s">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;parent&#39;</span><span class="p">,</span> <span class="s">&quot;parent__category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_6180_6203</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Dates with limits and/or counts</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;month&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_tickets_7087_12242</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Dates with extra select columns</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span>
            <span class="p">[</span><span class="s">&#39;datetime.datetime(2007, 12, 19, 0, 0)&#39;</span><span class="p">,</span> <span class="s">&#39;datetime.datetime(2007, 12, 20, 0, 0)&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;datetime.datetime(2007, 12, 19, 0, 0)&#39;</span><span class="p">,</span> <span class="s">&#39;datetime.datetime(2007, 12, 20, 0, 0)&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">name</span><span class="o">=</span><span class="s">&quot;one&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;name=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;datetime.datetime(2007, 12, 19, 0, 0)&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;name=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;datetime.datetime(2007, 12, 19, 0, 0)&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7155</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Nullable dates</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;modified&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;datetime.datetime(2007, 12, 19, 0, 0)&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7098</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Make sure semi-deprecated ordering by related models syntax still
works.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertValueQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;note__note&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;queries_note.note&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">),</span>
            <span class="p">[{</span><span class="s">&#39;note__note&#39;</span><span class="p">:</span> <span class="s">&#39;n2&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;note__note&#39;</span><span class="p">:</span> <span class="s">&#39;n3&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;note__note&#39;</span><span class="p">:</span> <span class="s">&#39;n3&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;note__note&#39;</span><span class="p">:</span> <span class="s">&#39;n3&#39;</span><span class="p">}]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7096</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Make sure exclude() with multiple conditions continues to work.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="s">&#39;four&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>More twisted cases, involving nested negations.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_7204_7506</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Make sure querysets with related fields can be pickled. If this
doesn't crash, it's a Good Thing.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_ticket7813</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>We should also be able to pickle things that use select_related().
The only tricky thing here is to ensure that we do the related
selections properly after unpickling.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">query2</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">query2</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">query</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_deferred_load_qs_pickling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Check pickling of deferred-loading querysets</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;creator&#39;</span><span class="p">)</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">q2</span><span class="p">))</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">q3</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_ticket7277</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="o">.</span><span class="n">annotation_set</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t5</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">tag__children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t5</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">tag__children__children</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t5</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Annotation: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_7448_7707</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Complex objects should be converted to strings before being used in
lookups.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created__in</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">time1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">time2</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: one&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7235</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>An EmptyQuerySet should not raise exceptions if it is filtered.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">q</span> <span class="o">=</span> <span class="n">EmptyQuerySet</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">complex_filter</span><span class="p">({</span><span class="s">&#39;pk&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;spam&#39;</span><span class="p">,</span> <span class="s">&#39;eggs&#39;</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;eggs&#39;</span><span class="p">)),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-pub_date&#39;</span><span class="p">,</span> <span class="s">&#39;headline&#39;</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">q</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;is_recent&#39;</span><span class="p">:</span> <span class="s">&quot;pub_date &gt; &#39;2006-01-01&#39;&quot;</span><span class="p">}),</span>
            <span class="p">[]</span>
        <span class="p">)</span>
        <span class="n">q</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">low_mark</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="ne">AssertionError</span><span class="p">,</span>
            <span class="s">&#39;Cannot change a query once a slice has been taken&#39;</span><span class="p">,</span>
            <span class="n">q</span><span class="o">.</span><span class="n">extra</span><span class="p">,</span> <span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;is_recent&#39;</span><span class="p">:</span> <span class="s">&quot;pub_date &gt; &#39;2006-01-01&#39;&quot;</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">reverse</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="s">&#39;spam&#39;</span><span class="p">,</span> <span class="s">&#39;eggs&#39;</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="s">&#39;spam&#39;</span><span class="p">,</span> <span class="s">&#39;eggs&#39;</span><span class="p">),</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_ticket7791</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>There were "issues" when ordering and distinct-ing on fields related
via ForeignKeys.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;extrainfo__info&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()),</span>
            <span class="mi">3</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Pickling of DateQuerySets used to fail</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;created&#39;</span><span class="p">,</span> <span class="s">&#39;month&#39;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_ticket9997</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>If a ValuesList or Values queryset is passed as an inner query, we
make sure it's only requesting a single value and use that as the
thing to select.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Multi-valued values() and values_list() querysets should raise errors.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span>
            <span class="s">&#39;Cannot use a multi-field ValuesQuerySet as a filter value.&#39;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="ne">TypeError</span><span class="p">,</span>
            <span class="s">&#39;Cannot use a multi-field ValuesListQuerySet as a filter value.&#39;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket9985</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>qs.values_list(...).values(...) combinations should work.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertValueQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;note&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">),</span>
            <span class="p">[{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span> <span class="p">{</span><span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">notes__in</span><span class="o">=</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&quot;n1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;note&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Annotation: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket10205</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>When bailing out early because of an empty "__in" filter, we need
to set things up correctly internally so that subqueries can continue properly.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;foo&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket10432</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Testing an empty "__in" filter with a generator as the value.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">iter</span><span class="p">([])</span>
        <span class="n">n_obj</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">n_obj</span><span class="o">.</span><span class="n">pk</span><span class="p">]:</span>
                <span class="k">yield</span> <span class="n">i</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">f</span><span class="p">()),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">g</span><span class="p">())),</span> <span class="p">[</span><span class="n">n_obj</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_ticket10742</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Queries used in an __in clause don't execute subqueries</p></td><td class="code"><div class="highlight"><pre>        <span class="n">subq</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">subq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>The subquery result cache should not be populated</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subq</span><span class="o">.</span><span class="n">_result_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">subq</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">subq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&lt;Author: a3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Author: a4&gt;&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>The subquery result cache should not be populated</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subq</span><span class="o">.</span><span class="n">_result_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>

        <span class="n">subq</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">3000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">subq</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>The subquery result cache should not be populated</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">subq</span><span class="o">.</span><span class="n">_result_cache</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7076</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Excluding shouldn't eliminate NULL entries.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">modified</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time1</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: four&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: three&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Item: two&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">parent__name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7181</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Ordering by related tables should accomodate nullable fields (this
test is a little tricky, since NULL ordering is database dependent.
Instead, we just count the number of results).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;parent__name&#39;</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>Empty querysets can be merged with others.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span> <span class="o">|</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">|</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">(),</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_ticket9411</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Make sure bump_prefix() (an internal Query method) doesn't (re-)break. It's
sufficient that this query runs without error.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">bump_prefix</span><span class="p">()</span>
        <span class="n">first</span> <span class="o">=</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">first</span><span class="o">+</span><span class="mi">5</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_ticket8439</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Complex combinations of conjunctions, disjunctions and nullable
relations.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">item__note__extrainfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e2</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;xyz&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">report</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">r1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;xyz&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">item__note__extrainfo</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">e2</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Author: a2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tag__parent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">notes__note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Annotation: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;xx&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">extrainfo__author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">extrainfo</span><span class="o">=</span><span class="n">xx</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">xx</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">extrainfo__author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">extrainfo</span><span class="o">=</span><span class="n">xx</span><span class="p">))</span><span class="o">.</span><span class="n">query</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">alias_map</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">q</span><span class="o">.</span><span class="n">LOUTER</span> <span class="ow">and</span> <span class="n">q</span><span class="o">.</span><span class="n">alias_refcount</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]),</span>
            <span class="mi">1</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket17429</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that Meta.ordering=None works the same as Meta.ordering=[]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">original_ordering</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span>
        <span class="n">Tag</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">Tag</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">ordering</span> <span class="o">=</span> <span class="n">original_ordering</span>

    <span class="k">def</span> <span class="nf">test_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">)))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)</span><span class="o">|~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)</span><span class="o">|~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">)))])</span>

    <span class="k">def</span> <span class="nf">test_nested_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">))])</span>

    <span class="k">def</span> <span class="nf">test_double_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">)))])</span>

    <span class="nd">@unittest.expectedFailure</span>
    <span class="k">def</span> <span class="nf">test_exclude_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;t4&#39;</span><span class="p">,</span> <span class="s">&#39;t3&#39;</span><span class="p">])),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;t4&#39;</span><span class="p">,</span> <span class="s">&#39;t3&#39;</span><span class="p">]))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;t4&#39;</span><span class="p">,</span> <span class="s">&#39;t3&#39;</span><span class="p">])),</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~~</span><span class="n">Q</span><span class="p">(</span><span class="n">tags__name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;t4&#39;</span><span class="p">,</span> <span class="s">&#39;t3&#39;</span><span class="p">]))])</span>

<span class="k">class</span> <span class="nc">Queries2Tests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket4289</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>A slight variation on the restricting the filtering choices by the
lookup constraints.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num__lt</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num__lt</span><span class="o">=</span><span class="mi">13</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num__lt</span><span class="o">=</span><span class="mi">12</span><span class="p">)),</span>
            <span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">num__lt</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">4</span><span class="p">)),</span>
            <span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">4</span><span class="p">)),</span>
            <span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">4</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket12239</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Float was being rounded to integer on gte queries on integer field.  Tests
show that gt, lt, gte, and lte work as desired.  Note that the fix changes
get<em>prep</em>lookup for gte and lt queries only.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mf">11.9</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mf">12.0</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gt</span><span class="o">=</span><span class="mf">12.1</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mf">12.0</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lt</span><span class="o">=</span><span class="mf">12.1</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gte</span><span class="o">=</span><span class="mf">11.9</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gte</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gte</span><span class="o">=</span><span class="mf">12.0</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gte</span><span class="o">=</span><span class="mf">12.1</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__gte</span><span class="o">=</span><span class="mf">12.9</span><span class="p">),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lte</span><span class="o">=</span><span class="mf">11.9</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lte</span><span class="o">=</span><span class="mi">12</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lte</span><span class="o">=</span><span class="mf">12.0</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lte</span><span class="o">=</span><span class="mf">12.1</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__lte</span><span class="o">=</span><span class="mf">12.9</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Number: 4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 8&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Number: 12&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7411</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Saving to db must work even with partially read result set in another
cursor.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ITER_CHUNK_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span> <span class="k">break</span>

    <span class="k">def</span> <span class="nf">test_ticket7759</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Count should work with a partially read result set.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">count</span> <span class="o">=</span> <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="n">count</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">run</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">Queries3Tests</span><span class="p">(</span><span class="n">BaseQuerysetTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_ticket7107</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>This shouldn't create an infinite loop.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Valid</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_ticket8683</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Raise proper error when a DateQuerySet gets passed a wrong type of
field</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="ne">AssertionError</span><span class="p">,</span>
            <span class="s">&quot;&#39;name&#39; isn&#39;t a DateField.&quot;</span><span class="p">,</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">dates</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;month&#39;</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">Queries4Tests</span><span class="p">(</span><span class="n">BaseQuerysetTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">generic</span> <span class="o">=</span> <span class="n">NamedCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Generic&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>

        <span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n2&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">e1</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e2&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">n2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1001</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a3</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a3&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3003</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r1</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;r1&#39;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;r2&#39;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r3</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;r3&#39;</span><span class="p">)</span>

        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;i1&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">note</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;i2&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">note</span><span class="o">=</span><span class="n">n1</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket14876</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">creator__extra__info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">))</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span> <span class="o">|</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__extra__info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;&lt;Report: r1&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;Report: r3&gt;&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">q1</span><span class="o">.</span><span class="n">query</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">q2</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>

        <span class="n">q1</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__extra__info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">creator__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__extra__info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">))</span> <span class="o">|</span> <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;&lt;Report: r1&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;Report: r3&gt;&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">q1</span><span class="o">.</span><span class="n">query</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">q2</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>

        <span class="n">q1</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">creator__report__name</span><span class="o">=</span><span class="s">&#39;r1&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span> <span class="o">|</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__report__name</span><span class="o">=</span><span class="s">&#39;r1&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;&lt;Item: i1&gt;&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">q1</span><span class="o">.</span><span class="n">query</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">q2</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>

        <span class="n">q1</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__report__name</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="n">q2</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator__report__name</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span> <span class="o">|</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a1</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;&lt;Item: i1&gt;&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">q1</span><span class="o">.</span><span class="n">query</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">q2</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_ticket7095</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>Updates that are filtered on the model being updated are somewhat
tricky in MySQL. This exercises that case.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ManagedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;mm1&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ManagedModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;mm&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>A values() or values_list() query across joined models must use outer
joins appropriately.
Note: In Oracle, we expect a null CharField to return '' instead of
None.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interprets_empty_strings_as_nulls</span><span class="p">:</span>
            <span class="n">expected_null_charfield_repr</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expected_null_charfield_repr</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertValueQuerysetEqual</span><span class="p">(</span>
            <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;creator__extra__info&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;e1&#39;</span><span class="p">,</span> <span class="s">&#39;e2&#39;</span><span class="p">,</span> <span class="n">expected_null_charfield_repr</span><span class="p">],</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>Similarly for select_related(), joins beyond an initial nullable join
must use outer joins so that all results are included.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Report</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">,</span> <span class="s">&quot;creator__extra&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Report: r1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Report: r2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Report: r3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>When there are multiple paths to a table from another table, we have
to be careful not to accidentally reuse an inappropriate join when
using select_related(). We used to return the parent's Detail record
here by mistake.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">d1</span> <span class="o">=</span> <span class="n">Detail</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&quot;d1&quot;</span><span class="p">)</span>
        <span class="n">d2</span> <span class="o">=</span> <span class="n">Detail</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&quot;d2&quot;</span><span class="p">)</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;m1&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">d1</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">Member</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;m2&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">d2</span><span class="p">)</span>
        <span class="n">Child</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">person</span><span class="o">=</span><span class="n">m2</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">m1</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">m1</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&quot;person__details&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">person</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">&#39;d2&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order_by_resetting</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>Calling order_by() with no parameters removes any existing ordering on the
model. But it should still be possible to add new ordering after that.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;ORDER BY&#39;</span> <span class="ow">in</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_ticket10181</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>Avoid raising an EmptyResultSet if an inner query is probably
empty (and hence, not executed).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])),</span>
            <span class="p">[]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_filter_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category1&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category2&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c2</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c3</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category__specialcategory__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">ci3</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_exclude_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category1&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category2&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c2</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c3</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">category__specialcategory__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci1</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_filter_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category1&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category2&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c2</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c3</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category__specialcategory__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci1</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_exclude_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category1&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">SpecialCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;named category2&quot;</span><span class="p">,</span>
                <span class="n">special_name</span><span class="o">=</span><span class="s">&quot;special2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c2</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c3</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">category__specialcategory__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">ci3</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_one2one_filter_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span>  <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat&quot;</span><span class="p">)</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat0&quot;</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>

        <span class="n">c2</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c1</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c0</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c0</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category__onetoonecategory__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">ci3</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_one2one_exclude_false</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span>  <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat&quot;</span><span class="p">)</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat0&quot;</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>

        <span class="n">c2</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c1</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c0</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c0</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">category__onetoonecategory__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci1</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_one2one_filter_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span>  <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat&quot;</span><span class="p">)</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat0&quot;</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>

        <span class="n">c2</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c1</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c0</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c0</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category__onetoonecategory__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci1</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket15316_one2one_exclude_true</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">c</span>  <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat&quot;</span><span class="p">)</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;cat0&quot;</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">SimpleCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;category1&quot;</span><span class="p">)</span>

        <span class="n">c2</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c1</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new1&quot;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">OneToOneCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">c0</span><span class="p">,</span> <span class="n">new_name</span><span class="o">=</span><span class="s">&quot;new2&quot;</span><span class="p">)</span>

        <span class="n">ci1</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">ci2</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c0</span><span class="p">)</span>
        <span class="n">ci3</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">c1</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">CategoryItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">category__onetoonecategory__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="n">ci2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">ci3</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Queries5Tests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>Ordering by 'rank' gives us rank2, rank1, rank3. Ordering by the
Meta.ordering will be rank3, rank2, rank1.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n2&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e2&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">n2</span><span class="p">)</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">1001</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a2&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">2002</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a3&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3003</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank1</span> <span class="o">=</span> <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">a2</span><span class="p">)</span>
        <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">a3</span><span class="p">)</span>
        <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">a1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>Cross model ordering is possible in Meta, too.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Ranking: 3: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 2: a2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 1: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;rank&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Ranking: 1: a3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 2: a2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 3: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Ordering of extra() pieces is possible, too and you can mix extra
fields and model fields in the ordering.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;django_site&#39;</span><span class="p">],</span> <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;-django_site.id&#39;</span><span class="p">,</span> <span class="s">&#39;rank&#39;</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Ranking: 1: a3&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 2: a2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 3: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;good&#39;</span><span class="p">:</span> <span class="s">&#39;case when rank &gt; 2 then 1 else 0 end&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">good</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">qs</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;-good&#39;</span><span class="p">,))],</span>
            <span class="p">[</span><span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;-good&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Ranking: 3: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 2: a2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 1: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>Despite having some extra aliases in the query, we can still omit
them in a values() query.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dicts</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;rank&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">],</span>
            <span class="p">[(</span><span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7256</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>An empty values() call includes all aliases, including those from an
extra()</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;good&#39;</span><span class="p">:</span> <span class="s">&#39;case when rank &gt; 2 then 1 else 0 end&#39;</span><span class="p">})</span>
        <span class="n">dicts</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">:</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">];</span> <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;author_id&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">())</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dicts</span><span class="p">],</span>
            <span class="p">[[(</span><span class="s">&#39;good&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)],</span> <span class="p">[(</span><span class="s">&#39;good&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)],</span> <span class="p">[(</span><span class="s">&#39;good&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;rank&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7045</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Extra tables used to crash SQL construction on the second use.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;django_site&#39;</span><span class="p">])</span>
        <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>test passes if this doesn't raise an exception.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_ticket9848</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>Make sure that updates which only filter on sub-tables don't
inadvertently update the wrong records (bug #9848).</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>Make sure that the IDs from different tables don't happen to match.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author__name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Ranking: 3: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author__name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="s">&#39;4&#39;</span><span class="p">),</span>
            <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">author__name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">r</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Ranking</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Ranking: 3: a1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 2: a2&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Ranking: 1: a3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket5261</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Test different empty excludes.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">Q</span><span class="p">()),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">()),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">()</span><span class="o">|~</span><span class="n">Q</span><span class="p">()),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="o">~</span><span class="n">Q</span><span class="p">()</span><span class="o">&amp;~</span><span class="n">Q</span><span class="p">()),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Note: n1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Note: n2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">SelectRelatedTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_tickets_3045_3288</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>Once upon a time, select_related() with circular relations would loop
infinitely if you forgot to specify "depth". Now we set an arbitrary
default upper bound.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(),</span> <span class="p">[])</span>


<span class="k">class</span> <span class="nc">SubclassFKTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_ticket7778</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Model subclasses could not be deleted if a nullable foreign key
relates to a model that relates back.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">num_celebs</span> <span class="o">=</span> <span class="n">Celebrity</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">tvc</span> <span class="o">=</span> <span class="n">TvChef</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Huey&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Celebrity</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">num_celebs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">Fan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">fan_of</span><span class="o">=</span><span class="n">tvc</span><span class="p">)</span>
        <span class="n">Fan</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">fan_of</span><span class="o">=</span><span class="n">tvc</span><span class="p">)</span>
        <span class="n">tvc</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>The parent object should have been deleted as well.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Celebrity</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="n">num_celebs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CustomPkTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_ticket7371</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Related</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;custom&#39;</span><span class="p">),</span> <span class="p">[])</span>


<span class="k">class</span> <span class="nc">NullableRelOrderingTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_ticket10028</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>Ordering by model related to nullable relations(!) should use outer
joins, so that all results are included.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Plaything</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;p1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Plaything</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Plaything: p1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_join_already_in_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>Ordering by model related to nullable relations should not change
the join type of already existing joins.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Plaything</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;p1&quot;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">SingleObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;s&#39;</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">RelatedObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">single</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">Plaything</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;p2&quot;</span><span class="p">,</span> <span class="n">others</span><span class="o">=</span><span class="n">r</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Plaything</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">others__isnull</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;INNER&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;others__single__name&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>The ordering by others<strong>single</strong>pk will add one new join (to single)
and that join must be LEFT join. The already existing join to related
objects must be kept INNER. So, we have both a INNER and a LEFT join
in the query.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;LEFT&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;INNER&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;&lt;Plaything: p2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">DisjunctiveFilterTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket7872</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>Another variation on the disjunctive filtering theme.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>For the purposes of this regression test, it's important that there is no
Join object releated to the LeafA we create.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">LeafA</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">LeafA</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;&lt;LeafA: first&gt;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">LeafA</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">Q</span><span class="p">(</span><span class="n">join__b__data</span><span class="o">=</span><span class="s">&#39;second&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;LeafA: first&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket8283</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>Checking that applying filters after a disjunction works correctly.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="p">(</span><span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span><span class="o">|</span><span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e2&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;ExtraInfo: e1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="p">(</span><span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e2&#39;</span><span class="p">)</span><span class="o">|</span><span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;ExtraInfo: e1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">Queries6Tests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">generic</span> <span class="o">=</span> <span class="n">NamedCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Generic&quot;</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t2&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">t4</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t3</span><span class="p">)</span>
        <span class="n">t5</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t5&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t3</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ann1</span> <span class="o">=</span> <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a1&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">ann1</span><span class="o">.</span><span class="n">notes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">ann2</span> <span class="o">=</span> <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a2&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="n">t4</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>This next test used to cause really weird PostgreSQL behavior, but it was
only apparent much later when the full test suite ran.
@unittest.expectedFailure</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">test_slicing_and_cache_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>We can do slicing beyond what is currently in the result cache,
too.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>We need to mess with the implementation internals a bit here to decrease the
cache fill size so that we don't read all the results at once.</p></td><td class="code"><div class="highlight"><pre>        <span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">query</span>
        <span class="n">query</span><span class="o">.</span><span class="n">ITER_CHUNK_SIZE</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>Fill the cache with the first chunk.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>Query beyond the end of the cache and check that it is filled out as required.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">qs</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">),</span> <span class="mi">5</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>But querying beyond the end of the result set will fail.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">qs</span><span class="p">[</span><span class="mi">100</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_parallel_iterators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>Test that parallel iterators work.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">i1</span><span class="p">,</span> <span class="n">i2</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="nb">iter</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">i1</span><span class="p">)),</span> <span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">i1</span><span class="p">)),</span> <span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">i2</span><span class="p">)),</span> <span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">i2</span><span class="p">)),</span> <span class="s">&#39;&lt;Tag: t2&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">i2</span><span class="p">)),</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">i1</span><span class="p">)),</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_nested_queries_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>Nested queries should not evaluate the inner query as part of constructing the
SQL (so we should see a nested query here, indicated by two "SELECT" calls).</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">notes__in</span><span class="o">=</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&quot;xyzzy&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&#39;SELECT&#39;</span><span class="p">),</span>
            <span class="mi">2</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_tickets_8921_9188</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>Incorrect SQL was being generated for certain types of exclude()
queries that crossed multi-valued relations (#8921, #9188 and some
pre-emptively discovered cases).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">PointerA</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">connection__pointerb__id</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">PointerA</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">connection__pointerb__id</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="p">[]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t3&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>This example is tricky because the parent could be NULL, so only checking
parents with annotations omits some results (tag t1, in this case).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">parent__annotation__name</span><span class="o">=</span><span class="s">&quot;a1&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Tag: t1&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t4&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;Tag: t5&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>The annotation->tag link is single values and tag->children links is
multi-valued. So we have to split the exclude filter in the middle
and then optimize the inner query without losing results.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">tag__children__name</span><span class="o">=</span><span class="s">&quot;t2&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Annotation: a2&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>Nested queries are possible (although should be used with care, since
they have performance problems on backends like MySQL.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">notes__in</span><span class="o">=</span><span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&quot;n1&quot;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Annotation: a1&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket3739</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>The all() method on querysets returns a copy of the queryset.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">q1</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNot</span><span class="p">(</span><span class="n">q1</span><span class="p">,</span> <span class="n">q1</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">RawQueriesTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket14729</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>Test representation of raw query with one or few parameters passed as list</p></td><td class="code"><div class="highlight"><pre>        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;SELECT * FROM queries_note WHERE note = </span><span class="si">%s</span><span class="s">&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;n1&#39;</span><span class="p">]</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="n">str_prefix</span><span class="p">(</span><span class="s">&quot;&lt;RawQuerySet: </span><span class="si">%(_)s</span><span class="s">&#39;SELECT * FROM queries_note WHERE note = n1&#39;&gt;&quot;</span><span class="p">))</span>

        <span class="n">query</span> <span class="o">=</span> <span class="s">&quot;SELECT * FROM queries_note WHERE note = </span><span class="si">%s</span><span class="s"> and misc = </span><span class="si">%s</span><span class="s">&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">]</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="n">str_prefix</span><span class="p">(</span><span class="s">&quot;&lt;RawQuerySet: </span><span class="si">%(_)s</span><span class="s">&#39;SELECT * FROM queries_note WHERE note = n1 and misc = foo&#39;&gt;&quot;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">GeneratorExpressionTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_ticket10432</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>Using an empty generator expression as the rvalue for an "__in"
lookup is legal.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">())),</span>
            <span class="p">[]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ComparisonTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n1</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;n1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;e1&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a2</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a2&#39;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">2002</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">e1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ticket8597</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>Regression tests for case-insensitive comparisons</p></td><td class="code"><div class="highlight"><pre>        <span class="n">_</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;a_b&quot;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;x%y&quot;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">creator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a2</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__iexact</span><span class="o">=</span><span class="s">&quot;A_b&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: a_b&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__iexact</span><span class="o">=</span><span class="s">&quot;x%Y&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: x%y&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__istartswith</span><span class="o">=</span><span class="s">&quot;A_b&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: a_b&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__iendswith</span><span class="o">=</span><span class="s">&quot;A_b&quot;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;Item: a_b&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ExistsSql</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>Ok - so the exist query worked - but did it include too many columns?</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&quot;id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;sql&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="s">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;sql&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">QuerysetOrderedTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for the Queryset.ordered attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">test_no_default_or_explicit_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_cleared_default_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_explicit_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order_by_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_annotated_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Annotation</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_notes</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;notes&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;num_notes&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ordered</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SubqueryTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ordered_subselect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Subselects honor any manual ordering&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span> <span class="o">=</span> <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>

            <span class="n">query</span> <span class="o">=</span> <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]))</span>

            <span class="n">query</span> <span class="o">=</span> <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Oracle and MySQL both have problems with sliced subselects.
This prevents us from even evaluating this test case at all.
Refs #10099</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">allow_sliced_subqueries</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_sliced_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Delete queries can safely contain sliced subqueries&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-id&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span> <span class="nb">set</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]))</span>
        <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>Oracle and MySQL both have problems with sliced subselects.
This prevents us from even evaluating this test case at all.
Refs #10099</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">connections</span><span class="p">[</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">]</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">allow_sliced_subqueries</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CloneTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_evaluated_queryset_as_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;#13227 -- If a queryset is already evaluated, it can still be used as a query arg&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">Note</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;Test1&#39;</span><span class="p">,</span> <span class="n">misc</span><span class="o">=</span><span class="s">&#39;misc&#39;</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">ExtraInfo</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s">&#39;good&#39;</span><span class="p">,</span> <span class="n">note</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">n_list</span> <span class="o">=</span> <span class="n">Note</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>Evaluate the Note queryset, populating the query cache</p></td><td class="code"><div class="highlight"><pre>        <span class="nb">list</span><span class="p">(</span><span class="n">n_list</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>Use the note queryset in a query, and evalute
that query in a way that involves cloning.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ExtraInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">note__in</span><span class="o">=</span><span class="n">n_list</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s">&#39;good&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Query should be clonable&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EmptyQuerySetTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_emptyqueryset_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><h1>14366 -- Calling .values() on an EmptyQuerySet and then cloning that</h1>

<p>should not cause an error"</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;num&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;num&#39;</span><span class="p">),</span> <span class="p">[]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_values_subquery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&quot;pk&quot;</span><span class="p">)),</span>
            <span class="p">[]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;pk&quot;</span><span class="p">)),</span>
            <span class="p">[]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ValuesQuerysetTests</span><span class="p">(</span><span class="n">BaseQuerysetTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_flat_values_lits</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">72</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;num&quot;</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;num&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertValueQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="mi">72</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">WeirdQuerysetSlicingTests</span><span class="p">(</span><span class="n">BaseQuerysetTest</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;four&#39;</span><span class="p">,</span> <span class="n">created</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_tickets_7698_10202</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>People like to slice with '0' as the high-water mark.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">],</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">][:</span><span class="mi">10</span><span class="p">],</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="ne">AssertionError</span><span class="p">,</span>
            <span class="s">&#39;Cannot change a query once a slice has been taken.&#39;</span><span class="p">,</span>
            <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[:</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">latest</span><span class="p">,</span> <span class="s">&#39;created&#39;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_empty_resultset_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>ticket #12192</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">1</span><span class="p">:</span><span class="mi">1</span><span class="p">]))</span>


<span class="k">class</span> <span class="nc">EscapingTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_ticket_7302</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>Reserved names are appropriately escaped</p></td><td class="code"><div class="highlight"><pre>        <span class="n">_</span> <span class="o">=</span> <span class="n">ReservedName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">ReservedName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">37</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">ReservedName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;order&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;ReservedName: b&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;ReservedName: a&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">ReservedName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;stuff&#39;</span><span class="p">:</span><span class="s">&#39;name&#39;</span><span class="p">},</span> <span class="n">order_by</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;order&#39;</span><span class="p">,</span><span class="s">&#39;stuff&#39;</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;&lt;ReservedName: b&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;ReservedName: a&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ToFieldTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_in_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">apple</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
        <span class="n">pear</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pear&quot;</span><span class="p">)</span>
        <span class="n">lunch</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">apple</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;lunch&quot;</span><span class="p">)</span>
        <span class="n">dinner</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">pear</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;dinner&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">food__in</span><span class="o">=</span><span class="p">[</span><span class="n">apple</span><span class="p">,</span> <span class="n">pear</span><span class="p">])),</span>
            <span class="nb">set</span><span class="p">([</span><span class="n">lunch</span><span class="p">,</span> <span class="n">dinner</span><span class="p">]),</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_reverse_in</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">apple</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
        <span class="n">pear</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;pear&quot;</span><span class="p">)</span>
        <span class="n">lunch_apple</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">apple</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;lunch&quot;</span><span class="p">)</span>
        <span class="n">lunch_pear</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">pear</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;dinner&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">eaten__in</span><span class="o">=</span><span class="p">[</span><span class="n">lunch_apple</span><span class="p">,</span> <span class="n">lunch_pear</span><span class="p">])),</span>
            <span class="nb">set</span><span class="p">([</span><span class="n">apple</span><span class="p">,</span> <span class="n">pear</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_single_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">apple</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
        <span class="n">lunch</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">apple</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;lunch&quot;</span><span class="p">)</span>
        <span class="n">dinner</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">apple</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;dinner&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">apple</span><span class="p">)),</span>
            <span class="nb">set</span><span class="p">([</span><span class="n">lunch</span><span class="p">,</span> <span class="n">dinner</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_single_object_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">apple</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
        <span class="n">lunch</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">apple</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;lunch&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">eaten</span><span class="o">=</span><span class="n">lunch</span><span class="p">)),</span>
            <span class="nb">set</span><span class="p">([</span><span class="n">apple</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_recursive_fk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">node1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">node1</span><span class="p">)),</span>
            <span class="p">[</span><span class="n">node2</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_recursive_fk_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">node1</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="n">node2</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">node1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">Node</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node2</span><span class="p">)),</span>
            <span class="p">[</span><span class="n">node1</span><span class="p">]</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">ConditionalTests</span><span class="p">(</span><span class="n">BaseQuerysetTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Tests whose execution depend on different environment conditions like</span>
<span class="sd">    Python version or DB backend features&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">generic</span> <span class="o">=</span> <span class="n">NamedCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Generic&quot;</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t1&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t2&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t1</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">generic</span><span class="p">)</span>
        <span class="n">t3</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t3&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">t4</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t4&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t3</span><span class="p">)</span>
        <span class="n">t5</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;t5&#39;</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">t3</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>In Python 2.6 beta releases, exceptions raised in <strong>len</strong> are swallowed
(Python issue 1242657), so these cases return an empty list, rather than
raising an exception. Not a lot we can do about that, unfortunately, due to
the way Python handles list() calls internally. Thus, we skip the tests for
Python 2.6.</p></td><td class="code"><div class="highlight"><pre>    <span class="nd">@unittest.skipIf</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="s">&quot;Python version is 2.6&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_infinite_loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>If you're not careful, it's possible to introduce infinite loops via
default ordering on foreign keys in a cycle. We detect that.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="n">FieldError</span><span class="p">,</span>
            <span class="s">&#39;Infinite loop caused by ordering.&#39;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">LoopX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="c"># Force queryset evaluation with list()</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="n">FieldError</span><span class="p">,</span>
            <span class="s">&#39;Infinite loop caused by ordering.&#39;</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">LoopZ</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="c"># Force queryset evaluation with list()</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>Note that this doesn't cause an infinite loop, since the default
ordering on the Tag model is empty (and thus defaults to using "id"
for the related field).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;parent&#39;</span><span class="p">)),</span> <span class="mi">5</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>... but you can still order in a non-recursive fashion amongst linked
fields (the previous test failed because the default ordering was
recursive).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">LoopX</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;y__x__y__x__id&#39;</span><span class="p">),</span>
            <span class="p">[]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>When grouping without specifying ordering, we add an explicit "ORDER BY NULL"
portion in MySQL to prevent unnecessary sorting.</p></td><td class="code"><div class="highlight"><pre>    <span class="nd">@skipUnlessDBFeature</span><span class="p">(</span><span class="s">&#39;requires_explicit_null_ordering_when_grouping&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_null_ordering_added</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;parent_id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span><span class="o">.</span><span class="n">query</span>
        <span class="n">query</span><span class="o">.</span><span class="n">group_by</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;parent_id&#39;</span><span class="p">]</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">fragment</span> <span class="o">=</span> <span class="s">&quot;ORDER BY &quot;</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">sql</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">fragment</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">fragment</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;NULL&quot;</span><span class="p">,</span> <span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragment</span><span class="p">)),</span> <span class="n">pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">fragment</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>Sqlite 3 does not support passing in more than 1000 parameters except by
changing a parameter at compilation time.</p></td><td class="code"><div class="highlight"><pre>    <span class="nd">@skipUnlessDBFeature</span><span class="p">(</span><span class="s">&#39;supports_1000_query_parameters&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_ticket14244</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>Test that the "in" lookup works with lists of 1000 items or more.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">numbers</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">:</span>
            <span class="n">_</span> <span class="o">=</span> <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__in</span><span class="o">=</span><span class="n">numbers</span><span class="p">[:</span><span class="mi">1000</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">1000</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__in</span><span class="o">=</span><span class="n">numbers</span><span class="p">[:</span><span class="mi">1001</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">1001</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__in</span><span class="o">=</span><span class="n">numbers</span><span class="p">[:</span><span class="mi">2000</span><span class="p">])</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">2000</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Number</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num__in</span><span class="o">=</span><span class="n">numbers</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">2500</span>
        <span class="p">)</span>


<span class="k">class</span> <span class="nc">UnionTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests for the union of two querysets. Bug #12252.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">objectas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">objectbs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">objectcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">a_info</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="s">&#39;two&#39;</span><span class="p">,</span> <span class="s">&#39;three&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">a_info</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">ObjectA</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
            <span class="n">o</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">objectas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">b_info</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;un&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">objectas</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;deux&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">objectas</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;trois&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">objectas</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">objecta</span> <span class="ow">in</span> <span class="n">b_info</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">ObjectB</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">number</span><span class="p">,</span> <span class="n">objecta</span><span class="o">=</span><span class="n">objecta</span><span class="p">)</span>
            <span class="n">o</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">objectbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="n">c_info</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&#39;ein&#39;</span><span class="p">,</span> <span class="n">objectas</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">objectbs</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;zwei&#39;</span><span class="p">,</span> <span class="n">objectas</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">objectbs</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">objecta</span><span class="p">,</span> <span class="n">objectb</span> <span class="ow">in</span> <span class="n">c_info</span><span class="p">:</span>
            <span class="n">o</span> <span class="o">=</span> <span class="n">ObjectC</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">objecta</span><span class="o">=</span><span class="n">objecta</span><span class="p">,</span> <span class="n">objectb</span><span class="o">=</span><span class="n">objectb</span><span class="p">)</span>
            <span class="n">o</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">objectcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">):</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">Q1</span><span class="p">)</span> <span class="o">|</span> <span class="nb">filter</span><span class="p">(</span><span class="n">Q2</span><span class="p">)),</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">Q1</span> <span class="o">|</span> <span class="n">Q2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">Q2</span><span class="p">)</span> <span class="o">|</span> <span class="nb">filter</span><span class="p">(</span><span class="n">Q1</span><span class="p">)),</span> <span class="nb">set</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="n">Q1</span> <span class="o">|</span> <span class="n">Q2</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">test_A_AB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">)</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objectb__name</span><span class="o">=</span><span class="s">&#39;deux&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_union</span><span class="p">(</span><span class="n">ObjectA</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_A_AB2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">)</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objectb__name</span><span class="o">=</span><span class="s">&#39;deux&#39;</span><span class="p">,</span> <span class="n">objectb__num</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_union</span><span class="p">(</span><span class="n">ObjectA</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_AB_ACB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objectb__name</span><span class="o">=</span><span class="s">&#39;deux&#39;</span><span class="p">)</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objectc__objectb__name</span><span class="o">=</span><span class="s">&#39;deux&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_union</span><span class="p">(</span><span class="n">ObjectA</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_BAB_BAC</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objecta__objectb__name</span><span class="o">=</span><span class="s">&#39;deux&#39;</span><span class="p">)</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objecta__objectc__name</span><span class="o">=</span><span class="s">&#39;ein&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_union</span><span class="p">(</span><span class="n">ObjectB</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_BAB_BACB</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objecta__objectb__name</span><span class="o">=</span><span class="s">&#39;deux&#39;</span><span class="p">)</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objecta__objectc__objectb__name</span><span class="o">=</span><span class="s">&#39;trois&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_union</span><span class="p">(</span><span class="n">ObjectB</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_BA_BCA__BAB_BAC_BCA</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objecta__name</span><span class="o">=</span><span class="s">&#39;one&#39;</span><span class="p">,</span> <span class="n">objectc__objecta__name</span><span class="o">=</span><span class="s">&#39;two&#39;</span><span class="p">)</span>
        <span class="n">Q2</span> <span class="o">=</span> <span class="n">Q</span><span class="p">(</span><span class="n">objecta__objectc__name</span><span class="o">=</span><span class="s">&#39;ein&#39;</span><span class="p">,</span> <span class="n">objectc__objecta__name</span><span class="o">=</span><span class="s">&#39;three&#39;</span><span class="p">,</span> <span class="n">objecta__objectb__name</span><span class="o">=</span><span class="s">&#39;trois&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_union</span><span class="p">(</span><span class="n">ObjectB</span><span class="p">,</span> <span class="n">Q1</span><span class="p">,</span> <span class="n">Q2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DefaultValuesInsertTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_no_extra_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>Ticket #17056 -- affects Oracle</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Creation of an instance of a model with only the PK field shouldn&#39;t error out after bulk insert refactoring (#17056)&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NullInExcludeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;i1&#39;</span><span class="p">)</span>
        <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_null_in_exclude_qs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">none_val</span> <span class="o">=</span> <span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interprets_empty_strings_as_nulls</span> <span class="k">else</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">[]),</span>
            <span class="p">[</span><span class="s">&#39;i1&#39;</span><span class="p">,</span> <span class="n">none_val</span><span class="p">],</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;i1&#39;</span><span class="p">]),</span>
            <span class="p">[</span><span class="n">none_val</span><span class="p">],</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;i3&#39;</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;i1&#39;</span><span class="p">,</span> <span class="n">none_val</span><span class="p">],</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>
        <span class="n">inner_qs</span> <span class="o">=</span> <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;i1&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="n">inner_qs</span><span class="p">),</span>
            <span class="p">[</span><span class="n">none_val</span><span class="p">],</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>Check that the inner queryset wasn't executed - it should be turned
into subquery above</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertIs</span><span class="p">(</span><span class="n">inner_qs</span><span class="o">.</span><span class="n">_result_cache</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="nd">@unittest.expectedFailure</span>
    <span class="k">def</span> <span class="nf">test_col_not_in_list_containing_null</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The following case is not handled properly because</span>
<span class="sd">        SQL&#39;s COL NOT IN (list containing null) handling is too weird to</span>
<span class="sd">        abstract away.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">NullableName</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">[</span><span class="bp">None</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;i1&#39;</span><span class="p">],</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">EmptyStringsAsNullTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that filtering on non-null character fields works as expected.</span>
<span class="sd">    The reason for these tests is that Oracle treats &#39;&#39; as NULL, and this</span>
<span class="sd">    can cause problems in query construction. Refs #17957.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nc</span> <span class="o">=</span> <span class="n">NamedCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_direct_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">NamedCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;nonexisting&#39;</span><span class="p">]),</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_joined_exclude</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">DumbCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">namedcategory__name__in</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;nonexisting&#39;</span><span class="p">]),</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nc</span><span class="o">.</span><span class="n">pk</span><span class="p">],</span> <span class="n">attrgetter</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">ProxyQueryCleanupTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_evaluated_proxy_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that generating the query string doesn&#39;t alter the query&#39;s state</span>
<span class="sd">        in irreversible ways. Refs #18248.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ProxyCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">ProxyCategory</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">WhereNodeTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">DummyNode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">as_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&#39;dummy&#39;</span><span class="p">,</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">test_empty_full_handling_conjunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">EverythingNode</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">NothingNode</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">EverythingNode</span><span class="p">(),</span> <span class="n">EverythingNode</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">EverythingNode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;dummy&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;(dummy AND dummy)&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;NOT (dummy AND dummy)&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">NothingNode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">()])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="k">def</span> <span class="nf">test_empty_full_handling_disjunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">EverythingNode</span><span class="p">()],</span> <span class="n">connector</span><span class="o">=</span><span class="s">&#39;OR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">NothingNode</span><span class="p">()],</span> <span class="n">connector</span><span class="o">=</span><span class="s">&#39;OR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">EverythingNode</span><span class="p">(),</span> <span class="n">EverythingNode</span><span class="p">()],</span> <span class="n">connector</span><span class="o">=</span><span class="s">&#39;OR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">EverythingNode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">()],</span> <span class="n">connector</span><span class="o">=</span><span class="s">&#39;OR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">()],</span> <span class="n">connector</span><span class="o">=</span><span class="s">&#39;OR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;(dummy OR dummy)&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;NOT (dummy OR dummy)&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">NothingNode</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">DummyNode</span><span class="p">()],</span> <span class="n">connector</span><span class="o">=</span><span class="s">&#39;OR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;dummy&#39;</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;NOT (dummy)&#39;</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="k">def</span> <span class="nf">test_empty_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">quote_name</span>
        <span class="n">empty_w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">()</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">empty_w</span><span class="p">,</span> <span class="n">empty_w</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">connector</span> <span class="o">=</span> <span class="s">&#39;OR&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span><span class="o">.</span><span class="n">negate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">),</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">WhereNode</span><span class="p">(</span><span class="n">children</span><span class="o">=</span><span class="p">[</span><span class="n">empty_w</span><span class="p">,</span> <span class="n">NothingNode</span><span class="p">()],</span> <span class="n">connector</span><span class="o">=</span><span class="s">&#39;OR&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">EmptyResultSet</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">as_sql</span><span class="p">,</span> <span class="n">qn</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
