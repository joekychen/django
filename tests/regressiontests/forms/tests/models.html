<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › forms › tests › models.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>models.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>-<em>- coding: utf-8 -</em>-</p></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">django.core.files.uploadedfile</span> <span class="kn">import</span> <span class="n">SimpleUploadedFile</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">Form</span><span class="p">,</span> <span class="n">ModelForm</span><span class="p">,</span> <span class="n">FileField</span><span class="p">,</span> <span class="n">ModelChoiceField</span>
<span class="kn">from</span> <span class="nn">django.forms.models</span> <span class="kn">import</span> <span class="n">ModelFormMetaclass</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">..models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">ChoiceOptionModel</span><span class="p">,</span> <span class="n">ChoiceFieldModel</span><span class="p">,</span> <span class="n">FileModel</span><span class="p">,</span> <span class="n">Group</span><span class="p">,</span>
    <span class="n">BoundaryModel</span><span class="p">,</span> <span class="n">Defaults</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ChoiceFieldForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">ChoiceFieldModel</span>


<span class="k">class</span> <span class="nc">FileForm</span><span class="p">(</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">file1</span> <span class="o">=</span> <span class="n">FileField</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TestTicket12510</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; It is not necessary to generate choices for ModelChoiceField (regression test for #12510). &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s">&#39;abc&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_choices_not_fetched_when_not_rendering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>only one query is required to pull the model from DB</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">ModelChoiceField</span><span class="p">(</span><span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-name&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">field</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ModelFormCallableModelDefault</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_no_empty_option</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;If a model&#39;s ForeignKey has blank=False and a default, no empty option is created (Refs #10792).&quot;</span>
        <span class="n">option</span> <span class="o">=</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ChoiceFieldForm</span><span class="p">()</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;choice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">choices</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">choices</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">option</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">option</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">test_callable_initial_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The initial value for a callable default returning a queryset is the pk (refs #13769)&quot;</span>
        <span class="n">obj1</span> <span class="o">=</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">obj2</span> <span class="o">=</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;option 2&#39;</span><span class="p">)</span>
        <span class="n">obj3</span> <span class="o">=</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;option 3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertHTMLEqual</span><span class="p">(</span><span class="n">ChoiceFieldForm</span><span class="p">()</span><span class="o">.</span><span class="n">as_p</span><span class="p">(),</span> <span class="s">&quot;&quot;&quot;&lt;p&gt;&lt;label for=&quot;id_choice&quot;&gt;Choice:&lt;/label&gt; &lt;select name=&quot;choice&quot; id=&quot;id_choice&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot; selected=&quot;selected&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-choice&quot; value=&quot;1&quot; id=&quot;initial-id_choice&quot; /&gt;&lt;/p&gt;</span>
<span class="s">&lt;p&gt;&lt;label for=&quot;id_choice_int&quot;&gt;Choice int:&lt;/label&gt; &lt;select name=&quot;choice_int&quot; id=&quot;id_choice_int&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot; selected=&quot;selected&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-choice_int&quot; value=&quot;1&quot; id=&quot;initial-id_choice_int&quot; /&gt;&lt;/p&gt;</span>
<span class="s">&lt;p&gt;&lt;label for=&quot;id_multi_choice&quot;&gt;Multi choice:&lt;/label&gt; &lt;select multiple=&quot;multiple&quot; name=&quot;multi_choice&quot; id=&quot;id_multi_choice&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot; selected=&quot;selected&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-multi_choice&quot; value=&quot;1&quot; id=&quot;initial-id_multi_choice_0&quot; /&gt; &lt;span class=&quot;helptext&quot;&gt; Hold down &quot;Control&quot;, or &quot;Command&quot; on a Mac, to select more than one.&lt;/span&gt;&lt;/p&gt;</span>
<span class="s">&lt;p&gt;&lt;label for=&quot;id_multi_choice_int&quot;&gt;Multi choice int:&lt;/label&gt; &lt;select multiple=&quot;multiple&quot; name=&quot;multi_choice_int&quot; id=&quot;id_multi_choice_int&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot; selected=&quot;selected&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-multi_choice_int&quot; value=&quot;1&quot; id=&quot;initial-id_multi_choice_int_0&quot; /&gt; &lt;span class=&quot;helptext&quot;&gt; Hold down &quot;Control&quot;, or &quot;Command&quot; on a Mac, to select more than one.&lt;/span&gt;&lt;/p&gt;&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_initial_instance_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Initial instances for model fields may also be instances (refs #7287)&quot;</span>
        <span class="n">obj1</span> <span class="o">=</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">obj2</span> <span class="o">=</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;option 2&#39;</span><span class="p">)</span>
        <span class="n">obj3</span> <span class="o">=</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;option 3&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertHTMLEqual</span><span class="p">(</span><span class="n">ChoiceFieldForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span>
                <span class="s">&#39;choice&#39;</span><span class="p">:</span> <span class="n">obj2</span><span class="p">,</span>
                <span class="s">&#39;choice_int&#39;</span><span class="p">:</span> <span class="n">obj2</span><span class="p">,</span>
                <span class="s">&#39;multi_choice&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">obj2</span><span class="p">,</span><span class="n">obj3</span><span class="p">],</span>
                <span class="s">&#39;multi_choice_int&#39;</span><span class="p">:</span> <span class="n">ChoiceOptionModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;default&quot;</span><span class="p">),</span>
            <span class="p">})</span><span class="o">.</span><span class="n">as_p</span><span class="p">(),</span> <span class="s">&quot;&quot;&quot;&lt;p&gt;&lt;label for=&quot;id_choice&quot;&gt;Choice:&lt;/label&gt; &lt;select name=&quot;choice&quot; id=&quot;id_choice&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot; selected=&quot;selected&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-choice&quot; value=&quot;2&quot; id=&quot;initial-id_choice&quot; /&gt;&lt;/p&gt;</span>
<span class="s">&lt;p&gt;&lt;label for=&quot;id_choice_int&quot;&gt;Choice int:&lt;/label&gt; &lt;select name=&quot;choice_int&quot; id=&quot;id_choice_int&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot; selected=&quot;selected&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-choice_int&quot; value=&quot;2&quot; id=&quot;initial-id_choice_int&quot; /&gt;&lt;/p&gt;</span>
<span class="s">&lt;p&gt;&lt;label for=&quot;id_multi_choice&quot;&gt;Multi choice:&lt;/label&gt; &lt;select multiple=&quot;multiple&quot; name=&quot;multi_choice&quot; id=&quot;id_multi_choice&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot; selected=&quot;selected&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot; selected=&quot;selected&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-multi_choice&quot; value=&quot;2&quot; id=&quot;initial-id_multi_choice_0&quot; /&gt;</span>
<span class="s">&lt;input type=&quot;hidden&quot; name=&quot;initial-multi_choice&quot; value=&quot;3&quot; id=&quot;initial-id_multi_choice_1&quot; /&gt; &lt;span class=&quot;helptext&quot;&gt; Hold down &quot;Control&quot;, or &quot;Command&quot; on a Mac, to select more than one.&lt;/span&gt;&lt;/p&gt;</span>
<span class="s">&lt;p&gt;&lt;label for=&quot;id_multi_choice_int&quot;&gt;Multi choice int:&lt;/label&gt; &lt;select multiple=&quot;multiple&quot; name=&quot;multi_choice_int&quot; id=&quot;id_multi_choice_int&quot;&gt;</span>
<span class="s">&lt;option value=&quot;1&quot;&gt;ChoiceOption 1&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;2&quot; selected=&quot;selected&quot;&gt;ChoiceOption 2&lt;/option&gt;</span>
<span class="s">&lt;option value=&quot;3&quot; selected=&quot;selected&quot;&gt;ChoiceOption 3&lt;/option&gt;</span>
<span class="s">&lt;/select&gt;&lt;input type=&quot;hidden&quot; name=&quot;initial-multi_choice_int&quot; value=&quot;2&quot; id=&quot;initial-id_multi_choice_int_0&quot; /&gt;</span>
<span class="s">&lt;input type=&quot;hidden&quot; name=&quot;initial-multi_choice_int&quot; value=&quot;3&quot; id=&quot;initial-id_multi_choice_int_1&quot; /&gt; &lt;span class=&quot;helptext&quot;&gt; Hold down &quot;Control&quot;, or &quot;Command&quot; on a Mac, to select more than one.&lt;/span&gt;&lt;/p&gt;&quot;&quot;&quot;</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">FormsModelTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_unicode_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>FileModel with unicode filename and data #########################</p></td><td class="code"><div class="highlight"><pre>        <span class="n">f</span> <span class="o">=</span> <span class="n">FileForm</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{},</span> <span class="n">files</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;file1&#39;</span><span class="p">:</span> <span class="n">SimpleUploadedFile</span><span class="p">(</span><span class="s">&#39;我隻氣墊船裝滿晒鱔.txt&#39;</span><span class="p">,</span> <span class="s">&#39;मेरी मँडराने वाली नाव सर्पमीनों से भरी ह&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))},</span> <span class="n">auto_id</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;file1&#39;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">FileModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;file1&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;tests/</span><span class="se">\u6211\u96bb\u6c23\u588a\u8239\u88dd\u6eff\u6652\u9c54</span><span class="s">.txt&#39;</span><span class="p">)</span>
        <span class="n">m</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_boundary_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Boundary conditions on a PostitiveIntegerField #########################</p></td><td class="code"><div class="highlight"><pre>        <span class="k">class</span> <span class="nc">BoundaryForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
            <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">BoundaryModel</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">BoundaryForm</span><span class="p">({</span><span class="s">&#39;positive_integer&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">BoundaryForm</span><span class="p">({</span><span class="s">&#39;positive_integer&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">BoundaryForm</span><span class="p">({</span><span class="s">&#39;positive_integer&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">100</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_formfield_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Formfield initial values ########
If the model has default values for some fields, they are used as the formfield
initial values.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">class</span> <span class="nc">DefaultsForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
            <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">Defaults</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">DefaultsForm</span><span class="p">()</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span><span class="p">,</span> <span class="s">&#39;class default value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">DefaultsForm</span><span class="p">()</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;def_date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1980</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">DefaultsForm</span><span class="p">()</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">initial</span><span class="p">,</span> <span class="mi">42</span><span class="p">)</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">DefaultsForm</span><span class="p">()[</span><span class="s">&#39;callable_default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_widget</span><span class="p">()</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">DefaultsForm</span><span class="p">()[</span><span class="s">&#39;callable_default&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_widget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>In a ModelForm that is passed an instance, the initial values come from the
instance's values, not the model's defaults.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">foo_instance</span> <span class="o">=</span> <span class="n">Defaults</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;instance value&#39;</span><span class="p">,</span> <span class="n">def_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1969</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">instance_form</span> <span class="o">=</span> <span class="n">DefaultsForm</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">foo_instance</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance_form</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="s">&#39;instance value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance_form</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s">&#39;def_date&#39;</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1969</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">instance_form</span><span class="o">.</span><span class="n">initial</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">],</span> <span class="mi">12</span><span class="p">)</span>

        <span class="kn">from</span> <span class="nn">django.forms</span> <span class="kn">import</span> <span class="n">CharField</span>

        <span class="k">class</span> <span class="nc">ExcludingForm</span><span class="p">(</span><span class="n">ModelForm</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

            <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="n">Defaults</span>
                <span class="n">exclude</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;callable_default&#39;</span><span class="p">]</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">ExcludingForm</span><span class="p">({</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="mi">99</span><span class="p">,</span> <span class="s">&#39;def_date&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">is_valid</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="s">&#39;Hello&#39;</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;class default value&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">99</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">def_date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">RelatedModelFormTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_invalid_loading_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test for issue 10405</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
            <span class="n">model</span><span class="o">=</span><span class="n">A</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">ModelFormMetaclass</span><span class="p">,</span> <span class="n">b</span><span class="s">&#39;Form&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">ModelForm</span><span class="p">,),</span> <span class="p">{</span><span class="s">&#39;Meta&#39;</span><span class="p">:</span> <span class="n">Meta</span><span class="p">})</span>

        <span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">test_valid_loading_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test for issue 10405</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
            <span class="n">model</span><span class="o">=</span><span class="n">A</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">issubclass</span><span class="p">(</span><span class="n">ModelFormMetaclass</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Form&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">ModelForm</span><span class="p">,),</span> <span class="p">{</span><span class="s">&#39;Meta&#39;</span><span class="p">:</span> <span class="n">Meta</span><span class="p">}),</span> <span class="n">ModelForm</span><span class="p">))</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
