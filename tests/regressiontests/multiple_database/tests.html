<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › multiple_database › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">django.core</span> <span class="kn">import</span> <span class="n">management</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connections</span><span class="p">,</span> <span class="n">router</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Book</span><span class="p">,</span> <span class="n">Person</span><span class="p">,</span> <span class="n">Pet</span><span class="p">,</span> <span class="n">Review</span><span class="p">,</span> <span class="n">UserProfile</span>


<span class="k">def</span> <span class="nf">copy_content_types_from_default_to_other</span><span class="p">():</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>On post_syncdb, content types are created in the 'default' database.
However, tests of generic foreign keys require them in 'other' too.
The problem is masked on backends that defer constraints checks: at the
end of each test, there's a rollback, and constraints are never checked.
It only appears on MySQL + InnoDB.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">ct</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QueryTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_db_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Check that querysets will use the default database by default&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_default_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Objects created on the default database don&#39;t leak onto other databases&quot;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Create a book on the default database using create()</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                            <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Create a book on the default database using a save</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="p">()</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Check that book exists on the default database, but not on other database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;&quot;Dive Into Python&quot; should exist on default database&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;&quot;Dive into Python&quot; should exist on default database&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_other_creation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Objects created on another database don&#39;t leak onto the default database&quot;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Create a book on the second database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                           <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Create a book on the default database using a save</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="p">()</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Check that book exists on the default database, but not on other database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;&quot;Dive Into Python&quot; should exist on other database&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;&quot;Dive into Python&quot; should exist on other database&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_basic_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Queries are constrained to a single database&quot;</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">dive</span> <span class="o">=</span>  <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title__icontains</span><span class="o">=</span><span class="s">&quot;dive&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">title__icontains</span><span class="o">=</span><span class="s">&quot;dive&quot;</span><span class="p">)</span>

        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title__iexact</span><span class="o">=</span><span class="s">&quot;dive INTO python&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">title__iexact</span><span class="o">=</span><span class="s">&quot;dive INTO python&quot;</span><span class="p">)</span>

        <span class="n">dive</span> <span class="o">=</span>  <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">published__year</span><span class="o">=</span><span class="mi">2009</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">published</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">published__year</span><span class="o">=</span><span class="mi">2009</span><span class="p">)</span>

        <span class="n">years</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;published&#39;</span><span class="p">,</span> <span class="s">&#39;year&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">years</span><span class="p">],</span> <span class="p">[</span><span class="mi">2009</span><span class="p">])</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;published&#39;</span><span class="p">,</span> <span class="s">&#39;year&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">years</span><span class="p">],</span> <span class="p">[])</span>

        <span class="n">months</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;published&#39;</span><span class="p">,</span> <span class="s">&#39;month&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">month</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">months</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">months</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;published&#39;</span><span class="p">,</span> <span class="s">&#39;month&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="n">o</span><span class="o">.</span><span class="n">month</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">months</span><span class="p">],</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_m2m_separation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;M2M fields are constrained to a single database&quot;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Save the author relations</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">marty</span><span class="p">]</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Inspect the m2m tables directly.
There should be 1 entry in each database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Check that queries work across m2m joins</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Marty Alchin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Pro Django&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Marty Alchin&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Reget the objects to clear caches</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Retrive related object by descriptor. Related objects should be database-baound</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_m2m_forward_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;M2M forward manipulations are all constrained to a single DB&quot;</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Save the author relations</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Add a second author</p></td><td class="code"><div class="highlight"><pre>        <span class="n">john</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;John Smith&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;John Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>


        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">john</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;John Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Remove the second author</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">john</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;John Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Clear all authors</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;John Smith&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Create an author through the m2m interface</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Jane Brown&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">authors__name</span><span class="o">=</span><span class="s">&#39;Jane Brown&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_m2m_reverse_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;M2M reverse manipulations are all constrained to a single DB&quot;</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Save the author relations</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Create a second book on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">grease</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Greasemonkey Hacks&quot;</span><span class="p">,</span>
                                                    <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2005</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Add a books to the m2m</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">grease</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Greasemonkey Hacks&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Remove a book from the m2m</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">grease</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Greasemonkey Hacks&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Clear the books associated with mark</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Greasemonkey Hacks&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Create a book through the m2m interface</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into HTML5&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__title</span><span class="o">=</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_m2m_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Operations that involve sharing M2M objects across databases raise an error&quot;</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Set a foreign key set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">book_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">pro</span><span class="p">,</span> <span class="n">dive</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Add to an m2m with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dive</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Set a m2m with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">book_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">pro</span><span class="p">,</span> <span class="n">dive</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Add to a reverse m2m with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">marty</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Set a reverse m2m with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span><span class="p">,</span> <span class="n">marty</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">test_m2m_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Cascaded deletions of m2m relations issue queries on the right database&quot;</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Check the initial state</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Delete the object on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>The person still exists ...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>... but the book has been deleted</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>... and the relationship object has also been deleted.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Now try deletion in the reverse direction. Set up the relation again</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>Check the initial state</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Delete the object on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>The person has been deleted ...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>... but the book still exists</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>... and the relationship object has been deleted.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_separation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;FK fields are constrained to a single database&quot;</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span>
        <span class="n">george</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;George Vilches&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span>
        <span class="n">chris</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Chris Mills&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Save the author's favourite books</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">george</span>
        <span class="n">pro</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">dive</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">chris</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;George Vilches&quot;</span><span class="p">)</span>

        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Chris Mills&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Check that queries work across foreign key joins</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Pro Django&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;George Vilches&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Pro Django&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Chris Mills&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Reget the objects to clear caches</p></td><td class="code"><div class="highlight"><pre>        <span class="n">chris</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Chris Mills&quot;</span><span class="p">)</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Retrive related object by descriptor. Related objects should be database-baound</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">chris</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_reverse_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;FK reverse manipulations are all constrained to a single DB&quot;</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                       <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span>
        <span class="n">chris</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Chris Mills&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Save the author relations</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">chris</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>Add a second book edited by chris</p></td><td class="code"><div class="highlight"><pre>        <span class="n">html5</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into HTML5&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>

        <span class="n">chris</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">html5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Chris Mills&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Chris Mills&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Remove the second editor</p></td><td class="code"><div class="highlight"><pre>        <span class="n">chris</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">html5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Chris Mills&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Clear all edited books</p></td><td class="code"><div class="highlight"><pre>        <span class="n">chris</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Create an author through the m2m interface</p></td><td class="code"><div class="highlight"><pre>        <span class="n">chris</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Water&#39;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into Water&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Chris Mills&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">edited__title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Operations that involve sharing FK objects across databases raise an error&quot;</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Set a foreign key with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">marty</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>Set a foreign key set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">edited</span> <span class="o">=</span> <span class="p">[</span><span class="n">pro</span><span class="p">,</span> <span class="n">dive</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-63"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-63">&#182;</a></div><p>Add to a foreign key set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dive</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-64"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-64">&#182;</a></div><p>BUT! if you assign a FK object when the base object hasn't
been saved yet, you implicitly assign the database for the
base object.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">chris</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Chris Mills&quot;</span><span class="p">)</span>
        <span class="n">html5</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into HTML5&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-65"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-65">&#182;</a></div><p>initially, no db assigned</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">chris</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html5</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-66"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-66">&#182;</a></div><p>old object comes from 'other', so the new object is set to use 'other'...</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">chris</span>
        <span class="n">html5</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">mark</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">chris</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html5</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-67"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-67">&#182;</a></div><p>... but it isn't saved yet</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-68"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-68">&#182;</a></div><p>When saved (no using required), new objects goes to 'other'</p></td><td class="code"><div class="highlight"><pre>        <span class="n">chris</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">html5</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Marty Alchin&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Chris Mills&#39;</span><span class="p">,</span> <span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Pro Django&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">,</span> <span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-69"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-69">&#182;</a></div><p>This also works if you assign the FK in the constructor</p></td><td class="code"><div class="highlight"><pre>        <span class="n">water</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Water&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">editor</span><span class="o">=</span><span class="n">mark</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">water</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-70"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-70">&#182;</a></div><p>... but it isn't saved yet</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Pro Django&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">,</span> <span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-71"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-71">&#182;</a></div><p>When saved, the new book goes to 'other'</p></td><td class="code"><div class="highlight"><pre>        <span class="n">water</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Pro Django&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Dive into HTML5&#39;</span><span class="p">,</span> <span class="s">&#39;Dive into Python&#39;</span><span class="p">,</span> <span class="s">&#39;Dive into Water&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Cascaded deletions of Foreign Key relations issue queries on the right database&quot;</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span>
        <span class="n">fido</span> <span class="o">=</span> <span class="n">Pet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Fido&quot;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">mark</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-72"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-72">&#182;</a></div><p>Check the initial state</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Pet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Pet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-73"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-73">&#182;</a></div><p>Delete the person object, which will cascade onto the pet</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Pet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-74"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-74">&#182;</a></div><p>Both the pet and the person have been deleted from the right database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Pet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_validation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;ForeignKey.validate() uses the correct database&quot;</span>
        <span class="n">mickey</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mickey&quot;</span><span class="p">)</span>
        <span class="n">pluto</span> <span class="o">=</span> <span class="n">Pet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Pluto&quot;</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">mickey</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">pluto</span><span class="o">.</span><span class="n">full_clean</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_o2o_separation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;OneToOne fields are constrained to a single database&quot;</span></pre></div></td></tr>


<tr id="section-75"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-75">&#182;</a></div><p>Create a user and profile on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;alice&#39;</span><span class="p">,</span> <span class="s">&#39;alice@example.com&#39;</span><span class="p">)</span>
        <span class="n">alice_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">alice</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s">&#39;chocolate&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-76"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-76">&#182;</a></div><p>Create a user and profile on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;bob@example.com&#39;</span><span class="p">)</span>
        <span class="n">bob_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">bob</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-77"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-77">&#182;</a></div><p>Retrieve related objects; queries should be database constrained</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&quot;alice&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">userprofile</span><span class="o">.</span><span class="n">flavor</span><span class="p">,</span> <span class="s">&quot;chocolate&quot;</span><span class="p">)</span>

        <span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&quot;bob&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">userprofile</span><span class="o">.</span><span class="n">flavor</span><span class="p">,</span> <span class="s">&quot;crunchy frog&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-78"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-78">&#182;</a></div><p>Check that queries work across joins</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">userprofile__flavor</span><span class="o">=</span><span class="s">&#39;chocolate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;alice&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">userprofile__flavor</span><span class="o">=</span><span class="s">&#39;chocolate&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">userprofile__flavor</span><span class="o">=</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">userprofile__flavor</span><span class="o">=</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;bob&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-79"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-79">&#182;</a></div><p>Reget the objects to clear caches</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flavor</span><span class="o">=</span><span class="s">&#39;chocolate&#39;</span><span class="p">)</span>
        <span class="n">bob_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flavor</span><span class="o">=</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-80"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-80">&#182;</a></div><p>Retrive related object by descriptor. Related objects should be database-baound</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice_profile</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;alice&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob_profile</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;bob&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_o2o_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Operations that involve sharing FK objects across databases raise an error&quot;</span></pre></div></td></tr>


<tr id="section-81"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-81">&#182;</a></div><p>Create a user and profile on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;alice&#39;</span><span class="p">,</span> <span class="s">&#39;alice@example.com&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-82"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-82">&#182;</a></div><p>Create a user and profile on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;bob@example.com&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-83"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-83">&#182;</a></div><p>Set a one-to-one relation with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">alice</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s">&#39;chocolate&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bob</span><span class="o">.</span><span class="n">userprofile</span> <span class="o">=</span> <span class="n">alice_profile</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-84"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-84">&#182;</a></div><p>BUT! if you assign a FK object when the base object hasn't
been saved yet, you implicitly assign the database for the
base object.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bob_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">bob</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">)</span>

        <span class="n">new_bob_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">(</span><span class="n">flavor</span><span class="o">=</span><span class="s">&quot;spring surprise&quot;</span><span class="p">)</span>

        <span class="n">charlie</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;charlie&#39;</span><span class="p">,</span><span class="n">email</span><span class="o">=</span><span class="s">&#39;charlie@example.com&#39;</span><span class="p">)</span>
        <span class="n">charlie</span><span class="o">.</span><span class="n">set_unusable_password</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-85"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-85">&#182;</a></div><p>initially, no db assigned</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_bob_profile</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charlie</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-86"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-86">&#182;</a></div><p>old object comes from 'other', so the new object is set to use 'other'...</p></td><td class="code"><div class="highlight"><pre>        <span class="n">new_bob_profile</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">bob</span>
        <span class="n">charlie</span><span class="o">.</span><span class="n">userprofile</span> <span class="o">=</span> <span class="n">bob_profile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">new_bob_profile</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">charlie</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-87"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-87">&#182;</a></div><p>... but it isn't saved yet</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;bob&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;flavor&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-88"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-88">&#182;</a></div><p>When saved (no using required), new objects goes to 'other'</p></td><td class="code"><div class="highlight"><pre>        <span class="n">charlie</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">bob_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">new_bob_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;alice&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;username&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;charlie&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;flavor&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;chocolate&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;flavor&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">,</span> <span class="s">&#39;spring surprise&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-89"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-89">&#182;</a></div><p>This also works if you assign the O2O relation in the constructor</p></td><td class="code"><div class="highlight"><pre>        <span class="n">denise</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;denise&#39;</span><span class="p">,</span><span class="s">&#39;denise@example.com&#39;</span><span class="p">)</span>
        <span class="n">denise_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">(</span><span class="n">flavor</span><span class="o">=</span><span class="s">&quot;tofu&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">denise</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">denise_profile</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-90"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-90">&#182;</a></div><p>... but it isn't saved yet</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;flavor&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;chocolate&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;flavor&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">,</span> <span class="s">&#39;spring surprise&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-91"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-91">&#182;</a></div><p>When saved, the new profile goes to 'other'</p></td><td class="code"><div class="highlight"><pre>        <span class="n">denise_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;flavor&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;chocolate&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;flavor&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                           <span class="p">[</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">,</span> <span class="s">&#39;spring surprise&#39;</span><span class="p">,</span> <span class="s">&#39;tofu&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_generic_key_separation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Generic fields are constrained to a single database&quot;</span>
        <span class="n">copy_content_types_from_default_to_other</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-92"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-92">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">review1</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Monthly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">pro</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-93"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-93">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">review2</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Weekly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">dive</span><span class="p">)</span>

        <span class="n">review1</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Monthly&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review1</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>

        <span class="n">review2</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Weekly&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review2</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-94"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-94">&#182;</a></div><p>Reget the objects to clear caches</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-95"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-95">&#182;</a></div><p>Retrive related object by descriptor. Related objects should be database-bound</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Weekly&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_generic_key_reverse_operations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Generic reverse manipulations are all constrained to a single DB&quot;</span>
        <span class="n">copy_content_types_from_default_to_other</span><span class="p">()</span>

        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Temp&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">review1</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Weekly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">dive</span><span class="p">)</span>
        <span class="n">review2</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Monthly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">temp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Weekly&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-96"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-96">&#182;</a></div><p>Add a second review</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">review2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Monthly&#39;</span><span class="p">,</span> <span class="s">&#39;Python Weekly&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-97"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-97">&#182;</a></div><p>Remove the second author</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">review1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Monthly&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-98"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-98">&#182;</a></div><p>Clear all reviews</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span></pre></div></td></tr>


<tr id="section-99"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-99">&#182;</a></div><p>Create an author through the generic interface</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&#39;Python Daily&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Daily&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_generic_key_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Operations that involve sharing generic key objects across databases raise an error&quot;</span>
        <span class="n">copy_content_types_from_default_to_other</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-100"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-100">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">review1</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Monthly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">pro</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-101"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-101">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">review2</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Weekly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">dive</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-102"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-102">&#182;</a></div><p>Set a foreign key with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">review1</span><span class="o">.</span><span class="n">content_object</span> <span class="o">=</span> <span class="n">dive</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-103"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-103">&#182;</a></div><p>Add to a foreign key set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">review1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to assign across databases&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-104"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-104">&#182;</a></div><p>BUT! if you assign a FK object when the base object hasn't
been saved yet, you implicitly assign the database for the
base object.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">review3</span> <span class="o">=</span> <span class="n">Review</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Daily&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-105"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-105">&#182;</a></div><p>initially, no db assigned</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review3</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-106"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-106">&#182;</a></div><p>Dive comes from 'other', so review3 is set to use 'other'...</p></td><td class="code"><div class="highlight"><pre>        <span class="n">review3</span><span class="o">.</span><span class="n">content_object</span> <span class="o">=</span> <span class="n">dive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review3</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-107"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-107">&#182;</a></div><p>... but it isn't saved yet</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">pro</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Monthly&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Weekly&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-108"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-108">&#182;</a></div><p>When saved, John goes to 'other'</p></td><td class="code"><div class="highlight"><pre>        <span class="n">review3</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">pro</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Monthly&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">object_id</span><span class="o">=</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;source&#39;</span><span class="p">,</span><span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
                          <span class="p">[</span><span class="s">&#39;Python Daily&#39;</span><span class="p">,</span> <span class="s">&#39;Python Weekly&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_generic_key_deletion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Cascaded deletions of Generic Key relations issue queries on the right database&quot;</span>
        <span class="n">copy_content_types_from_default_to_other</span><span class="p">()</span>

        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">review</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Weekly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">dive</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-109"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-109">&#182;</a></div><p>Check the initial state</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-110"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-110">&#182;</a></div><p>Delete the Book object, which will cascade onto the pet</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-111"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-111">&#182;</a></div><p>Both the pet and the person have been deleted from the right database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_ordering</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;get_next_by_XXX commands stick to a single database&quot;</span>
        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">learn</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Learning Python&quot;</span><span class="p">,</span>
                                                   <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">get_next_by_published</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">get_previous_by_published</span><span class="p">()</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;Learning Python&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;test the raw() method across databases&quot;</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
            <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&quot;other&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;SELECT id FROM multiple_database_book&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> <span class="p">[</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">raw</span><span class="p">(</span><span class="s">&#39;SELECT id FROM multiple_database_book&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">o</span><span class="p">:</span> <span class="n">o</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> <span class="p">[</span><span class="n">dive</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Database assignment is retained if an object is retrieved with select_related()&quot;</span></pre></div></td></tr>


<tr id="section-112"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-112">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                                  <span class="n">editor</span><span class="o">=</span><span class="n">mark</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-113"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-113">&#182;</a></div><p>Retrieve the Person using select_related()</p></td><td class="code"><div class="highlight"><pre>        <span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;editor&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-114"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-114">&#182;</a></div><p>The editor instance should have a db state</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">book</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_subquery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure as_sql works with subqueries and master/slave.&quot;&quot;&quot;</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;fff&#39;</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">editor__in</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-115"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-115">&#182;</a></div><p>When you call <strong>str</strong> on the query object, it doesn't know about using
so it falls back to the default. If the subquery explicitly uses a
different database, an error should be raised.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-116"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-116">&#182;</a></div><p>Evaluating the query shouldn't work, either</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Iterating over query should raise ValueError&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">test_related_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Related managers return managers, not querysets&quot;</span>
        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-117"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-117">&#182;</a></div><p>extra_arg is removed by the BookManager's implementation of
create(); but the BookManager's implementation won't get called
unless edited returns a Manager, not a queryset</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                             <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                             <span class="n">extra_arg</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">mark</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                    <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                    <span class="n">extra_arg</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">mark</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Water&quot;</span><span class="p">,</span>
                           <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                           <span class="n">extra_arg</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">mark</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Water&quot;</span><span class="p">,</span>
                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                  <span class="n">extra_arg</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-118"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-118">&#182;</a></div><p>A test router. The behavior is vaguely master/slave, but the
databases aren't assumed to propagate changes.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">or</span> <span class="s">&#39;other&#39;</span>
        <span class="k">return</span> <span class="s">&#39;other&#39;</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DEFAULT_DB_ALIAS</span>

    <span class="k">def</span> <span class="nf">allow_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj1</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj2</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">allow_syncdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">True</span>

<span class="k">class</span> <span class="nc">AuthRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A router to control all database operations on models in</span>
<span class="sd">    the contrib.auth application&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="s">&quot;Point all read operations on auth models to &#39;default&#39;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-119"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-119">&#182;</a></div><p>We use default here to ensure we can tell the difference
between a read request and a write request for Auth objects</p></td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="s">&#39;default&#39;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="s">&quot;Point all operations on auth models to &#39;other&#39;&quot;</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;other&#39;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">allow_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="s">&quot;Allow any relation if a model in Auth is involved&quot;</span>
        <span class="k">if</span> <span class="n">obj1</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span> <span class="ow">or</span> <span class="n">obj2</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">allow_syncdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="s">&quot;Make sure the auth app only appears on the &#39;other&#39; db&quot;</span>
        <span class="k">if</span> <span class="n">db</span> <span class="o">==</span> <span class="s">&#39;other&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span>
        <span class="k">elif</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span> <span class="o">==</span> <span class="s">&#39;auth&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">WriteRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-120"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-120">&#182;</a></div><p>A router that only expresses an opinion on writes</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;writer&#39;</span>

<span class="k">class</span> <span class="nc">RouterTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-121"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-121">&#182;</a></div><p>Make the 'other' database appear to be a slave of the 'default'</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routers</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">TestRouter</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-122"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-122">&#182;</a></div><p>Restore the 'other' database as an independent database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span>

    <span class="k">def</span> <span class="nf">test_db_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Check that querysets obey the router for db suggestions&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_syncdb_selection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Synchronization behavior is predictable&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-123"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-123">&#182;</a></div><p>Add the auth router to the chain.
TestRouter is a universal synchronizer, so it should have no effect.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">TestRouter</span><span class="p">(),</span> <span class="n">AuthRouter</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-124"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-124">&#182;</a></div><p>Now check what happens if the router order is the other way around</p></td><td class="code"><div class="highlight"><pre>        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AuthRouter</span><span class="p">(),</span> <span class="n">TestRouter</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_partial_router</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;A router can choose to implement a subset of methods&quot;</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-125"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-125">&#182;</a></div><p>First check the baseline behavior.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="n">User</span><span class="p">),</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="n">Book</span><span class="p">),</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="n">User</span><span class="p">),</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="n">Book</span><span class="p">),</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">dive</span><span class="p">,</span> <span class="n">dive</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span>

        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">WriteRouter</span><span class="p">(),</span> <span class="n">AuthRouter</span><span class="p">(),</span> <span class="n">TestRouter</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="n">User</span><span class="p">),</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_read</span><span class="p">(</span><span class="n">Book</span><span class="p">),</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="n">User</span><span class="p">),</span> <span class="s">&#39;writer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">db_for_write</span><span class="p">(</span><span class="n">Book</span><span class="p">),</span> <span class="s">&#39;writer&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_relation</span><span class="p">(</span><span class="n">dive</span><span class="p">,</span> <span class="n">dive</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">User</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">Book</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">test_database_routing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span>
        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                                   <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
                                                   <span class="n">editor</span><span class="o">=</span><span class="n">marty</span><span class="p">)</span>
        <span class="n">pro</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">marty</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-126"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-126">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-127"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-127">&#182;</a></div><p>An update query will be routed to the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Pro Django&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-128"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-128">&#182;</a></div><p>By default, the get query will be directed to 'other'</p></td><td class="code"><div class="highlight"><pre>            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Pro Django&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Shouldn&#39;t be able to find the book&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-129"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-129">&#182;</a></div><p>But the same query issued explicitly at a database will work.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Pro Django&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-130"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-130">&#182;</a></div><p>Check that the update worked.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-131"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-131">&#182;</a></div><p>An update query with an explicit using clause will be routed
to the requested database.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pages</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pages</span><span class="p">,</span> <span class="mi">300</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-132"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-132">&#182;</a></div><p>Related object queries stick to the same database
as the original object, regardless of the router</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span> <span class="p">[</span><span class="s">&#39;Marty Alchin&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">editor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;Marty Alchin&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-133"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-133">&#182;</a></div><p>get<em>or</em>create is a special case. The get needs to be targeted at
the write database in order to avoid potential transaction
consistency problems</p></td><td class="code"><div class="highlight"><pre>        <span class="n">book</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">created</span><span class="p">)</span>

        <span class="n">book</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive Into Python&quot;</span><span class="p">,</span>
                                                   <span class="n">defaults</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;published&#39;</span><span class="p">:</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">created</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-134"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-134">&#182;</a></div><p>Check the head count of objects</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-135"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-135">&#182;</a></div><p>If a database isn't specified, the read database is used</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-136"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-136">&#182;</a></div><p>A delete query will also be routed to the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pages__gt</span><span class="o">=</span><span class="mi">150</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-137"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-137">&#182;</a></div><p>The default database has lost the book.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Foreign keys can cross databases if they two databases have a common source&quot;</span></pre></div></td></tr>


<tr id="section-138"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-138">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                                   <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-139"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-139">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-140"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-140">&#182;</a></div><p>Set a foreign key with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">marty</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-141"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-141">&#182;</a></div><p>Database assignments of original objects haven't changed...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-142"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-142">&#182;</a></div><p>... but they will when the affected object is saved.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-143"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-143">&#182;</a></div><p>...and the source database now has a copy of any object saved</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Source database should have a copy of saved object&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-144"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-144">&#182;</a></div><p>This isn't a real master-slave database, so restore the original from other</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-145"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-145">&#182;</a></div><p>Set a foreign key set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">edited</span> <span class="o">=</span> <span class="p">[</span><span class="n">pro</span><span class="p">,</span> <span class="n">dive</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-146"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-146">&#182;</a></div><p>Assignment implies a save, so database assignments of original objects have changed...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-147"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-147">&#182;</a></div><p>...and the source database now has a copy of any object saved</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Source database should have a copy of saved object&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-148"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-148">&#182;</a></div><p>This isn't a real master-slave database, so restore the original from other</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-149"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-149">&#182;</a></div><p>Add to a foreign key set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dive</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-150"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-150">&#182;</a></div><p>Add implies a save, so database assignments of original objects have changed...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-151"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-151">&#182;</a></div><p>...and the source database now has a copy of any object saved</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Source database should have a copy of saved object&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-152"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-152">&#182;</a></div><p>This isn't a real master-slave database, so restore the original from other</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-153"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-153">&#182;</a></div><p>If you assign a FK object when the base object hasn't
been saved yet, you implicitly assign the database for the
base object.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">chris</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Chris Mills&quot;</span><span class="p">)</span>
        <span class="n">html5</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into HTML5&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-154"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-154">&#182;</a></div><p>initially, no db assigned</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">chris</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html5</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-155"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-155">&#182;</a></div><p>old object comes from 'other', so the new object is set to use the
source of 'other'...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">chris</span>
        <span class="n">html5</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">mark</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">chris</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">html5</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-156"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-156">&#182;</a></div><p>This also works if you assign the FK in the constructor</p></td><td class="code"><div class="highlight"><pre>        <span class="n">water</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Water&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2001</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">editor</span><span class="o">=</span><span class="n">mark</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">water</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-157"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-157">&#182;</a></div><p>For the remainder of this test, create a copy of 'mark' in the
'default' database to prevent integrity errors on backends that
don't defer constraints checks until the end of the transaction</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-158"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-158">&#182;</a></div><p>This moved 'mark' in the 'default' database, move it back in 'other'</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-159"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-159">&#182;</a></div><p>If you create an object through a FK relation, it will be
written to the write database, even if the original object
was on the read database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">cheesecake</span> <span class="o">=</span> <span class="n">mark</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Cheesecake&#39;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cheesecake</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-160"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-160">&#182;</a></div><p>Same goes for get<em>or</em>create, regardless of whether getting or creating</p></td><td class="code"><div class="highlight"><pre>        <span class="n">cheesecake</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">mark</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Cheesecake&#39;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">cheesecake</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">puddles</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">mark</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Puddles&#39;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">puddles</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_m2m_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;M2M relations can cross databases if the database share a source&quot;</span></pre></div></td></tr>


<tr id="section-161"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-161">&#182;</a></div><p>Create books and authors on the inverse to the usual database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                                 <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span>

        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                    <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-162"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-162">&#182;</a></div><p>Now save back onto the usual database.
This simulates master/slave - the objects exist on both database,
but the _state.db is as it is for all other tests.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">marty</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">mark</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-163"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-163">&#182;</a></div><p>Check that we have 2 of both types of object on both databases</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-164"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-164">&#182;</a></div><p>Set a m2m set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">book_set</span> <span class="o">=</span> <span class="p">[</span><span class="n">pro</span><span class="p">,</span> <span class="n">dive</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-165"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-165">&#182;</a></div><p>Database assignments don't change</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-166"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-166">&#182;</a></div><p>All m2m relations should be saved on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-167"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-167">&#182;</a></div><p>Reset relations</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-168"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-168">&#182;</a></div><p>Add to an m2m with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">marty</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dive</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-169"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-169">&#182;</a></div><p>Database assignments don't change</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-170"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-170">&#182;</a></div><p>All m2m relations should be saved on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-171"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-171">&#182;</a></div><p>Reset relations</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-172"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-172">&#182;</a></div><p>Set a reverse m2m with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">mark</span><span class="p">,</span> <span class="n">marty</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-173"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-173">&#182;</a></div><p>Database assignments don't change</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-174"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-174">&#182;</a></div><p>All m2m relations should be saved on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-175"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-175">&#182;</a></div><p>Reset relations</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-176"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-176">&#182;</a></div><p>Add to a reverse m2m with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">marty</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-177"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-177">&#182;</a></div><p>Database assignments don't change</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mark</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-178"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-178">&#182;</a></div><p>All m2m relations should be saved on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-179"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-179">&#182;</a></div><p>If you create an object through a M2M relation, it will be
written to the write database, even if the original object
was on the read database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice</span> <span class="o">=</span> <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Alice&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-180"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-180">&#182;</a></div><p>Same goes for get<em>or</em>create, regardless of whether getting or creating</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Alice&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

        <span class="n">bob</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">dive</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Bob&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_o2o_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Operations that involve sharing FK objects across databases raise an error&quot;</span></pre></div></td></tr>


<tr id="section-181"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-181">&#182;</a></div><p>Create a user and profile on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;alice&#39;</span><span class="p">,</span> <span class="s">&#39;alice@example.com&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-182"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-182">&#182;</a></div><p>Create a user and profile on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;bob@example.com&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-183"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-183">&#182;</a></div><p>Set a one-to-one relation with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">alice</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s">&#39;chocolate&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bob</span><span class="o">.</span><span class="n">userprofile</span> <span class="o">=</span> <span class="n">alice_profile</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-184"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-184">&#182;</a></div><p>Database assignments of original objects haven't changed...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice_profile</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-185"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-185">&#182;</a></div><p>... but they will when the affected object is saved.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bob</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_generic_key_cross_database_protection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Generic Key operations can span databases if they share a source&quot;</span>
        <span class="n">copy_content_types_from_default_to_other</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-186"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-186">&#182;</a></div><p>Create a book and author on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">review1</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Monthly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">pro</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-187"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-187">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">review2</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Weekly&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">dive</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-188"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-188">&#182;</a></div><p>Set a generic foreign key with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">review1</span><span class="o">.</span><span class="n">content_object</span> <span class="o">=</span> <span class="n">dive</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-189"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-189">&#182;</a></div><p>Database assignments of original objects haven't changed...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review1</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review2</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-190"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-190">&#182;</a></div><p>... but they will when the affected object is saved.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review1</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-191"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-191">&#182;</a></div><p>...and the source database now has a copy of any object saved</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Source database should have a copy of saved object&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-192"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-192">&#182;</a></div><p>This isn't a real master-slave database, so restore the original from other</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-193"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-193">&#182;</a></div><p>Add to a generic foreign key set with an object from a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">review1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&quot;Assignment across master/slave databases with a common source should be ok&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-194"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-194">&#182;</a></div><p>Database assignments of original objects haven't changed...</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review1</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review2</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-195"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-195">&#182;</a></div><p>... but they will when the affected object is saved.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">dive</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-196"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-196">&#182;</a></div><p>...and the source database now has a copy of any object saved</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;Source database should have a copy of saved object&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-197"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-197">&#182;</a></div><p>BUT! if you assign a FK object when the base object hasn't
been saved yet, you implicitly assign the database for the
base object.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">review3</span> <span class="o">=</span> <span class="n">Review</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Daily&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-198"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-198">&#182;</a></div><p>initially, no db assigned</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review3</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-199"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-199">&#182;</a></div><p>Dive comes from 'other', so review3 is set to use the source of 'other'...</p></td><td class="code"><div class="highlight"><pre>        <span class="n">review3</span><span class="o">.</span><span class="n">content_object</span> <span class="o">=</span> <span class="n">dive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">review3</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-200"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-200">&#182;</a></div><p>If you create an object through a M2M relation, it will be
written to the write database, even if the original object
was on the read database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">)</span>
        <span class="n">nyt</span> <span class="o">=</span> <span class="n">dive</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;New York Times&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">dive</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nyt</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_m2m_managers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;M2M relations are represented by managers, and can be controlled like managers&quot;</span>
        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                                 <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span>
        <span class="n">pro_authors</span> <span class="o">=</span> <span class="n">pro</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">marty</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_managers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;FK reverse relations are represented by managers, and can be controlled like managers&quot;</span>
        <span class="n">marty</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span>
        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                                 <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
                                                 <span class="n">editor</span><span class="o">=</span><span class="n">marty</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">marty</span><span class="o">.</span><span class="n">edited</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_generic_key_managers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Generic key relations are represented by managers, and can be controlled like managers&quot;</span>
        <span class="n">copy_content_types_from_default_to_other</span><span class="p">()</span>

        <span class="n">pro</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                                 <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">review1</span> <span class="o">=</span> <span class="n">Review</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="s">&quot;Python Monthly&quot;</span><span class="p">,</span>
                                                       <span class="n">content_object</span><span class="o">=</span><span class="n">pro</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pro</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_subquery</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure as_sql works with subqueries and master/slave.&quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-201"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-201">&#182;</a></div><p>Create a book and author on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mark</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mark Pilgrim&quot;</span><span class="p">)</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">,</span>
                                                  <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
                                                  <span class="n">editor</span><span class="o">=</span><span class="n">mark</span><span class="p">)</span>

        <span class="n">sub</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Mark Pilgrim&#39;</span><span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">editor__in</span><span class="o">=</span><span class="n">sub</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-202"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-202">&#182;</a></div><p>When you call <strong>str</strong> on the query object, it doesn't know about using
so it falls back to the default. Don't let routing instructions
force the subquery to an incompatible database.</p></td><td class="code"><div class="highlight"><pre>        <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-203"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-203">&#182;</a></div><p>If you evaluate the query, it should work, running on 'other'</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span> <span class="p">[</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">AuthTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-204"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-204">&#182;</a></div><p>Make the 'other' database appear to be a slave of the 'default'</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routers</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AuthRouter</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-205"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-205">&#182;</a></div><p>Restore the 'other' database as an independent database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span>

    <span class="k">def</span> <span class="nf">test_auth_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;The methods on the auth manager obey database hints&quot;</span></pre></div></td></tr>


<tr id="section-206"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-206">&#182;</a></div><p>Create one user using default allocation policy</p></td><td class="code"><div class="highlight"><pre>        <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;alice&#39;</span><span class="p">,</span> <span class="s">&#39;alice@example.com&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-207"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-207">&#182;</a></div><p>Create another user, explicitly specifying the database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;bob@example.com&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-208"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-208">&#182;</a></div><p>The second user only exists on the other database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;alice&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;alice&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;other&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&#39;alice&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-209"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-209">&#182;</a></div><p>The second user only exists on the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;bob&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;bob&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="s">&#39;default&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&#39;bob&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-210"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-210">&#182;</a></div><p>That is... there is one user on each database</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_dumpdata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Check that dumpdata honors allow_syncdb restrictions on the router&quot;</span>
        <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;alice&#39;</span><span class="p">,</span> <span class="s">&#39;alice@example.com&#39;</span><span class="p">)</span>
        <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;bob@example.com&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-211"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-211">&#182;</a></div><p>Check that dumping the default database doesn't try to include auth
because allow_syncdb prohibits auth on default</p></td><td class="code"><div class="highlight"><pre>        <span class="n">new_io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="s">&#39;dumpdata&#39;</span><span class="p">,</span> <span class="s">&#39;auth&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;json&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">new_io</span><span class="p">)</span>
        <span class="n">command_output</span> <span class="o">=</span> <span class="n">new_io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">command_output</span><span class="p">,</span> <span class="s">&#39;[]&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-212"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-212">&#182;</a></div><p>Check that dumping the other database does include auth</p></td><td class="code"><div class="highlight"><pre>        <span class="n">new_io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="s">&#39;dumpdata&#39;</span><span class="p">,</span> <span class="s">&#39;auth&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s">&#39;json&#39;</span><span class="p">,</span> <span class="n">database</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">new_io</span><span class="p">)</span>
        <span class="n">command_output</span> <span class="o">=</span> <span class="n">new_io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;&quot;email&quot;: &quot;alice@example.com&quot;,&#39;</span> <span class="ow">in</span> <span class="n">command_output</span><span class="p">)</span>

<span class="n">_missing</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
<span class="k">class</span> <span class="nc">UserProfileTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_auth_profile_module</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;AUTH_PROFILE_MODULE&#39;</span><span class="p">,</span> <span class="n">_missing</span><span class="p">)</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_PROFILE_MODULE</span> <span class="o">=</span> <span class="s">&#39;multiple_database.UserProfile&#39;</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_auth_profile_module</span> <span class="ow">is</span> <span class="n">_missing</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_PROFILE_MODULE</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_PROFILE_MODULE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_auth_profile_module</span>

    <span class="k">def</span> <span class="nf">test_user_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">alice</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;alice&#39;</span><span class="p">,</span> <span class="s">&#39;alice@example.com&#39;</span><span class="p">)</span>
        <span class="n">bob</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">db_manager</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="s">&#39;bob&#39;</span><span class="p">,</span> <span class="s">&#39;bob@example.com&#39;</span><span class="p">)</span>

        <span class="n">alice_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">alice</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s">&#39;chocolate&#39;</span><span class="p">)</span>
        <span class="n">alice_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">bob_profile</span> <span class="o">=</span> <span class="n">UserProfile</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">bob</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s">&#39;crunchy frog&#39;</span><span class="p">)</span>
        <span class="n">bob_profile</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">alice</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">flavor</span><span class="p">,</span> <span class="s">&#39;chocolate&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">bob</span><span class="o">.</span><span class="n">get_profile</span><span class="p">()</span><span class="o">.</span><span class="n">flavor</span><span class="p">,</span> <span class="s">&#39;crunchy frog&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AntiPetRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-213"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-213">&#182;</a></div><p>A router that only expresses an opinion on syncdb,
passing pets to the 'other' database</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">allow_syncdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="s">&quot;Make sure the auth app only appears on the &#39;other&#39; db&quot;</span>
        <span class="k">if</span> <span class="n">db</span> <span class="o">==</span> <span class="s">&#39;other&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span> <span class="o">==</span> <span class="s">&#39;Pet&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span> <span class="o">!=</span> <span class="s">&#39;Pet&#39;</span>

<span class="k">class</span> <span class="nc">FixtureTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">fixtures</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;multidb-common&#39;</span><span class="p">,</span> <span class="s">&#39;multidb&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-214"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-214">&#182;</a></div><p>Install the anti-pet router</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routers</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AntiPetRouter</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-215"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-215">&#182;</a></div><p>Restore the 'other' database as an independent database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span>

    <span class="k">def</span> <span class="nf">test_fixture_loading</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Multi-db fixtures are loaded correctly&quot;</span></pre></div></td></tr>


<tr id="section-216"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-216">&#182;</a></div><p>Check that "Pro Django" exists on the default database, but not on other database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;&quot;Pro Django&quot; should exist on default database&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-217"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-217">&#182;</a></div><p>Check that "Dive into Python" exists on the default database, but not on other database</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;&quot;Dive into Python&quot; should exist on other database&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-218"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-218">&#182;</a></div><p>Check that "Definitive Guide" exists on the both databases</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;The Definitive Guide to Django&quot;</span><span class="p">)</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;The Definitive Guide to Django&quot;</span><span class="p">)</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;The Definitive Guide to Django&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">Book</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;&quot;The Definitive Guide to Django&quot; should exist on both databases&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_pseudo_empty_fixtures</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;A fixture can contain entries, but lead to nothing in the database; this shouldn&#39;t raise an error (ref #14068)&quot;</span>
        <span class="n">new_io</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">management</span><span class="o">.</span><span class="n">call_command</span><span class="p">(</span><span class="s">&#39;loaddata&#39;</span><span class="p">,</span> <span class="s">&#39;pets&#39;</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">new_io</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">new_io</span><span class="p">)</span>
        <span class="n">command_output</span> <span class="o">=</span> <span class="n">new_io</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-219"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-219">&#182;</a></div><p>No objects will actually be loaded</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">command_output</span><span class="p">,</span> <span class="s">&quot;Installed 0 object(s) (of 2) from 1 fixture(s)&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PickleQuerySetTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_pickling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">db</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Dive into Python&#39;</span><span class="p">,</span> <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DatabaseReceiver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Used in the tests for the database argument in signals (#13552)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_database</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;using&#39;</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">WriteToOtherRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A router that sends all writes to the other database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;other&quot;</span>

<span class="k">class</span> <span class="nc">SignalTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routers</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span>

    <span class="k">def</span> <span class="nf">_write_to_other</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Sends all writes to &#39;other&#39;.&quot;</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">WriteToOtherRouter</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">_write_to_default</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Sends all writes to the default DB&quot;</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span>

    <span class="k">def</span> <span class="nf">test_database_arg_save_and_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests that the pre/post_save signal contains the correct database.</span>
<span class="sd">        (#13552)</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-220"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-220">&#182;</a></div><p>Make some signal receivers</p></td><td class="code"><div class="highlight"><pre>        <span class="n">pre_save_receiver</span> <span class="o">=</span> <span class="n">DatabaseReceiver</span><span class="p">()</span>
        <span class="n">post_save_receiver</span> <span class="o">=</span> <span class="n">DatabaseReceiver</span><span class="p">()</span>
        <span class="n">pre_delete_receiver</span> <span class="o">=</span> <span class="n">DatabaseReceiver</span><span class="p">()</span>
        <span class="n">post_delete_receiver</span> <span class="o">=</span> <span class="n">DatabaseReceiver</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-221"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-221">&#182;</a></div><p>Make model and connect receivers</p></td><td class="code"><div class="highlight"><pre>        <span class="n">signals</span><span class="o">.</span><span class="n">pre_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">Person</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="n">pre_save_receiver</span><span class="p">)</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">post_save</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">Person</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="n">post_save_receiver</span><span class="p">)</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">pre_delete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">Person</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="n">pre_delete_receiver</span><span class="p">)</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">post_delete</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="n">Person</span><span class="p">,</span> <span class="n">receiver</span><span class="o">=</span><span class="n">post_delete_receiver</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Darth Vader&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-222"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-222">&#182;</a></div><p>Save and test receivers got calls</p></td><td class="code"><div class="highlight"><pre>        <span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pre_save_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">post_save_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-223"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-223">&#182;</a></div><p>Delete, and test</p></td><td class="code"><div class="highlight"><pre>        <span class="n">p</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pre_delete_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">post_delete_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-224"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-224">&#182;</a></div><p>Save again to a different database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&quot;other&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pre_save_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">post_save_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-225"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-225">&#182;</a></div><p>Delete, and test</p></td><td class="code"><div class="highlight"><pre>        <span class="n">p</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="s">&quot;other&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">pre_delete_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">post_delete_receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_database_arg_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that the m2m_changed signal has a correct database arg (#13552)</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-226"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-226">&#182;</a></div><p>Make a receiver</p></td><td class="code"><div class="highlight"><pre>        <span class="n">receiver</span> <span class="o">=</span> <span class="n">DatabaseReceiver</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-227"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-227">&#182;</a></div><p>Connect it</p></td><td class="code"><div class="highlight"><pre>        <span class="n">signals</span><span class="o">.</span><span class="n">m2m_changed</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">receiver</span><span class="o">=</span><span class="n">receiver</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-228"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-228">&#182;</a></div><p>Create the models that will be used for the tests</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-229"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-229">&#182;</a></div><p>Create a copy of the models on the 'other' database to prevent
integrity errors on backends that don't defer constraints checks</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
                                           <span class="n">published</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">published</span><span class="p">)</span>
        <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-230"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-230">&#182;</a></div><p>Test addition</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_other</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_default</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-231"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-231">&#182;</a></div><p>Test removal</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_other</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_default</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-232"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-232">&#182;</a></div><p>Test addition in reverse</p></td><td class="code"><div class="highlight"><pre>        <span class="n">p</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_other</span><span class="p">()</span>
        <span class="n">p</span><span class="o">.</span><span class="n">book_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_default</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-233"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-233">&#182;</a></div><p>Test clearing</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_other</span><span class="p">()</span>
        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_to_default</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">receiver</span><span class="o">.</span><span class="n">_database</span><span class="p">,</span> <span class="s">&quot;other&quot;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AttributeErrorRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">&quot;A router to test the exception handling of ConnectionRouter&quot;</span>
    <span class="k">def</span> <span class="nf">db_for_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span>

    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span>

<span class="k">class</span> <span class="nc">RouterAttributeErrorTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routers</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AttributeErrorRouter</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span>

    <span class="k">def</span> <span class="nf">test_attribute_error_read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Check that the AttributeError from AttributeErrorRouter bubbles up&quot;</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Reset routers so we can save a Book instance</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AttributeErrorRouter</span><span class="p">()]</span> <span class="c"># Install our router</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">b</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_attribute_error_save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Check that the AttributeError from AttributeErrorRouter bubbles up&quot;</span>
        <span class="n">dive</span> <span class="o">=</span> <span class="n">Book</span><span class="p">()</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Dive into Python&quot;</span>
        <span class="n">dive</span><span class="o">.</span><span class="n">published</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2009</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">dive</span><span class="o">.</span><span class="n">save</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_attribute_error_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Check that the AttributeError from AttributeErrorRouter bubbles up&quot;</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Reset routers so we can save our Book, Person instances</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="n">b</span><span class="o">.</span><span class="n">editor</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AttributeErrorRouter</span><span class="p">()]</span> <span class="c"># Install our router</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">delete</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_attribute_error_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Check that the AttributeError from AttributeErrorRouter bubbles up&quot;</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[]</span> <span class="c"># Reset routers so we can save our Book, Person instances</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AttributeErrorRouter</span><span class="p">()]</span> <span class="c"># Install our router</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="nb">setattr</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="s">&#39;authors&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">ModelMetaRouter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">&quot;A router to ensure model arguments are real model classes&quot;</span>
    <span class="k">def</span> <span class="nf">db_for_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">**</span><span class="n">hints</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s">&#39;_meta&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span>

<span class="k">class</span> <span class="nc">RouterModelArgumentTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span> <span class="o">=</span> <span class="n">router</span><span class="o">.</span><span class="n">routers</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="p">[</span><span class="n">ModelMetaRouter</span><span class="p">()]</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">router</span><span class="o">.</span><span class="n">routers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_routers</span>

    <span class="k">def</span> <span class="nf">test_m2m_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Pro Django&quot;</span><span class="p">,</span>
                                <span class="n">published</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Marty Alchin&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-234"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-234">&#182;</a></div><p>test add</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-235"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-235">&#182;</a></div><p>test remove</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-236"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-236">&#182;</a></div><p>test clear</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-237"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-237">&#182;</a></div><p>test setattr</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-238"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-238">&#182;</a></div><p>test M2M collection</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_foreignkey_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Bob&#39;</span><span class="p">)</span>
        <span class="n">pet</span> <span class="o">=</span> <span class="n">Pet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">owner</span><span class="o">=</span><span class="n">person</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;Wart&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-239"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-239">&#182;</a></div><p>test related FK collection</p></td><td class="code"><div class="highlight"><pre>        <span class="n">person</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
