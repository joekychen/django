<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › null_fk_ordering › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Author</span><span class="p">,</span> <span class="n">Article</span><span class="p">,</span> <span class="n">SystemInfo</span><span class="p">,</span> <span class="n">Forum</span><span class="p">,</span> <span class="n">Post</span><span class="p">,</span> <span class="n">Comment</span>


<span class="k">class</span> <span class="nc">NullFkOrderingTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_ordering_across_null_fk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #7512</span>

<span class="sd">        ordering across nullable Foreign Keys shouldn&#39;t exclude results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">author_1</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Tom Jones&#39;</span><span class="p">)</span>
        <span class="n">author_2</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Bob Smith&#39;</span><span class="p">)</span>
        <span class="n">article_1</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;No author on this article&#39;</span><span class="p">)</span>
        <span class="n">article_2</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author_1</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;This article written by Tom Jones&#39;</span><span class="p">)</span>
        <span class="n">article_3</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">author_2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;This article written by Bob Smith&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>We can't compare results directly (since different databases sort NULLs to
different ends of the ordering), but we can check that all results are
returned.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">SystemInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">system_name</span><span class="o">=</span><span class="s">&#39;System Info&#39;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">Forum</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">system_info</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">forum_name</span><span class="o">=</span><span class="s">&#39;First forum&#39;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">forum</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;First Post&#39;</span><span class="p">)</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">comment_text</span><span class="o">=</span><span class="s">&#39;My first comment&#39;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">comment_text</span><span class="o">=</span><span class="s">&#39;My second comment&#39;</span><span class="p">)</span>
        <span class="n">s2</span> <span class="o">=</span> <span class="n">SystemInfo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">system_name</span><span class="o">=</span><span class="s">&#39;More System Info&#39;</span><span class="p">)</span>
        <span class="n">f2</span> <span class="o">=</span> <span class="n">Forum</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">system_info</span><span class="o">=</span><span class="n">s2</span><span class="p">,</span> <span class="n">forum_name</span><span class="o">=</span><span class="s">&#39;Second forum&#39;</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">forum</span><span class="o">=</span><span class="n">f2</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s">&#39;Second Post&#39;</span><span class="p">)</span>
        <span class="n">c3</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">comment_text</span><span class="o">=</span><span class="s">&#39;Another first comment&#39;</span><span class="p">)</span>
        <span class="n">c4</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">post</span><span class="o">=</span><span class="n">p2</span><span class="p">,</span> <span class="n">comment_text</span><span class="o">=</span><span class="s">&#39;Another second comment&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>We have to test this carefully. Some databases sort NULL values before
everything else, some sort them afterwards. So we extract the ordered list
and check the length. Before the fix, this list was too short (some values
were omitted).</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
