<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › model_fields › imagefield.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>imagefield.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>

<span class="kn">from</span> <span class="nn">django.core.files</span> <span class="kn">import</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">django.core.files.images</span> <span class="kn">import</span> <span class="n">ImageFile</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="n">Person</span><span class="p">,</span> <span class="n">PersonWithHeight</span><span class="p">,</span> <span class="n">PersonWithHeightAndWidth</span><span class="p">,</span>
    <span class="n">PersonDimensionsFirst</span><span class="p">,</span> <span class="n">PersonTwoImages</span><span class="p">,</span> <span class="n">TestImageFieldFile</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>If PIL available, do these tests.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">Image</span><span class="p">:</span>

    <span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">temp_storage_dir</span>


    <span class="k">class</span> <span class="nc">ImageFieldTestMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Mixin class to provide common functionality to ImageField test classes.</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Person model to use for tests.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">PersonModel</span> <span class="o">=</span> <span class="n">PersonWithHeightAndWidth</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>File class to use for file instances.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">File</span> <span class="o">=</span> <span class="n">ImageFile</span>

        <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Creates a pristine temp directory (or deletes and recreates if it</span>
<span class="sd">            already exists) that the model uses as its storage directory.</span>

<span class="sd">            Sets up two ImageFile instances for use in tests.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">temp_storage_dir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_storage_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">temp_storage_dir</span><span class="p">)</span>

            <span class="n">file_path1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;4x8.png&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file_path1</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">))</span>

            <span class="n">file_path2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;8x4.png&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file_path2</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Removes temp directory and all its contents.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_storage_dir</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">check_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
                             <span class="n">field_name</span><span class="o">=</span><span class="s">&#39;mugshot&#39;</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Asserts that the given width and height values match both the</span>
<span class="sd">            field&#39;s height and width attributes and the height and width fields</span>
<span class="sd">            (if defined) the image field is caching to.</span>

<span class="sd">            Note, this method will check for dimension fields named by adding</span>
<span class="sd">            &quot;_width&quot; or &quot;_height&quot; to the name of the ImageField.  So, the</span>
<span class="sd">            models used in these tests must have their fields named</span>
<span class="sd">            accordingly.</span>

<span class="sd">            By default, we check the field named &quot;mugshot&quot;, but this can be</span>
<span class="sd">            specified by passing the field_name parameter.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Check height/width attributes of field.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">height</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s">&#39;width&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="s">&#39;height&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Check height/width fields of model, if defined.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">width_field_name</span> <span class="o">=</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s">&#39;_width&#39;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">width_field_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">width_field_name</span><span class="p">),</span> <span class="n">width</span><span class="p">)</span>
            <span class="n">height_field_name</span> <span class="o">=</span> <span class="n">field_name</span> <span class="o">+</span> <span class="s">&#39;_height&#39;</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">height_field_name</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">height_field_name</span><span class="p">),</span> <span class="n">height</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">ImageFieldTests</span><span class="p">(</span><span class="n">ImageFieldTestMixin</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests for ImageField that don&#39;t need to be run with each of the</span>
<span class="sd">        different test model classes.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">test_equal_notequal_hash</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Bug #9786: Ensure &#39;==&#39; and &#39;!=&#39; work correctly.</span>
<span class="sd">            Bug #9508: make sure hash() works as expected (equal items must</span>
<span class="sd">            hash to the same value).</span>
<span class="sd">            &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Create two Persons with different mugshots.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joe&quot;</span><span class="p">)</span>
            <span class="n">p1</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Bob&quot;</span><span class="p">)</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">!=</span> <span class="n">p2</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Test again with an instance fetched from the db.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p1_db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joe&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p1_db</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">==</span> <span class="n">p2</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p1_db</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">!=</span> <span class="n">p2</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Instance from db should match the local instance.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p1_db</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">==</span> <span class="n">p1</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">hash</span><span class="p">(</span><span class="n">p1_db</span><span class="o">.</span><span class="n">mugshot</span><span class="p">),</span> <span class="nb">hash</span><span class="p">(</span><span class="n">p1</span><span class="o">.</span><span class="n">mugshot</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p1_db</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">!=</span> <span class="n">p1</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_instantiate_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            If the underlying file is unavailable, still create instantiate the</span>
<span class="sd">            object without error.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joan&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;shot&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joan&quot;</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">path</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span> <span class="o">+</span> <span class="s">&#39;.moved&#39;</span><span class="p">)</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joan&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_delete_when_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Bug #8175: correctly delete an object where the file no longer</span>
<span class="sd">            exists on the file system.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Fred&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;shot&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">test_size_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Bug #8534: FileField.size should not leave the file open.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joan&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;shot&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Get a "clean" model instance</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joan&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>It won't have an opened file.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">closed</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>After asking for the size, the file should still be closed.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">_</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">size</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">closed</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Tests that ImageField can be pickled, unpickled, and that the</span>
<span class="sd">            image of the unpickled version is the same as the original.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="kn">import</span> <span class="nn">pickle</span>

            <span class="n">p</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joe&quot;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="n">p2</span> <span class="o">=</span> <span class="n">Person</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Bob&quot;</span><span class="p">)</span>
            <span class="n">p2</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span>

            <span class="n">loaded_p</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">dump</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="n">loaded_p</span><span class="o">.</span><span class="n">mugshot</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">ImageFieldTwoDimensionsTests</span><span class="p">(</span><span class="n">ImageFieldTestMixin</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests behavior of an ImageField and its dimensions fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Tests assigning an image field through the model&#39;s constructor.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">,</span> <span class="n">mugshot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_image_after_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Tests behavior when image is not passed in constructor.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>TestImageField value will default to being an instance of its
attr_class, a  TestImageFieldFile, with name == None, which will
cause it to evaluate as False.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="n">TestImageFieldFile</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Test setting a fresh created model instance.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Tests assigning an image in Manager.create().</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">,</span> <span class="n">mugshot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_default_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Tests that the default value for an ImageField is an instance of</span>
<span class="sd">            the field&#39;s attr_class (TestImageFieldFile in this case) with no</span>
<span class="sd">            name (name set to None).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="n">TestImageFieldFile</span><span class="p">),</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="p">),</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_assignment_to_None</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Tests that assigning ImageField to None clears dimensions.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">,</span> <span class="n">mugshot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>If image assigned to None, dimension fields should be cleared.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_field_save_and_delete_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Tests assignment using the field&#39;s save method and deletion using</span>
<span class="sd">            the field&#39;s delete method.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>A new file should update dimensions.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Field and dimensions should be cleared after a delete.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks that dimensions are updated correctly in various situations.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Dimensions should get set if file is saved.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Test dimensions after fetching from database.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Bug 11084: Dimensions should not get recalculated if file is
coming from the database.  We test this by checking if the file
was opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>After checking dimensions on the image field, the file will have
opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Dimensions should now be cached, and if we reset was_opened and
check dimensions again, the file should not have opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>If we assign a new image to the instance, the dimensions should
update.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Dimensions were recalculated, and hence file should have opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>


    <span class="k">class</span> <span class="nc">ImageFieldNoDimensionsTests</span><span class="p">(</span><span class="n">ImageFieldTwoDimensionsTests</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests behavior of an ImageField with no dimension fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">PersonModel</span> <span class="o">=</span> <span class="n">Person</span>


    <span class="k">class</span> <span class="nc">ImageFieldOneDimensionTests</span><span class="p">(</span><span class="n">ImageFieldTwoDimensionsTests</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests behavior of an ImageField with one dimensions field.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">PersonModel</span> <span class="o">=</span> <span class="n">PersonWithHeight</span>


    <span class="k">class</span> <span class="nc">ImageFieldDimensionsFirstTests</span><span class="p">(</span><span class="n">ImageFieldTwoDimensionsTests</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests behavior of an ImageField where the dimensions fields are</span>
<span class="sd">        defined before the ImageField.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">PersonModel</span> <span class="o">=</span> <span class="n">PersonDimensionsFirst</span>


    <span class="k">class</span> <span class="nc">ImageFieldUsingFileTests</span><span class="p">(</span><span class="n">ImageFieldTwoDimensionsTests</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests behavior of an ImageField when assigning it a File instance</span>
<span class="sd">        rather than an ImageFile instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">PersonModel</span> <span class="o">=</span> <span class="n">PersonDimensionsFirst</span>
        <span class="n">File</span> <span class="o">=</span> <span class="n">File</span>


    <span class="k">class</span> <span class="nc">TwoImageFieldTests</span><span class="p">(</span><span class="n">ImageFieldTestMixin</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests a model with two ImageFields.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">PersonModel</span> <span class="o">=</span> <span class="n">PersonTwoImages</span>

        <span class="k">def</span> <span class="nf">test_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">mugshot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span> <span class="n">headshot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_create</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">mugshot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span>
                                                <span class="n">headshot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>

            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">headshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Clear the ImageFields one at a time.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">headshot</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_field_save_and_delete_methods</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>We can use save=True when deleting the image field with null=True
dimension fields and the other field has an image.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">save</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">test_dimensions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks that dimensions are updated correctly in various situations.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Dimensions should get set for the saved file.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;mug&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;head&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Test dimensions after fetching from database.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">PersonModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Joe&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Bug 11084: Dimensions should not get recalculated if file is
coming from the database.  We test this by checking if the file
was opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span><span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>After checking dimensions on the image fields, the files will
have been opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Dimensions should now be cached, and if we reset was_opened and
check dimensions again, the file should not have opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">was_opened</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span><span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>If we assign a new image to the instance, the dimensions should
update.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">p</span><span class="o">.</span><span class="n">mugshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span>
            <span class="n">p</span><span class="o">.</span><span class="n">headshot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;mugshot&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_dimensions</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&#39;headshot&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Dimensions were recalculated, and hence file should have opened.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">mugshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">headshot</span><span class="o">.</span><span class="n">was_opened</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
