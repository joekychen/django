<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › mail › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>coding: utf-8</p></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">asyncore</span>
<span class="kn">import</span> <span class="nn">email</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">smtpd</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">django.core</span> <span class="kn">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="p">(</span><span class="n">EmailMessage</span><span class="p">,</span> <span class="n">mail_admins</span><span class="p">,</span> <span class="n">mail_managers</span><span class="p">,</span>
        <span class="n">EmailMultiAlternatives</span><span class="p">,</span> <span class="n">send_mail</span><span class="p">,</span> <span class="n">send_mass_mail</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">django.core.mail.backends</span> <span class="kn">import</span> <span class="n">console</span><span class="p">,</span> <span class="n">dummy</span><span class="p">,</span> <span class="n">locmem</span><span class="p">,</span> <span class="n">filebased</span><span class="p">,</span> <span class="n">smtp</span>
<span class="kn">from</span> <span class="nn">django.core.mail.message</span> <span class="kn">import</span> <span class="n">BadHeaderError</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">override_settings</span>
<span class="kn">from</span> <span class="nn">django.utils.translation</span> <span class="kn">import</span> <span class="n">ugettext_lazy</span>


<span class="k">class</span> <span class="nc">MailTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Non-backend specific tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">test_ascii</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="s">&#39;Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&#39;Content&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">],</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">],</span> <span class="s">&#39;to@example.com&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_multiple_recipients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="s">&#39;Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&#39;Content&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">],</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">],</span> <span class="s">&#39;to@example.com, other@example.com&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_cc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Regression test for #7722&quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">cc</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;cc@example.com&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Cc&#39;</span><span class="p">],</span> <span class="s">&#39;cc@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">recipients</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc@example.com&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Test multiple CC with multiple To</p></td><td class="code"><div class="highlight"><pre>        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">],</span> <span class="n">cc</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;cc@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc.other@example.com&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Cc&#39;</span><span class="p">],</span> <span class="s">&#39;cc@example.com, cc.other@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">recipients</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc.other@example.com&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Testing with Bcc</p></td><td class="code"><div class="highlight"><pre>        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">],</span> <span class="n">cc</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;cc@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc.other@example.com&#39;</span><span class="p">],</span> <span class="n">bcc</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;bcc@example.com&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Cc&#39;</span><span class="p">],</span> <span class="s">&#39;cc@example.com, cc.other@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">recipients</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc.other@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;bcc@example.com&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_recipients_as_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">),</span> <span class="n">cc</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;cc@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc.other@example.com&#39;</span><span class="p">),</span> <span class="n">bcc</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;bcc@example.com&#39;</span><span class="p">,))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Cc&#39;</span><span class="p">],</span> <span class="s">&#39;cc@example.com, cc.other@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">recipients</span><span class="p">(),</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;cc.other@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;bcc@example.com&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_header_injection</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject</span><span class="se">\n</span><span class="s">Injection Test&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">BadHeaderError</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">ugettext_lazy</span><span class="p">(</span><span class="s">&#39;Subject</span><span class="se">\n</span><span class="s">Injection Test&#39;</span><span class="p">),</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">BadHeaderError</span><span class="p">,</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_space_continuation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test for space continuation character in long (ascii) subject headers (#7747)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Long subject lines that get wrapped should use a space continuation character to get expected behavior in Outlook and Thunderbird&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">],</span> <span class="s">&#39;Long subject lines that get wrapped should use a space continuation</span><span class="se">\n</span><span class="s"> character to get expected behavior in Outlook and Thunderbird&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_message_header_overrides</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Specifying dates or message-ids in the extra headers overrides the</span>
<span class="sd">        default values (#9233)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;date&quot;</span><span class="p">:</span> <span class="s">&quot;Fri, 09 Nov 2001 01:08:47 -0000&quot;</span><span class="p">,</span> <span class="s">&quot;Message-ID&quot;</span><span class="p">:</span> <span class="s">&quot;foo&quot;</span><span class="p">}</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">,</span> <span class="s">&#39;content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;Content-Type: text/plain; charset=&quot;utf-8&quot;</span><span class="se">\n</span><span class="s">MIME-Version: 1.0</span><span class="se">\n</span><span class="s">Content-Transfer-Encoding: 7bit</span><span class="se">\n</span><span class="s">Subject: subject</span><span class="se">\n</span><span class="s">From: from@example.com</span><span class="se">\n</span><span class="s">To: to@example.com</span><span class="se">\n</span><span class="s">date: Fri, 09 Nov 2001 01:08:47 -0000</span><span class="se">\n</span><span class="s">Message-ID: foo</span><span class="se">\n\n</span><span class="s">content&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_from_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure we can manually set the From header (#9214)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">],</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_to_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure we can manually set the To header (#17444)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span>
                             <span class="p">[</span><span class="s">&#39;list-subscriber@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;list-subscriber2@example.com&#39;</span><span class="p">],</span>
                             <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;To&#39;</span><span class="p">:</span> <span class="s">&#39;mailing-list@example.com&#39;</span><span class="p">})</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">],</span> <span class="s">&#39;mailing-list@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;list-subscriber@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;list-subscriber2@example.com&#39;</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>If we don't set the To header manually, it should default to the <code>to</code> argument to the constructor</p></td><td class="code"><div class="highlight"><pre>        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span>
                             <span class="p">[</span><span class="s">&#39;list-subscriber@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;list-subscriber2@example.com&#39;</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;To&#39;</span><span class="p">],</span> <span class="s">&#39;list-subscriber@example.com, list-subscriber2@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;list-subscriber@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;list-subscriber2@example.com&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_multiple_message_call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression for #13259 - Make sure that headers are not changed when</span>
<span class="sd">        calling EmailMessage.message()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">],</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;From&#39;</span><span class="p">],</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_unicode_address_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression for #11144 - When a to/from/cc header contains unicode,</span>
<span class="sd">        make sure the email addresses are parsed correctly (especially with</span>
<span class="sd">        regards to commas)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&quot;Firstname Sürname&quot; &lt;to@example.com&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()[</span><span class="s">&#39;To&#39;</span><span class="p">],</span> <span class="s">&#39;=?utf-8?q?Firstname_S=C3=BCrname?= &lt;to@example.com&gt;, other@example.com&#39;</span><span class="p">)</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&quot;Sürname, Firstname&quot; &lt;to@example.com&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;other@example.com&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()[</span><span class="s">&#39;To&#39;</span><span class="p">],</span> <span class="s">&#39;=?utf-8?q?S=C3=BCrname=2C_Firstname?= &lt;to@example.com&gt;, other@example.com&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_unicode_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&quot;Gżegżółka&quot;</span><span class="p">,</span> <span class="s">&quot;Content&quot;</span><span class="p">,</span> <span class="s">&quot;from@example.com&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;to@example.com&quot;</span><span class="p">],</span>
                             <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;Sender&quot;</span><span class="p">:</span> <span class="s">&#39;&quot;Firstname Sürname&quot; &lt;sender@example.com&gt;&#39;</span><span class="p">,</span>
                                      <span class="s">&quot;Comments&quot;</span><span class="p">:</span> <span class="s">&#39;My Sürname is non-ASCII&#39;</span><span class="p">})</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Subject&#39;</span><span class="p">],</span> <span class="s">&#39;=?utf-8?b?R8W8ZWfFvMOzxYJrYQ==?=&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Sender&#39;</span><span class="p">],</span> <span class="s">&#39;=?utf-8?q?Firstname_S=C3=BCrname?= &lt;sender@example.com&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&#39;Comments&#39;</span><span class="p">],</span> <span class="s">&#39;=?utf-8?q?My_S=C3=BCrname_is_non-ASCII?=&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_safe_mime_multipart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure headers can be set with a different encoding than utf-8 in</span>
<span class="sd">        SafeMIMEMultipart as well</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Date&quot;</span><span class="p">:</span> <span class="s">&quot;Fri, 09 Nov 2001 01:08:47 -0000&quot;</span><span class="p">,</span> <span class="s">&quot;Message-ID&quot;</span><span class="p">:</span> <span class="s">&quot;foo&quot;</span><span class="p">}</span>
        <span class="n">subject</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;Sürname, Firstname&quot; &lt;to@example.com&gt;&#39;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="s">&#39;This is an important message.&#39;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="s">&#39;&lt;p&gt;This is an &lt;strong&gt;important&lt;/strong&gt; message.&lt;/p&gt;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMultiAlternatives</span><span class="p">(</span><span class="s">&#39;Message from Firstname Sürname&#39;</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span> <span class="p">[</span><span class="n">to</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">attach_alternative</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;iso-8859-1&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()[</span><span class="s">&#39;To&#39;</span><span class="p">],</span> <span class="s">&#39;=?iso-8859-1?q?S=FCrname=2C_Firstname?= &lt;to@example.com&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()[</span><span class="s">&#39;Subject&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span> <span class="s">&#39;=?iso-8859-1?q?Message_from_Firstname_S=FCrname?=&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression for #12791 - Encode body correctly with other encodings</span>
<span class="sd">        than utf-8</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Firstname Sürname is a great guy.&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;other@example.com&#39;</span><span class="p">])</span>
        <span class="n">email</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;iso-8859-1&#39;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Type: text/plain; charset=&quot;iso-8859-1&quot;</span><span class="se">\n</span><span class="s">MIME-Version: 1.0</span><span class="se">\n</span><span class="s">Content-Transfer-Encoding: quoted-printable</span><span class="se">\n</span><span class="s">Subject: Subject</span><span class="se">\n</span><span class="s">From: from@example.com</span><span class="se">\n</span><span class="s">To: other@example.com&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&#39;Firstname S=FCrname is a great guy.&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Make sure MIME attachments also works correctly with other encodings than utf-8</p></td><td class="code"><div class="highlight"><pre>        <span class="n">text_content</span> <span class="o">=</span> <span class="s">&#39;Firstname Sürname is a great guy.&#39;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="s">&#39;&lt;p&gt;Firstname Sürname is a &lt;strong&gt;great&lt;/strong&gt; guy.&lt;/p&gt;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMultiAlternatives</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="s">&#39;iso-8859-1&#39;</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">attach_alternative</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">as_string</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;Content-Type: text/plain; charset=&quot;iso-8859-1&quot;</span><span class="se">\n</span><span class="s">MIME-Version: 1.0</span><span class="se">\n</span><span class="s">Content-Transfer-Encoding: quoted-printable</span><span class="se">\n\n</span><span class="s">Firstname S=FCrname is a great guy.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">as_string</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;Content-Type: text/html; charset=&quot;iso-8859-1&quot;</span><span class="se">\n</span><span class="s">MIME-Version: 1.0</span><span class="se">\n</span><span class="s">Content-Transfer-Encoding: quoted-printable</span><span class="se">\n\n</span><span class="s">&lt;p&gt;Firstname S=FCrname is a &lt;strong&gt;great&lt;/strong&gt; guy.&lt;/p&gt;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_attachments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Regression test for #9367&quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Date&quot;</span><span class="p">:</span> <span class="s">&quot;Fri, 09 Nov 2001 01:08:47 -0000&quot;</span><span class="p">,</span> <span class="s">&quot;Message-ID&quot;</span><span class="p">:</span> <span class="s">&quot;foo&quot;</span><span class="p">}</span>
        <span class="n">subject</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;to@example.com&#39;</span>
        <span class="n">text_content</span> <span class="o">=</span> <span class="s">&#39;This is an important message.&#39;</span>
        <span class="n">html_content</span> <span class="o">=</span> <span class="s">&#39;&lt;p&gt;This is an &lt;strong&gt;important&lt;/strong&gt; message.&lt;/p&gt;&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMultiAlternatives</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">text_content</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span> <span class="p">[</span><span class="n">to</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">attach_alternative</span><span class="p">(</span><span class="n">html_content</span><span class="p">,</span> <span class="s">&quot;text/html&quot;</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s">&quot;an attachment.pdf&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;%PDF-1.4.%...&quot;</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">&quot;application/pdf&quot;</span><span class="p">)</span>
        <span class="n">msg_str</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">msg_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;multipart/mixed&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_default_type</span><span class="p">(),</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;multipart/alternative&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;application/pdf&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_non_ascii_attachment_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Regression test for #14964&quot;&quot;&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Date&quot;</span><span class="p">:</span> <span class="s">&quot;Fri, 09 Nov 2001 01:08:47 -0000&quot;</span><span class="p">,</span> <span class="s">&quot;Message-ID&quot;</span><span class="p">:</span> <span class="s">&quot;foo&quot;</span><span class="p">}</span>
        <span class="n">subject</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="s">&#39;hello&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="s">&#39;to@example.com&#39;</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s">&#39;This is the message.&#39;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">subject</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">from_email</span><span class="p">,</span> <span class="p">[</span><span class="n">to</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Unicode in file name</p></td><td class="code"><div class="highlight"><pre>        <span class="n">msg</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="s">&quot;une pièce jointe.pdf&quot;</span><span class="p">,</span> <span class="n">b</span><span class="s">&quot;%PDF-1.4.%...&quot;</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">&quot;application/pdf&quot;</span><span class="p">)</span>
        <span class="n">msg_str</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">msg_str</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_filename</span><span class="p">(),</span> <span class="s">&#39;une pièce jointe.pdf&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_dummy_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that dummy backends returns correct number of sent messages</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">dummy</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">()</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">email</span><span class="p">,</span> <span class="n">email</span><span class="p">,</span> <span class="n">email</span><span class="p">]),</span> <span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_arbitrary_keyword</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that get_connection() accepts arbitrary keyword that might be</span>
<span class="sd">        used with custom backends.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="n">fail_silently</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">foo</span><span class="o">=</span><span class="s">&#39;bar&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">fail_silently</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_custom_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test custom backend defined in this suite.&quot;&quot;&quot;</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;regressiontests.mail.custombackend.EmailBackend&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="s">&#39;test_outbox&#39;</span><span class="p">))</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">email</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_backend_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test backend argument of mail.get_connection()&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;django.core.mail.backends.smtp.EmailBackend&#39;</span><span class="p">),</span> <span class="n">smtp</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;django.core.mail.backends.locmem.EmailBackend&#39;</span><span class="p">),</span> <span class="n">locmem</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;django.core.mail.backends.dummy.EmailBackend&#39;</span><span class="p">),</span> <span class="n">dummy</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;django.core.mail.backends.console.EmailBackend&#39;</span><span class="p">),</span> <span class="n">console</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">))</span>
        <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;django.core.mail.backends.filebased.EmailBackend&#39;</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">tmp_dir</span><span class="p">),</span> <span class="n">filebased</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(),</span> <span class="n">locmem</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">))</span>

    <span class="nd">@override_settings</span><span class="p">(</span>
        <span class="n">EMAIL_BACKEND</span><span class="o">=</span><span class="s">&#39;django.core.mail.backends.locmem.EmailBackend&#39;</span><span class="p">,</span>
        <span class="n">ADMINS</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;nobody&#39;</span><span class="p">,</span> <span class="s">&#39;nobody@example.com&#39;</span><span class="p">)],</span>
        <span class="n">MANAGERS</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;nobody&#39;</span><span class="p">,</span> <span class="s">&#39;nobody@example.com&#39;</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">test_connection_arg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test connection argument to send_mail(), et. al.&quot;&quot;&quot;</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="p">[]</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Send using non-default connection</p></td><td class="code"><div class="highlight"><pre>        <span class="n">connection</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;regressiontests.mail.custombackend.EmailBackend&#39;</span><span class="p">)</span>
        <span class="n">send_mail</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="s">&#39;Subject&#39;</span><span class="p">)</span>

        <span class="n">connection</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;regressiontests.mail.custombackend.EmailBackend&#39;</span><span class="p">)</span>
        <span class="n">send_mass_mail</span><span class="p">([</span>
                <span class="p">(</span><span class="s">&#39;Subject1&#39;</span><span class="p">,</span> <span class="s">&#39;Content1&#39;</span><span class="p">,</span> <span class="s">&#39;from1@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to1@example.com&#39;</span><span class="p">]),</span>
                <span class="p">(</span><span class="s">&#39;Subject2&#39;</span><span class="p">,</span> <span class="s">&#39;Content2&#39;</span><span class="p">,</span> <span class="s">&#39;from2@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to2@example.com&#39;</span><span class="p">]),</span>
            <span class="p">],</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="s">&#39;Subject1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="s">&#39;Subject2&#39;</span><span class="p">)</span>

        <span class="n">connection</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;regressiontests.mail.custombackend.EmailBackend&#39;</span><span class="p">)</span>
        <span class="n">mail_admins</span><span class="p">(</span><span class="s">&#39;Admin message&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="s">&#39;[Django] Admin message&#39;</span><span class="p">)</span>

        <span class="n">connection</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;regressiontests.mail.custombackend.EmailBackend&#39;</span><span class="p">)</span>
        <span class="n">mail_managers</span><span class="p">(</span><span class="s">&#39;Manager message&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">,</span> <span class="p">[])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">test_outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="s">&#39;[Django] Manager message&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_dont_mangle_from_in_body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Regression for #13433 - Make sure that EmailMessage doesn't mangle
'From ' in message body.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;From the future&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;&gt;From the future&#39;</span> <span class="ow">in</span> <span class="n">email</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_dont_base64_encode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Ticket #3472
Shouldn't use Base64 encoding at all</p></td><td class="code"><div class="highlight"><pre>        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;UTF-8 encoded body&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Transfer-Encoding: base64&#39;</span> <span class="ow">in</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">())</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Ticket #11212
Shouldn't use quoted printable, should detect it can represent content with 7 bit data</p></td><td class="code"><div class="highlight"><pre>        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Body with only ASCII characters.&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Transfer-Encoding: quoted-printable&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Transfer-Encoding: 7bit&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Shouldn't use quoted printable, should detect it can represent content with 8 bit data</p></td><td class="code"><div class="highlight"><pre>        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Body with latin characters: àáä.&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Transfer-Encoding: quoted-printable&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Transfer-Encoding: 8bit&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Body with non latin characters: А Б В Г Д Е Ж Ѕ З И І К Л М Н О П.&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">message</span><span class="p">()</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Transfer-Encoding: quoted-printable&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;Content-Transfer-Encoding: 8bit&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseEmailBackendTests</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">email_backend</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings_override</span> <span class="o">=</span> <span class="n">override_settings</span><span class="p">(</span><span class="n">EMAIL_BACKEND</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">email_backend</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings_override</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings_override</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">assertStartsWith</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">first</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">second</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">longMessage</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">second</span><span class="p">)],</span> <span class="n">second</span><span class="p">,</span> <span class="s">&quot;First string doesn&#39;t start with the second.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_mailbox_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">flush_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_the_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mailbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mailbox_content</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mailbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s">&quot;Expected exactly one message, got </span><span class="si">%d</span><span class="s">.</span><span class="se">\n</span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mailbox</span><span class="p">),</span> <span class="p">[</span>
                <span class="n">m</span><span class="o">.</span><span class="n">as_string</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mailbox</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="n">num_sent</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">email</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">num_sent</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;subject&quot;</span><span class="p">],</span> <span class="s">&quot;Subject&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&quot;Content&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;from&quot;</span><span class="p">],</span> <span class="s">&quot;from@example.com&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">&quot;to&quot;</span><span class="p">),</span> <span class="p">[</span><span class="s">&quot;to@example.com&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_send_many</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email1</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content1&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="n">email2</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content2&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">])</span>
        <span class="n">num_sent</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">email1</span><span class="p">,</span> <span class="n">email2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">num_sent</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mailbox_content</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">messages</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&quot;Content1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&quot;Content2&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_send_verbose_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&quot;Subject&quot;</span><span class="p">,</span> <span class="s">&quot;Content&quot;</span><span class="p">,</span> <span class="s">&#39;&quot;Firstname Sürname&quot; &lt;from@example.com&gt;&#39;</span><span class="p">,</span>
                             <span class="p">[</span><span class="s">&quot;to@example.com&quot;</span><span class="p">])</span>
        <span class="n">email</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;subject&quot;</span><span class="p">],</span> <span class="s">&quot;Subject&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&quot;Content&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s">&quot;from&quot;</span><span class="p">],</span> <span class="s">&quot;=?utf-8?q?Firstname_S=C3=BCrname?= &lt;from@example.com&gt;&quot;</span><span class="p">)</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">MANAGERS</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;nobody&#39;</span><span class="p">,</span> <span class="s">&#39;nobody@example.com&#39;</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">test_html_mail_managers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test html_message argument to mail_managers&quot;&quot;&quot;</span>
        <span class="n">mail_managers</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="n">html_message</span><span class="o">=</span><span class="s">&#39;HTML Content&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;[Django] Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">&#39;to&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s">&#39;nobody@example.com&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&#39;Content&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&#39;HTML Content&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;text/html&#39;</span><span class="p">)</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMINS</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;nobody&#39;</span><span class="p">,</span> <span class="s">&#39;nobody@example.com&#39;</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">test_html_mail_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Test html_message argument to mail_admins &quot;&quot;&quot;</span>
        <span class="n">mail_admins</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="n">html_message</span><span class="o">=</span><span class="s">&#39;HTML Content&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;[Django] Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_all</span><span class="p">(</span><span class="s">&#39;to&#39;</span><span class="p">),</span> <span class="p">[</span><span class="s">&#39;nobody@example.com&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">is_multipart</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">()),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&#39;Content&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(),</span> <span class="s">&#39;HTML Content&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_payload</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;text/html&#39;</span><span class="p">)</span>

    <span class="nd">@override_settings</span><span class="p">(</span>
        <span class="n">ADMINS</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;nobody&#39;</span><span class="p">,</span> <span class="s">&#39;nobody+admin@example.com&#39;</span><span class="p">)],</span>
        <span class="n">MANAGERS</span><span class="o">=</span><span class="p">[(</span><span class="s">&#39;nobody&#39;</span><span class="p">,</span> <span class="s">&#39;nobody+manager@example.com&#39;</span><span class="p">)])</span>
    <span class="k">def</span> <span class="nf">test_manager_and_admin_mail_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        String prefix + lazy translated subject = bad output</span>
<span class="sd">        Regression for #13494</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mail_managers</span><span class="p">(</span><span class="n">ugettext_lazy</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">),</span> <span class="s">&#39;Content&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;[Django] Subject&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flush_mailbox</span><span class="p">()</span>
        <span class="n">mail_admins</span><span class="p">(</span><span class="n">ugettext_lazy</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">),</span> <span class="s">&#39;Content&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;[Django] Subject&#39;</span><span class="p">)</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">ADMINS</span><span class="o">=</span><span class="p">(),</span> <span class="n">MANAGERS</span><span class="o">=</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_empty_admins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that mail_admins/mail_managers doesn&#39;t connect to the mail server</span>
<span class="sd">        if there are no recipients (#9383)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mail_admins</span><span class="p">(</span><span class="s">&#39;hi&#39;</span><span class="p">,</span> <span class="s">&#39;there&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mailbox_content</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="n">mail_managers</span><span class="p">(</span><span class="s">&#39;hi&#39;</span><span class="p">,</span> <span class="s">&#39;there&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mailbox_content</span><span class="p">(),</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_message_cc_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #7722</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">cc</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;cc@example.com&#39;</span><span class="p">])</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">email</span><span class="p">])</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertStartsWith</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">as_string</span><span class="p">(),</span> <span class="n">b</span><span class="s">&#39;Content-Type: text/plain; charset=&quot;utf-8&quot;</span><span class="se">\n</span><span class="s">MIME-Version: 1.0</span><span class="se">\n</span><span class="s">Content-Transfer-Encoding: 7bit</span><span class="se">\n</span><span class="s">Subject: Subject</span><span class="se">\n</span><span class="s">From: from@example.com</span><span class="se">\n</span><span class="s">To: to@example.com</span><span class="se">\n</span><span class="s">Cc: cc@example.com</span><span class="se">\n</span><span class="s">Date: &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_idn_send</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #14301</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">send_mail</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@öäü.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@öäü.com&#39;</span><span class="p">]))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;from&#39;</span><span class="p">),</span> <span class="s">&#39;from@xn--4ca9at.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;to&#39;</span><span class="p">),</span> <span class="s">&#39;to@xn--4ca9at.com&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">flush_mailbox</span><span class="p">()</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@öäü.com&#39;</span><span class="p">,</span>
                     <span class="p">[</span><span class="s">&#39;to@öäü.com&#39;</span><span class="p">],</span> <span class="n">cc</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;cc@öäü.com&#39;</span><span class="p">])</span>
        <span class="n">m</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;from&#39;</span><span class="p">),</span> <span class="s">&#39;from@xn--4ca9at.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;to&#39;</span><span class="p">),</span> <span class="s">&#39;to@xn--4ca9at.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;cc&#39;</span><span class="p">),</span> <span class="s">&#39;cc@xn--4ca9at.com&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_recipient_without_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #15042</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">send_mail</span><span class="p">(</span><span class="s">&quot;Subject&quot;</span><span class="p">,</span> <span class="s">&quot;Content&quot;</span><span class="p">,</span> <span class="s">&quot;tester&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;django&quot;</span><span class="p">]))</span>
        <span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_the_message</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;from&#39;</span><span class="p">),</span> <span class="s">&quot;tester&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;to&#39;</span><span class="p">),</span> <span class="s">&quot;django&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">LocmemBackendTests</span><span class="p">(</span><span class="n">BaseEmailBackendTests</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">):</span>
    <span class="n">email_backend</span> <span class="o">=</span> <span class="s">&#39;django.core.mail.backends.locmem.EmailBackend&#39;</span>

    <span class="k">def</span> <span class="nf">get_mailbox_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">message</span><span class="p">()</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">flush_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LocmemBackendTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>
        <span class="n">mail</span><span class="o">.</span><span class="n">outbox</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">test_locmem_shared_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make sure that the locmen backend populates the outbox.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">locmem</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">()</span>
        <span class="n">connection2</span> <span class="o">=</span> <span class="n">locmem</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">()</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">email</span><span class="p">])</span>
        <span class="n">connection2</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">email</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FileBackendTests</span><span class="p">(</span><span class="n">BaseEmailBackendTests</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">):</span>
    <span class="n">email_backend</span> <span class="o">=</span> <span class="s">&#39;django.core.mail.backends.filebased.EmailBackend&#39;</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileBackendTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">addCleanup</span><span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings_override</span> <span class="o">=</span> <span class="n">override_settings</span><span class="p">(</span><span class="n">EMAIL_FILE_PATH</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings_override</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_settings_override</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileBackendTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_mailbox_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
                <span class="n">session</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">79</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">session</span> <span class="k">if</span> <span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">messages</span>

    <span class="k">def</span> <span class="nf">test_file_sessions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Make sure opening a connection creates a new file&quot;&quot;&quot;</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;bounce@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;From&#39;</span><span class="p">:</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">})</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_file</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get_content_type</span><span class="p">(),</span> <span class="s">&#39;text/plain&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;subject&#39;</span><span class="p">),</span> <span class="s">&#39;Subject&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;from&#39;</span><span class="p">),</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;to&#39;</span><span class="p">),</span> <span class="s">&#39;to@example.com&#39;</span><span class="p">)</span>

        <span class="n">connection2</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="n">connection2</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">connection</span><span class="o">.</span><span class="n">send_messages</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">msg</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">open</span><span class="p">())</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmp_dir</span><span class="p">)),</span> <span class="mi">3</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ConsoleBackendTests</span><span class="p">(</span><span class="n">BaseEmailBackendTests</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">):</span>
    <span class="n">email_backend</span> <span class="o">=</span> <span class="s">&#39;django.core.mail.backends.console.EmailBackend&#39;</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConsoleBackendTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stdout</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">__stdout</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConsoleBackendTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stream</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_mailbox_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">messages</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="s">&#39;-&#39;</span> <span class="o">*</span> <span class="mi">79</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">messages</span> <span class="k">if</span> <span class="n">m</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_console_stream_kwarg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that the console backend can be pointed at an arbitrary stream.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">mail</span><span class="o">.</span><span class="n">get_connection</span><span class="p">(</span><span class="s">&#39;django.core.mail.backends.console.EmailBackend&#39;</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">)</span>
        <span class="n">send_mail</span><span class="p">(</span><span class="s">&#39;Subject&#39;</span><span class="p">,</span> <span class="s">&#39;Content&#39;</span><span class="p">,</span> <span class="s">&#39;from@example.com&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;Content-Type: text/plain; charset=&quot;utf-8&quot;</span><span class="se">\n</span><span class="s">MIME-Version: 1.0</span><span class="se">\n</span><span class="s">Content-Transfer-Encoding: 7bit</span><span class="se">\n</span><span class="s">Subject: Subject</span><span class="se">\n</span><span class="s">From: from@example.com</span><span class="se">\n</span><span class="s">To: to@example.com</span><span class="se">\n</span><span class="s">Date: &#39;</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">FakeSMTPServer</span><span class="p">(</span><span class="n">smtpd</span><span class="o">.</span><span class="n">SMTPServer</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Asyncore SMTP server wrapped into a thread. Based on DummyFTPServer from:</span>
<span class="sd">    http://svn.python.org/view/python/branches/py3k/Lib/test/test_ftplib.py?revision=86061&amp;view=markup</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">smtpd</span><span class="o">.</span><span class="n">SMTPServer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sink</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">process_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peer</span><span class="p">,</span> <span class="n">mailfrom</span><span class="p">,</span> <span class="n">rcpttos</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">message_from_string</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">maddr</span> <span class="o">=</span> <span class="n">email</span><span class="o">.</span><span class="n">Utils</span><span class="o">.</span><span class="n">parseaddr</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;from&#39;</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">mailfrom</span> <span class="o">!=</span> <span class="n">maddr</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;553 &#39;</span><span class="si">%s</span><span class="s">&#39; != &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mailfrom</span><span class="p">,</span> <span class="n">maddr</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sink</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_sink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sink</span><span class="p">[:]</span>

    <span class="k">def</span> <span class="nf">flush_sink</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sink</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__flag</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__flag</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__flag</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="ow">and</span> <span class="n">asyncore</span><span class="o">.</span><span class="n">socket_map</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">active_lock</span><span class="p">:</span>
                <span class="n">asyncore</span><span class="o">.</span><span class="n">loop</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">asyncore</span><span class="o">.</span><span class="n">close_all</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SMTPBackendTests</span><span class="p">(</span><span class="n">BaseEmailBackendTests</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">):</span>
    <span class="n">email_backend</span> <span class="o">=</span> <span class="s">&#39;django.core.mail.backends.smtp.EmailBackend&#39;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">setUpClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">FakeSMTPServer</span><span class="p">((</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_settings_override</span> <span class="o">=</span> <span class="n">override_settings</span><span class="p">(</span>
            <span class="n">EMAIL_HOST</span><span class="o">=</span><span class="s">&quot;127.0.0.1&quot;</span><span class="p">,</span>
            <span class="n">EMAIL_PORT</span><span class="o">=</span><span class="n">cls</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_settings_override</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">tearDownClass</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">_settings_override</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
        <span class="n">cls</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SMTPBackendTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">setUp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">flush_sink</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">flush_sink</span><span class="p">()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SMTPBackendTests</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">tearDown</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">flush_mailbox</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">flush_sink</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_mailbox_content</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">get_sink</span><span class="p">()</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">EMAIL_HOST_USER</span><span class="o">=</span><span class="s">&quot;not empty username&quot;</span><span class="p">,</span>
                        <span class="n">EMAIL_HOST_PASSWORD</span><span class="o">=</span><span class="s">&quot;not empty password&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_email_authentication_use_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;not empty username&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s">&#39;not empty password&#39;</span><span class="p">)</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">EMAIL_HOST_USER</span><span class="o">=</span><span class="s">&quot;not empty username&quot;</span><span class="p">,</span>
                        <span class="n">EMAIL_HOST_PASSWORD</span><span class="o">=</span><span class="s">&quot;not empty password&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_email_authentication_override_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;username&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&#39;password&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;username&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">)</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">EMAIL_HOST_USER</span><span class="o">=</span><span class="s">&quot;not empty username&quot;</span><span class="p">,</span>
                        <span class="n">EMAIL_HOST_PASSWORD</span><span class="o">=</span><span class="s">&quot;not empty password&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_email_disabled_authentication</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">backend</span> <span class="o">=</span> <span class="n">smtp</span><span class="o">.</span><span class="n">EmailBackend</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">password</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
