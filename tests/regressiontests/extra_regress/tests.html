<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › extra_regress › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.utils.datastructures</span> <span class="kn">import</span> <span class="n">SortedDict</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">TestObject</span><span class="p">,</span> <span class="n">Order</span><span class="p">,</span> <span class="n">RevisionableModel</span>


<span class="k">class</span> <span class="nc">ExtraRegressTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span>
                    <span class="n">username</span><span class="o">=</span><span class="s">&quot;fred&quot;</span><span class="p">,</span>
                    <span class="n">password</span><span class="o">=</span><span class="s">&quot;secret&quot;</span><span class="p">,</span>
                    <span class="n">email</span><span class="o">=</span><span class="s">&quot;fred@example.com&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_regression_7314_7372</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression tests for #7314 and #7372</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">RevisionableModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&#39;First Revision&#39;</span><span class="p">,</span>
            <span class="n">when</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">rm</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

        <span class="n">rm2</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">new_revision</span><span class="p">()</span>
        <span class="n">rm2</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&quot;Second Revision&quot;</span>
        <span class="n">rm</span><span class="o">.</span><span class="n">when</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">rm2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rm2</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&#39;Second Revision&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rm2</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&#39;First Revision&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertNotEqual</span><span class="p">(</span><span class="n">rm2</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">rm</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">rm2</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">rm</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Queryset to match most recent revision:</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">RevisionableModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
                <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;</span><span class="si">%(table)s</span><span class="s">.id IN (SELECT MAX(rev.id) FROM </span><span class="si">%(table)s</span><span class="s"> rev GROUP BY rev.base_id)&quot;</span> <span class="o">%</span> <span class="p">{</span>
                    <span class="s">&#39;table&#39;</span><span class="p">:</span> <span class="n">RevisionableModel</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">,</span>
                <span class="p">}]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span>
            <span class="p">[(</span><span class="s">&#39;Second Revision&#39;</span><span class="p">,</span> <span class="s">&#39;First Revision&#39;</span><span class="p">)],</span>
            <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Queryset to search for string in title:</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs2</span> <span class="o">=</span> <span class="n">RevisionableModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">title__contains</span><span class="o">=</span><span class="s">&quot;Revision&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs2</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;First Revision&#39;</span><span class="p">,</span> <span class="s">&#39;First Revision&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;Second Revision&#39;</span><span class="p">,</span> <span class="s">&#39;First Revision&#39;</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Following queryset should return the most recent revision:</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span> <span class="o">&amp;</span> <span class="n">qs2</span><span class="p">,</span>
            <span class="p">[(</span><span class="s">&#39;Second Revision&#39;</span><span class="p">,</span> <span class="s">&#39;First Revision&#39;</span><span class="p">)],</span>
            <span class="n">transform</span><span class="o">=</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_extra_stay_tied</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Extra select parameters should stay tied to their corresponding
select portions. Applies when portions are updated or otherwise
moved around.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
                    <span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&quot;alpha&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;beta&quot;</span><span class="p">,</span> <span class="s">&quot;2&quot;</span><span class="p">),</span>  <span class="p">(</span><span class="s">&quot;gamma&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">))),</span>
                    <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;beta&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;alpha&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;alpha&#39;</span><span class="p">,</span> <span class="s">&#39;beta&#39;</span><span class="p">,</span> <span class="s">&#39;gamma&#39;</span><span class="p">)),</span>
            <span class="p">[{</span><span class="s">&#39;alpha&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;beta&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;gamma&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_regression_7957</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #7957: Combining extra() calls should leave the</span>
<span class="sd">        corresponding parameters associated with the right extra() bit. I.e.</span>
<span class="sd">        internal dictionary must remain sorted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;alpha&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                       <span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;beta&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;beta&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
                       <span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;alpha&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_regression_7961</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #7961: When not using a portion of an</span>
<span class="sd">        extra(...) in a query, remove any corresponding parameters from the</span>
<span class="sd">        query as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;alpha&quot;</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_regression_8063</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #8063: limiting a query shouldn&#39;t discard any</span>
<span class="sd">        extra() bits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;id=</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;&lt;User: fred&gt;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;&lt;User: fred&gt;&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_regression_8039</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #8039: Ordering sometimes removed relevant tables</span>
<span class="sd">        from extra(). This test is the critical case: ordering uses a table,</span>
<span class="sd">        but then removes the reference because of an optimisation. The table</span>
<span class="sd">        should still be present because of the extra() call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
                <span class="n">Order</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;username=</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">],</span>
                                    <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;fred&quot;</span><span class="p">],</span>
                                    <span class="n">tables</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;auth_user&quot;</span><span class="p">]</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;created_by&#39;</span><span class="p">),</span>
                <span class="p">[]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_regression_8819</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #8819: Fields in the extra(select=...) list</span>
<span class="sd">        should be available to extra(order_by=...).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;extra_field&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;User: fred&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;extra_field&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;extra_field&#39;</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;&lt;User: fred&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;extra_field&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span> <span class="n">order_by</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;extra_field&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span>
            <span class="p">[</span><span class="s">&#39;&lt;User: fred&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_dates_query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When calling the dates() method on a queryset with extra selection</span>
<span class="sd">        columns, we can (and should) ignore those columns. They don&#39;t change</span>
<span class="sd">        the result and cause incorrect SQL to be produced otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rm</span> <span class="o">=</span> <span class="n">RevisionableModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&#39;First Revision&#39;</span><span class="p">,</span>
            <span class="n">when</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">RevisionableModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;the_answer&quot;</span><span class="p">:</span> <span class="s">&#39;id&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;when&#39;</span><span class="p">,</span> <span class="s">&#39;month&#39;</span><span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;datetime.datetime(2008, 9, 1, 0, 0)&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_values_with_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #10256... If there is a values() clause, Extra</span>
<span class="sd">        columns are only returned if they are explicitly mentioned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;third&#39;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="p">[{</span><span class="s">&#39;bar&#39;</span><span class="p">:</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">:</span> <span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">:</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;whiz&#39;</span><span class="p">:</span> <span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">}]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Extra clauses after an empty values clause are still included</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))),</span>
            <span class="p">[{</span><span class="s">&#39;bar&#39;</span><span class="p">:</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">:</span> <span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">:</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;whiz&#39;</span><span class="p">:</span> <span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">}]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Extra columns are ignored if not mentioned in the values() clause</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">)),</span>
            <span class="p">[{</span><span class="s">&#39;second&#39;</span><span class="p">:</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">}]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Extra columns after a non-empty values() clause are ignored</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))),</span>
            <span class="p">[{</span><span class="s">&#39;second&#39;</span><span class="p">:</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">}]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Extra columns can be partially returned</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">)),</span>
            <span class="p">[{</span><span class="s">&#39;second&#39;</span><span class="p">:</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">}]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Also works if only extra columns are included</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">,</span> <span class="s">&#39;whiz&#39;</span><span class="p">)),</span>
            <span class="p">[{</span><span class="s">&#39;foo&#39;</span><span class="p">:</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;whiz&#39;</span><span class="p">:</span> <span class="s">&#39;third&#39;</span><span class="p">}]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Values list works the same way
All columns are returned for an empty values_list()</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">()),</span>
            <span class="p">[(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">)]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Extra columns after an empty values_list() are still included</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">()</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))),</span>
            <span class="p">[(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">)]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Extra columns ignored completely if not mentioned in values_list()</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">)),</span>
            <span class="p">[(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">)]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Extra columns after a non-empty values_list() clause are ignored completely</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))),</span>
            <span class="p">[(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;second&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Only the extra columns specified in the values_list() are returned</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;whiz&#39;</span><span class="p">)),</span>
            <span class="p">[(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">)]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>...also works if only extra columns are included</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;whiz&#39;</span><span class="p">)),</span>
            <span class="p">[(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;third&#39;</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">[</span><span class="s">&#39;third&#39;</span><span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>... and values are returned in the order they are specified</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;foo&#39;</span><span class="p">)),</span>
            <span class="p">[(</span><span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;first&#39;</span><span class="p">,</span><span class="s">&#39;id&#39;</span><span class="p">)),</span>
            <span class="p">[(</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="n">SortedDict</span><span class="p">(((</span><span class="s">&#39;foo&#39;</span><span class="p">,</span><span class="s">&#39;first&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;bar&#39;</span><span class="p">,</span><span class="s">&#39;second&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span><span class="s">&#39;third&#39;</span><span class="p">))))</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;whiz&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;bar&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">)),</span>
            <span class="p">[(</span><span class="s">&#39;third&#39;</span><span class="p">,</span> <span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_regression_10847</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression for #10847: the list of extra columns can always be</span>
<span class="sd">        accurately evaluated. Using an inner query ensures that as_sql() is</span>
<span class="sd">        producing correct output without requiring full evaluation and</span>
<span class="sd">        execution of the inner query.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;first&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;second&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;third&#39;</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;extra&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)),</span>
            <span class="p">[{</span><span class="s">&#39;pk&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">}]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">pk__in</span><span class="o">=</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;extra&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;TestObject: TestObject: first,second,third&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;extra&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})),</span>
            <span class="p">[{</span><span class="s">&#39;pk&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">}]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                 <span class="n">pk__in</span><span class="o">=</span><span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;extra&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
            <span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;TestObject: TestObject: first,second,third&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span> <span class="o">|</span>
               <span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;id &gt; </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">],</span> <span class="n">params</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">]),</span>
            <span class="p">[</span><span class="s">&#39;&lt;TestObject: TestObject: first,second,third&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_regression_17877</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ensure that extra WHERE clauses get correctly ANDed, even when they</span>
<span class="sd">        contain OR operations.</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Test Case 1: should appear in queryset.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Test Case 2: should appear in queryset.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Test Case 3: should not appear in queryset, bug case.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Test Case 4: should not appear in queryset.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Test Case 5: should not appear in queryset.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Test Case 6: should not appear in queryset, bug case.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">t</span> <span class="o">=</span> <span class="n">TestObject</span><span class="p">(</span><span class="n">first</span><span class="o">=</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">,</span> <span class="n">third</span><span class="o">=</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">TestObject</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span>
                <span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&quot;first = &#39;a&#39; OR second = &#39;a&#39;&quot;</span><span class="p">,</span> <span class="s">&quot;third = &#39;a&#39;&quot;</span><span class="p">],</span>
            <span class="p">),</span>
            <span class="p">[</span><span class="s">&#39;&lt;TestObject: TestObject: a,a,a&gt;&#39;</span><span class="p">,</span> <span class="s">&#39;&lt;TestObject: TestObject: b,a,a&gt;&#39;</span><span class="p">]</span>
        <span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
