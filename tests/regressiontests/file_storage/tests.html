<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › file_storage › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>-<em>- coding: utf-8 -</em>-</p></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">threading</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">dummy_threading</span> <span class="kn">as</span> <span class="nn">threading</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">SuspiciousOperation</span><span class="p">,</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.core.files.base</span> <span class="kn">import</span> <span class="n">File</span><span class="p">,</span> <span class="n">ContentFile</span>
<span class="kn">from</span> <span class="nn">django.core.files.images</span> <span class="kn">import</span> <span class="n">get_image_dimensions</span>
<span class="kn">from</span> <span class="nn">django.core.files.storage</span> <span class="kn">import</span> <span class="n">FileSystemStorage</span><span class="p">,</span> <span class="n">get_storage_class</span>
<span class="kn">from</span> <span class="nn">django.core.files.uploadedfile</span> <span class="kn">import</span> <span class="n">UploadedFile</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">SimpleTestCase</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">unittest</span>
<span class="kn">from</span> <span class="nn">..servers.tests</span> <span class="kn">import</span> <span class="n">LiveServerBase</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Try to import PIL in either of the two ways it can end up installed.
Checking for the existence of Image is enough for CPython, but
for PyPy, you need to check for the underlying modules</p></td><td class="code"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">_imaging</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">Image</span><span class="o">,</span> <span class="nn">_imaging</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">Image</span> <span class="o">=</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">GetStorageClassTests</span><span class="p">(</span><span class="n">SimpleTestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_get_filesystem_storage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_storage_class returns the class for a storage backend name/path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">get_storage_class</span><span class="p">(</span><span class="s">&#39;django.core.files.storage.FileSystemStorage&#39;</span><span class="p">),</span>
            <span class="n">FileSystemStorage</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_get_invalid_storage_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_storage_class raises an error if the requested import don&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="n">ImproperlyConfigured</span><span class="p">,</span>
            <span class="s">&quot;NonExistingStorage isn&#39;t a storage module.&quot;</span><span class="p">,</span>
            <span class="n">get_storage_class</span><span class="p">,</span>
            <span class="s">&#39;NonExistingStorage&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_get_nonexisting_storage_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_storage_class raises an error if the requested class don&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesMessage</span><span class="p">(</span>
            <span class="n">ImproperlyConfigured</span><span class="p">,</span>
            <span class="s">&#39;Storage module &quot;django.core.files.storage&quot; does not define a &#39;</span>\
                <span class="s">&#39;&quot;NonExistingStorage&quot; class.&#39;</span><span class="p">,</span>
            <span class="n">get_storage_class</span><span class="p">,</span>
            <span class="s">&#39;django.core.files.storage.NonExistingStorage&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_get_nonexisting_storage_module</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_storage_class raises an error if the requested module don&#39;t exist.</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Error message may or may not be the fully qualified path.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaisesRegexp</span><span class="p">(</span>
            <span class="n">ImproperlyConfigured</span><span class="p">,</span>
            <span class="p">(</span><span class="s">&#39;Error importing storage module django.core.files.non_existing_&#39;</span>
                <span class="s">&#39;storage: &quot;No module named .*non_existing_storage&quot;&#39;</span><span class="p">),</span>
            <span class="n">get_storage_class</span><span class="p">,</span>
            <span class="s">&#39;django.core.files.non_existing_storage.NonExistingStorage&#39;</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">FileStorageTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">storage_class</span> <span class="o">=</span> <span class="n">FileSystemStorage</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_class</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="s">&#39;/test_media_url/&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Set up a second temporary directory which is ensured to have a mixed
case name.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir2</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;aBc&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_emtpy_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes sure an exception is raised if the location is empty</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_class</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">base_location</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_file_access_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Standard file access options are available, and work as expected.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;storage_test&#39;</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;storage_test&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;storage contents&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;storage_test&#39;</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;storage_test&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s">&#39;storage contents&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;storage_test&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;storage_test&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_file_accessed_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage returns a Datetime object for the last accessed time of</span>
<span class="sd">        a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom contents&#39;</span><span class="p">)</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">atime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">accessed_time</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">atime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getatime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">f_name</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">accessed_time</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_created_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage returns a Datetime object for the creation time of</span>
<span class="sd">        a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom contents&#39;</span><span class="p">)</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">created_time</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ctime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getctime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">f_name</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">created_time</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_modified_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage returns a Datetime object for the last modified time of</span>
<span class="sd">        a file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom contents&#39;</span><span class="p">)</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
        <span class="n">mtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">modified_time</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mtime</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">f_name</span><span class="p">))))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">modified_time</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_save_without_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage extracts the filename from the content object if no</span>
<span class="sd">        name is given explicitly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom contents&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;test.file&#39;</span>

        <span class="n">storage_f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">storage_f_name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">storage_f_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_save_with_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saving a pathname should create intermediate directories as necessary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;path/to&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;path/to/test.file&#39;</span><span class="p">,</span>
            <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;file saved with path&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;path/to&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;path/to/test.file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
            <span class="n">b</span><span class="s">&#39;file saved with path&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="s">&#39;to&#39;</span><span class="p">,</span> <span class="s">&#39;test.file&#39;</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;path/to/test.file&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage returns the full path of a file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom contents&#39;</span><span class="p">)</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">f_name</span><span class="p">),</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="n">f_name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage returns a url to access a given file from the Web.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s">&#39;test.file&#39;</span><span class="p">),</span>
            <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span> <span class="s">&#39;test.file&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>should encode special chars except ~!*()'
like encodeURIComponent() JavaScript function do</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s">r&quot;&quot;&quot;~!*()&#39;@#$%^&amp;*abc`+ =.file&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="sd">&quot;&quot;&quot;/test_media_url/~!*()&#39;%40%23%24%25%5E%26*abc%60%2B%20%3D.file&quot;&quot;&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>should stanslate os path separator(s) to the url path separator</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="s">&quot;&quot;&quot;a/b</span><span class="se">\\</span><span class="s">c.file&quot;&quot;&quot;</span><span class="p">),</span>
            <span class="sd">&quot;&quot;&quot;/test_media_url/a/b/c.file&quot;&quot;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="s">&#39;test.file&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_listdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage returns a tuple containing directories and files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;storage_test_1&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;storage_test_2&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;storage_dir_1&#39;</span><span class="p">))</span>

        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;storage_test_1&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom content&#39;</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;storage_test_2&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom content&#39;</span><span class="p">))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;storage_dir_1&#39;</span><span class="p">))</span>

        <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dirs</span><span class="p">),</span> <span class="nb">set</span><span class="p">([</span><span class="s">&#39;storage_dir_1&#39;</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">),</span>
                         <span class="nb">set</span><span class="p">([</span><span class="s">&#39;storage_test_1&#39;</span><span class="p">,</span> <span class="s">&#39;storage_test_2&#39;</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;storage_test_1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;storage_test_2&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;storage_dir_1&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_file_storage_prevents_directory_traversal</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage prevents directory traversal (files can only be accessed if</span>
<span class="sd">        they&#39;re below the storage location).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">SuspiciousOperation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span> <span class="s">&#39;..&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">SuspiciousOperation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span> <span class="s">&#39;/etc/passwd&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_storage_preserves_filename_case</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The storage backend should preserve case of filenames.&quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Create a storage backend associated with the mixed case name
directory.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">temp_storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_class</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir2</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Ask that storage backend to store a file with a mixed case filename.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mixed_case</span> <span class="o">=</span> <span class="s">&#39;CaSe_SeNsItIvE&#39;</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="n">temp_storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">mixed_case</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;storage contents&#39;</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir2</span><span class="p">,</span> <span class="n">mixed_case</span><span class="p">),</span>
                         <span class="n">temp_storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">mixed_case</span><span class="p">))</span>
        <span class="n">temp_storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">mixed_case</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_makedirs_race_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage should be robust against directory creation race conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">real_makedirs</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Monkey-patch os.makedirs, to simulate a normal call, a raced call,
and an error.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">def</span> <span class="nf">fake_makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;normal&#39;</span><span class="p">):</span>
                <span class="n">real_makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;raced&#39;</span><span class="p">):</span>
                <span class="n">real_makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">,</span> <span class="s">&#39;simulated EEXIST&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;error&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="s">&#39;simulated EACCES&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;unexpected argument </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span> <span class="o">=</span> <span class="n">fake_makedirs</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;normal/test.file&#39;</span><span class="p">,</span>
                <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;saved normally&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;normal/test.file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
                <span class="n">b</span><span class="s">&#39;saved normally&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;raced/test.file&#39;</span><span class="p">,</span>
                <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;saved with race&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;raced/test.file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span>
                <span class="n">b</span><span class="s">&#39;saved with race&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Check that OSErrors aside from EEXIST are still raised.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">,</span> <span class="s">&#39;error/test.file&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;not saved&#39;</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span> <span class="o">=</span> <span class="n">real_makedirs</span>

    <span class="k">def</span> <span class="nf">test_remove_race_handling</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File storage should be robust against file removal race conditions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">real_remove</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">remove</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Monkey-patch os.remove, to simulate a normal call, a raced call,
and an error.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">def</span> <span class="nf">fake_remove</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">path</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;normal.file&#39;</span><span class="p">):</span>
                <span class="n">real_remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;raced.file&#39;</span><span class="p">):</span>
                <span class="n">real_remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="s">&#39;simulated ENOENT&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">path</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">,</span> <span class="s">&#39;error.file&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="s">&#39;simulated EACCES&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail</span><span class="p">(</span><span class="s">&#39;unexpected argument </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">fake_remove</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;normal.file&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;delete normally&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;normal.file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;normal.file&#39;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;raced.file&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;delete with race&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;raced.file&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;normal.file&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Check that OSErrors aside from ENOENT are still raised.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;error.file&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;delete with error&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">,</span> <span class="s">&#39;error.file&#39;</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">real_remove</span>


<span class="k">class</span> <span class="nc">CustomStorage</span><span class="p">(</span><span class="n">FileSystemStorage</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_available_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append numbers to duplicate files rather than underscores, like Trac.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="n">basename</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">number</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">basename</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)]</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
            <span class="n">number</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">name</span>

<span class="k">class</span> <span class="nc">CustomStorageTests</span><span class="p">(</span><span class="n">FileStorageTests</span><span class="p">):</span>
    <span class="n">storage_class</span> <span class="o">=</span> <span class="n">CustomStorage</span>

    <span class="k">def</span> <span class="nf">test_custom_get_available_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;custom_storage&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;custom contents&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="s">&#39;custom_storage&#39;</span><span class="p">)</span>
        <span class="n">second</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;custom_storage&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;more contents&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="s">&#39;custom_storage.2&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">first</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">UnicodeFileNameTests</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_unicode_file_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #8156: files with unicode names I can&#39;t quite figure</span>
<span class="sd">        out the encoding situation between doctest and this file, but the actual</span>
<span class="sd">        repr doesn&#39;t matter; it just shouldn&#39;t return a unicode object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uf</span> <span class="o">=</span> <span class="n">UploadedFile</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;¿Cómo?&#39;</span><span class="p">,</span><span class="n">content_type</span><span class="o">=</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">uf</span><span class="o">.</span><span class="n">__repr__</span><span class="p">()),</span> <span class="nb">str</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Tests for a race condition on file saving (#4948).
This is written in such a way that it'll always pass on platforms
without threading.</p></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SlowFile</span><span class="p">(</span><span class="n">ContentFile</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">ContentFile</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">chunks</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">FileSaveRaceConditionTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">FileSystemStorage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">save_file</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;conflict&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">SlowFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;Data&quot;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_race_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_file</span><span class="p">(</span><span class="s">&#39;conflict&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;conflict&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s">&#39;conflict_1&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;conflict&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="s">&#39;conflict_1&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FileStoragePermissions</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_perms</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FILE_UPLOAD_PERMISSIONS</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">FILE_UPLOAD_PERMISSIONS</span> <span class="o">=</span> <span class="mo">0666</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">FileSystemStorage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">FILE_UPLOAD_PERMISSIONS</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_perms</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file_upload_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;the_file&quot;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;data&quot;</span><span class="p">))</span>
        <span class="n">actual_mode</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">name</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mo">0777</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">actual_mode</span><span class="p">,</span> <span class="mo">0666</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FileStoragePathParsing</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">FileSystemStorage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_directory_with_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Regression test for #9610.</span>

<span class="sd">        If the directory name contains a dot and the file name doesn&#39;t, make</span>
<span class="sd">        sure we still mangle the file name instead of the directory name.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;dotted.path/test&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;dotted.path/test&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;2&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s">&#39;dotted_.path&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s">&#39;dotted.path/test&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s">&#39;dotted.path/test_1&#39;</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">test_first_character_dot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        File names with a dot as their first character don&#39;t have an extension,</span>
<span class="sd">        and the underscore should get added to the end.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;dotted.path/.test&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;1&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&#39;dotted.path/.test&#39;</span><span class="p">,</span> <span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;2&quot;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s">&#39;dotted.path/.test&#39;</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage_dir</span><span class="p">,</span> <span class="s">&#39;dotted.path/.test_1&#39;</span><span class="p">)))</span>

<span class="k">class</span> <span class="nc">DimensionClosingBug</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that get_image_dimensions() properly closes files (#8817)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="s">&quot;PIL not installed&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_not_closing_of_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open files passed into get_image_dimensions() should stay opened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">empty_io</span> <span class="o">=</span> <span class="n">BytesIO</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">get_image_dimensions</span><span class="p">(</span><span class="n">empty_io</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="ow">not</span> <span class="n">empty_io</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span>

    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="s">&quot;PIL not installed&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_closing_of_filenames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        get_image_dimensions() called with a filename should closed the file.</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>We need to inject a modified open() builtin into the images module
that checks if the file was closed properly if the function is
called with a filename instead of an file object.
get<em>image</em>dimensions will call our catching_open instead of the
regular builtin one.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">class</span> <span class="nc">FileWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="n">_closed</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
            <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">catching_open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">FileWrapper</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>

        <span class="kn">from</span> <span class="nn">django.core.files</span> <span class="kn">import</span> <span class="n">images</span>
        <span class="n">images</span><span class="o">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">catching_open</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">get_image_dimensions</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;test1.png&quot;</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">images</span><span class="o">.</span><span class="n">open</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">FileWrapper</span><span class="o">.</span><span class="n">_closed</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">InconsistentGetImageDimensionsBug</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that get_image_dimensions() works properly after various calls</span>
<span class="sd">    using a file handler (#11158)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@unittest.skipUnless</span><span class="p">(</span><span class="n">Image</span><span class="p">,</span> <span class="s">&quot;PIL not installed&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_multiple_calls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Multiple calls of get_image_dimensions() should return the same size.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">django.core.files.images</span> <span class="kn">import</span> <span class="n">ImageFile</span>

        <span class="n">img_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="s">&quot;test.png&quot;</span><span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ImageFile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">))</span>
        <span class="n">image_pil</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">img_path</span><span class="p">)</span>
        <span class="n">size_1</span><span class="p">,</span> <span class="n">size_2</span> <span class="o">=</span> <span class="n">get_image_dimensions</span><span class="p">(</span><span class="n">image</span><span class="p">),</span> <span class="n">get_image_dimensions</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">image_pil</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">size_1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">size_1</span><span class="p">,</span> <span class="n">size_2</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">ContentFileTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test that the constructor of ContentFile accepts &#39;name&#39; (#16590).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">test_content_file_default_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;content&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_content_file_custom_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s">&quot;I can have a name too!&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ContentFile</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;content&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">NoNameFileTestCase</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Other examples of unnamed files may be tempfile.SpooledTemporaryFile or</span>
<span class="sd">    urllib.urlopen()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">test_noname_file_default_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;A file with no name&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_noname_file_get_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">File</span><span class="p">(</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;A file with no name&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">19</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">FileLikeObjectTestCase</span><span class="p">(</span><span class="n">LiveServerBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test file-like objects (#15644).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">FileSystemStorage</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_urllib2_urlopen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test the File storage API with a file like object coming from urllib2.urlopen()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file_like_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;/example_view/&#39;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">file_like_object</span><span class="p">)</span>
        <span class="n">stored_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">&quot;remote_file.html&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="n">stored_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">stored_filename</span><span class="p">)</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;/example_view/&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">stored_file</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">remote_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
