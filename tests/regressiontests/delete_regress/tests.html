<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › delete_regress › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">backend</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">TransactionTestCase</span><span class="p">,</span> <span class="n">skipUnlessDBFeature</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Book</span><span class="p">,</span> <span class="n">Award</span><span class="p">,</span> <span class="n">AwardNote</span><span class="p">,</span> <span class="n">Person</span><span class="p">,</span> <span class="n">Child</span><span class="p">,</span> <span class="n">Toy</span><span class="p">,</span> <span class="n">PlayedWith</span><span class="p">,</span>
    <span class="n">PlayedWithNote</span><span class="p">,</span> <span class="n">Email</span><span class="p">,</span> <span class="n">Researcher</span><span class="p">,</span> <span class="n">Food</span><span class="p">,</span> <span class="n">Eaten</span><span class="p">,</span> <span class="n">Policy</span><span class="p">,</span> <span class="n">Version</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span>
    <span class="n">Item</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="n">File</span><span class="p">,</span> <span class="n">Photo</span><span class="p">,</span> <span class="n">FooFile</span><span class="p">,</span> <span class="n">FooImage</span><span class="p">,</span> <span class="n">FooPhoto</span><span class="p">,</span> <span class="n">FooFileProxy</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Can't run this test under SQLite, because you can't
get two connections to an in-memory database.</p></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">DeleteLockingTest</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Create a second connection to the default database</p></td><td class="code"><div class="highlight"><pre>        <span class="n">conn_settings</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATABASES</span><span class="p">[</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn2</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">DatabaseWrapper</span><span class="p">({</span>
            <span class="s">&#39;HOST&#39;</span><span class="p">:</span> <span class="n">conn_settings</span><span class="p">[</span><span class="s">&#39;HOST&#39;</span><span class="p">],</span>
            <span class="s">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">conn_settings</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">],</span>
            <span class="s">&#39;OPTIONS&#39;</span><span class="p">:</span> <span class="n">conn_settings</span><span class="p">[</span><span class="s">&#39;OPTIONS&#39;</span><span class="p">],</span>
            <span class="s">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="n">conn_settings</span><span class="p">[</span><span class="s">&#39;PASSWORD&#39;</span><span class="p">],</span>
            <span class="s">&#39;PORT&#39;</span><span class="p">:</span> <span class="n">conn_settings</span><span class="p">[</span><span class="s">&#39;PORT&#39;</span><span class="p">],</span>
            <span class="s">&#39;USER&#39;</span><span class="p">:</span> <span class="n">conn_settings</span><span class="p">[</span><span class="s">&#39;USER&#39;</span><span class="p">],</span>
            <span class="s">&#39;TIME_ZONE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">TIME_ZONE</span><span class="p">,</span>
        <span class="p">})</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Put both DB connections into managed transaction mode</p></td><td class="code"><div class="highlight"><pre>        <span class="n">transaction</span><span class="o">.</span><span class="n">enter_transaction_management</span><span class="p">()</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">managed</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn2</span><span class="o">.</span><span class="n">_enter_transaction_management</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Close down the second connection.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">transaction</span><span class="o">.</span><span class="n">leave_transaction_management</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn2</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@skipUnlessDBFeature</span><span class="p">(</span><span class="s">&#39;test_db_allows_multiple_connections&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_concurrent_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Deletes on concurrent transactions don&#39;t collide and lock the database. Regression for #9479&quot;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Create some dummy data</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b1</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">pagecount</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">pagecount</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
        <span class="n">b3</span> <span class="o">=</span> <span class="n">Book</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">pagecount</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
        <span class="n">b1</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">b2</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">b3</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Delete something using connection 2.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">cursor2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conn2</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">cursor2</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;DELETE from delete_regress_book WHERE id=1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn2</span><span class="o">.</span><span class="n">_commit</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Now perform a queryset delete that covers the object
deleted in connection 2. This causes an infinite loop
under MySQL InnoDB unless we keep track of already
deleted objects.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pagecount__lt</span><span class="o">=</span><span class="mi">250</span><span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">())</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DeleteCascadeTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_generic_relation_cascade</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Django cascades deletes through generic-related objects to their</span>
<span class="sd">        reverse relations.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">person</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Nelson Mandela&#39;</span><span class="p">)</span>
        <span class="n">award</span> <span class="o">=</span> <span class="n">Award</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Nobel&#39;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="n">person</span><span class="p">)</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">AwardNote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">note</span><span class="o">=</span><span class="s">&#39;a peace prize&#39;</span><span class="p">,</span>
                                        <span class="n">award</span><span class="o">=</span><span class="n">award</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">AwardNote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">person</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Award</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>first two asserts are just sanity checks, this is the kicker:</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">AwardNote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_fk_to_m2m_through</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If an M2M relationship has an explicitly-specified through model, and</span>
<span class="sd">        some other model has an FK to that through model, deletion is cascaded</span>
<span class="sd">        from one of the participants in the M2M, to the through model, to its</span>
<span class="sd">        related model.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">juan</span> <span class="o">=</span> <span class="n">Child</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Juan&#39;</span><span class="p">)</span>
        <span class="n">paints</span> <span class="o">=</span> <span class="n">Toy</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Paints&#39;</span><span class="p">)</span>
        <span class="n">played</span> <span class="o">=</span> <span class="n">PlayedWith</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">child</span><span class="o">=</span><span class="n">juan</span><span class="p">,</span> <span class="n">toy</span><span class="o">=</span><span class="n">paints</span><span class="p">,</span>
                                           <span class="n">date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">())</span>
        <span class="n">note</span> <span class="o">=</span> <span class="n">PlayedWithNote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">played</span><span class="o">=</span><span class="n">played</span><span class="p">,</span>
                                             <span class="n">note</span><span class="o">=</span><span class="s">&#39;the next Jackson Pollock&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">PlayedWithNote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">paints</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">PlayedWith</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>first two asserts just sanity checks, this is the kicker:</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">PlayedWithNote</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_15776</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">policy</span> <span class="o">=</span> <span class="n">Policy</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">policy_number</span><span class="o">=</span><span class="s">&quot;1234&quot;</span><span class="p">)</span>
        <span class="n">version</span> <span class="o">=</span> <span class="n">Version</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">policy</span><span class="o">=</span><span class="n">policy</span><span class="p">)</span>
        <span class="n">location</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
        <span class="n">policy</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">DeleteCascadeTransactionTests</span><span class="p">(</span><span class="n">TransactionTestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Auto-created many-to-many through tables referencing a parent model are</span>
<span class="sd">        correctly found by the delete cascade when a child of that parent is</span>
<span class="sd">        deleted.</span>

<span class="sd">        Refs #14896.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">Researcher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">email</span> <span class="o">=</span> <span class="n">Email</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">label</span><span class="o">=</span><span class="s">&quot;office-email&quot;</span><span class="p">,</span> <span class="n">email_address</span><span class="o">=</span><span class="s">&quot;carl@science.edu&quot;</span>
        <span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">contacts</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>

        <span class="n">email</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_to_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cascade deletion works with ForeignKey.to_field set to non-PK.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">apple</span> <span class="o">=</span> <span class="n">Food</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;apple&quot;</span><span class="p">)</span>
        <span class="n">eaten</span> <span class="o">=</span> <span class="n">Eaten</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">food</span><span class="o">=</span><span class="n">apple</span><span class="p">,</span> <span class="n">meal</span><span class="o">=</span><span class="s">&quot;lunch&quot;</span><span class="p">)</span>

        <span class="n">apple</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">LargeDeleteTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_large_deletes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Regression for #13309 -- if the number of objects &gt; chunk size, deletion still occurs&quot;</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">300</span><span class="p">):</span>
            <span class="n">track</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">pagecount</span><span class="o">=</span><span class="n">x</span><span class="o">+</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>



<span class="k">class</span> <span class="nc">ProxyDeleteTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tests on_delete behavior for proxy models.</span>

<span class="sd">    See #16128.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">create_image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an Image referenced by both a FooImage and a FooFile.&quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Create an Image</p></td><td class="code"><div class="highlight"><pre>        <span class="n">test_image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">()</span>
        <span class="n">test_image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">foo_image</span> <span class="o">=</span> <span class="n">FooImage</span><span class="p">(</span><span class="n">my_image</span><span class="o">=</span><span class="n">test_image</span><span class="p">)</span>
        <span class="n">foo_image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Get the Image instance as a File</p></td><td class="code"><div class="highlight"><pre>        <span class="n">test_file</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">test_image</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">foo_file</span> <span class="o">=</span> <span class="n">FooFile</span><span class="p">(</span><span class="n">my_file</span><span class="o">=</span><span class="n">test_file</span><span class="p">)</span>
        <span class="n">foo_file</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">test_image</span>


    <span class="k">def</span> <span class="nf">test_delete_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deleting the *proxy* instance bubbles through to its non-proxy and</span>
<span class="sd">        *all* referring objects are deleted.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_image</span><span class="p">()</span>

        <span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>An Image deletion == File deletion</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>The Image deletion cascaded and <em>all</em> references to it are deleted.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooImage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_delete_proxy_of_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deleting a proxy-of-proxy instance should bubble through to its proxy</span>
<span class="sd">        and non-proxy parents, deleting *all* referring objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">test_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_image</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Get the Image as a Photo</p></td><td class="code"><div class="highlight"><pre>        <span class="n">test_photo</span> <span class="o">=</span> <span class="n">Photo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">test_image</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">foo_photo</span> <span class="o">=</span> <span class="n">FooPhoto</span><span class="p">(</span><span class="n">my_photo</span><span class="o">=</span><span class="n">test_photo</span><span class="p">)</span>
        <span class="n">foo_photo</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="n">Photo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>A Photo deletion == Image deletion == File deletion</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Photo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>The Photo deletion should have cascaded and deleted <em>all</em>
references to it.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooPhoto</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooImage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_delete_concrete_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deleting an instance of a concrete model should also delete objects</span>
<span class="sd">        referencing its proxy subclass.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_image</span><span class="p">()</span>

        <span class="n">File</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>A File deletion == Image deletion</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>The File deletion should have cascaded and deleted <em>all</em> references
to it.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooFile</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooImage</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_delete_proxy_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If a pair of proxy models are linked by an FK from one concrete parent</span>
<span class="sd">        to the other, deleting one proxy model cascade-deletes the other, and</span>
<span class="sd">        the deletion happens in the right order (not triggering an</span>
<span class="sd">        IntegrityError on databases unable to defer integrity checks).</span>

<span class="sd">        Refs #17918.</span>

<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Create an Image (proxy of File) and FooFileProxy (proxy of FooFile,
which has an FK to File)</p></td><td class="code"><div class="highlight"><pre>        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">as_file</span> <span class="o">=</span> <span class="n">File</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">image</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="n">FooFileProxy</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">my_file</span><span class="o">=</span><span class="n">as_file</span><span class="p">)</span>

        <span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FooFileProxy</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()),</span> <span class="mi">0</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
