<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › aggregation_regress › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">attrgetter</span>

<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">FieldError</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">Sum</span><span class="p">,</span> <span class="n">StdDev</span><span class="p">,</span> <span class="n">Variance</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Q</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">Approximate</span><span class="p">,</span> <span class="n">skipUnlessDBFeature</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Author</span><span class="p">,</span> <span class="n">Book</span><span class="p">,</span> <span class="n">Publisher</span><span class="p">,</span> <span class="n">Clues</span><span class="p">,</span> <span class="n">Entries</span><span class="p">,</span> <span class="n">HardbackBook</span>


<span class="k">class</span> <span class="nc">AggregationTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">fixtures</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;aggregation_regress.json&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">assertObjectAttrs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">),</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_aggregates_in_where_clause</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #12822: DatabaseError: aggregates not allowed in</span>
<span class="sd">        WHERE clause</span>

<span class="sd">        Tests that the subselect works and returns results equivalent to a</span>
<span class="sd">        query with the IDs listed.</span>

<span class="sd">        Before the corresponding fix for this bug, this test passed in 1.1 and</span>
<span class="sd">        failed in 1.2-beta (trunk).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;contact&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;contact&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id__max&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>don't do anything with the queryset (qs) before including it as a
subquery</p></td><td class="code"><div class="highlight"><pre>        <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">qs1</span> <span class="o">=</span> <span class="n">books</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
        <span class="n">qs2</span> <span class="o">=</span> <span class="n">books</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs1</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">qs2</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_aggregates_in_where_clause_pre_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #12822: DatabaseError: aggregates not allowed in</span>
<span class="sd">        WHERE clause</span>

<span class="sd">        Same as the above test, but evaluates the queryset for the subquery</span>
<span class="sd">        before it&#39;s used as a subquery.</span>

<span class="sd">        Before the corresponding fix for this bug, this test failed in both</span>
<span class="sd">        1.1 and 1.2-beta (trunk).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;contact&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;contact&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;id__max&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>force the queryset (qs) for the subquery to be evaluated in its
current state</p></td><td class="code"><div class="highlight"><pre>        <span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
        <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">qs1</span> <span class="o">=</span> <span class="n">books</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">qs</span><span class="p">)</span>
        <span class="n">qs2</span> <span class="o">=</span> <span class="n">books</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs1</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">qs2</span><span class="p">))</span>

    <span class="nd">@skipUnlessDBFeature</span><span class="p">(</span><span class="s">&#39;supports_subqueries_in_group_by&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_annotate_with_extra</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Regression test for #11916: Extra params + aggregation creates</span>
<span class="sd">        incorrect SQL.</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>oracle doesn't support subqueries in group by clause</p></td><td class="code"><div class="highlight"><pre>        <span class="n">shortest_book_sql</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        SELECT name</span>
<span class="s">        FROM aggregation_regress_book b</span>
<span class="s">        WHERE b.publisher_id = aggregation_regress_publisher.id</span>
<span class="s">        ORDER BY b.pages</span>
<span class="s">        LIMIT 1</span>
<span class="s">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>tests that this query does not raise a DatabaseError due to the full
subselect being (erroneously) added to the GROUP BY parameters</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span>
            <span class="s">&#39;name_of_shortest_book&#39;</span><span class="p">:</span> <span class="n">shortest_book_sql</span><span class="p">,</span>
        <span class="p">})</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">total_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>force execution of the query</p></td><td class="code"><div class="highlight"><pre>        <span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Ordering requests are ignored</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s">&quot;age&quot;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&quot;age__avg&quot;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">37.444</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Implicit ordering is also ignored</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s">&quot;pages&quot;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&quot;pages__sum&quot;</span><span class="p">:</span> <span class="mi">3703</span><span class="p">},</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Baseline results</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">),</span> <span class="n">Avg</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;pages__sum&#39;</span><span class="p">:</span> <span class="mi">3703</span><span class="p">,</span> <span class="s">&#39;pages__avg&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">617.166</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)}</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Empty values query doesn't affect grouping or results</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">),</span> <span class="n">Avg</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;pages__sum&#39;</span><span class="p">:</span> <span class="mi">3703</span><span class="p">,</span> <span class="s">&#39;pages__avg&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">617.166</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">)}</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Aggregate overrides extra selected column</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;price_per_page&#39;</span> <span class="p">:</span> <span class="s">&#39;price / pages&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;pages__sum&#39;</span><span class="p">:</span> <span class="mi">3703</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Annotations get combined with extra select clauses</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&quot;authors__age&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;manufacture_cost&quot;</span><span class="p">:</span> <span class="s">&quot;price * .5&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertObjectAttrs</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
            <span class="n">contact_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">isbn</span><span class="o">=</span><span class="s">&#39;067232959&#39;</span><span class="p">,</span>
            <span class="n">mean_auth_age</span><span class="o">=</span><span class="mf">45.0</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;Sams Teach Yourself Django in 24 Hours&#39;</span><span class="p">,</span>
            <span class="n">pages</span><span class="o">=</span><span class="mi">528</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;23.09&quot;</span><span class="p">),</span>
            <span class="n">pubdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">publisher_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">rating</span><span class="o">=</span><span class="mf">3.0</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Different DB backends return different types for the extra select computation</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">manufacture_cost</span> <span class="o">==</span> <span class="mf">11.545</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">manufacture_cost</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;11.545&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Order of the annotate/extra in the query doesn't matter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;manufacture_cost&#39;</span> <span class="p">:</span> <span class="s">&#39;price * .5&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertObjectAttrs</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span>
            <span class="n">contact_id</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="nb">id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">isbn</span><span class="o">=</span><span class="s">&#39;067232959&#39;</span><span class="p">,</span>
            <span class="n">mean_auth_age</span><span class="o">=</span><span class="mf">45.0</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;Sams Teach Yourself Django in 24 Hours&#39;</span><span class="p">,</span>
            <span class="n">pages</span><span class="o">=</span><span class="mi">528</span><span class="p">,</span>
            <span class="n">price</span><span class="o">=</span><span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;23.09&quot;</span><span class="p">),</span>
            <span class="n">pubdate</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="n">publisher_id</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">rating</span><span class="o">=</span><span class="mf">3.0</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Different DB backends return different types for the extra select computation</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">manufacture_cost</span> <span class="o">==</span> <span class="mf">11.545</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">manufacture_cost</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;11.545&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Values queries can be combined with annotate and extra</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;manufacture_cost&#39;</span> <span class="p">:</span> <span class="s">&#39;price * .5&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">manufacture_cost</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;manufacture_cost&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">manufacture_cost</span> <span class="o">==</span> <span class="mf">11.545</span> <span class="ow">or</span> <span class="n">manufacture_cost</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;11.545&#39;</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;manufacture_cost&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&quot;contact_id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s">&quot;id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">&quot;isbn&quot;</span><span class="p">:</span> <span class="s">&quot;067232959&quot;</span><span class="p">,</span>
            <span class="s">&quot;mean_auth_age&quot;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span>
            <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;Sams Teach Yourself Django in 24 Hours&quot;</span><span class="p">,</span>
            <span class="s">&quot;pages&quot;</span><span class="p">:</span> <span class="mi">528</span><span class="p">,</span>
            <span class="s">&quot;price&quot;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;23.09&quot;</span><span class="p">),</span>
            <span class="s">&quot;pubdate&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s">&quot;publisher_id&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">&quot;rating&quot;</span><span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="p">})</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>The order of the (empty) values, annotate and extra clauses doesn't
matter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;manufacture_cost&#39;</span> <span class="p">:</span> <span class="s">&#39;price * .5&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">manufacture_cost</span> <span class="o">=</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;manufacture_cost&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">manufacture_cost</span> <span class="o">==</span> <span class="mf">11.545</span> <span class="ow">or</span> <span class="n">manufacture_cost</span> <span class="o">==</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&#39;11.545&#39;</span><span class="p">))</span>
        <span class="k">del</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;manufacture_cost&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;contact_id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">&#39;isbn&#39;</span><span class="p">:</span> <span class="s">&#39;067232959&#39;</span><span class="p">,</span>
            <span class="s">&#39;mean_auth_age&#39;</span><span class="p">:</span> <span class="mf">45.0</span><span class="p">,</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Sams Teach Yourself Django in 24 Hours&#39;</span><span class="p">,</span>
            <span class="s">&#39;pages&#39;</span><span class="p">:</span> <span class="mi">528</span><span class="p">,</span>
            <span class="s">&#39;price&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;23.09&quot;</span><span class="p">),</span>
            <span class="s">&#39;pubdate&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2008</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="s">&#39;publisher_id&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">&#39;rating&#39;</span><span class="p">:</span> <span class="mf">3.0</span>
        <span class="p">})</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>If the annotation precedes the values clause, it won't be included
unless it is explicitly named</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;price_per_page&#39;</span> <span class="p">:</span> <span class="s">&#39;price / pages&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&#39;The Definitive Guide to Django: Web Development Done Right&#39;</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;price_per_page&#39;</span> <span class="p">:</span> <span class="s">&#39;price / pages&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;mean_auth_age&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;mean_auth_age&#39;</span><span class="p">:</span> <span class="mf">34.5</span><span class="p">,</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;The Definitive Guide to Django: Web Development Done Right&#39;</span><span class="p">,</span>
        <span class="p">})</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>If an annotation isn't included in the values, it can still be used
in a filter</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">n_authors__gt</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&#39;Python Web Development with Django&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>The annotations are added to values output if values() precedes
annotate()</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;price_per_page&#39;</span> <span class="p">:</span> <span class="s">&#39;price / pages&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;mean_auth_age&#39;</span><span class="p">:</span> <span class="mf">34.5</span><span class="p">,</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;The Definitive Guide to Django: Web Development Done Right&#39;</span><span class="p">,</span>
        <span class="p">})</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Check that all of the objects are getting counted (allow_nulls) and
that values respects the amount of objects</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;friends__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
            <span class="mi">9</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Check that consecutive calls to annotate accumulate in the query</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;price&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">oldest</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;oldest&#39;</span><span class="p">,</span> <span class="s">&#39;price&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;publisher__num_awards&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;price&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;30&quot;</span><span class="p">),</span> <span class="s">&#39;oldest&#39;</span><span class="p">:</span> <span class="mi">35</span><span class="p">,</span> <span class="s">&#39;publisher__num_awards__max&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;price&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;29.69&quot;</span><span class="p">),</span> <span class="s">&#39;oldest&#39;</span><span class="p">:</span> <span class="mi">37</span><span class="p">,</span> <span class="s">&#39;publisher__num_awards__max&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;price&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;23.09&quot;</span><span class="p">),</span> <span class="s">&#39;oldest&#39;</span><span class="p">:</span> <span class="mi">45</span><span class="p">,</span> <span class="s">&#39;publisher__num_awards__max&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;price&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;75&quot;</span><span class="p">),</span> <span class="s">&#39;oldest&#39;</span><span class="p">:</span> <span class="mi">57</span><span class="p">,</span> <span class="s">&#39;publisher__num_awards__max&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;price&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;82.8&quot;</span><span class="p">),</span> <span class="s">&#39;oldest&#39;</span><span class="p">:</span> <span class="mi">57</span><span class="p">,</span> <span class="s">&#39;publisher__num_awards__max&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_aggrate_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Aggregates can be composed over annotations.
The return type is derived from the composed aggregate</p></td><td class="code"><div class="highlight"><pre>        <span class="n">vals</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors__id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">),</span> <span class="n">Max</span><span class="p">(</span><span class="s">&#39;price&#39;</span><span class="p">),</span> <span class="n">Sum</span><span class="p">(</span><span class="s">&#39;num_authors&#39;</span><span class="p">),</span> <span class="n">Avg</span><span class="p">(</span><span class="s">&#39;num_authors&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;num_authors__sum&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s">&#39;num_authors__avg&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">1.666</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="s">&#39;pages__max&#39;</span><span class="p">:</span> <span class="mi">1132</span><span class="p">,</span>
            <span class="s">&#39;price__max&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;82.80&quot;</span><span class="p">)</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="nf">test_field_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Bad field requests in aggregates are caught and reported</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">FieldError</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">FieldError</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">FieldError</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors__id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_more</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Old-style count aggregations can be mixed with new-style</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">6</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Non-ordinal, non-computed Aggregates over annotations correctly
inherit the annotation's internal type if the annotation is ordinal
or computed</p></td><td class="code"><div class="highlight"><pre>        <span class="n">vals</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;num_authors&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">vals</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;num_authors__max&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">avg_price</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;book__price&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;avg_price&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">vals</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;avg_price__max&#39;</span><span class="p">:</span> <span class="mf">75.0</span><span class="p">}</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Aliases are quoted to protected aliases that might be reserved names</p></td><td class="code"><div class="highlight"><pre>        <span class="n">vals</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">number</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">),</span> <span class="n">select</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">vals</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;number&#39;</span><span class="p">:</span> <span class="mi">1132</span><span class="p">,</span> <span class="s">&#39;select&#39;</span><span class="p">:</span> <span class="mi">1132</span><span class="p">}</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Regression for #10064: select_related() plays nice with aggregates</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;contact_id&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
            <span class="s">&#39;isbn&#39;</span><span class="p">:</span> <span class="s">&#39;013790395&#39;</span><span class="p">,</span>
            <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Artificial Intelligence: A Modern Approach&#39;</span><span class="p">,</span>
            <span class="s">&#39;num_authors&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s">&#39;pages&#39;</span><span class="p">:</span> <span class="mi">1132</span><span class="p">,</span>
            <span class="s">&#39;price&#39;</span><span class="p">:</span> <span class="n">Decimal</span><span class="p">(</span><span class="s">&quot;82.8&quot;</span><span class="p">),</span>
            <span class="s">&#39;pubdate&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1995</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
            <span class="s">&#39;publisher_id&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
            <span class="s">&#39;rating&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
        <span class="p">})</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>Regression for #10010: exclude on an aggregate field is correctly
negated</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))),</span>
            <span class="mi">6</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_authors__gt</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
            <span class="mi">1</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">num_authors__gt</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
            <span class="mi">5</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_authors__lt</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">num_authors__lt</span><span class="o">=</span><span class="mi">2</span><span class="p">)),</span>
            <span class="mi">2</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">num_authors__lt</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_authors__lt</span><span class="o">=</span><span class="mi">3</span><span class="p">)),</span>
            <span class="mi">2</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_aggregate_fexpr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Aggregates can be used with F() expressions
... where the F() is pushed into the HAVING clause</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_books__lt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;num_awards&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;num_books&#39;</span><span class="p">,</span><span class="s">&#39;num_awards&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Morgan Kaufmann&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Prentice Hall&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">num_books__lt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;num_awards&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;num_books&#39;</span><span class="p">,</span><span class="s">&#39;num_awards&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Apress&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&quot;Jonno&#39;s House of Books&quot;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Sams&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>... and where the F() references an aggregate</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_awards__gt</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;num_books&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;num_books&#39;</span><span class="p">,</span><span class="s">&#39;num_awards&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Morgan Kaufmann&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Prentice Hall&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">num_books__lt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;num_awards&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span><span class="s">&#39;num_books&#39;</span><span class="p">,</span><span class="s">&#39;num_awards&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Apress&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&quot;Jonno&#39;s House of Books&quot;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;num_books&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Sams&#39;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_db_col_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Tests on fields with non-default table and column names.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Clues</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;EntryID__Entry&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Appearances</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;EntryID&#39;</span><span class="p">),</span> <span class="n">Distinct_Clues</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;Clue&#39;</span><span class="p">,</span> <span class="n">distinct</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Entries</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">clue_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;clues__ID&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span> <span class="nf">test_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>Regression for #10089: Check handling of empty result sets with
aggregates</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">0</span>
        <span class="p">)</span>

        <span class="n">vals</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">),</span> <span class="n">avg_authors</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">),</span> <span class="n">max_authors</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">),</span> <span class="n">max_price</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;price&#39;</span><span class="p">),</span> <span class="n">max_rating</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">vals</span><span class="p">,</span>
            <span class="p">{</span><span class="s">&#39;max_authors&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;max_rating&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;num_authors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;avg_authors&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;max_price&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book__authors&#39;</span><span class="p">),</span> <span class="n">avg_authors</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;book__authors&#39;</span><span class="p">),</span> <span class="n">max_authors</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;book__authors&#39;</span><span class="p">),</span> <span class="n">max_price</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;book__price&#39;</span><span class="p">),</span> <span class="n">max_rating</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;book__rating&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;max_authors&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&quot;Jonno&#39;s House of Books&quot;</span><span class="p">,</span> <span class="s">&#39;num_awards&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;max_price&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;num_authors&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#39;max_rating&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;avg_authors&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_more_more</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>Regression for #10113 - Fields mentioned in order<em>by() must be
included in the GROUP BY. This only becomes a problem when the
order</em>by introduces a new join.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;publisher__name&#39;</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Practical Django Projects&quot;</span><span class="p">,</span>
                <span class="s">&quot;The Definitive Guide to Django: Web Development Done Right&quot;</span><span class="p">,</span>
                <span class="s">&quot;Paradigms of Artificial Intelligence Programming: Case Studies in Common Lisp&quot;</span><span class="p">,</span>
                <span class="s">&quot;Artificial Intelligence: A Modern Approach&quot;</span><span class="p">,</span>
                <span class="s">&quot;Python Web Development with Django&quot;</span><span class="p">,</span>
                <span class="s">&quot;Sams Teach Yourself Django in 24 Hours&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>Regression for #10127 - Empty select_related() works with annotate</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">rating__lt</span><span class="o">=</span><span class="mf">4.5</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&#39;Artificial Intelligence: A Modern Approach&#39;</span><span class="p">,</span> <span class="mf">51.5</span><span class="p">,</span> <span class="s">&#39;Prentice Hall&#39;</span><span class="p">,</span> <span class="s">&#39;Peter Norvig&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;Practical Django Projects&#39;</span><span class="p">,</span> <span class="mf">29.0</span><span class="p">,</span> <span class="s">&#39;Apress&#39;</span><span class="p">,</span> <span class="s">&#39;James Bennett&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;Python Web Development with Django&#39;</span><span class="p">,</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">30.333</span><span class="p">,</span> <span class="n">places</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="s">&#39;Prentice Hall&#39;</span><span class="p">,</span> <span class="s">&#39;Jeffrey Forcier&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s">&#39;Sams Teach Yourself Django in 24 Hours&#39;</span><span class="p">,</span> <span class="mf">45.0</span><span class="p">,</span> <span class="s">&#39;Sams&#39;</span><span class="p">,</span> <span class="s">&#39;Brad Dayley&#39;</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">authors__age__avg</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">publisher</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">contact</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>Regression for #10132 - If the values() clause only mentioned extra
(select=) columns, those columns are used for grouping</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span><span class="s">&#39;publisher_id&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;pub&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;pub&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span><span class="s">&#39;publisher_id&#39;</span><span class="p">,</span> <span class="s">&#39;foo&#39;</span><span class="p">:</span><span class="s">&#39;pages&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;pub&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;pub&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;pub&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&#39;id__count&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>Regression for #10182 - Queries with aggregate calls are correctly
realiased when used in a subquery</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ids</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pages__gt</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">n_authors__gt</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;n_authors&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="n">ids</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Python Web Development with Django&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>Regression for #15709 - Ensure each group_by field only exists once
per query</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">max_pages</span><span class="o">=</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">()</span>
        <span class="n">grouping</span><span class="p">,</span> <span class="n">gb_params</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">get_grouping</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">grouping</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_duplicate_alias</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>Regression for #11256 - duplicating a default alias raises ValueError.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">,</span> <span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">),</span> <span class="n">authors__age__avg</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_field_name_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>Regression for #11256 - providing an aggregate name that conflicts with a field name on the model raises ValueError</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;friends__age&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_m2m_name_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>Regression for #11256 - providing an aggregate name that conflicts with an m2m name on the model raises ValueError</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">,</span> <span class="n">friends</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;friends&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_values_queryset_non_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>Regression for #14707 -- If you're using a values query set, some potential conflicts are avoided.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>age is a field on Author, so it shouldn't be allowed as an aggregate.
But age isn't included in the ValuesQuerySet, so it is.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">results</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book_contact_set&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="s">&#39;Adrian Holovaty&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;age&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>Same problem, but aggregating over m2m fields</p></td><td class="code"><div class="highlight"><pre>        <span class="n">results</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;friends__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="s">&#39;Adrian Holovaty&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;age&#39;</span><span class="p">],</span> <span class="mf">32.0</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>Same problem, but colliding with an m2m field</p></td><td class="code"><div class="highlight"><pre>        <span class="n">results</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">friends</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;friends&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="mi">9</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="s">&#39;Adrian Holovaty&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;friends&#39;</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_reverse_relation_name_conflict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>Regression for #11256 - providing an aggregate name that conflicts with a reverse-related name on the model raises ValueError</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">,</span> <span class="n">book_contact_set</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;friends__age&#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>Regression for #10197 -- Queries with aggregates can be pickled.
First check that pickling is possible at all. No crash = success</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-48"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-48">&#182;</a></div><p>Then check that the round trip works.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">query</span> <span class="o">=</span> <span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">qs2</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">qs2</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get_compiler</span><span class="p">(</span><span class="n">qs2</span><span class="o">.</span><span class="n">db</span><span class="p">)</span><span class="o">.</span><span class="n">as_sql</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">query</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_more_more_more</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-49"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-49">&#182;</a></div><p>Regression for #10199 - Aggregate calls clone the original query so
the original query can still be used</p></td><td class="code"><div class="highlight"><pre>        <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">books</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s">&quot;authors__age&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span>
                <span class="s">&#39;Artificial Intelligence: A Modern Approach&#39;</span><span class="p">,</span>
                <span class="s">&#39;Paradigms of Artificial Intelligence Programming: Case Studies in Common Lisp&#39;</span><span class="p">,</span>
                <span class="s">&#39;Practical Django Projects&#39;</span><span class="p">,</span>
                <span class="s">&#39;Python Web Development with Django&#39;</span><span class="p">,</span>
                <span class="s">&#39;Sams Teach Yourself Django in 24 Hours&#39;</span><span class="p">,</span>
                <span class="s">&#39;The Definitive Guide to Django: Web Development Done Right&#39;</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-50"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-50">&#182;</a></div><p>Regression for #10248 - Annotations work with DateQuerySets</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;pubdate&#39;</span><span class="p">,</span> <span class="s">&#39;day&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1995</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2007</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-51"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-51">&#182;</a></div><p>Regression for #10290 - extra selects with parameters can be used for
grouping.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_auth_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">select</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;sheets&#39;</span> <span class="p">:</span> <span class="s">&#39;(pages + </span><span class="si">%s</span><span class="s">) / </span><span class="si">%s</span><span class="s">&#39;</span><span class="p">},</span> <span class="n">select_params</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;sheets&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;sheets&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="mi">150</span><span class="p">,</span>
                <span class="mi">175</span><span class="p">,</span>
                <span class="mi">224</span><span class="p">,</span>
                <span class="mi">264</span><span class="p">,</span>
                <span class="mi">473</span><span class="p">,</span>
                <span class="mi">566</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s">&quot;sheets&quot;</span><span class="p">])</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-52"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-52">&#182;</a></div><p>Regression for 10425 - annotations don't get in the way of a count()
clause</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;publisher&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">4</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;publisher&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;publisher&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">6</span>
        <span class="p">)</span>

        <span class="n">publishers</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">),</span>
            <span class="p">[</span>
                <span class="s">&quot;Apress&quot;</span><span class="p">,</span>
                <span class="s">&quot;Sams&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">publishers</span> <span class="o">=</span> <span class="n">publishers</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;book&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">publishers</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">n_books</span><span class="p">,</span>
            <span class="mi">2</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">),</span>
            <span class="p">[</span>
                <span class="s">&quot;Apress&quot;</span><span class="p">,</span>
                <span class="s">&quot;Sams&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">books</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">publisher__in</span><span class="o">=</span><span class="n">publishers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">books</span><span class="p">,</span> <span class="p">[</span>
                <span class="s">&quot;Practical Django Projects&quot;</span><span class="p">,</span>
                <span class="s">&quot;Sams Teach Yourself Django in 24 Hours&quot;</span><span class="p">,</span>
                <span class="s">&quot;The Definitive Guide to Django: Web Development Done Right&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">sorted</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">publishers</span><span class="p">),</span>
            <span class="p">[</span>
                <span class="s">&quot;Apress&quot;</span><span class="p">,</span>
                <span class="s">&quot;Sams&quot;</span>
            <span class="p">]</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-53"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-53">&#182;</a></div><p>Regression for 10666 - inherited fields work with annotations and
aggregations</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">HardbackBook</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">n_pages</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s">&#39;book_ptr__pages&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;n_pages&#39;</span><span class="p">:</span> <span class="mi">2078</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">HardbackBook</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">n_pages</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;n_pages&#39;</span><span class="p">:</span> <span class="mi">2078</span><span class="p">},</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">HardbackBook</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book_ptr__authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;n_authors&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;n_authors&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Artificial Intelligence: A Modern Approach&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;n_authors&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Paradigms of Artificial Intelligence Programming: Case Studies in Common Lisp&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">HardbackBook</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;n_authors&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">{</span><span class="s">&#39;n_authors&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Artificial Intelligence: A Modern Approach&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s">&#39;n_authors&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="s">&#39;Paradigms of Artificial Intelligence Programming: Case Studies in Common Lisp&#39;</span><span class="p">}</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">h</span><span class="p">:</span> <span class="n">h</span><span class="p">,</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-54"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-54">&#182;</a></div><p>Regression for #10766 - Shouldn't be able to reference an aggregate
fields in an aggregate() call.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span>
            <span class="n">FieldError</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">mean_age</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;authors__age&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;mean_age&#39;</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_empty_filter_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;friends&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="mi">0</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_empty_filter_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">id__in</span><span class="o">=</span><span class="p">[])</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;friends&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;pk&quot;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&quot;pk__count&quot;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_none_call_before_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-55"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-55">&#182;</a></div><p>Regression for #11789</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">none</span><span class="p">()</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Avg</span><span class="p">(</span><span class="s">&#39;age&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;age__avg&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_annotate_and_join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;friends__name&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">friends__name</span><span class="o">=</span><span class="s">&quot;Joe&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_f_expression_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-56"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-56">&#182;</a></div><p>Books with less than 200 pages per author.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pages__lt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;n_authors&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">200</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;pk&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="n">qs</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Python Web Development with Django&quot;</span>
            <span class="p">],</span>
            <span class="n">attrgetter</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_values_annotate_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;pk&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;pk&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">test_having_group_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-57"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-57">&#182;</a></div><p>Test that when a field occurs on the LHS of a HAVING clause that it
appears correctly in the GROUP BY clause</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">pages__gt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;n_authors&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-58"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-58">&#182;</a></div><p>Results should be the same, all Books have more pages than authors</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_annotation_disjunction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;authors&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Python Web Development with Django&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="s">&quot;Artificial Intelligence: A Modern Approach&quot;</span><span class="p">,</span>
                <span class="s">&quot;Python Web Development with Django&quot;</span><span class="p">,</span>
                <span class="s">&quot;The Definitive Guide to Django: Web Development Done Right&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">attrgetter</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;authors&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;The Definitive Guide to Django: Web Development Done Right&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Artificial Intelligence: A Modern Approach&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">Q</span><span class="p">(</span><span class="n">n_authors</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="s">&quot;The Definitive Guide to Django: Web Development Done Right&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">attrgetter</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">rating_sum</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s">&quot;book__rating&quot;</span><span class="p">),</span>
            <span class="n">book_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;book&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">rating_sum__gt</span><span class="o">=</span><span class="mf">5.5</span><span class="p">)</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">rating_sum__isnull</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;pk&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="s">&quot;Apress&quot;</span><span class="p">,</span>
                <span class="s">&quot;Prentice Hall&quot;</span><span class="p">,</span>
                <span class="s">&quot;Jonno&#39;s House of Books&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">attrgetter</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">rating_sum</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span><span class="s">&quot;book__rating&quot;</span><span class="p">),</span>
            <span class="n">book_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;book&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Q</span><span class="p">(</span><span class="n">pk__lt</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&quot;book_count&quot;</span><span class="p">))</span> <span class="o">|</span> <span class="n">Q</span><span class="p">(</span><span class="n">rating_sum</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;pk&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="s">&quot;Apress&quot;</span><span class="p">,</span>
                <span class="s">&quot;Jonno&#39;s House of Books&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">attrgetter</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_quoting_aggregate_order_by</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&quot;Python Web Development with Django&quot;</span>
        <span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">authorCount</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&quot;authors&quot;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&quot;authorCount&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span> <span class="p">[</span>
                <span class="p">(</span><span class="s">&quot;Python Web Development with Django&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">authorCount</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@skipUnlessDBFeature</span><span class="p">(</span><span class="s">&#39;supports_stddev&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_stddev</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">StdDev</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;pages__stddev&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">311.46</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">StdDev</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;rating__stddev&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">0.60</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">StdDev</span><span class="p">(</span><span class="s">&#39;price&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;price__stddev&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">24.16</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">StdDev</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;pages__stddev&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">341.19</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">StdDev</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;rating__stddev&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">0.66</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">StdDev</span><span class="p">(</span><span class="s">&#39;price&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;price__stddev&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">26.46</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Variance</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;pages__variance&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">97010.80</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Variance</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;rating__variance&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">0.36</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Variance</span><span class="p">(</span><span class="s">&#39;price&#39;</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;price__variance&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">583.77</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Variance</span><span class="p">(</span><span class="s">&#39;pages&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;pages__variance&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">116412.96</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Variance</span><span class="p">(</span><span class="s">&#39;rating&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;rating__variance&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">0.44</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
            <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Variance</span><span class="p">(</span><span class="s">&#39;price&#39;</span><span class="p">,</span> <span class="n">sample</span><span class="o">=</span><span class="bp">True</span><span class="p">)),</span>
            <span class="p">{</span><span class="s">&#39;price__variance&#39;</span><span class="p">:</span> <span class="n">Approximate</span><span class="p">(</span><span class="mf">700.53</span><span class="p">,</span> <span class="mi">2</span><span class="p">)}</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_filtering_by_annotation_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-59"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-59">&#182;</a></div><p>Regression test for #14476</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-60"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-60">&#182;</a></div><p>The name of the explicitly provided annotation name in this case
poses no problem</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">book_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book_cnt</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;Peter Norvig&#39;</span><span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-61"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-61">&#182;</a></div><p>Neither in this case</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">book_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book_count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;Peter Norvig&#39;</span><span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-62"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-62">&#182;</a></div><p>This case used to fail because the ORM couldn't resolve the
automatically generated annotation name <code>book__count</code></p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">book__count</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">qs</span><span class="p">,</span>
            <span class="p">[</span><span class="s">&#39;Peter Norvig&#39;</span><span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
