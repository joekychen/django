<!DOCTYPE html>
<html><head><title>joekychen/django » tests › regressiontests › file_uploads › views.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>views.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">django.core.files.uploadedfile</span> <span class="kn">import</span> <span class="n">UploadedFile</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">HttpResponseServerError</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">FileModel</span><span class="p">,</span> <span class="n">UPLOAD_TO</span>
<span class="kn">from</span> <span class="nn">.tests</span> <span class="kn">import</span> <span class="n">UNICODE_FILENAME</span>
<span class="kn">from</span> <span class="nn">.uploadhandler</span> <span class="kn">import</span> <span class="n">QuotaUploadHandler</span><span class="p">,</span> <span class="n">ErroringUploadHandler</span>


<span class="k">def</span> <span class="nf">file_upload_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check that a file upload can be updated into the POST dictionary without</span>
<span class="sd">    going pear-shaped.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">form_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">form_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;file_field&#39;</span><span class="p">),</span> <span class="n">UploadedFile</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">form_data</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">],</span> <span class="nb">unicode</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>If a file is posted, the dummy client should only post the file name,
not the full path.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">form_data</span><span class="p">[</span><span class="s">&#39;file_field&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">file_upload_view_verify</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the sha digest hash to verify the uploaded contents.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">form_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">form_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">form_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_hash&#39;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">+</span> <span class="s">&#39;_hash&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">submitted_hash</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="n">key</span> <span class="o">+</span> <span class="s">&#39;_hash&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">UploadedFile</span><span class="p">):</span>
            <span class="n">new_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">read</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">new_hash</span> <span class="o">!=</span> <span class="n">submitted_hash</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Adding large file to the database should succeed</p></td><td class="code"><div class="highlight"><pre>    <span class="n">largefile</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s">&#39;file_field2&#39;</span><span class="p">]</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">FileModel</span><span class="p">()</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">testfile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">largefile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">largefile</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">file_upload_unicode_name</span><span class="p">(</span><span class="n">request</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Check to see if unicode name came through properly.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s">&#39;file_unicode&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">UNICODE_FILENAME</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HttpResponseServerError</span><span class="p">()</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">None</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Check to make sure the exotic characters are preserved even
through file save.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">uni_named_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s">&#39;file_unicode&#39;</span><span class="p">]</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">FileModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">testfile</span><span class="o">=</span><span class="n">uni_named_file</span><span class="p">)</span>
    <span class="n">full_name</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">UPLOAD_TO</span><span class="p">,</span> <span class="n">uni_named_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_name</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseServerError</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Cleanup the object with its exotic file name immediately.
(shutil.rmtree used elsewhere in the tests to clean up the
upload directory has been seen to choke on unicode
filenames on Windows.)</p></td><td class="code"><div class="highlight"><pre>    <span class="n">obj</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">file_upload_echo</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple view to echo back info about uploaded files for tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">file_upload_echo_content</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simple view to echo back the content of uploaded files for tests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">r</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">file_upload_quota</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dynamically add in an upload handler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">upload_handlers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QuotaUploadHandler</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">file_upload_echo</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">file_upload_quota_broken</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    You can&#39;t change handlers after reading FILES; this view shouldn&#39;t work.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">file_upload_echo</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">request</span><span class="o">.</span><span class="n">upload_handlers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">QuotaUploadHandler</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">file_upload_getlist_count</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check the .getlist() function to ensure we receive the correct number of files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_counts</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">file_counts</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">file_counts</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">file_upload_errors</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">request</span><span class="o">.</span><span class="n">upload_handlers</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ErroringUploadHandler</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">file_upload_echo</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">file_upload_filename_case_view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check adding the file to the database will preserve the filename case.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">FILES</span><span class="p">[</span><span class="s">&#39;file_field&#39;</span><span class="p">]</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">FileModel</span><span class="p">()</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">testfile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="nb">file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">obj</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
