<!DOCTYPE html>
<html><head><title>joekychen/django » tests › modeltests › prefetch_related › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">django.contrib.contenttypes.models</span> <span class="kn">import</span> <span class="n">ContentType</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connection</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">override_settings</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Author</span><span class="p">,</span> <span class="n">Book</span><span class="p">,</span> <span class="n">Reader</span><span class="p">,</span> <span class="n">Qualification</span><span class="p">,</span> <span class="n">Teacher</span><span class="p">,</span> <span class="n">Department</span><span class="p">,</span>
    <span class="n">TaggedItem</span><span class="p">,</span> <span class="n">Bookmark</span><span class="p">,</span> <span class="n">AuthorAddress</span><span class="p">,</span> <span class="n">FavoriteAuthors</span><span class="p">,</span> <span class="n">AuthorWithAge</span><span class="p">,</span>
    <span class="n">BookWithYear</span><span class="p">,</span> <span class="n">BookReview</span><span class="p">,</span> <span class="n">Person</span><span class="p">,</span> <span class="n">House</span><span class="p">,</span> <span class="n">Room</span><span class="p">,</span> <span class="n">Employee</span><span class="p">,</span> <span class="n">Comment</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrefetchRelatedTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Poems&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book2</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Jane Eyre&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book3</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Wuthering Heights&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book4</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Sense and Sensibility&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">author1</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Charlotte&quot;</span><span class="p">,</span>
                                             <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author2</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Anne&quot;</span><span class="p">,</span>
                                             <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author3</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Emily&quot;</span><span class="p">,</span>
                                             <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author4</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Jane&quot;</span><span class="p">,</span>
                                             <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book4</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">author2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">author3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book3</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book4</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author4</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reader1</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Amy&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader2</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Belinda&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reader1</span><span class="o">.</span><span class="n">books_read</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader2</span><span class="o">.</span><span class="n">books_read</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_m2m_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">)]</span>

        <span class="n">normal_lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="n">normal_lists</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">test_m2m_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books&#39;</span><span class="p">)]</span>

        <span class="n">normal_lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="n">normal_lists</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreignkey_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">books</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">first_book</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_book&#39;</span><span class="p">)]</span>

        <span class="n">normal_books</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">first_book</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">books</span><span class="p">,</span> <span class="n">normal_books</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreignkey_reverse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">first_time_authors</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                     <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_time_authors&#39;</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span><span class="s">&quot;&lt;Author: Charlotte&gt;&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_onetoone_reverse_no_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Regression for #17439</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;bookwithyear&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">BookWithYear</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
                <span class="n">book</span><span class="o">.</span><span class="n">bookwithyear</span>

    <span class="k">def</span> <span class="nf">test_survives_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">first_time_authors</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                     <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_time_authors&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">1000</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">test_len</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_time_authors&#39;</span><span class="p">)</span>
            <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">first_time_authors</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                     <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_time_authors&#39;</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">first_time_authors</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
                     <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_time_authors&#39;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">first_time_authors</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_time_authors&#39;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">first_time_authors</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that we can clear the behavior by calling prefetch_related()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">with_prefetch</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books&#39;</span><span class="p">)</span>
            <span class="n">without_prefetch</span> <span class="o">=</span> <span class="n">with_prefetch</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">without_prefetch</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_m2m_then_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test we can follow a m2m and another m2m</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books__read_by&#39;</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                      <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Belinda&quot;</span><span class="p">]],</span>  <span class="c"># Charlotte - Poems, Jane Eyre</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">]],</span>                <span class="c"># Anne - Poems</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span> <span class="p">[]],</span>            <span class="c"># Emily - Poems, Wuthering Heights</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">,</span> <span class="s">&quot;Belinda&quot;</span><span class="p">]],</span>    <span class="c"># Jane - Sense and Sense</span>
            <span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_overriding_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books&#39;</span><span class="p">,</span> <span class="s">&#39;books__read_by&#39;</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                      <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Belinda&quot;</span><span class="p">]],</span>  <span class="c"># Charlotte - Poems, Jane Eyre</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">]],</span>                <span class="c"># Anne - Poems</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span> <span class="p">[]],</span>            <span class="c"># Emily - Poems, Wuthering Heights</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">,</span> <span class="s">&quot;Belinda&quot;</span><span class="p">]],</span>    <span class="c"># Jane - Sense and Sense</span>
            <span class="p">])</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books__read_by&#39;</span><span class="p">,</span> <span class="s">&#39;books&#39;</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                      <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Belinda&quot;</span><span class="p">]],</span>  <span class="c"># Charlotte - Poems, Jane Eyre</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">]],</span>                <span class="c"># Anne - Poems</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span> <span class="p">[]],</span>            <span class="c"># Emily - Poems, Wuthering Heights</span>
                <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">,</span> <span class="s">&quot;Belinda&quot;</span><span class="p">]],</span>    <span class="c"># Jane - Sense and Sense</span>
            <span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that objects retrieved with .get() get the prefetch behavior.</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Need a double</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books__read_by&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Charlotte&quot;</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                      <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;Belinda&quot;</span><span class="p">]])</span>  <span class="c"># Poems, Jane Eyre</span>

    <span class="k">def</span> <span class="nf">test_foreign_key_then_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test we can follow an m2m relation after a relation like ForeignKey</span>
<span class="sd">        that doesn&#39;t have many objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;first_book&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_book__read_by&#39;</span><span class="p">)</span>
            <span class="n">lists</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">first_book</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                     <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lists</span><span class="p">,</span> <span class="p">[[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span>
                                     <span class="p">[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span>
                                     <span class="p">[</span><span class="s">&quot;Amy&quot;</span><span class="p">],</span>
                                     <span class="p">[</span><span class="s">&quot;Amy&quot;</span><span class="p">,</span> <span class="s">&quot;Belinda&quot;</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">test_attribute_error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books_read__xyz&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">AttributeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;prefetch_related&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_invalid_final_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;authors__name&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">cm</span><span class="p">:</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;prefetch_related&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&quot;name&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">exception</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">DefaultManagerTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qual1</span> <span class="o">=</span> <span class="n">Qualification</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;BA&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qual2</span> <span class="o">=</span> <span class="n">Qualification</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;BSci&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qual3</span> <span class="o">=</span> <span class="n">Qualification</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;MA&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qual4</span> <span class="o">=</span> <span class="n">Qualification</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;PhD&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">teacher1</span> <span class="o">=</span> <span class="n">Teacher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mr Cleese&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher2</span> <span class="o">=</span> <span class="n">Teacher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mr Idle&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher3</span> <span class="o">=</span> <span class="n">Teacher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mr Chapman&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">teacher1</span><span class="o">.</span><span class="n">qualifications</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qual1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qual2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qual3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">qual4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher2</span><span class="o">.</span><span class="n">qualifications</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qual1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teacher3</span><span class="o">.</span><span class="n">qualifications</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qual2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dept1</span> <span class="o">=</span> <span class="n">Department</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;English&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dept2</span> <span class="o">=</span> <span class="n">Department</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Physics&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dept1</span><span class="o">.</span><span class="n">teachers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">teacher2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dept2</span><span class="o">.</span><span class="n">teachers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">teacher1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">teacher3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_m2m_then_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>When we prefetch the teachers, and force the query, we don't want
the default manager on teachers to immediately get all the related
qualifications, since this will do one query per teacher.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">qs</span> <span class="o">=</span> <span class="n">Department</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;teachers&#39;</span><span class="p">)</span>
            <span class="n">depts</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> department: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">dept</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">unicode</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dept</span><span class="o">.</span><span class="n">teachers</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
                             <span class="k">for</span> <span class="n">dept</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">depts</span><span class="p">,</span>
                             <span class="s">&quot;English department: Mr Cleese (BA, BSci, MA, PhD), Mr Idle (BA)</span><span class="se">\n</span><span class="s">&quot;</span>
                             <span class="s">&quot;Physics department: Mr Cleese (BA, BSci, MA, PhD), Mr Chapman (BSci)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GenericRelationTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">book1</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Winnie the Pooh&quot;</span><span class="p">)</span>
        <span class="n">book2</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Do you like green eggs and spam?&quot;</span><span class="p">)</span>
        <span class="n">book3</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Three Men In A Boat&quot;</span><span class="p">)</span>

        <span class="n">reader1</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;me&quot;</span><span class="p">)</span>
        <span class="n">reader2</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;you&quot;</span><span class="p">)</span>
        <span class="n">reader3</span> <span class="o">=</span> <span class="n">Reader</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;someone&quot;</span><span class="p">)</span>

        <span class="n">book1</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reader1</span><span class="p">,</span> <span class="n">reader2</span><span class="p">)</span>
        <span class="n">book2</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reader2</span><span class="p">)</span>
        <span class="n">book3</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reader3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">book3</span> <span class="o">=</span> <span class="n">book1</span><span class="p">,</span> <span class="n">book2</span><span class="p">,</span> <span class="n">book3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reader1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader3</span> <span class="o">=</span> <span class="n">reader1</span><span class="p">,</span> <span class="n">reader2</span><span class="p">,</span> <span class="n">reader3</span>

    <span class="k">def</span> <span class="nf">test_prefetch_GFK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;great&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reader1</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;stupid&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;amazing&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reader3</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>1 for TaggedItem table, 1 for Book table, 1 for Reader table</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;content_object&#39;</span><span class="p">)</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_prefetch_GFK_nonint_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">comment</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>1 for Comment table, 1 for Book table</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;content_object&#39;</span><span class="p">)</span>
            <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">content_object</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">test_traverse_GFK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Test that we can traverse a &#39;content_object&#39; with prefetch_related() and</span>
<span class="sd">        get to related objects on the other side (assuming it is suitably</span>
<span class="sd">        filtered)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book3</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reader1</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reader2</span><span class="p">)</span>

        <span class="n">ct</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">Book</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>We get 3 queries - 1 for main query, 1 for content<em>objects since they
all use the same table, and 1 for the 'read</em>by' relation.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>If we limit to books, we know that they will have 'read_by'
attributes, so the following makes sense:</p></td><td class="code"><div class="highlight"><pre>            <span class="n">qs</span> <span class="o">=</span> <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">ct</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">&#39;awesome&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;content_object__read_by&#39;</span><span class="p">)</span>
            <span class="n">readers_of_awesome_books</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">qs</span>
                                            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">tag</span><span class="o">.</span><span class="n">content_object</span><span class="o">.</span><span class="n">read_by</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">readers_of_awesome_books</span><span class="p">,</span> <span class="nb">set</span><span class="p">([</span><span class="s">&quot;me&quot;</span><span class="p">,</span> <span class="s">&quot;you&quot;</span><span class="p">,</span> <span class="s">&quot;someone&quot;</span><span class="p">]))</span>

    <span class="k">def</span> <span class="nf">test_nullable_GFK</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;awesome&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">,</span>
                                  <span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reader1</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;great&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="p">)</span>
        <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">tag</span><span class="o">=</span><span class="s">&quot;rubbish&quot;</span><span class="p">,</span> <span class="n">content_object</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book3</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">created_by</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;created_by&#39;</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">result</span><span class="p">,</span>
                         <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">created_by</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>

    <span class="k">def</span> <span class="nf">test_generic_relation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Bookmark</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="s">&#39;http://www.djangoproject.com/&#39;</span><span class="p">)</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content_object</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">&#39;django&#39;</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">TaggedItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">content_object</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">tag</span><span class="o">=</span><span class="s">&#39;python&#39;</span><span class="p">)</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">Bookmark</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;tags&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">tags</span><span class="p">),</span> <span class="p">[</span><span class="s">&quot;django&quot;</span><span class="p">,</span> <span class="s">&quot;python&quot;</span><span class="p">])</span>


<span class="k">class</span> <span class="nc">MultiTableInheritanceTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book1</span> <span class="o">=</span> <span class="n">BookWithYear</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;Poems&quot;</span><span class="p">,</span> <span class="n">published_year</span><span class="o">=</span><span class="mi">2010</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book2</span> <span class="o">=</span> <span class="n">BookWithYear</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s">&quot;More poems&quot;</span><span class="p">,</span> <span class="n">published_year</span><span class="o">=</span><span class="mi">2011</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author1</span> <span class="o">=</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;Jane&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author2</span> <span class="o">=</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;Tom&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">49</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author3</span> <span class="o">=</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s">&#39;Robert&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">48</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorAddress</span> <span class="o">=</span> <span class="n">AuthorAddress</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&#39;SomeStreet 1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="o">.</span><span class="n">aged_authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">author3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">br1</span> <span class="o">=</span> <span class="n">BookReview</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book1</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="s">&quot;review book1&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">br2</span> <span class="o">=</span> <span class="n">BookReview</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book2</span><span class="p">,</span> <span class="n">notes</span><span class="o">=</span><span class="s">&quot;review book2&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreignkey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;addresses&#39;</span><span class="p">)</span>
            <span class="n">addresses</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                         <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">addresses</span><span class="p">,</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authorAddress</span><span class="p">)],</span> <span class="p">[],</span> <span class="p">[]])</span>

    <span class="k">def</span> <span class="nf">test_foreignkey_to_inherited</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">BookReview</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;book&#39;</span><span class="p">)</span>
            <span class="n">titles</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">book</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEquals</span><span class="p">(</span><span class="n">titles</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;Poems&quot;</span><span class="p">,</span> <span class="s">&quot;More poems&quot;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test_m2m_to_inheriting_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books_with_year&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">book</span><span class="p">)</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">books_with_year</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                   <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">lst2</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">book</span><span class="p">)</span> <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">books_with_year</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">lst2</span><span class="p">)</span>

        <span class="n">qs</span> <span class="o">=</span> <span class="n">BookWithYear</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;aged_authors&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">book</span><span class="o">.</span><span class="n">aged_authors</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                   <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">BookWithYear</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">lst2</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">author</span><span class="p">)</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">book</span><span class="o">.</span><span class="n">aged_authors</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
               <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">lst2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_parent_link_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">author</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;author&#39;</span><span class="p">)]</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">DEBUG</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_child_link_prefetch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">authorwithage</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;authorwithage&#39;</span><span class="p">)]</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Regression for #18090: the prefetching query must include an IN clause.
Note that on Oracle the table name is upper case in the generated SQL,
thus the .lower() call.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39;authorwithage&#39;</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;sql&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">&#39; IN &#39;</span><span class="p">,</span> <span class="n">connection</span><span class="o">.</span><span class="n">queries</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;sql&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">authorwithage</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()])</span>


<span class="k">class</span> <span class="nc">ForeignKeyToFieldTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">book</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Poems&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author1</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Jane&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author2</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Tom&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">author3</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Robert&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">book</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">authorAddress</span> <span class="o">=</span> <span class="n">AuthorAddress</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&#39;SomeStreet 1&#39;</span>
        <span class="p">)</span>
        <span class="n">FavoriteAuthors</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">,</span>
                                       <span class="n">likes_author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author2</span><span class="p">)</span>
        <span class="n">FavoriteAuthors</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author2</span><span class="p">,</span>
                                       <span class="n">likes_author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author3</span><span class="p">)</span>
        <span class="n">FavoriteAuthors</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author3</span><span class="p">,</span>
                                       <span class="n">likes_author</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_foreignkey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;addresses&#39;</span><span class="p">)</span>
            <span class="n">addresses</span> <span class="o">=</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">address</span><span class="p">)</span> <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                         <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">addresses</span><span class="p">,</span> <span class="p">[[</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">authorAddress</span><span class="p">)],</span> <span class="p">[],</span> <span class="p">[]])</span>

    <span class="k">def</span> <span class="nf">test_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;favorite_authors&#39;</span><span class="p">,</span> <span class="s">&#39;favors_me&#39;</span><span class="p">)</span>
            <span class="n">favorites</span> <span class="o">=</span> <span class="p">[(</span>
                 <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">i_like</span><span class="p">)</span> <span class="k">for</span> <span class="n">i_like</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">favorite_authors</span><span class="o">.</span><span class="n">all</span><span class="p">()],</span>
                 <span class="p">[</span><span class="nb">unicode</span><span class="p">(</span><span class="n">likes_me</span><span class="p">)</span> <span class="k">for</span> <span class="n">likes_me</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">favors_me</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
                <span class="p">)</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span>
                <span class="n">favorites</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="p">([</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author2</span><span class="p">)],[</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author3</span><span class="p">)]),</span>
                    <span class="p">([</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author3</span><span class="p">)],[</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">)]),</span>
                    <span class="p">([</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author1</span><span class="p">)],[</span><span class="nb">unicode</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">author2</span><span class="p">)])</span>
                <span class="p">]</span>
            <span class="p">)</span>


<span class="k">class</span> <span class="nc">LookupOrderingTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test cases that demonstrate that ordering of lookups is important, and</span>
<span class="sd">    ensure it is preserved.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person1</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joe&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person2</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Mary&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">house1</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s">&quot;123 Main St&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">house2</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s">&quot;45 Side St&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">house3</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s">&quot;6 Downing St&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">house4</span> <span class="o">=</span> <span class="n">House</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="s">&quot;7 Regents St&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">room1_1</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Dining room&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1_2</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Lounge&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room1_3</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Kitchen&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">room2_1</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Dining room&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room2_2</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Lounge&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">room3_1</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Dining room&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room3_2</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Lounge&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room3_3</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Kitchen&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">room4_1</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Dining room&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house4</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">room4_2</span> <span class="o">=</span> <span class="n">Room</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Lounge&quot;</span><span class="p">,</span> <span class="n">house</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">house4</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">person1</span><span class="o">.</span><span class="n">houses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">house1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">house2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">person2</span><span class="o">.</span><span class="n">houses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">house3</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">house4</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>The following two queries must be done in the same order as written,
otherwise 'primary_house' will cause non-prefetched lookups</p></td><td class="code"><div class="highlight"><pre>            <span class="n">qs</span> <span class="o">=</span> <span class="n">Person</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;houses__rooms&#39;</span><span class="p">,</span>
                                                 <span class="s">&#39;primary_house__occupants&#39;</span><span class="p">)</span>
            <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">primary_house</span><span class="o">.</span><span class="n">occupants</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">NullableTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">boss</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Peter&quot;</span><span class="p">)</span>
        <span class="n">worker1</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Joe&quot;</span><span class="p">,</span> <span class="n">boss</span><span class="o">=</span><span class="n">boss</span><span class="p">)</span>
        <span class="n">worker2</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Angela&quot;</span><span class="p">,</span> <span class="n">boss</span><span class="o">=</span><span class="n">boss</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_traverse_nullable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Because we use select_related() for 'boss', it doesn't need to be
prefetched, but we can still traverse it although it contains some nulls</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;boss&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;boss__serfs&#39;</span><span class="p">)</span>
            <span class="n">co_serfs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">boss</span><span class="o">.</span><span class="n">serfs</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">boss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>

        <span class="n">qs2</span> <span class="o">=</span>  <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;boss&#39;</span><span class="p">)</span>
        <span class="n">co_serfs2</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">boss</span><span class="o">.</span><span class="n">serfs</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">boss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">qs2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">co_serfs</span><span class="p">,</span> <span class="n">co_serfs2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_prefetch_nullable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>One for main employee, one for boss, one for serfs</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">qs</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;boss__serfs&#39;</span><span class="p">)</span>
            <span class="n">co_serfs</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">boss</span><span class="o">.</span><span class="n">serfs</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">boss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">qs</span><span class="p">]</span>

        <span class="n">qs2</span> <span class="o">=</span>  <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">co_serfs2</span> <span class="o">=</span>  <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">boss</span><span class="o">.</span><span class="n">serfs</span><span class="o">.</span><span class="n">all</span><span class="p">())</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">boss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">qs2</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">co_serfs</span><span class="p">,</span> <span class="n">co_serfs2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_in_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In-bulk does correctly prefetch objects by not using .iterator()</span>
<span class="sd">        directly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">boss1</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Peter&quot;</span><span class="p">)</span>
        <span class="n">boss2</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Jack&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Check that prefetch is done and it does not cause any errors.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">bulk</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;serfs&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">in_bulk</span><span class="p">([</span><span class="n">boss1</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="n">boss2</span><span class="o">.</span><span class="n">pk</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bulk</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">serfs</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">MultiDbTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="n">multi_db</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_using_is_honored_m2m</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">book1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Poems&quot;</span><span class="p">)</span>
        <span class="n">book2</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Jane Eyre&quot;</span><span class="p">)</span>
        <span class="n">book3</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Wuthering Heights&quot;</span><span class="p">)</span>
        <span class="n">book4</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Sense and Sensibility&quot;</span><span class="p">)</span>

        <span class="n">author1</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Charlotte&quot;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book1</span><span class="p">)</span>
        <span class="n">author2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Anne&quot;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book1</span><span class="p">)</span>
        <span class="n">author3</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Emily&quot;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book1</span><span class="p">)</span>
        <span class="n">author4</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Jane&quot;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book4</span><span class="p">)</span>

        <span class="n">book1</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author1</span><span class="p">,</span> <span class="n">author2</span><span class="p">,</span> <span class="n">author3</span><span class="p">)</span>
        <span class="n">book2</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author1</span><span class="p">)</span>
        <span class="n">book3</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author3</span><span class="p">)</span>
        <span class="n">book4</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">author4</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Forward</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">):</span>
            <span class="n">books</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">book</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">book</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
                             <span class="k">for</span> <span class="n">book</span> <span class="ow">in</span> <span class="n">qs1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">books</span><span class="p">,</span>
                         <span class="s">&quot;Poems (Charlotte, Anne, Emily)</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;Jane Eyre (Charlotte)</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;Wuthering Heights (Emily)</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;Sense and Sensibility (Jane)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Reverse</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;books&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">):</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">author</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">author</span><span class="o">.</span><span class="n">books</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
                               <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">qs2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">authors</span><span class="p">,</span>
                          <span class="s">&quot;Charlotte: Poems, Jane Eyre</span><span class="se">\n</span><span class="s">&quot;</span>
                          <span class="s">&quot;Anne: Poems</span><span class="se">\n</span><span class="s">&quot;</span>
                          <span class="s">&quot;Emily: Poems, Wuthering Heights</span><span class="se">\n</span><span class="s">&quot;</span>
                          <span class="s">&quot;Jane: Sense and Sensibility</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_using_is_honored_fkey</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">book1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Poems&quot;</span><span class="p">)</span>
        <span class="n">book2</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Sense and Sensibility&quot;</span><span class="p">)</span>

        <span class="n">author1</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Charlotte Bronte&quot;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book1</span><span class="p">)</span>
        <span class="n">author2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Jane Austen&quot;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book2</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Forward</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">):</span>
            <span class="n">books</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">first_book</span><span class="o">.</span><span class="n">title</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_book&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&quot;Poems, Sense and Sensibility&quot;</span><span class="p">,</span> <span class="n">books</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Reverse</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">):</span>
            <span class="n">books</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">b</span><span class="o">.</span><span class="n">first_time_authors</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
                            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">B</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;first_time_authors&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">books</span><span class="p">,</span>
                         <span class="s">&quot;Poems (Charlotte Bronte)</span><span class="se">\n</span><span class="s">&quot;</span>
                         <span class="s">&quot;Sense and Sensibility (Jane Austen)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_using_is_honored_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">BookWithYear</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">AuthorWithAge</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">using</span><span class="p">(</span><span class="s">&#39;other&#39;</span><span class="p">)</span>
        <span class="n">book1</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;Poems&quot;</span><span class="p">,</span> <span class="n">published_year</span><span class="o">=</span><span class="mi">2010</span><span class="p">)</span>
        <span class="n">book2</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&quot;More poems&quot;</span><span class="p">,</span> <span class="n">published_year</span><span class="o">=</span><span class="mi">2011</span><span class="p">)</span>
        <span class="n">author1</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Jane&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book1</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
        <span class="n">author2</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Tom&#39;</span><span class="p">,</span> <span class="n">first_book</span><span class="o">=</span><span class="n">book1</span><span class="p">,</span> <span class="n">age</span><span class="o">=</span><span class="mi">49</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>parent link</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">):</span>
            <span class="n">authors</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;author&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">authors</span><span class="p">,</span> <span class="s">&quot;Jane, Tom&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>child link</p></td><td class="code"><div class="highlight"><pre>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertNumQueries</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">using</span><span class="o">=</span><span class="s">&#39;other&#39;</span><span class="p">):</span>
            <span class="n">ages</span> <span class="o">=</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">authorwithage</span><span class="o">.</span><span class="n">age</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">A</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">&#39;authorwithage&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ages</span><span class="p">,</span> <span class="s">&quot;50, 49&quot;</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
