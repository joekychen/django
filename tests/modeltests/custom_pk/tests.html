<!DOCTYPE html>
<html><head><title>joekychen/django » tests › modeltests › custom_pk › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div><p>-<em>- coding: utf-8 -</em>-</p></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">IntegrityError</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span><span class="p">,</span> <span class="n">skipIfDBFeature</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Employee</span><span class="p">,</span> <span class="n">Business</span><span class="p">,</span> <span class="n">Bar</span><span class="p">,</span> <span class="n">Foo</span>


<span class="k">class</span> <span class="nc">CustomPKTests</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test_custom_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dan</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">employee_code</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s">&quot;Dan&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s">&quot;Jones&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span>
                <span class="s">&quot;Dan Jones&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="nb">unicode</span>
        <span class="p">)</span>

        <span class="n">fran</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">employee_code</span><span class="o">=</span><span class="mi">456</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s">&quot;Fran&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s">&quot;Bones&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span>
                <span class="s">&quot;Fran Bones&quot;</span><span class="p">,</span>
                <span class="s">&quot;Dan Jones&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="nb">unicode</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">123</span><span class="p">),</span> <span class="n">dan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">456</span><span class="p">),</span> <span class="n">fran</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">,</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Use the name of the primary key, rather than pk.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">employee_code</span><span class="o">=</span><span class="mi">123</span><span class="p">),</span> <span class="n">dan</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>pk can be used as a substitute for the primary key.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="p">[</span><span class="mi">123</span><span class="p">,</span> <span class="mi">456</span><span class="p">]),</span> <span class="p">[</span>
                <span class="s">&quot;Fran Bones&quot;</span><span class="p">,</span>
                <span class="s">&quot;Dan Jones&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="nb">unicode</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>The primary key can be accessed via the pk property on the model.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">e</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">123</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">pk</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Or we can use the real attribute name for the primary key:</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">employee_code</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Fran got married and changed her last name.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">fran</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="mi">456</span><span class="p">)</span>
        <span class="n">fran</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="s">&quot;Jones&quot;</span>
        <span class="n">fran</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">last_name</span><span class="o">=</span><span class="s">&quot;Jones&quot;</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Dan Jones&quot;</span><span class="p">,</span>
                <span class="s">&quot;Fran Jones&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="nb">unicode</span>
        <span class="p">)</span>

        <span class="n">emps</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">in_bulk</span><span class="p">([</span><span class="mi">123</span><span class="p">,</span> <span class="mi">456</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">emps</span><span class="p">[</span><span class="mi">123</span><span class="p">],</span> <span class="n">dan</span><span class="p">)</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Sears&quot;</span><span class="p">)</span>
        <span class="n">b</span><span class="o">.</span><span class="n">employees</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dan</span><span class="p">,</span> <span class="n">fran</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">b</span><span class="o">.</span><span class="n">employees</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span>
                <span class="s">&quot;Dan Jones&quot;</span><span class="p">,</span>
                <span class="s">&quot;Fran Jones&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="nb">unicode</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">fran</span><span class="o">.</span><span class="n">business_set</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="p">[</span>
                <span class="s">&quot;Sears&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">in_bulk</span><span class="p">([</span><span class="s">&quot;Sears&quot;</span><span class="p">]),</span> <span class="p">{</span>
            <span class="s">&quot;Sears&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
        <span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Sears&quot;</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Sears&quot;</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="s">&quot;Sears&quot;</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Sears&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Queries across tables, involving primary key</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">business__name</span><span class="o">=</span><span class="s">&quot;Sears&quot;</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Dan Jones&quot;</span><span class="p">,</span>
                <span class="s">&quot;Fran Jones&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="nb">unicode</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">business__pk</span><span class="o">=</span><span class="s">&quot;Sears&quot;</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Dan Jones&quot;</span><span class="p">,</span>
                <span class="s">&quot;Fran Jones&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="nb">unicode</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">employees__employee_code</span><span class="o">=</span><span class="mi">123</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Sears&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">employees__pk</span><span class="o">=</span><span class="mi">123</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Sears&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertQuerysetEqual</span><span class="p">(</span>
            <span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">employees__first_name__startswith</span><span class="o">=</span><span class="s">&quot;Fran&quot;</span><span class="p">),</span> <span class="p">[</span>
                <span class="s">&quot;Sears&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">b</span><span class="o">.</span><span class="n">name</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_unicode_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Primary key may be unicode string</p></td><td class="code"><div class="highlight"><pre>        <span class="n">bus</span> <span class="o">=</span> <span class="n">Business</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;jaźń&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_unique_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>The primary key must also obviously be unique, so trying to create a
new object with the same primary key will fail.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">e</span> <span class="o">=</span> <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">employee_code</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s">&quot;Frank&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s">&quot;Jones&quot;</span>
        <span class="p">)</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="n">employee_code</span><span class="o">=</span><span class="mi">123</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s">&quot;Fred&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s">&quot;Jones&quot;</span>
        <span class="p">)</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_rollback</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_custom_field_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Regression for #10785 -- Custom fields can be used for primary keys.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">new_bar</span> <span class="o">=</span> <span class="n">Bar</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
        <span class="n">new_foo</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="n">new_bar</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="n">new_bar</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">new_foo</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="n">new_bar</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">Foo</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">bar</span><span class="o">=</span><span class="n">new_bar</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">new_foo</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">bar</span><span class="p">,</span> <span class="n">new_bar</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>SQLite lets objects be saved with an empty primary key, even though an
integer is expected. So we can't check for an error being raised in that
case for SQLite. Remove it from the suite for this next bit.</p></td><td class="code"><div class="highlight"><pre>    <span class="nd">@skipIfDBFeature</span><span class="p">(</span><span class="s">&#39;supports_unspecified_pk&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_required_pk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>The primary key must be specified, so an error is raised if you
try to create an object without it.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sid</span> <span class="o">=</span> <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="n">IntegrityError</span><span class="p">,</span>
            <span class="n">Employee</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">,</span> <span class="n">first_name</span><span class="o">=</span><span class="s">&quot;Tom&quot;</span><span class="p">,</span> <span class="n">last_name</span><span class="o">=</span><span class="s">&quot;Smith&quot;</span>
        <span class="p">)</span>
        <span class="n">transaction</span><span class="o">.</span><span class="n">savepoint_rollback</span><span class="p">(</span><span class="n">sid</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
