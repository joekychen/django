<!DOCTYPE html>
<html><head><title>joekychen/django » django › core › management › validation.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>validation.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">django.core.management.color</span> <span class="kn">import</span> <span class="n">color_style</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">smart_str</span>
<span class="kn">from</span> <span class="nn">django.utils.itercompat</span> <span class="kn">import</span> <span class="n">is_iterable</span>

<span class="k">class</span> <span class="nc">ModelErrorCollection</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">color_style</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">context</span><span class="p">,</span> <span class="n">error</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">ERROR</span><span class="p">(</span><span class="n">smart_str</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">error</span><span class="p">))))</span>

<span class="k">def</span> <span class="nf">get_validation_errors</span><span class="p">(</span><span class="n">outfile</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validates all models that are part of the specified app. If no app name is provided,</span>
<span class="sd">    validates all models of all installed apps. Writes errors, if any, to outfile.</span>
<span class="sd">    Returns number of errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
    <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">connection</span>
    <span class="kn">from</span> <span class="nn">django.db.models.loading</span> <span class="kn">import</span> <span class="n">get_app_errors</span>
    <span class="kn">from</span> <span class="nn">django.db.models.fields.related</span> <span class="kn">import</span> <span class="n">RelatedObject</span>
    <span class="kn">from</span> <span class="nn">django.db.models.deletion</span> <span class="kn">import</span> <span class="n">SET_NULL</span><span class="p">,</span> <span class="n">SET_DEFAULT</span>

    <span class="n">e</span> <span class="o">=</span> <span class="n">ModelErrorCollection</span><span class="p">(</span><span class="n">outfile</span><span class="p">)</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="ow">in</span> <span class="n">get_app_errors</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">cls</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">app</span><span class="p">):</span>
        <span class="n">opts</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_meta</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Do field-specific validation.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">local_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="n">opts</span><span class="o">.</span><span class="n">pk</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;id&#39;</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: You can</span><span class="se">\&#39;</span><span class="s">t use &quot;id&quot; as a field name, because each model automatically gets an &quot;id&quot; field if none of the fields have primary_key=True. You need to either remove/rename your &quot;id&quot; field or add primary_key=True to a field.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;_&#39;</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: Field names cannot end with underscores, because this would lead to ambiguous queryset filters.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">null</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">connection</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">interprets_empty_strings_as_nulls</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>We cannot reliably check this for backends like Oracle which
consider NULL and '' to be equal (and thus set up
character-based fields a little differently).</p></td><td class="code"><div class="highlight"><pre>                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: Primary key fields cannot have null=True.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">max_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">max_length</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">max_length</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: CharFields require a &quot;max_length&quot; attribute that is a positive integer.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: CharFields require a &quot;max_length&quot; attribute that is a positive integer.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">):</span>
                <span class="n">decimalp_ok</span><span class="p">,</span> <span class="n">mdigits_ok</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span>
                <span class="n">decimalp_msg</span> <span class="o">=</span><span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: DecimalFields require a &quot;decimal_places&quot; attribute that is a non-negative integer.&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">decimal_places</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">decimal_places</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">decimal_places</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">decimalp_msg</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">decimalp_ok</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">decimalp_msg</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">mdigits_msg</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: DecimalFields require a &quot;max_digits&quot; attribute that is a positive integer.&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">max_digits</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">max_digits</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">max_digits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span>  <span class="n">mdigits_msg</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mdigits_ok</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">mdigits_msg</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">invalid_values_msg</span> <span class="o">=</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: DecimalFields require a &quot;max_digits&quot; attribute value that is greater than or equal to the value of the &quot;decimal_places&quot; attribute.&#39;</span>
                <span class="k">if</span> <span class="n">decimalp_ok</span> <span class="ow">and</span> <span class="n">mdigits_ok</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">decimal_places</span> <span class="o">&gt;</span> <span class="n">max_digits</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">invalid_values_msg</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">upload_to</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: FileFields require an &quot;upload_to&quot; attribute.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ImageField</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Try to import PIL in either of the two ways it can end up installed.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">try</span><span class="p">:</span>
                    <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">Image</span>
                    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: To use ImageFields, you need to install the Python Imaging Library. Get it at http://www.pythonware.com/products/pil/ .&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;null&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: BooleanFields do not accept null values. Use a NullBooleanField instead.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">FilePathField</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">allow_files</span> <span class="ow">or</span> <span class="n">f</span><span class="o">.</span><span class="n">allow_folders</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: FilePathFields must have either allow_files or allow_folders set to True.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">is_iterable</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">choices</span><span class="p">):</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: &quot;choices&quot; should be iterable (e.g., a tuple or list).&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">choices</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: &quot;choices&quot; should be a sequence of two-tuples.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">db_index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;: &quot;db_index&quot; should be either None, True or False.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Perform any backend-specific field validation.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">connection</span><span class="o">.</span><span class="n">validation</span><span class="o">.</span><span class="n">validate_field</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Check if the on_delete behavior is sane</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="s">&#39;on_delete&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">on_delete</span> <span class="o">==</span> <span class="n">SET_NULL</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">null</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; specifies on_delete=SET_NULL, but cannot be null.&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">on_delete</span> <span class="o">==</span> <span class="n">SET_DEFAULT</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">has_default</span><span class="p">():</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; specifies on_delete=SET_DEFAULT, but has no default value.&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Check to see if the related field will clash with any existing
fields, m2m fields, m2m related objects or related objects</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">get_models</span><span class="p">():</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; has a relation with model </span><span class="si">%s</span><span class="s">, which has either not been installed or is abstract.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>it is a string and we could not find the model it refers to
so skip the next section</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                    <span class="k">continue</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Make sure the related field specified by a ForeignKey is unique</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">field_name</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Field &#39;</span><span class="si">%s</span><span class="s">&#39; under model &#39;</span><span class="si">%s</span><span class="s">&#39; must have a unique=True constraint.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">field_name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

                <span class="n">rel_opts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">_meta</span>
                <span class="n">rel_name</span> <span class="o">=</span> <span class="n">RelatedObject</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span>
                <span class="n">rel_query_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">is_hidden</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">local_many_to_many</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">get_all_related_many_to_many_objects</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">get_all_related_objects</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">seen_intermediary_signatures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">local_many_to_many</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Check to see if the related m2m field will clash with any
existing fields, m2m fields, m2m related objects or related
objects</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">get_models</span><span class="p">():</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; has an m2m relation with model </span><span class="si">%s</span><span class="s">, which has either not been installed or is abstract.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>it is a string and we could not find the model it refers to
so skip the next section</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                    <span class="k">continue</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Check that the field is not set to unique.  ManyToManyFields do not support unique.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;ManyToManyFields cannot be unique.  Remove the unique argument on &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">from_model</span><span class="p">,</span> <span class="n">to_model</span> <span class="o">=</span> <span class="n">cls</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span>
                <span class="k">if</span> <span class="n">from_model</span> <span class="o">==</span> <span class="n">to_model</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">symmetrical</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Many-to-many fields with intermediate tables cannot be symmetrical.&quot;</span><span class="p">)</span>
                <span class="n">seen_from</span><span class="p">,</span> <span class="n">seen_to</span><span class="p">,</span> <span class="n">seen_self</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">inter_field</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="n">rel_to</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">inter_field</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="s">&#39;to&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">from_model</span> <span class="o">==</span> <span class="n">to_model</span><span class="p">:</span> <span class="c"># relation to self</span>
                        <span class="k">if</span> <span class="n">rel_to</span> <span class="o">==</span> <span class="n">from_model</span><span class="p">:</span>
                            <span class="n">seen_self</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">seen_self</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Intermediary model </span><span class="si">%s</span><span class="s"> has more than &quot;</span>
                                <span class="s">&quot;two foreign keys to </span><span class="si">%s</span><span class="s">, which is ambiguous &quot;</span>
                                <span class="s">&quot;and is not permitted.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                                    <span class="n">from_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">rel_to</span> <span class="o">==</span> <span class="n">from_model</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">seen_from</span><span class="p">:</span>
                                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Intermediary model </span><span class="si">%s</span><span class="s"> has more &quot;</span>
                                    <span class="s">&quot;than one foreign key to </span><span class="si">%s</span><span class="s">, which is &quot;</span>
                                    <span class="s">&quot;ambiguous and is not permitted.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                                         <span class="n">from_model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
                                     <span class="p">)</span>
                                 <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">seen_from</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">elif</span> <span class="n">rel_to</span> <span class="o">==</span> <span class="n">to_model</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">seen_to</span><span class="p">:</span>
                                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Intermediary model </span><span class="si">%s</span><span class="s"> has more &quot;</span>
                                    <span class="s">&quot;than one foreign key to </span><span class="si">%s</span><span class="s">, which is &quot;</span>
                                    <span class="s">&quot;ambiguous and is not permitted.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                        <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                                        <span class="n">rel_to</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">seen_to</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">include_auto_created</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; specifies an m2m relation through model &quot;</span>
                        <span class="s">&quot;</span><span class="si">%s</span><span class="s">, which has not been installed.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="n">signature</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">signature</span> <span class="ow">in</span> <span class="n">seen_intermediary_signatures</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;The model </span><span class="si">%s</span><span class="s"> has two manually-defined m2m &quot;</span>
                        <span class="s">&quot;relations through the model </span><span class="si">%s</span><span class="s">, which is not &quot;</span>
                        <span class="s">&quot;permitted. Please consider using an extra field on &quot;</span>
                        <span class="s">&quot;your intermediary model instead.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">seen_intermediary_signatures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">signature</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span><span class="p">:</span>
                    <span class="n">seen_related_fk</span><span class="p">,</span> <span class="n">seen_this_fk</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span> <span class="bp">False</span>
                    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">seen_related_fk</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">:</span>
                                <span class="n">seen_related_fk</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span> <span class="o">==</span> <span class="n">cls</span><span class="p">:</span>
                                <span class="n">seen_this_fk</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">seen_related_fk</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">seen_this_fk</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; is a manually-defined m2m relation &quot;</span>
                            <span class="s">&quot;through model </span><span class="si">%s</span><span class="s">, which does not have foreign keys &quot;</span>
                            <span class="s">&quot;to </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">)</span>
                        <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;&#39;</span><span class="si">%s</span><span class="s">&#39; specifies an m2m relation through model </span><span class="si">%s</span><span class="s">, &quot;</span>
                    <span class="s">&quot;which has not been installed&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">rel_opts</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">_meta</span>
            <span class="n">rel_name</span> <span class="o">=</span> <span class="n">RelatedObject</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">to</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span>
            <span class="n">rel_query_name</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">related_query_name</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>If rel_name is none, there is no reverse accessor (this only
occurs for symmetrical m2m relations to self). If this is the
case, there are no clashes to check for this field, as there are
no reverse descriptors for this field.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">rel_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">local_many_to_many</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">get_all_related_many_to_many_objects</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                            <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related m2m field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">get_all_related_objects</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_name</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Accessor for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">()</span> <span class="o">==</span> <span class="n">rel_query_name</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&quot;Reverse query name for m2m field &#39;</span><span class="si">%s</span><span class="s">&#39; clashes with related field &#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;. Add a related_name argument to the definition for &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">rel_opts</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">get_accessor_name</span><span class="p">(),</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Check ordering attribute.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">ordering</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s">&#39;?&#39;</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">):</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">field_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">opts</span><span class="o">.</span><span class="n">order_with_respect_to</span> <span class="ow">and</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s">&#39;_order&#39;</span><span class="p">:</span>
                    <span class="k">continue</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Skip ordering in the format field1__field2 (FIXME: checking
this format would be nice, but it's a little fiddly).</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="s">&#39;__&#39;</span> <span class="ow">in</span> <span class="n">field_name</span><span class="p">:</span>
                    <span class="k">continue</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Skip ordering on pk. This is always a valid order<em>by field
but is an alias and therefore won't be found by opts.get</em>field.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="n">field_name</span> <span class="o">==</span> <span class="s">&#39;pk&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">opts</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">many_to_many</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">models</span><span class="o">.</span><span class="n">FieldDoesNotExist</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;ordering&quot; refers to &quot;</span><span class="si">%s</span><span class="s">&quot;, a field that doesn</span><span class="se">\&#39;</span><span class="s">t exist.&#39;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Check unique_together.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="n">ut</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">unique_together</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">ut</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">opts</span><span class="o">.</span><span class="n">get_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">many_to_many</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">models</span><span class="o">.</span><span class="n">FieldDoesNotExist</span><span class="p">:</span>
                    <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;unique_together&quot; refers to </span><span class="si">%s</span><span class="s">, a field that doesn</span><span class="se">\&#39;</span><span class="s">t exist. Check your syntax.&#39;</span> <span class="o">%</span> <span class="n">field_name</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyRel</span><span class="p">):</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;unique_together&quot; refers to </span><span class="si">%s</span><span class="s">. ManyToManyFields are not supported in unique_together.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">opts</span><span class="o">.</span><span class="n">local_fields</span><span class="p">:</span>
                        <span class="n">e</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="s">&#39;&quot;unique_together&quot; refers to </span><span class="si">%s</span><span class="s">. This is not in the same model as the unique_together statement.&#39;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
