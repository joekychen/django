<!DOCTYPE html>
<html><head><title>joekychen/django » django › core › management › commands › syncdb.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>syncdb.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">optparse</span> <span class="kn">import</span> <span class="n">make_option</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">call_command</span>
<span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">NoArgsCommand</span>
<span class="kn">from</span> <span class="nn">django.core.management.color</span> <span class="kn">import</span> <span class="n">no_style</span>
<span class="kn">from</span> <span class="nn">django.core.management.sql</span> <span class="kn">import</span> <span class="n">custom_sql_for_model</span><span class="p">,</span> <span class="n">emit_post_sync_signal</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connections</span><span class="p">,</span> <span class="n">router</span><span class="p">,</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">models</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span>
<span class="kn">from</span> <span class="nn">django.utils.datastructures</span> <span class="kn">import</span> <span class="n">SortedDict</span>
<span class="kn">from</span> <span class="nn">django.utils.importlib</span> <span class="kn">import</span> <span class="n">import_module</span>


<span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">NoArgsCommand</span><span class="p">):</span>
    <span class="n">option_list</span> <span class="o">=</span> <span class="n">NoArgsCommand</span><span class="o">.</span><span class="n">option_list</span> <span class="o">+</span> <span class="p">(</span>
        <span class="n">make_option</span><span class="p">(</span><span class="s">&#39;--noinput&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;interactive&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;Tells Django to NOT prompt the user for input of any kind.&#39;</span><span class="p">),</span>
        <span class="n">make_option</span><span class="p">(</span><span class="s">&#39;--no-initial-data&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_false&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;load_initial_data&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s">&#39;Tells Django not to load any initial data after database synchronization.&#39;</span><span class="p">),</span>
        <span class="n">make_option</span><span class="p">(</span><span class="s">&#39;--database&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s">&#39;database&#39;</span><span class="p">,</span>
            <span class="n">default</span><span class="o">=</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&#39;Nominates a database to synchronize. &#39;</span>
                <span class="s">&#39;Defaults to the &quot;default&quot; database.&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s">&quot;Create the database tables for all apps in INSTALLED_APPS whose tables haven&#39;t already been created.&quot;</span>

    <span class="k">def</span> <span class="nf">handle_noargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>

        <span class="n">verbosity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;verbosity&#39;</span><span class="p">))</span>
        <span class="n">interactive</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;interactive&#39;</span><span class="p">)</span>
        <span class="n">show_traceback</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;traceback&#39;</span><span class="p">)</span>
        <span class="n">load_initial_data</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;load_initial_data&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">style</span> <span class="o">=</span> <span class="n">no_style</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Import the 'management' module within each installed app, to register
dispatcher events.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;.management&#39;</span><span class="p">,</span> <span class="n">app_name</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>This is slightly hackish. We want to ignore ImportErrors
if the "management" module itself is missing -- but we don't
want to ignore the exception if the management module exists
but raises an ImportError for some reason. The only way we
can do this is to check the text of the exception. Note that
we're a bit broad in how we check the text, because different
Python implementations may not use the same text.
CPython uses the text "No module named management"
PyPy uses "No module named myproject.myapp.management"</p></td><td class="code"><div class="highlight"><pre>                <span class="n">msg</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">msg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;No module named&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;management&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">msg</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="n">db</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;database&#39;</span><span class="p">)</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">db</span><span class="p">]</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Get a list of already installed <em>models</em> so that references work right.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">tables</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">table_names</span><span class="p">()</span>
        <span class="n">seen_models</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">installed_models</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
        <span class="n">created_models</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">pending_references</span> <span class="o">=</span> <span class="p">{}</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Build the manifest of apps and models that are to be synchronized</p></td><td class="code"><div class="highlight"><pre>        <span class="n">all_models</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">get_models</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">include_auto_created</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">router</span><span class="o">.</span><span class="n">allow_syncdb</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">m</span><span class="p">)])</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">models</span><span class="o">.</span><span class="n">get_apps</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="k">def</span> <span class="nf">model_installed</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
            <span class="n">opts</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span>
            <span class="n">converter</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">table_name_converter</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="p">((</span><span class="n">converter</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">auto_created</span> <span class="ow">and</span> <span class="n">converter</span><span class="p">(</span><span class="n">opts</span><span class="o">.</span><span class="n">auto_created</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">))</span>

        <span class="n">manifest</span> <span class="o">=</span> <span class="n">SortedDict</span><span class="p">(</span>
            <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="nb">filter</span><span class="p">(</span><span class="n">model_installed</span><span class="p">,</span> <span class="n">model_list</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">model_list</span> <span class="ow">in</span> <span class="n">all_models</span>
        <span class="p">)</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Create the tables for each model</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Creating tables ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">model_list</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Create the model's database table, if it doesn't already exist.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Processing </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> model</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">))</span>
                <span class="n">sql</span><span class="p">,</span> <span class="n">references</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">sql_create_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">seen_models</span><span class="p">)</span>
                <span class="n">seen_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="n">created_models</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">refto</span><span class="p">,</span> <span class="n">refs</span> <span class="ow">in</span> <span class="n">references</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">pending_references</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">refto</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">refs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">refto</span> <span class="ow">in</span> <span class="n">seen_models</span><span class="p">:</span>
                        <span class="n">sql</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">sql_for_pending_references</span><span class="p">(</span><span class="n">refto</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">pending_references</span><span class="p">))</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">sql_for_pending_references</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">pending_references</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">sql</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Creating table </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">statement</span> <span class="ow">in</span> <span class="n">sql</span><span class="p">:</span>
                    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">statement</span><span class="p">)</span>
                <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">introspection</span><span class="o">.</span><span class="n">table_name_converter</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">))</span>


        <span class="n">transaction</span><span class="o">.</span><span class="n">commit_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Send the post_syncdb signal, so individual apps can do whatever they need
to do at this point.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">emit_post_sync_signal</span><span class="p">(</span><span class="n">created_models</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>The connection may have been closed by a syncdb handler.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">cursor</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Install custom SQL for the app (but only if this
is a model we've just created)</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Installing custom SQL ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">model_list</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">created_models</span><span class="p">:</span>
                    <span class="n">custom_sql</span> <span class="o">=</span> <span class="n">custom_sql_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">custom_sql</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Installing custom SQL for </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> model</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="n">custom_sql</span><span class="p">:</span>
                                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Failed to install custom SQL for </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> model: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> \
                                                <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">show_traceback</span><span class="p">:</span>
                                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
                            <span class="n">transaction</span><span class="o">.</span><span class="n">rollback_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">transaction</span><span class="o">.</span><span class="n">commit_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;No custom SQL for </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> model</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Installing indexes ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Install SQL indices for all newly created models</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">model_list</span> <span class="ow">in</span> <span class="n">manifest</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">created_models</span><span class="p">:</span>
                    <span class="n">index_sql</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">sql_indexes_for_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">index_sql</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Installing index for </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> model</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">sql</span> <span class="ow">in</span> <span class="n">index_sql</span><span class="p">:</span>
                                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Failed to install index for </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s"> model: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> \
                                                <span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
                            <span class="n">transaction</span><span class="o">.</span><span class="n">rollback_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">transaction</span><span class="o">.</span><span class="n">commit_unless_managed</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">db</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Load initial_data fixtures (unless that has been disabled)</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">load_initial_data</span><span class="p">:</span>
            <span class="n">call_command</span><span class="p">(</span><span class="s">&#39;loaddata&#39;</span><span class="p">,</span> <span class="s">&#39;initial_data&#39;</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="n">verbosity</span><span class="p">,</span>
                         <span class="n">database</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">skip_validation</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
