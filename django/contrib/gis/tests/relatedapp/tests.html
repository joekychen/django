<!DOCTYPE html>
<html><head><title>joekychen/django » django › contrib › gis › tests › relatedapp › tests.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>tests.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="kn">from</span> <span class="nn">django.contrib.gis.geos</span> <span class="kn">import</span> <span class="n">GEOSGeometry</span><span class="p">,</span> <span class="n">Point</span><span class="p">,</span> <span class="n">MultiPoint</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.db.models</span> <span class="kn">import</span> <span class="n">Collect</span><span class="p">,</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Extent</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.geometry.backend</span> <span class="kn">import</span> <span class="n">Geometry</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.tests.utils</span> <span class="kn">import</span> <span class="n">mysql</span><span class="p">,</span> <span class="n">oracle</span><span class="p">,</span> <span class="n">no_mysql</span><span class="p">,</span> <span class="n">no_oracle</span><span class="p">,</span> <span class="n">no_spatialite</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">City</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">DirectoryEntry</span><span class="p">,</span> <span class="n">Parcel</span><span class="p">,</span> <span class="n">Book</span><span class="p">,</span> <span class="n">Author</span><span class="p">,</span> <span class="n">Article</span>


<span class="k">class</span> <span class="nc">RelatedGeoModelTest</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test02_select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing `select_related` on geographic models (see #7126).&quot;</span>
        <span class="n">qs1</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">qs2</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">()</span>
        <span class="n">qs3</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;location&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Reference data for what's in the fixtures.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">cities</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&#39;Aurora&#39;</span><span class="p">,</span> <span class="s">&#39;TX&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">97.516111</span><span class="p">,</span> <span class="mf">33.058333</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Roswell&#39;</span><span class="p">,</span> <span class="s">&#39;NM&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">104.528056</span><span class="p">,</span> <span class="mf">33.387222</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&#39;Kecksburg&#39;</span><span class="p">,</span> <span class="s">&#39;PA&#39;</span><span class="p">,</span>  <span class="o">-</span><span class="mf">79.460734</span><span class="p">,</span> <span class="mf">40.18476</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">qs</span> <span class="ow">in</span> <span class="p">(</span><span class="n">qs1</span><span class="p">,</span> <span class="n">qs2</span><span class="p">,</span> <span class="n">qs3</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ref</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cities</span><span class="p">,</span> <span class="n">qs</span><span class="p">):</span>
                <span class="n">nm</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">ref</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">Point</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>

    <span class="nd">@no_mysql</span>
    <span class="k">def</span> <span class="nf">test03_transform_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing the `transform` GeoQuerySet method on related geographic models.&quot;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>All the transformations are to state plane coordinate systems using
US Survey Feet (thus a tolerance of 0 implies error w/in 1 survey foot).</p></td><td class="code"><div class="highlight"><pre>        <span class="n">tol</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">def</span> <span class="nf">check_pnt</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">pnt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pnt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">pnt</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">srid</span><span class="p">,</span> <span class="n">pnt</span><span class="o">.</span><span class="n">srid</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Each city transformed to the SRID of their state plane coordinate system.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">transformed</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;Kecksburg&#39;</span><span class="p">,</span> <span class="mi">2272</span><span class="p">,</span> <span class="s">&#39;POINT(1490553.98959621 314792.131023984)&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s">&#39;Roswell&#39;</span><span class="p">,</span> <span class="mi">2257</span><span class="p">,</span> <span class="s">&#39;POINT(481902.189077221 868477.766629735)&#39;</span><span class="p">),</span>
                       <span class="p">(</span><span class="s">&#39;Aurora&#39;</span><span class="p">,</span> <span class="mi">2276</span><span class="p">,</span> <span class="s">&#39;POINT(2269923.2484839 7069381.28722222)&#39;</span><span class="p">),</span>
                       <span class="p">)</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">srid</span><span class="p">,</span> <span class="n">wkt</span> <span class="ow">in</span> <span class="n">transformed</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Doing this implicitly sets <code>select_related</code> select the location.
TODO: Fix why this breaks on Oracle.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">qs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">srid</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="s">&#39;location__point&#39;</span><span class="p">))</span>
            <span class="n">check_pnt</span><span class="p">(</span><span class="n">GEOSGeometry</span><span class="p">(</span><span class="n">wkt</span><span class="p">,</span> <span class="n">srid</span><span class="p">),</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>

    <span class="nd">@no_mysql</span>
    <span class="nd">@no_spatialite</span>
    <span class="k">def</span> <span class="nf">test04a_related_extent_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing the `extent` GeoQuerySet aggregates on related geographic models.&quot;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>This combines the Extent and Union aggregates into one query</p></td><td class="code"><div class="highlight"><pre>        <span class="n">aggs</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Extent</span><span class="p">(</span><span class="s">&#39;location__point&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>One for all locations, one that excludes New Mexico (Roswell).</p></td><td class="code"><div class="highlight"><pre>        <span class="n">all_extent</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">104.528056</span><span class="p">,</span> <span class="mf">29.763374</span><span class="p">,</span> <span class="o">-</span><span class="mf">79.460734</span><span class="p">,</span> <span class="mf">40.18476</span><span class="p">)</span>
        <span class="n">txpa_extent</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">97.516111</span><span class="p">,</span> <span class="mf">29.763374</span><span class="p">,</span> <span class="o">-</span><span class="mf">79.460734</span><span class="p">,</span> <span class="mf">40.18476</span><span class="p">)</span>
        <span class="n">e1</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extent</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s">&#39;location__point&#39;</span><span class="p">)</span>
        <span class="n">e2</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">&#39;NM&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">extent</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s">&#39;location__point&#39;</span><span class="p">)</span>
        <span class="n">e3</span> <span class="o">=</span> <span class="n">aggs</span><span class="p">[</span><span class="s">&#39;location__point__extent&#39;</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>The tolerance value is to four decimal places because of differences
between the Oracle and PostGIS spatial backends on the extent calculation.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">tol</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">for</span> <span class="n">ref</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">all_extent</span><span class="p">,</span> <span class="n">e1</span><span class="p">),</span> <span class="p">(</span><span class="n">txpa_extent</span><span class="p">,</span> <span class="n">e2</span><span class="p">),</span> <span class="p">(</span><span class="n">all_extent</span><span class="p">,</span> <span class="n">e3</span><span class="p">)]:</span>
            <span class="k">for</span> <span class="n">ref_val</span><span class="p">,</span> <span class="n">e_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertAlmostEqual</span><span class="p">(</span><span class="n">ref_val</span><span class="p">,</span> <span class="n">e_val</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>

    <span class="nd">@no_mysql</span>
    <span class="k">def</span> <span class="nf">test04b_related_union_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing the `unionagg` GeoQuerySet aggregates on related geographic models.&quot;</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>This combines the Extent and Union aggregates into one query</p></td><td class="code"><div class="highlight"><pre>        <span class="n">aggs</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Union</span><span class="p">(</span><span class="s">&#39;location__point&#39;</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>These are the points that are components of the aggregate geographic
union that is returned.  Each point # corresponds to City PK.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">p1</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">104.528056</span><span class="p">,</span> <span class="mf">33.387222</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">97.516111</span><span class="p">,</span> <span class="mf">33.058333</span><span class="p">)</span>
        <span class="n">p3</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">79.460734</span><span class="p">,</span> <span class="mf">40.18476</span><span class="p">)</span>
        <span class="n">p4</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">96.801611</span><span class="p">,</span> <span class="mf">32.782057</span><span class="p">)</span>
        <span class="n">p5</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="o">-</span><span class="mf">95.363151</span><span class="p">,</span> <span class="mf">29.763374</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Creating the reference union geometry depending on the spatial backend,
as Oracle will have a different internal ordering of the component
geometries than PostGIS.  The second union aggregate is for a union
query that includes limiting information in the WHERE clause (in other
words a <code>.filter()</code> precedes the call to <code>.unionagg()</code>).</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">oracle</span><span class="p">:</span>
            <span class="n">ref_u1</span> <span class="o">=</span> <span class="n">MultiPoint</span><span class="p">(</span><span class="n">p4</span><span class="p">,</span> <span class="n">p5</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
            <span class="n">ref_u2</span> <span class="o">=</span> <span class="n">MultiPoint</span><span class="p">(</span><span class="n">p3</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Looks like PostGIS points by longitude value.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">ref_u1</span> <span class="o">=</span> <span class="n">MultiPoint</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p4</span><span class="p">,</span> <span class="n">p5</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
            <span class="n">ref_u2</span> <span class="o">=</span> <span class="n">MultiPoint</span><span class="p">(</span><span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>

        <span class="n">u1</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">unionagg</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s">&#39;location__point&#39;</span><span class="p">)</span>
        <span class="n">u2</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">name__in</span><span class="o">=</span><span class="p">(</span><span class="s">&#39;Roswell&#39;</span><span class="p">,</span> <span class="s">&#39;Houston&#39;</span><span class="p">,</span> <span class="s">&#39;Dallas&#39;</span><span class="p">,</span> <span class="s">&#39;Fort Worth&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">unionagg</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s">&#39;location__point&#39;</span><span class="p">)</span>
        <span class="n">u3</span> <span class="o">=</span> <span class="n">aggs</span><span class="p">[</span><span class="s">&#39;location__point__union&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ref_u1</span><span class="p">,</span> <span class="n">u1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ref_u2</span><span class="p">,</span> <span class="n">u2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ref_u1</span><span class="p">,</span> <span class="n">u3</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test05_select_related_fk_to_subclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing that calling select_related on a query over a model with an FK to a model subclass works&quot;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Regression test for #9752.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">DirectoryEntry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">select_related</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test06_f_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing F() expressions on GeometryFields.&quot;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Constructing a dummy parcel border and getting the City instance for
assigning the FK.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">b1</span> <span class="o">=</span> <span class="n">GEOSGeometry</span><span class="p">(</span><span class="s">&#39;POLYGON((-97.501205 33.052520,-97.501205 33.052576,-97.501150 33.052576,-97.501150 33.052520,-97.501205 33.052520))&#39;</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">)</span>
        <span class="n">pcity</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Aurora&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>First parcel has incorrect center point that is equal to the City;
it also has a second border that is different from the first as a
100ft buffer around the City.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">c1</span> <span class="o">=</span> <span class="n">pcity</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">point</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="mi">2276</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">b2</span> <span class="o">=</span> <span class="n">c2</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">Parcel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;P1&#39;</span><span class="p">,</span> <span class="n">city</span><span class="o">=</span><span class="n">pcity</span><span class="p">,</span> <span class="n">center1</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">center2</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span> <span class="n">border1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">border2</span><span class="o">=</span><span class="n">b2</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Now creating a second Parcel where the borders are the same, just
in different coordinate systems.  The center points are also the
same (but in different coordinate systems), and this time they
actually correspond to the centroid of the border.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">c1</span> <span class="o">=</span> <span class="n">b1</span><span class="o">.</span><span class="n">centroid</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="mi">2276</span><span class="p">,</span> <span class="n">clone</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="n">Parcel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;P2&#39;</span><span class="p">,</span> <span class="n">city</span><span class="o">=</span><span class="n">pcity</span><span class="p">,</span> <span class="n">center1</span><span class="o">=</span><span class="n">c1</span><span class="p">,</span> <span class="n">center2</span><span class="o">=</span><span class="n">c2</span><span class="p">,</span> <span class="n">border1</span><span class="o">=</span><span class="n">b1</span><span class="p">,</span> <span class="n">border2</span><span class="o">=</span><span class="n">b1</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Should return the second Parcel, which has the center within the
border.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Parcel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">center1__within</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;border1&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;P2&#39;</span><span class="p">,</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mysql</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>This time center2 is in a different coordinate system and needs
to be wrapped in transformation SQL.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">qs</span> <span class="o">=</span> <span class="n">Parcel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">center2__within</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;border1&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;P2&#39;</span><span class="p">,</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Should return the first Parcel, which has the center point equal
to the point in the City ForeignKey.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Parcel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">center1</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;city__location__point&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;P1&#39;</span><span class="p">,</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">mysql</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>This time the city column should be wrapped in transformation SQL.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">qs</span> <span class="o">=</span> <span class="n">Parcel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">border2__contains</span><span class="o">=</span><span class="n">F</span><span class="p">(</span><span class="s">&#39;city__location__point&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s">&#39;P1&#39;</span><span class="p">,</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test07_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing values() and values_list() and GeoQuerySets.&quot;</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>GeoQuerySet and GeoValuesQuerySet, and GeoValuesListQuerySet respectively.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">gqs</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">gvqs</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">gvlqs</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Incrementing through each of the models, dictionaries, and tuples
returned by the different types of GeoQuerySets.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">gqs</span><span class="p">,</span> <span class="n">gvqs</span><span class="p">,</span> <span class="n">gvlqs</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>The values should be Geometry objects and not raw strings returned
by the spatial database.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s">&#39;point&#39;</span><span class="p">],</span> <span class="n">Geometry</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">Geometry</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">point</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="s">&#39;point&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">point</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test08_defer_only</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing defer() and only() on Geographic models.&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">def_qs</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">defer</span><span class="p">(</span><span class="s">&#39;point&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">loc</span><span class="p">,</span> <span class="n">def_loc</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">def_qs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">loc</span><span class="o">.</span><span class="n">point</span><span class="p">,</span> <span class="n">def_loc</span><span class="o">.</span><span class="n">point</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test09_pk_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Ensuring correct primary key column is selected across relations. See #10757.&quot;</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>The expected ID values -- notice the last two location IDs
are out of order.  Dallas and Houston have location IDs that differ
from their PKs -- this is done to ensure that the related location
ID column is selected instead of ID column for the city.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">city_ids</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">loc_ids</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
        <span class="n">ids_qs</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;location__id&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">val_dict</span><span class="p">,</span> <span class="n">c_id</span><span class="p">,</span> <span class="n">l_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ids_qs</span><span class="p">,</span> <span class="n">city_ids</span><span class="p">,</span> <span class="n">loc_ids</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val_dict</span><span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">],</span> <span class="n">c_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">val_dict</span><span class="p">[</span><span class="s">&#39;location__id&#39;</span><span class="p">],</span> <span class="n">l_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test10_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing the combination of two GeoQuerySets.  See #10807.&quot;</span>
        <span class="n">buf1</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Aurora&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">buf2</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Kecksburg&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">point</span><span class="o">.</span><span class="n">buffer</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">qs1</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">location__point__within</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
        <span class="n">qs2</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">location__point__within</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">qs1</span> <span class="o">|</span> <span class="n">qs2</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combined</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;Aurora&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s">&#39;Kecksburg&#39;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test11_geoquery_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Ensuring GeoQuery objects are unpickled correctly.  See #10839.&quot;</span>
        <span class="kn">import</span> <span class="nn">pickle</span>
        <span class="kn">from</span> <span class="nn">django.contrib.gis.db.models.sql</span> <span class="kn">import</span> <span class="n">GeoQuery</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">q_str</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">q_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">GeoQuery</span><span class="p">,</span> <span class="n">q</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>TODO: fix on Oracle -- get the following error because the SQL is ordered
by a geometry object, which Oracle apparently doesn't like:
 ORA-22901: cannot compare nested table or VARRAY or LOB attributes of an object type</p></td><td class="code"><div class="highlight"><pre>    <span class="nd">@no_oracle</span>
    <span class="k">def</span> <span class="nf">test12a_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing `Count` aggregate use with the `GeoManager` on geo-fields.&quot;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>The City, 'Fort Worth' uses the same location as Dallas.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">dallas</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;Dallas&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Count annotation should be 2 for the Dallas location now.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">loc</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_cities</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;city&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">dallas</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">loc</span><span class="o">.</span><span class="n">num_cities</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test12b_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing `Count` aggregate use with the `GeoManager` on non geo-fields. See #11087.&quot;</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Should only be one author (Trevor Paglen) returned by this query, and
the annotation should have 3 for the number of books, see #11087.
Also testing with a <code>GeoValuesQuerySet</code>, see #11489.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">qs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;books&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_books__gt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vqs</span> <span class="o">=</span> <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;books&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">num_books__gt</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_books</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">vqs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">vqs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;num_books&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">test13c_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing `Count` aggregate with `.values()`.  See #15305.&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Location</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_cities</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;city&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;point&#39;</span><span class="p">,</span> <span class="s">&#39;num_cities&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">qs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;num_cities&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">qs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;point&#39;</span><span class="p">],</span> <span class="n">GEOSGeometry</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>TODO: The phantom model does appear on Oracle.</p></td><td class="code"><div class="highlight"><pre>    <span class="nd">@no_oracle</span>
    <span class="k">def</span> <span class="nf">test13_select_related_null_fk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing `select_related` on a nullable ForeignKey via `GeoManager`. See #11381.&quot;</span>
        <span class="n">no_author</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Without Author&#39;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">Book</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;author&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s">&#39;Without Author&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>Should be <code>None</code>, and not a 'dummy' model.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">b</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>

    <span class="nd">@no_mysql</span>
    <span class="nd">@no_oracle</span>
    <span class="nd">@no_spatialite</span>
    <span class="k">def</span> <span class="nf">test14_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing the `collect` GeoQuerySet method and `Collect` aggregate.&quot;</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>Reference query:
SELECT AsText(ST<em>Collect("relatedapp</em>location"."point")) FROM "relatedapp<em>city" LEFT OUTER JOIN
   "relatedapp</em>location" ON ("relatedapp<em>city"."location</em>id" = "relatedapp<em>location"."id")
   WHERE "relatedapp</em>city"."state" = 'TX';</p></td><td class="code"><div class="highlight"><pre>        <span class="n">ref_geom</span> <span class="o">=</span> <span class="n">GEOSGeometry</span><span class="p">(</span><span class="s">&#39;MULTIPOINT(-97.516111 33.058333,-96.801611 32.782057,-95.363151 29.763374,-96.801611 32.782057)&#39;</span><span class="p">)</span>

        <span class="n">c1</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">&#39;TX&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s">&#39;location__point&#39;</span><span class="p">)</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="n">City</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="s">&#39;TX&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Collect</span><span class="p">(</span><span class="s">&#39;location__point&#39;</span><span class="p">))[</span><span class="s">&#39;location__point__collect&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">coll</span> <span class="ow">in</span> <span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>Even though Dallas and Ft. Worth share same point, Collect doesn't
consolidate -- that's why 4 points in MultiPoint.</p></td><td class="code"><div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">coll</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">ref_geom</span><span class="p">,</span> <span class="n">coll</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test15_invalid_select_related</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Testing doing select_related on the related name manager of a unique FK. See #13934.&quot;</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">&#39;author__article&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>This triggers TypeError when <code>get_default_columns</code> has no <code>local_only</code>
keyword.  The TypeError is swallowed if QuerySet is actually
evaluated as list generation swallows TypeError in CPython.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">sql</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">qs</span><span class="o">.</span><span class="n">query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test16_annotated_date_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Ensure annotated date querysets work if spatial backend is used.  See #14648.&quot;</span>
        <span class="n">birth_years</span> <span class="o">=</span> <span class="p">[</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span>
                       <span class="nb">list</span><span class="p">(</span><span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">num_books</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">&#39;books&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">dates</span><span class="p">(</span><span class="s">&#39;dob&#39;</span><span class="p">,</span> <span class="s">&#39;year&#39;</span><span class="p">))]</span>
        <span class="n">birth_years</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">([</span><span class="mi">1950</span><span class="p">,</span> <span class="mi">1974</span><span class="p">],</span> <span class="n">birth_years</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>TODO: Related tests for KML, GML, and distance lookups.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
