<!DOCTYPE html>
<html><head><title>joekychen/django » django › contrib › gis › templates › gis › admin › openlayers.js

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../../index.html"></a><h1>openlayers.js</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="p">{</span><span class="o">%</span> <span class="nx">load</span> <span class="nx">l10n</span> <span class="o">%</span><span class="p">}{</span><span class="err">#</span> <span class="nx">Author</span><span class="o">:</span> <span class="nx">Justin</span> <span class="nx">Bronn</span><span class="p">,</span> <span class="nx">Travis</span> <span class="nx">Pinney</span> <span class="o">&amp;</span> <span class="nx">Dane</span> <span class="nx">Springmeyer</span> <span class="err">#</span><span class="p">}</span>
<span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Projection</span><span class="p">.</span><span class="nx">addTransform</span><span class="p">(</span><span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="s2">&quot;EPSG:3857&quot;</span><span class="p">,</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">SphericalMercator</span><span class="p">.</span><span class="nx">projectForward</span><span class="p">);</span>
<span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">vars</span> <span class="o">%</span><span class="p">}</span><span class="kd">var</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">controls</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">panel</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">re</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s2">&quot;^SRID=\\d+;(.+)&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">);</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span> <span class="o">=</span> <span class="p">{};</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">modifiable</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">modifiable</span><span class="o">|</span><span class="nx">yesno</span><span class="o">:</span><span class="s2">&quot;true,false&quot;</span> <span class="p">}};</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">wkt_f</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Format</span><span class="p">.</span><span class="nx">WKT</span><span class="p">();</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_collection</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">is_collection</span><span class="o">|</span><span class="nx">yesno</span><span class="o">:</span><span class="s2">&quot;true,false&quot;</span> <span class="p">}};</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">collection_type</span> <span class="o">=</span> <span class="s1">&#39;{{ collection_type }}&#39;</span><span class="p">;</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_linestring</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">is_linestring</span><span class="o">|</span><span class="nx">yesno</span><span class="o">:</span><span class="s2">&quot;true,false&quot;</span> <span class="p">}};</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_polygon</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">is_polygon</span><span class="o">|</span><span class="nx">yesno</span><span class="o">:</span><span class="s2">&quot;true,false&quot;</span> <span class="p">}};</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_point</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">is_point</span><span class="o">|</span><span class="nx">yesno</span><span class="o">:</span><span class="s2">&quot;true,false&quot;</span> <span class="p">}};</span>
<span class="p">{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">get_ewkt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">feat</span><span class="p">){</span><span class="k">return</span> <span class="s1">&#39;SRID={{ srid }};&#39;</span> <span class="o">+</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">wkt_f</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">feat</span><span class="p">);}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">read_wkt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">wkt</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>OpenLayers cannot handle EWKT -- we make sure to strip it out.
EWKT is only exposed to OL if there's a validation error in the admin.</p></td><td class="code"><div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">wkt</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">match</span><span class="p">){</span><span class="nx">wkt</span> <span class="o">=</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">];}</span>
  <span class="k">return</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">wkt_f</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">wkt</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">write_wkt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">feat</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_collection</span><span class="p">){</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">num_geom</span> <span class="o">=</span> <span class="nx">feat</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">components</span><span class="p">.</span><span class="nx">length</span><span class="p">;}</span>
  <span class="k">else</span> <span class="p">{</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">num_geom</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;}</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;{{ id }}&#39;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">get_ewkt</span><span class="p">(</span><span class="nx">feat</span><span class="p">);</span>
<span class="p">}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">add_wkt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>This function will sync the contents of the <code>vector</code> layer with the
WKT in the text field.</p></td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_collection</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">feat</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.{{</span> <span class="nx">geom_type</span> <span class="p">}}());</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
      <span class="nx">feat</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">addComponents</span><span class="p">([{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">features</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">geometry</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">write_wkt</span><span class="p">(</span><span class="nx">feat</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Make sure to remove any previously added features.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">){</span>
      <span class="nx">old_feats</span> <span class="o">=</span> <span class="p">[{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">features</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">removeFeatures</span><span class="p">(</span><span class="nx">old_feats</span><span class="p">);</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">destroyFeatures</span><span class="p">(</span><span class="nx">old_feats</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">write_wkt</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">modify_wkt</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">){</span>
  <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_collection</span><span class="p">){</span>
    <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_point</span><span class="p">){</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">add_wkt</span><span class="p">(</span><span class="nx">event</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>When modifying the selected components are added to the
vector layer so we only increment to the <code>num_geom</code> value.</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">feat</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">.{{</span> <span class="nx">geom_type</span> <span class="p">}}());</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">num_geom</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
	<span class="nx">feat</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">addComponents</span><span class="p">([{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">features</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">geometry</span><span class="p">]);</span>
      <span class="p">}</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">write_wkt</span><span class="p">(</span><span class="nx">feat</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">write_wkt</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">feature</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Function to clear vector features and purge wkt from div</p></td><td class="code"><div class="highlight"><pre><span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">deleteFeatures</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">removeFeatures</span><span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">features</span><span class="p">);</span>
  <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">destroyFeatures</span><span class="p">();</span>
<span class="p">}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">clearFeatures</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(){</span>
  <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">deleteFeatures</span><span class="p">();</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;{{ id }}&#39;</span><span class="p">).</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  <span class="p">{</span><span class="o">%</span> <span class="nx">localize</span> <span class="nx">off</span> <span class="o">%</span><span class="p">}</span>
  <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">setCenter</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">LonLat</span><span class="p">({{</span> <span class="nx">default_lon</span> <span class="p">}},</span> <span class="p">{{</span> <span class="nx">default_lat</span> <span class="p">}}),</span> <span class="p">{{</span> <span class="nx">default_zoom</span> <span class="p">}});</span>
  <span class="p">{</span><span class="o">%</span> <span class="nx">endlocalize</span> <span class="o">%</span><span class="p">}</span>
<span class="p">}</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Add Select control</p></td><td class="code"><div class="highlight"><pre><span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">addSelectControl</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">select</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">SelectFeature</span><span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;toggle&#39;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="s1">&#39;clickout&#39;</span> <span class="o">:</span> <span class="kc">true</span><span class="p">});</span>
  <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="nx">select</span><span class="p">);</span>
  <span class="nx">select</span><span class="p">.</span><span class="nx">activate</span><span class="p">();</span>
<span class="p">}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">enableDrawing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsByClass</span><span class="p">(</span><span class="s1">&#39;OpenLayers.Control.DrawFeature&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">activate</span><span class="p">();}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">enableEditing</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsByClass</span><span class="p">(</span><span class="s1">&#39;OpenLayers.Control.ModifyFeature&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">activate</span><span class="p">();}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Create an array of controls based on geometry type</p></td><td class="code"><div class="highlight"><pre><span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">getControls</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lyr</span><span class="p">){</span>
  <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">panel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Panel</span><span class="p">({</span><span class="s1">&#39;displayClass&#39;</span><span class="o">:</span> <span class="s1">&#39;olControlEditingToolbar&#39;</span><span class="p">});</span>
  <span class="kd">var</span> <span class="nx">nav</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Navigation</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">draw_ctl</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_linestring</span><span class="p">){</span>
    <span class="nx">draw_ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">DrawFeature</span><span class="p">(</span><span class="nx">lyr</span><span class="p">,</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Path</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;displayClass&#39;</span><span class="o">:</span> <span class="s1">&#39;olControlDrawFeaturePath&#39;</span><span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_polygon</span><span class="p">){</span>
    <span class="nx">draw_ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">DrawFeature</span><span class="p">(</span><span class="nx">lyr</span><span class="p">,</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Polygon</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;displayClass&#39;</span><span class="o">:</span> <span class="s1">&#39;olControlDrawFeaturePolygon&#39;</span><span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_point</span><span class="p">){</span>
    <span class="nx">draw_ctl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">DrawFeature</span><span class="p">(</span><span class="nx">lyr</span><span class="p">,</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Handler</span><span class="p">.</span><span class="nx">Point</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;displayClass&#39;</span><span class="o">:</span> <span class="s1">&#39;olControlDrawFeaturePoint&#39;</span><span class="p">});</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">modifiable</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">mod</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">ModifyFeature</span><span class="p">(</span><span class="nx">lyr</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;displayClass&#39;</span><span class="o">:</span> <span class="s1">&#39;olControlModifyFeature&#39;</span><span class="p">});</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">controls</span> <span class="o">=</span> <span class="p">[</span><span class="nx">nav</span><span class="p">,</span> <span class="nx">draw_ctl</span><span class="p">,</span> <span class="nx">mod</span><span class="p">];</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">lyr</span><span class="p">.</span><span class="nx">features</span><span class="p">.</span><span class="nx">length</span><span class="p">){</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">controls</span> <span class="o">=</span> <span class="p">[</span><span class="nx">nav</span><span class="p">,</span> <span class="nx">draw_ctl</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">controls</span> <span class="o">=</span> <span class="p">[</span><span class="nx">nav</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">map_options</span> <span class="o">%</span><span class="p">}</span><span class="c1">// The options hash, w/ zoom, resolution, and projection settings.</span>
    <span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span>
<span class="p">{</span><span class="o">%</span> <span class="nx">autoescape</span> <span class="nx">off</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">map_options</span><span class="p">.</span><span class="nx">items</span> <span class="o">%</span><span class="p">}</span>      <span class="s1">&#39;{{ item.0 }}&#39;</span> <span class="o">:</span> <span class="p">{{</span> <span class="nx">item</span><span class="p">.</span><span class="mi">1</span> <span class="p">}}{</span><span class="o">%</span> <span class="k">if</span> <span class="nx">not</span> <span class="nx">forloop</span><span class="p">.</span><span class="nx">last</span> <span class="o">%</span><span class="p">},{</span><span class="o">%</span> <span class="nx">endif</span> <span class="o">%</span><span class="p">}</span>
<span class="p">{</span><span class="o">%</span> <span class="nx">endfor</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nx">endautoescape</span> <span class="o">%</span><span class="p">}</span>    <span class="p">};{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>The admin map for this geometry field.</p></td><td class="code"><div class="highlight"><pre>    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Map</span><span class="p">(</span><span class="s1">&#39;{{ id }}_map&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Base Layer</p></td><td class="code"><div class="highlight"><pre>    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">base</span> <span class="o">=</span> <span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">base_layer</span> <span class="o">%</span><span class="p">}</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">WMS</span><span class="p">(</span><span class="s2">&quot;{{ wms_name }}&quot;</span><span class="p">,</span> <span class="s2">&quot;{{ wms_url }}&quot;</span><span class="p">,</span> <span class="p">{</span><span class="nx">layers</span><span class="o">:</span> <span class="s1">&#39;{{ wms_layer }}&#39;</span><span class="p">{{</span> <span class="nx">wms_options</span><span class="o">|</span><span class="nx">safe</span> <span class="p">}}});{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">base</span><span class="p">);</span>
    <span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">extra_layers</span> <span class="o">%</span><span class="p">}{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="nx">is_linestring</span> <span class="o">%</span><span class="p">}</span><span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">][</span><span class="s2">&quot;strokeWidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="c1">// Default too thin for linestrings. {% endif %}</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Layer</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="s2">&quot; {{ field_name }}&quot;</span><span class="p">);</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addLayer</span><span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Read WKT from the text field.</p></td><td class="code"><div class="highlight"><pre>    <span class="kd">var</span> <span class="nx">wkt</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;{{ id }}&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">wkt</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>After reading into geometry, immediately write back to
WKT <textarea> as EWKT (so that SRID is included).</p></td><td class="code"><div class="highlight"><pre>      <span class="kd">var</span> <span class="nx">admin_geom</span> <span class="o">=</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">read_wkt</span><span class="p">(</span><span class="nx">wkt</span><span class="p">);</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">write_wkt</span><span class="p">(</span><span class="nx">admin_geom</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_collection</span><span class="p">){</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>If geometry collection, add each component individually so they may be
edited individually.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">num_geom</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">){</span>
	  <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">([</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Feature</span><span class="p">.</span><span class="nx">Vector</span><span class="p">(</span><span class="nx">admin_geom</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">components</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">clone</span><span class="p">())]);</span>
	<span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">addFeatures</span><span class="p">([</span><span class="nx">admin_geom</span><span class="p">]);</span>
      <span class="p">}</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Zooming to the bounds.</p></td><td class="code"><div class="highlight"><pre>      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">zoomToExtent</span><span class="p">(</span><span class="nx">admin_geom</span><span class="p">.</span><span class="nx">geometry</span><span class="p">.</span><span class="nx">getBounds</span><span class="p">());</span>
      <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">is_point</span><span class="p">){</span>
          <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">zoomTo</span><span class="p">({{</span> <span class="nx">point_zoom</span> <span class="p">}});</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="p">{</span><span class="o">%</span> <span class="nx">localize</span> <span class="nx">off</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">setCenter</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">LonLat</span><span class="p">({{</span> <span class="nx">default_lon</span> <span class="p">}},</span> <span class="p">{{</span> <span class="nx">default_lat</span> <span class="p">}}),</span> <span class="p">{{</span> <span class="nx">default_zoom</span> <span class="p">}});</span>
      <span class="p">{</span><span class="o">%</span> <span class="nx">endlocalize</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>This allows editing of the geographic fields -- the modified WKT is
written back to the content field (as EWKT, so that the ORM will know
to transform back to original SRID).</p></td><td class="code"><div class="highlight"><pre>    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">({</span><span class="s2">&quot;featuremodified&quot;</span> <span class="o">:</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">modify_wkt</span><span class="p">});</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">on</span><span class="p">({</span><span class="s2">&quot;featureadded&quot;</span> <span class="o">:</span> <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">add_wkt</span><span class="p">});</span>
    <span class="p">{</span><span class="o">%</span> <span class="nx">block</span> <span class="nx">controls</span> <span class="o">%</span><span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Map controls:
Add geometry specific panel of toolbar controls</p></td><td class="code"><div class="highlight"><pre>    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">getControls</span><span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">layers</span><span class="p">.</span><span class="nx">vector</span><span class="p">);</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">panel</span><span class="p">.</span><span class="nx">addControls</span><span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">controls</span><span class="p">);</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">panel</span><span class="p">);</span>
    <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">addSelectControl</span><span class="p">();</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Then add optional visual controls</p></td><td class="code"><div class="highlight"><pre>    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="nx">mouse_position</span> <span class="o">%</span><span class="p">}{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">MousePosition</span><span class="p">());{</span><span class="o">%</span> <span class="nx">endif</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="nx">scale_text</span> <span class="o">%</span><span class="p">}{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">Scale</span><span class="p">());{</span><span class="o">%</span> <span class="nx">endif</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="nx">layerswitcher</span> <span class="o">%</span><span class="p">}{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">addControl</span><span class="p">(</span><span class="k">new</span> <span class="nx">OpenLayers</span><span class="p">.</span><span class="nx">Control</span><span class="p">.</span><span class="nx">LayerSwitcher</span><span class="p">());{</span><span class="o">%</span> <span class="nx">endif</span> <span class="o">%</span><span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Then add optional behavior controls</p></td><td class="code"><div class="highlight"><pre>    <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="nx">not</span> <span class="nx">scrollable</span> <span class="o">%</span><span class="p">}{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">map</span><span class="p">.</span><span class="nx">getControlsByClass</span><span class="p">(</span><span class="s1">&#39;OpenLayers.Control.Navigation&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">disableZoomWheel</span><span class="p">();{</span><span class="o">%</span> <span class="nx">endif</span> <span class="o">%</span><span class="p">}</span>
    <span class="p">{</span><span class="o">%</span> <span class="nx">endblock</span> <span class="o">%</span><span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">wkt</span><span class="p">){</span>
      <span class="k">if</span> <span class="p">({{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">modifiable</span><span class="p">){</span>
        <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">enableEditing</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="p">{{</span> <span class="nx">module</span> <span class="p">}}.</span><span class="nx">enableDrawing</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:6}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../../javascript/docco.min.js"></script>
</html>
