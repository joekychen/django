<!DOCTYPE html>
<html><head><title>joekychen/django » django › contrib › gis › gdal › libgdal.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>libgdal.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">c_char_p</span><span class="p">,</span> <span class="n">CDLL</span>
<span class="kn">from</span> <span class="nn">ctypes.util</span> <span class="kn">import</span> <span class="n">find_library</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.gdal.error</span> <span class="kn">import</span> <span class="n">OGRException</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Custom library path set?</p></td><td class="code"><div class="highlight"><pre><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
    <span class="n">lib_path</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GDAL_LIBRARY_PATH</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">EnvironmentError</span><span class="p">,</span> <span class="ne">ImportError</span><span class="p">):</span>
    <span class="n">lib_path</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">if</span> <span class="n">lib_path</span><span class="p">:</span>
    <span class="n">lib_names</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Windows NT shared libraries</p></td><td class="code"><div class="highlight"><pre>    <span class="n">lib_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;gdal19&#39;</span><span class="p">,</span> <span class="s">&#39;gdal18&#39;</span><span class="p">,</span> <span class="s">&#39;gdal17&#39;</span><span class="p">,</span> <span class="s">&#39;gdal16&#39;</span><span class="p">,</span> <span class="s">&#39;gdal15&#39;</span><span class="p">]</span>
<span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;posix&#39;</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>*NIX library names.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">lib_names</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;gdal&#39;</span><span class="p">,</span> <span class="s">&#39;GDAL&#39;</span><span class="p">,</span> <span class="s">&#39;gdal1.9.0&#39;</span><span class="p">,</span> <span class="s">&#39;gdal1.8.0&#39;</span><span class="p">,</span> <span class="s">&#39;gdal1.7.0&#39;</span><span class="p">,</span>
        <span class="s">&#39;gdal1.6.0&#39;</span><span class="p">,</span> <span class="s">&#39;gdal1.5.0&#39;</span><span class="p">,</span> <span class="s">&#39;gdal1.4.0&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">OGRException</span><span class="p">(</span><span class="s">&#39;Unsupported OS &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Using the ctypes <code>find_library</code> utility  to find the
path to the GDAL library from the list of library names.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">lib_names</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">lib_name</span> <span class="ow">in</span> <span class="n">lib_names</span><span class="p">:</span>
        <span class="n">lib_path</span> <span class="o">=</span> <span class="n">find_library</span><span class="p">(</span><span class="n">lib_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lib_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">break</span>

<span class="k">if</span> <span class="n">lib_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">OGRException</span><span class="p">(</span><span class="s">&#39;Could not find the GDAL library (tried &quot;</span><span class="si">%s</span><span class="s">&quot;). &#39;</span>
                       <span class="s">&#39;Try setting GDAL_LIBRARY_PATH in your settings.&#39;</span> <span class="o">%</span>
                       <span class="s">&#39;&quot;, &quot;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lib_names</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>This loads the GDAL/OGR C library</p></td><td class="code"><div class="highlight"><pre><span class="n">lgdal</span> <span class="o">=</span> <span class="n">CDLL</span><span class="p">(</span><span class="n">lib_path</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>On Windows, the GDAL binaries have some OSR routines exported with
STDCALL, while others are not.  Thus, the library will also need to
be loaded up as WinDLL for said OSR functions that require the
different calling convention.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">WinDLL</span>
    <span class="n">lwingdal</span> <span class="o">=</span> <span class="n">WinDLL</span><span class="p">(</span><span class="n">lib_path</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">std_call</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the correct STDCALL function for certain OSR routines on Win32</span>
<span class="sd">    platforms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lwingdal</span><span class="p">[</span><span class="n">func</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">lgdal</span><span class="p">[</span><span class="n">func</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><h3>Version-information functions.</h3></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Returns GDAL library version information with the given key.</p></td><td class="code"><div class="highlight"><pre><span class="n">_version_info</span> <span class="o">=</span> <span class="n">std_call</span><span class="p">(</span><span class="s">&#39;GDALVersionInfo&#39;</span><span class="p">)</span>
<span class="n">_version_info</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">c_char_p</span><span class="p">]</span>
<span class="n">_version_info</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">c_char_p</span>

<span class="k">def</span> <span class="nf">gdal_version</span><span class="p">():</span>
    <span class="s">&quot;Returns only the GDAL version number information.&quot;</span>
    <span class="k">return</span> <span class="n">_version_info</span><span class="p">(</span><span class="s">&#39;RELEASE_NAME&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gdal_full_version</span><span class="p">():</span>
    <span class="s">&quot;Returns the full GDAL version information.&quot;</span>
    <span class="k">return</span> <span class="n">_version_info</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gdal_release_date</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the release date in a string format, e.g, &quot;2007/06/27&quot;.</span>
<span class="sd">    If the date keyword argument is set to True, a Python datetime object</span>
<span class="sd">    will be returned instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span> <span class="k">as</span> <span class="n">date_type</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">_version_info</span><span class="p">(</span><span class="s">&#39;RELEASE_DATE&#39;</span><span class="p">)</span>
    <span class="n">yy</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">dd</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="p">(</span><span class="n">rel</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">rel</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">date_type</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">mm</span><span class="p">,</span> <span class="n">dd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">date</span><span class="p">:</span> <span class="k">return</span> <span class="n">d</span>
    <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%Y/%m/</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>

<span class="n">version_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;major&gt;\d+)\.(?P&lt;minor&gt;\d+)(\.(?P&lt;subminor&gt;\d+))?&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">gdal_version_info</span><span class="p">():</span>
    <span class="n">ver</span> <span class="o">=</span> <span class="n">gdal_version</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">version_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ver</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span> <span class="k">raise</span> <span class="n">OGRException</span><span class="p">(</span><span class="s">&#39;Could not parse GDAL version string &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">ver</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">key</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;major&#39;</span><span class="p">,</span> <span class="s">&#39;minor&#39;</span><span class="p">,</span> <span class="s">&#39;subminor&#39;</span><span class="p">)])</span>

<span class="n">_verinfo</span> <span class="o">=</span> <span class="n">gdal_version_info</span><span class="p">()</span>
<span class="n">GDAL_MAJOR_VERSION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_verinfo</span><span class="p">[</span><span class="s">&#39;major&#39;</span><span class="p">])</span>
<span class="n">GDAL_MINOR_VERSION</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_verinfo</span><span class="p">[</span><span class="s">&#39;minor&#39;</span><span class="p">])</span>
<span class="n">GDAL_SUBMINOR_VERSION</span> <span class="o">=</span> <span class="n">_verinfo</span><span class="p">[</span><span class="s">&#39;subminor&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">_verinfo</span><span class="p">[</span><span class="s">&#39;subminor&#39;</span><span class="p">])</span>
<span class="n">GDAL_VERSION</span> <span class="o">=</span> <span class="p">(</span><span class="n">GDAL_MAJOR_VERSION</span><span class="p">,</span> <span class="n">GDAL_MINOR_VERSION</span><span class="p">,</span> <span class="n">GDAL_SUBMINOR_VERSION</span><span class="p">)</span>
<span class="k">del</span> <span class="n">_verinfo</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>GeoJSON support is available only in GDAL 1.5+.</p></td><td class="code"><div class="highlight"><pre><span class="k">if</span> <span class="n">GDAL_VERSION</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
    <span class="n">GEOJSON</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">GEOJSON</span> <span class="o">=</span> <span class="bp">False</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
