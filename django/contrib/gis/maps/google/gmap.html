<!DOCTYPE html>
<html><head><title>joekychen/django » django › contrib › gis › maps › google › gmap.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>gmap.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.template.loader</span> <span class="kn">import</span> <span class="n">render_to_string</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">format_html</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>

<span class="kn">from</span> <span class="nn">django.contrib.gis.maps.google.overlays</span> <span class="kn">import</span> <span class="n">GPolygon</span><span class="p">,</span> <span class="n">GPolyline</span><span class="p">,</span> <span class="n">GMarker</span>

<span class="k">class</span> <span class="nc">GoogleMapException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>The default Google Maps URL (for the API javascript)
TODO: Internationalize for Japan, UK, etc.</p></td><td class="code"><div class="highlight"><pre><span class="n">GOOGLE_MAPS_URL</span><span class="o">=</span><span class="s">&#39;http://maps.google.com/maps?file=api&amp;v=</span><span class="si">%s</span><span class="s">&amp;key=&#39;</span>


<span class="k">class</span> <span class="nc">GoogleMap</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="s">&quot;A class for generating Google Maps JavaScript.&quot;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>String constants</p></td><td class="code"><div class="highlight"><pre>    <span class="n">onunload</span> <span class="o">=</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s">&#39;onunload=&quot;GUnload()&quot;&#39;</span><span class="p">)</span> <span class="c"># Cleans up after Google Maps</span>
    <span class="n">vml_css</span>  <span class="o">=</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s">&#39;v\:* {behavior:url(#default#VML);}&#39;</span><span class="p">)</span> <span class="c"># CSS for IE VML</span>
    <span class="n">xmlns</span>    <span class="o">=</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s">&#39;xmlns:v=&quot;urn:schemas-microsoft-com:vml&quot;&#39;</span><span class="p">)</span> <span class="c"># XML Namespace (for IE VML).</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">api_url</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">center</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">zoom</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dom_id</span><span class="o">=</span><span class="s">&#39;map&#39;</span><span class="p">,</span>
                 <span class="n">kml_urls</span><span class="o">=</span><span class="p">[],</span> <span class="n">polylines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">polygons</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">markers</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">template</span><span class="o">=</span><span class="s">&#39;gis/google/google-map.js&#39;</span><span class="p">,</span>
                 <span class="n">js_module</span><span class="o">=</span><span class="s">&#39;geodjango&#39;</span><span class="p">,</span>
                 <span class="n">extra_context</span><span class="o">=</span><span class="p">{}):</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>The Google Maps API Key defined in the settings will be used
if not passed in as a parameter.  The use of an API key is
<em>required</em>.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GOOGLE_MAPS_API_KEY</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">GoogleMapException</span><span class="p">(</span><span class="s">&#39;Google Maps API Key not found (try adding GOOGLE_MAPS_API_KEY to your settings).&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Getting the Google Maps API version, defaults to using the latest ("2.x"),
this is not necessarily the most stable.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">version</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;GOOGLE_MAPS_API_VERSION&#39;</span><span class="p">,</span> <span class="s">&#39;2.x&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">version</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Can specify the API URL in the <code>api_url</code> keyword.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="ow">not</span> <span class="n">api_url</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_url</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span> <span class="s">&#39;GOOGLE_MAPS_URL&#39;</span><span class="p">,</span> <span class="n">GOOGLE_MAPS_URL</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">api_url</span> <span class="o">=</span> <span class="n">api_url</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Setting the DOM id of the map, the load function, the JavaScript
template, and the KML URLs array.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">dom_id</span> <span class="o">=</span> <span class="n">dom_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_context</span> <span class="o">=</span> <span class="n">extra_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">js_module</span> <span class="o">=</span> <span class="n">js_module</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kml_urls</span> <span class="o">=</span> <span class="n">kml_urls</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Does the user want any GMarker, GPolygon, and/or GPolyline overlays?</p></td><td class="code"><div class="highlight"><pre>        <span class="n">overlay_info</span> <span class="o">=</span> <span class="p">[[</span><span class="n">GMarker</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="s">&#39;markers&#39;</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">GPolygon</span><span class="p">,</span> <span class="n">polygons</span><span class="p">,</span> <span class="s">&#39;polygons&#39;</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">GPolyline</span><span class="p">,</span> <span class="n">polylines</span><span class="p">,</span> <span class="s">&#39;polylines&#39;</span><span class="p">]]</span>

        <span class="k">for</span> <span class="n">overlay_class</span><span class="p">,</span> <span class="n">overlay_list</span><span class="p">,</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">overlay_info</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">,</span> <span class="p">[])</span>
            <span class="k">if</span> <span class="n">overlay_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">overlay</span> <span class="ow">in</span> <span class="n">overlay_list</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">overlay</span><span class="p">,</span> <span class="n">overlay_class</span><span class="p">):</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlay</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">varname</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">overlay_class</span><span class="p">(</span><span class="n">overlay</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>If GMarker, GPolygons, and/or GPolylines are used the zoom will be
automatically calculated via the Google Maps API.  If both a zoom
level and a center coordinate are provided with polygons/polylines,
no automatic determination will occur.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">calc_zoom</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">polylines</span>  <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">zoom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_zoom</span> <span class="o">=</span> <span class="bp">True</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Defaults for the zoom level and center coordinates if the zoom
is not automatically calculated.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">zoom</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">zoom</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span> <span class="o">=</span> <span class="n">zoom</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="n">center</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the JavaScript necessary for displaying this Google Map.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;calc_zoom&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_zoom</span><span class="p">,</span>
                  <span class="s">&#39;center&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span>
                  <span class="s">&#39;dom_id&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dom_id</span><span class="p">,</span>
                  <span class="s">&#39;js_module&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">js_module</span><span class="p">,</span>
                  <span class="s">&#39;kml_urls&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kml_urls</span><span class="p">,</span>
                  <span class="s">&#39;zoom&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">zoom</span><span class="p">,</span>
                  <span class="s">&#39;polygons&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">polygons</span><span class="p">,</span>
                  <span class="s">&#39;polylines&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">polylines</span><span class="p">,</span>
                  <span class="s">&#39;icons&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">icons</span><span class="p">,</span>
                  <span class="s">&#39;markers&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span><span class="p">,</span>
                  <span class="p">}</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns HTML body tag for loading and unloading Google Maps javascript.&quot;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s">&#39;&lt;body {0} {1}&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onload</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onunload</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">onload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns the `onload` HTML &lt;body&gt; attribute.&quot;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s">&#39;onload=&quot;{0}.{1}_load()&quot;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">js_module</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dom_id</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">api_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns the &lt;script&gt; tag for the Google Maps API javascript.&quot;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s">&#39;&lt;script src=&quot;{0}{1}&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">api_url</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">js</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns only the generated Google Maps JavaScript (no &lt;script&gt; tags).&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns all &lt;script&gt;&lt;/script&gt; tags required with Google Maps JavaScript.&quot;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s">  &lt;script type=&quot;text/javascript&quot;&gt;</span><span class="se">\n</span><span class="s">//&lt;![CDATA[</span><span class="se">\n</span><span class="si">%s</span><span class="s">//]]&gt;</span><span class="se">\n</span><span class="s">  &lt;/script&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">api_script</span><span class="p">,</span> <span class="n">mark_safe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">js</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">style</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns additional CSS styling needed for Google Maps on IE.&quot;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s">&#39;&lt;style type=&quot;text/css&quot;&gt;{0}&lt;/style&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vml_css</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">xhtml</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns XHTML information needed for IE VML overlays.&quot;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s">&#39;&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; {0}&gt;&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xmlns</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">icons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns a sequence of GIcon objects in this map.&quot;</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">([</span><span class="n">marker</span><span class="o">.</span><span class="n">icon</span> <span class="k">for</span> <span class="n">marker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">markers</span> <span class="k">if</span> <span class="n">marker</span><span class="o">.</span><span class="n">icon</span><span class="p">])</span>

<span class="k">class</span> <span class="nc">GoogleMapSet</span><span class="p">(</span><span class="n">GoogleMap</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A class for generating sets of Google Maps that will be shown on the</span>
<span class="sd">        same page together.</span>

<span class="sd">        Example:</span>
<span class="sd">         gmapset = GoogleMapSet( GoogleMap( ... ), GoogleMap( ... ) )</span>
<span class="sd">         gmapset = GoogleMapSet( [ gmap1, gmap2] )</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>The <code>google-multi.js</code> template is used instead of <code>google-single.js</code>
by default.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">template</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;template&#39;</span><span class="p">,</span> <span class="s">&#39;gis/google/google-multi.js&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>This is the template used to generate the GMap load JavaScript for
each map in the set.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">map_template</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;map_template&#39;</span><span class="p">,</span> <span class="s">&#39;gis/google/google-single.js&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Running GoogleMap.<strong>init</strong>(), and resetting the template
value with default obtained above.</p></td><td class="code"><div class="highlight"><pre>        <span class="nb">super</span><span class="p">(</span><span class="n">GoogleMapSet</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="n">template</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>If a tuple/list passed in as first element of args, then assume</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maps</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">maps</span> <span class="o">=</span> <span class="n">args</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Generating DOM ids for each of the maps in the set.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">dom_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;map</span><span class="si">%d</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">))]</span>

    <span class="k">def</span> <span class="nf">load_map_js</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns JavaScript containing all of the loading routines for each</span>
<span class="sd">        map in this set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dom_id</span><span class="p">,</span> <span class="n">gmap</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dom_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Backup copies the GoogleMap DOM id and template attributes.
They are overridden on each GoogleMap instance in the set so
that only the loading JavaScript (and not the header variables)
is used with the generated DOM ids.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">gmap</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">gmap</span><span class="o">.</span><span class="n">dom_id</span><span class="p">)</span>
            <span class="n">gmap</span><span class="o">.</span><span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_template</span>
            <span class="n">gmap</span><span class="o">.</span><span class="n">dom_id</span> <span class="o">=</span> <span class="n">dom_id</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gmap</span><span class="o">.</span><span class="n">js</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Restoring the backup values.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">gmap</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">gmap</span><span class="o">.</span><span class="n">dom_id</span> <span class="o">=</span> <span class="n">tmp</span>
        <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the JavaScript for the collection of Google Maps in</span>
<span class="sd">        this set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;js_module&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">js_module</span><span class="p">,</span>
                  <span class="s">&#39;dom_ids&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">dom_ids</span><span class="p">,</span>
                  <span class="s">&#39;load_map_js&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_map_js</span><span class="p">(),</span>
                  <span class="s">&#39;icons&#39;</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">icons</span><span class="p">,</span>
                  <span class="p">}</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_context</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_to_string</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">template</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">onload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns the `onload` HTML &lt;body&gt; attribute.&quot;</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Overloaded to use the <code>load</code> function defined in the
<code>google-multi.js</code>, which calls the load routines for
each one of the individual maps in the set.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s">&#39;onload=&quot;</span><span class="si">%s</span><span class="s">.load()&quot;&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">js_module</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">icons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns a sequence of all icons in each map of the set.&quot;</span>
        <span class="n">icons</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="nb">map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">maps</span><span class="p">:</span> <span class="n">icons</span> <span class="o">|=</span> <span class="nb">map</span><span class="o">.</span><span class="n">icons</span>
        <span class="k">return</span> <span class="n">icons</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
