<!DOCTYPE html>
<html><head><title>joekychen/django » django › contrib › gis › db › backends › spatialite › operations.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../../index.html"></a><h1>operations.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>

<span class="kn">from</span> <span class="nn">django.contrib.gis.db.backends.base</span> <span class="kn">import</span> <span class="n">BaseSpatialOperations</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.db.backends.util</span> <span class="kn">import</span> <span class="n">SpatialOperation</span><span class="p">,</span> <span class="n">SpatialFunction</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.db.backends.spatialite.adapter</span> <span class="kn">import</span> <span class="n">SpatiaLiteAdapter</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.geometry.backend</span> <span class="kn">import</span> <span class="n">Geometry</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.measure</span> <span class="kn">import</span> <span class="n">Distance</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.db.backends.sqlite3.base</span> <span class="kn">import</span> <span class="n">DatabaseOperations</span>
<span class="kn">from</span> <span class="nn">django.db.utils</span> <span class="kn">import</span> <span class="n">DatabaseError</span>

<span class="k">class</span> <span class="nc">SpatiaLiteOperator</span><span class="p">(</span><span class="n">SpatialOperation</span><span class="p">):</span>
    <span class="s">&quot;For SpatiaLite operators (e.g. `&amp;&amp;`, `~`).&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpatiaLiteOperator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">operator</span><span class="o">=</span><span class="n">operator</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SpatiaLiteFunction</span><span class="p">(</span><span class="n">SpatialFunction</span><span class="p">):</span>
    <span class="s">&quot;For SpatiaLite function calls.&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpatiaLiteFunction</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SpatiaLiteFunctionParam</span><span class="p">(</span><span class="n">SpatiaLiteFunction</span><span class="p">):</span>
    <span class="s">&quot;For SpatiaLite functions that take another parameter.&quot;</span>
    <span class="n">sql_template</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(function)s</span><span class="s">(</span><span class="si">%(geo_col)s</span><span class="s">, </span><span class="si">%(geometry)s</span><span class="s">, </span><span class="si">%%</span><span class="s">s)&#39;</span>

<span class="k">class</span> <span class="nc">SpatiaLiteDistance</span><span class="p">(</span><span class="n">SpatiaLiteFunction</span><span class="p">):</span>
    <span class="s">&quot;For SpatiaLite distance operations.&quot;</span>
    <span class="n">dist_func</span> <span class="o">=</span> <span class="s">&#39;Distance&#39;</span>
    <span class="n">sql_template</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%(function)s</span><span class="s">(</span><span class="si">%(geo_col)s</span><span class="s">, </span><span class="si">%(geometry)s</span><span class="s">) </span><span class="si">%(operator)s</span><span class="s"> </span><span class="si">%%</span><span class="s">s&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operator</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpatiaLiteDistance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dist_func</span><span class="p">,</span>
                                                 <span class="n">operator</span><span class="o">=</span><span class="n">operator</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">SpatiaLiteRelate</span><span class="p">(</span><span class="n">SpatiaLiteFunctionParam</span><span class="p">):</span>
    <span class="s">&quot;For SpatiaLite Relate(&lt;geom&gt;, &lt;pattern&gt;) calls.&quot;</span>
    <span class="n">pattern_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[012TF\*]{9}$&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pattern</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Invalid intersection matrix pattern &quot;</span><span class="si">%s</span><span class="s">&quot;.&#39;</span> <span class="o">%</span> <span class="n">pattern</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SpatiaLiteRelate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="s">&#39;Relate&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Valid distance types and substitutions</p></td><td class="code"><div class="highlight"><pre><span class="n">dtypes</span> <span class="o">=</span> <span class="p">(</span><span class="n">Decimal</span><span class="p">,</span> <span class="n">Distance</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_dist_ops</span><span class="p">(</span><span class="n">operator</span><span class="p">):</span>
    <span class="s">&quot;Returns operations for regular distances; spherical distances are not currently supported.&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">SpatiaLiteDistance</span><span class="p">(</span><span class="n">operator</span><span class="p">),)</span>

<span class="k">class</span> <span class="nc">SpatiaLiteOperations</span><span class="p">(</span><span class="n">DatabaseOperations</span><span class="p">,</span> <span class="n">BaseSpatialOperations</span><span class="p">):</span>
    <span class="n">compiler_module</span> <span class="o">=</span> <span class="s">&#39;django.contrib.gis.db.models.sql.compiler&#39;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;spatialite&#39;</span>
    <span class="n">spatialite</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">version_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;major&gt;\d)\.(?P&lt;minor1&gt;\d)\.(?P&lt;minor2&gt;\d+)&#39;</span><span class="p">)</span>
    <span class="n">valid_aggregates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;Extent&#39;</span><span class="p">,</span> <span class="s">&#39;Union&#39;</span><span class="p">)])</span>

    <span class="n">Adapter</span> <span class="o">=</span> <span class="n">SpatiaLiteAdapter</span>
    <span class="n">Adaptor</span> <span class="o">=</span> <span class="n">Adapter</span> <span class="c"># Backwards-compatibility alias.</span>

    <span class="n">area</span> <span class="o">=</span> <span class="s">&#39;Area&#39;</span>
    <span class="n">centroid</span> <span class="o">=</span> <span class="s">&#39;Centroid&#39;</span>
    <span class="n">contained</span> <span class="o">=</span> <span class="s">&#39;MbrWithin&#39;</span>
    <span class="n">difference</span> <span class="o">=</span> <span class="s">&#39;Difference&#39;</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="s">&#39;Distance&#39;</span>
    <span class="n">envelope</span> <span class="o">=</span> <span class="s">&#39;Envelope&#39;</span>
    <span class="n">intersection</span> <span class="o">=</span> <span class="s">&#39;Intersection&#39;</span>
    <span class="n">length</span> <span class="o">=</span> <span class="s">&#39;GLength&#39;</span> <span class="c"># OpenGis defines Length, but this conflicts with an SQLite reserved keyword</span>
    <span class="n">num_geom</span> <span class="o">=</span> <span class="s">&#39;NumGeometries&#39;</span>
    <span class="n">num_points</span> <span class="o">=</span> <span class="s">&#39;NumPoints&#39;</span>
    <span class="n">point_on_surface</span> <span class="o">=</span> <span class="s">&#39;PointOnSurface&#39;</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="s">&#39;ScaleCoords&#39;</span>
    <span class="n">svg</span> <span class="o">=</span> <span class="s">&#39;AsSVG&#39;</span>
    <span class="n">sym_difference</span> <span class="o">=</span> <span class="s">&#39;SymDifference&#39;</span>
    <span class="n">transform</span> <span class="o">=</span> <span class="s">&#39;Transform&#39;</span>
    <span class="n">translate</span> <span class="o">=</span> <span class="s">&#39;ShiftCoords&#39;</span>
    <span class="n">union</span> <span class="o">=</span> <span class="s">&#39;GUnion&#39;</span> <span class="c"># OpenGis defines Union, but this conflicts with an SQLite reserved keyword</span>
    <span class="n">unionagg</span> <span class="o">=</span> <span class="s">&#39;GUnion&#39;</span>

    <span class="n">from_text</span> <span class="o">=</span> <span class="s">&#39;GeomFromText&#39;</span>
    <span class="n">from_wkb</span> <span class="o">=</span> <span class="s">&#39;GeomFromWKB&#39;</span>
    <span class="n">select</span> <span class="o">=</span> <span class="s">&#39;AsText(</span><span class="si">%s</span><span class="s">)&#39;</span>

    <span class="n">geometry_functions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;equals&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Equals&#39;</span><span class="p">),</span>
        <span class="s">&#39;disjoint&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Disjoint&#39;</span><span class="p">),</span>
        <span class="s">&#39;touches&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Touches&#39;</span><span class="p">),</span>
        <span class="s">&#39;crosses&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Crosses&#39;</span><span class="p">),</span>
        <span class="s">&#39;within&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Within&#39;</span><span class="p">),</span>
        <span class="s">&#39;overlaps&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Overlaps&#39;</span><span class="p">),</span>
        <span class="s">&#39;contains&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Contains&#39;</span><span class="p">),</span>
        <span class="s">&#39;intersects&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Intersects&#39;</span><span class="p">),</span>
        <span class="s">&#39;relate&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">SpatiaLiteRelate</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">),</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Returns true if B's bounding box completely contains A's bounding box.</p></td><td class="code"><div class="highlight"><pre>        <span class="s">&#39;contained&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;MbrWithin&#39;</span><span class="p">),</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Returns true if A's bounding box completely contains B's bounding box.</p></td><td class="code"><div class="highlight"><pre>        <span class="s">&#39;bbcontains&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;MbrContains&#39;</span><span class="p">),</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Returns true if A's bounding box overlaps B's bounding box.</p></td><td class="code"><div class="highlight"><pre>        <span class="s">&#39;bboverlaps&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;MbrOverlaps&#39;</span><span class="p">),</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>These are implemented here as synonyms for Equals</p></td><td class="code"><div class="highlight"><pre>        <span class="s">&#39;same_as&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Equals&#39;</span><span class="p">),</span>
        <span class="s">&#39;exact&#39;</span> <span class="p">:</span> <span class="n">SpatiaLiteFunction</span><span class="p">(</span><span class="s">&#39;Equals&#39;</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="n">distance_functions</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;distance_gt&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">get_dist_ops</span><span class="p">(</span><span class="s">&#39;&gt;&#39;</span><span class="p">),</span> <span class="n">dtypes</span><span class="p">),</span>
        <span class="s">&#39;distance_gte&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">get_dist_ops</span><span class="p">(</span><span class="s">&#39;&gt;=&#39;</span><span class="p">),</span> <span class="n">dtypes</span><span class="p">),</span>
        <span class="s">&#39;distance_lt&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">get_dist_ops</span><span class="p">(</span><span class="s">&#39;&lt;&#39;</span><span class="p">),</span> <span class="n">dtypes</span><span class="p">),</span>
        <span class="s">&#39;distance_lte&#39;</span> <span class="p">:</span> <span class="p">(</span><span class="n">get_dist_ops</span><span class="p">(</span><span class="s">&#39;&lt;=&#39;</span><span class="p">),</span> <span class="n">dtypes</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="n">geometry_functions</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">distance_functions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DatabaseOperations</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Determine the version of the SpatiaLite library.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">vtup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialite_version_tuple</span><span class="p">()</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">vtup</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">if</span> <span class="n">version</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;GeoDjango only supports SpatiaLite versions &#39;</span>
                                           <span class="s">&#39;2.3.0 and above&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spatial_version</span> <span class="o">=</span> <span class="n">version</span>
        <span class="k">except</span> <span class="n">ImproperlyConfigured</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">msg</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&#39;Cannot determine the SpatiaLite version for the &quot;</span><span class="si">%s</span><span class="s">&quot; &#39;</span>
                                       <span class="s">&#39;database (error was &quot;</span><span class="si">%s</span><span class="s">&quot;).  Was the SpatiaLite initialization &#39;</span>
                                       <span class="s">&#39;SQL loaded on this database?&#39;</span> <span class="o">%</span>
                                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Creating the GIS terms dictionary.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">gis_terms</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;isnull&#39;</span><span class="p">]</span>
        <span class="n">gis_terms</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry_functions</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gis_terms</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">term</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">gis_terms</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">version</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Spatialite 2.4.0-RC4 added AsGML and AsKML, however both
RC2 (shipped in popular Debian/Ubuntu packages) and RC4
report version as '2.4.0', so we fall back to feature detection</p></td><td class="code"><div class="highlight"><pre>            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_spatialite_func</span><span class="p">(</span><span class="s">&quot;AsGML(GeomFromText(&#39;POINT(1 1)&#39;))&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">gml</span> <span class="o">=</span> <span class="s">&#39;AsGML&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kml</span> <span class="o">=</span> <span class="s">&#39;AsKML&#39;</span>
            <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>we are using &lt; 2.4.0-RC4</p></td><td class="code"><div class="highlight"><pre>                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">check_aggregate_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the given aggregate name is supported (that is, if it&#39;s</span>
<span class="sd">        in `self.valid_aggregates`).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agg_name</span> <span class="o">=</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">return</span> <span class="n">agg_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_aggregates</span>

    <span class="k">def</span> <span class="nf">convert_geom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wkt</span><span class="p">,</span> <span class="n">geo_field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts geometry WKT returned from a SpatiaLite aggregate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">wkt</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">wkt</span><span class="p">,</span> <span class="n">geo_field</span><span class="o">.</span><span class="n">srid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">geo_db_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns None because geometry columnas are added via the</span>
<span class="sd">        `AddGeometryColumn` stored procedure on SpatiaLite.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">get_distance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the distance parameters for the given geometry field,</span>
<span class="sd">        lookup value, and lookup type.  SpatiaLite only supports regular</span>
<span class="sd">        cartesian-based queries (no spheroid/sphere calculations for point</span>
<span class="sd">        geometries like PostGIS).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Distance</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">geodetic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;SpatiaLite does not support distance queries on &#39;</span>
                                 <span class="s">&#39;geometry fields with a geodetic coordinate system. &#39;</span>
                                 <span class="s">&#39;Distance objects; use a numeric value of your &#39;</span>
                                 <span class="s">&#39;distance in degrees instead.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dist_param</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Distance</span><span class="o">.</span><span class="n">unit_attname</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">units_name</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist_param</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dist_param</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_geom_placeholder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides a proper substitution value for Geometries that are not in the</span>
<span class="sd">        SRID of the field.  Specifically, this routine will substitute in the</span>
<span class="sd">        Transform() and GeomFromText() function call(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">transform_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">srid</span><span class="p">):</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span><span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">value</span><span class="o">.</span><span class="n">srid</span> <span class="o">==</span> <span class="n">srid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="s">&#39;expression&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">transform_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">srid</span><span class="p">):</span>
                <span class="n">placeholder</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%%</span><span class="s">s, </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">srid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">placeholder</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>No geometry value used for F expression, substitue in
the column name instead.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="n">placeholder</span> <span class="o">%</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_name</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">expression</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transform_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">srid</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Adding Transform() to the SQL placeholder.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">(</span><span class="si">%%</span><span class="s">s,</span><span class="si">%s</span><span class="s">), </span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">from_text</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">srid</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">srid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">(</span><span class="si">%%</span><span class="s">s,</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">from_text</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">srid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_spatialite_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper routine for calling SpatiaLite functions and returning</span>
<span class="sd">        their result.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">_cursor</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&#39;SELECT </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">func</span><span class="p">)</span>
                <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Responsibility of caller to perform error handling.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">geos_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns the version of GEOS used by SpatiaLite as a string.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spatialite_func</span><span class="p">(</span><span class="s">&#39;geos_version()&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">proj4_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns the version of the PROJ.4 library used by SpatiaLite.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spatialite_func</span><span class="p">(</span><span class="s">&#39;proj4_version()&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spatialite_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns the SpatiaLite library version as a string.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spatialite_func</span><span class="p">(</span><span class="s">&#39;spatialite_version()&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spatialite_version_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SpatiaLite version as a tuple (version string, major,</span>
<span class="sd">        minor, subminor).</span>
<span class="sd">        &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Getting the SpatiaLite version.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">try</span><span class="p">:</span>
            <span class="n">version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatialite_version</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>The <code>spatialite_version</code> function first appeared in version 2.3.1
of SpatiaLite, so doing a fallback test for 2.3.0 (which is
used by popular Debian/Ubuntu packages).</p></td><td class="code"><div class="highlight"><pre>            <span class="n">version</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_spatialite_func</span><span class="p">(</span><span class="s">&quot;X(GeomFromText(&#39;POINT(1 1)&#39;))&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">:</span> <span class="n">version</span> <span class="o">=</span> <span class="s">&#39;2.3.0&#39;</span>
            <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span>
                <span class="k">pass</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>If no version string defined, then just re-raise the original
exception.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">raise</span>

        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">major</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;major&#39;</span><span class="p">))</span>
            <span class="n">minor1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;minor1&#39;</span><span class="p">))</span>
            <span class="n">minor2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;minor2&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;Could not parse SpatiaLite version string: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">version</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor1</span><span class="p">,</span> <span class="n">minor2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spatial_aggregate_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agg</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the spatial aggregate SQL template and function for the</span>
<span class="sd">        given Aggregate instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">agg_name</span> <span class="o">=</span> <span class="n">agg</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_aggregate_support</span><span class="p">(</span><span class="n">agg</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> spatial aggregate is not implmented for this backend.&#39;</span> <span class="o">%</span> <span class="n">agg_name</span><span class="p">)</span>
        <span class="n">agg_name</span> <span class="o">=</span> <span class="n">agg_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">agg_name</span> <span class="o">==</span> <span class="s">&#39;union&#39;</span><span class="p">:</span> <span class="n">agg_name</span> <span class="o">+=</span> <span class="s">&#39;agg&#39;</span>
        <span class="n">sql_template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">%</span> <span class="s">&#39;</span><span class="si">%(function)s</span><span class="s">(</span><span class="si">%(field)s</span><span class="s">)&#39;</span>
        <span class="n">sql_function</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agg_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sql_template</span><span class="p">,</span> <span class="n">sql_function</span>

    <span class="k">def</span> <span class="nf">spatial_lookup_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lvalue</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">qn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the SpatiaLite-specific SQL for the given lookup value</span>
<span class="sd">        [a tuple of (alias, column, db_type)], lookup type, lookup</span>
<span class="sd">        value, the model field, and the quoting function.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">alias</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">db_type</span> <span class="o">=</span> <span class="n">lvalue</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Getting the quoted field as <code>geo_col</code>.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">geo_col</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">alias</span><span class="p">),</span> <span class="n">qn</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry_functions</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>See if a SpatiaLite geometry function matches the lookup type.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry_functions</span><span class="p">[</span><span class="n">lookup_type</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Lookup types that are tuples take tuple arguments, e.g., 'relate' and
distance lookups.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>First element of tuple is the SpatiaLiteOperation instance, and the
second element is either the type or a tuple of acceptable types
that may passed in as further parameters for the lookup type.</p></td><td class="code"><div class="highlight"><pre>                <span class="n">op</span><span class="p">,</span> <span class="n">arg_type</span> <span class="o">=</span> <span class="n">tmp</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>Ensuring that a tuple <em>value</em> was passed in from the user</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Tuple required for `</span><span class="si">%s</span><span class="s">` lookup type.&#39;</span> <span class="o">%</span> <span class="n">lookup_type</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>Geometry is first element of lookup tuple.</p></td><td class="code"><div class="highlight"><pre>                <span class="n">geom</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Number of valid tuple parameters depends on the lookup type.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Incorrect number of parameters given for `</span><span class="si">%s</span><span class="s">` lookup type.&#39;</span> <span class="o">%</span> <span class="n">lookup_type</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Ensuring the argument type matches what we expect.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">arg_type</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Argument type should be </span><span class="si">%s</span><span class="s">, got </span><span class="si">%s</span><span class="s"> instead.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg_type</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>For lookup type <code>relate</code>, the op instance is not yet created (has
to be instantiated here to check the pattern parameter).</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="n">lookup_type</span> <span class="o">==</span> <span class="s">&#39;relate&#39;</span><span class="p">:</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">distance_functions</span><span class="p">:</span>
                    <span class="n">op</span> <span class="o">=</span> <span class="n">op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">op</span> <span class="o">=</span> <span class="n">tmp</span>
                <span class="n">geom</span> <span class="o">=</span> <span class="n">value</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>Calling the <code>as_sql</code> function on the operation instance.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">as_sql</span><span class="p">(</span><span class="n">geo_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_geom_placeholder</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">geom</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">lookup_type</span> <span class="o">==</span> <span class="s">&#39;isnull&#39;</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Handling 'isnull' lookup type</p></td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> IS </span><span class="si">%s</span><span class="s">NULL&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">geo_col</span><span class="p">,</span> <span class="p">(</span><span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="s">&#39;NOT &#39;</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span><span class="p">))</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Got invalid lookup_type: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">repr</span><span class="p">(</span><span class="n">lookup_type</span><span class="p">))</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>Routines for getting the OGC-compliant models.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">geometry_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.contrib.gis.db.backends.spatialite.models</span> <span class="kn">import</span> <span class="n">GeometryColumns</span>
        <span class="k">return</span> <span class="n">GeometryColumns</span>

    <span class="k">def</span> <span class="nf">spatial_ref_sys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.contrib.gis.db.backends.spatialite.models</span> <span class="kn">import</span> <span class="n">SpatialRefSys</span>
        <span class="k">return</span> <span class="n">SpatialRefSys</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:6}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../../javascript/docco.min.js"></script>
</html>
