<!DOCTYPE html>
<html><head><title>joekychen/django » django › contrib › gis › db › models › sql › query.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../../index.html"></a><h1>query.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connections</span>
<span class="kn">from</span> <span class="nn">django.db.models.query</span> <span class="kn">import</span> <span class="n">sql</span>

<span class="kn">from</span> <span class="nn">django.contrib.gis.db.models.fields</span> <span class="kn">import</span> <span class="n">GeometryField</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.db.models.sql</span> <span class="kn">import</span> <span class="n">aggregates</span> <span class="k">as</span> <span class="n">gis_aggregates</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.db.models.sql.conversion</span> <span class="kn">import</span> <span class="n">AreaField</span><span class="p">,</span> <span class="n">DistanceField</span><span class="p">,</span> <span class="n">GeomField</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.db.models.sql.where</span> <span class="kn">import</span> <span class="n">GeoWhereNode</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.geometry.backend</span> <span class="kn">import</span> <span class="n">Geometry</span>
<span class="kn">from</span> <span class="nn">django.contrib.gis.measure</span> <span class="kn">import</span> <span class="n">Area</span><span class="p">,</span> <span class="n">Distance</span>


<span class="n">ALL_TERMS</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span>
            <span class="s">&#39;bbcontains&#39;</span><span class="p">,</span> <span class="s">&#39;bboverlaps&#39;</span><span class="p">,</span> <span class="s">&#39;contained&#39;</span><span class="p">,</span> <span class="s">&#39;contains&#39;</span><span class="p">,</span>
            <span class="s">&#39;contains_properly&#39;</span><span class="p">,</span> <span class="s">&#39;coveredby&#39;</span><span class="p">,</span> <span class="s">&#39;covers&#39;</span><span class="p">,</span> <span class="s">&#39;crosses&#39;</span><span class="p">,</span> <span class="s">&#39;disjoint&#39;</span><span class="p">,</span>
            <span class="s">&#39;distance_gt&#39;</span><span class="p">,</span> <span class="s">&#39;distance_gte&#39;</span><span class="p">,</span> <span class="s">&#39;distance_lt&#39;</span><span class="p">,</span> <span class="s">&#39;distance_lte&#39;</span><span class="p">,</span>
            <span class="s">&#39;dwithin&#39;</span><span class="p">,</span> <span class="s">&#39;equals&#39;</span><span class="p">,</span> <span class="s">&#39;exact&#39;</span><span class="p">,</span>
            <span class="s">&#39;intersects&#39;</span><span class="p">,</span> <span class="s">&#39;overlaps&#39;</span><span class="p">,</span> <span class="s">&#39;relate&#39;</span><span class="p">,</span> <span class="s">&#39;same_as&#39;</span><span class="p">,</span> <span class="s">&#39;touches&#39;</span><span class="p">,</span> <span class="s">&#39;within&#39;</span><span class="p">,</span>
            <span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;right&#39;</span><span class="p">,</span> <span class="s">&#39;overlaps_left&#39;</span><span class="p">,</span> <span class="s">&#39;overlaps_right&#39;</span><span class="p">,</span>
            <span class="s">&#39;overlaps_above&#39;</span><span class="p">,</span> <span class="s">&#39;overlaps_below&#39;</span><span class="p">,</span>
            <span class="s">&#39;strictly_above&#39;</span><span class="p">,</span> <span class="s">&#39;strictly_below&#39;</span>
            <span class="p">])</span>
<span class="n">ALL_TERMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">QUERY_TERMS</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">GeoQuery</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">Query</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A single spatial SQL query.</span>
<span class="sd">    &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Overridding the valid query terms.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">query_terms</span> <span class="o">=</span> <span class="n">ALL_TERMS</span>
    <span class="n">aggregates_module</span> <span class="o">=</span> <span class="n">gis_aggregates</span>

    <span class="n">compiler</span> <span class="o">=</span> <span class="s">&#39;GeoSQLCompiler&#39;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><h3>Methods overridden from the base Query class</h3></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">GeoWhereNode</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GeoQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">where</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>The following attributes are customized for the GeoQuerySet.
The GeoWhereNode and SpatialBackend classes contain backend-specific
routines and functions.</p></td><td class="code"><div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">custom_select</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transformed_srid</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_fields</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GeoQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Customized selection dictionary and transformed srid flag have
to also be added to obj.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">obj</span><span class="o">.</span><span class="n">custom_select</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">custom_select</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">transformed_srid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transformed_srid</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">extra_select_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">convert_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Using the same routines that Oracle does we can convert our</span>
<span class="sd">        extra selection objects into Geometry and Distance objects.</span>
<span class="sd">        TODO: Make converted objects &#39;lazy&#39; for less overhead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">oracle</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Running through Oracle's first.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">value</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GeoQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">convert_values</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span> <span class="ow">or</span> <span class="n">GeomField</span><span class="p">(),</span> <span class="n">connection</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Output from spatial function is NULL (e.g., called
function on a geometry field with NULL value).</p></td><td class="code"><div class="highlight"><pre>            <span class="k">pass</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">DistanceField</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Using the field's distance attribute, can instantiate
<code>Distance</code> with the right context.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">value</span> <span class="o">=</span> <span class="n">Distance</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">distance_att</span> <span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">AreaField</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Area</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">field</span><span class="o">.</span><span class="n">area_att</span> <span class="p">:</span> <span class="n">value</span><span class="p">})</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">(</span><span class="n">GeomField</span><span class="p">,</span> <span class="n">GeometryField</span><span class="p">))</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">get_aggregation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">using</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Remove any aggregates marked for reduction from the subquery
and move them to the outer AggregateQuery.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">using</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">aggregate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate_select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aggregate</span><span class="p">,</span> <span class="n">gis_aggregates</span><span class="o">.</span><span class="n">GeoAggregate</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">aggregate</span><span class="p">,</span> <span class="s">&#39;is_extent&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">or</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">oracle</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">extra_select_fields</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">GeomField</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">GeoQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_aggregation</span><span class="p">(</span><span class="n">using</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">resolve_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overridden from GeoQuery&#39;s normalize to handle the conversion of</span>
<span class="sd">        GeoAggregate objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aggregate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregates_module</span><span class="o">.</span><span class="n">GeoAggregate</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">is_extent</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">is_extent</span> <span class="o">==</span> <span class="s">&#39;3D&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">convert_extent3d</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">convert_extent</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">convert_geom</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">source</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">GeoQuery</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">resolve_aggregate</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Private API utilities, subject to change.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">def</span> <span class="nf">_geo_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the first Geometry field encountered; or specified via the</span>
<span class="sd">        `field_name` keyword.  The `field_name` may be a string specifying</span>
<span class="sd">        the geometry field on this GeoQuery&#39;s model, or a lookup string</span>
<span class="sd">        to a geometry field via a ForeignKey relation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Incrementing until the first geographic field is found.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="n">fld</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fld</span><span class="p">,</span> <span class="n">GeometryField</span><span class="p">):</span> <span class="k">return</span> <span class="n">fld</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Otherwise, check by the given field name -- which may be
a lookup to a <em>related</em> geographic field.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="n">GeoWhereNode</span><span class="o">.</span><span class="n">_check_geo_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:6}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../../javascript/docco.min.js"></script>
</html>
