<!DOCTYPE html>
<html><head><title>joekychen/django » django › http › utils.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>utils.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Functions that modify an HTTP request or response in some way.</span>
<span class="sd">&quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>This group of functions are run as part of the response handling, after
everything else, including all response middleware. Think of them as
"compulsory response middleware". Be careful about what goes here, because
it's a little fiddly to override this behavior, so they should be truly
universally applicable.</p></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">fix_location_header</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensures that we always use an absolute URI in any location header in the</span>
<span class="sd">    response. This is required by RFC 2616, section 14.30.</span>

<span class="sd">    Code constructing response objects is free to insert relative paths, as</span>
<span class="sd">    this function converts them to absolute paths.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s">&#39;Location&#39;</span> <span class="ow">in</span> <span class="n">response</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">get_host</span><span class="p">():</span>
        <span class="n">response</span><span class="p">[</span><span class="s">&#39;Location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">build_absolute_uri</span><span class="p">(</span><span class="n">response</span><span class="p">[</span><span class="s">&#39;Location&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">conditional_content_removal</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes the content of responses for HEAD requests, 1xx, 204 and 304</span>
<span class="sd">    responses. Ensures compliance with RFC 2616, section 4.3.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="mi">100</span> <span class="o">&lt;=</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">304</span><span class="p">):</span>
       <span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
       <span class="n">response</span><span class="p">[</span><span class="s">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&#39;HEAD&#39;</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">fix_IE_for_attach</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will prevent Django from serving a Content-Disposition header</span>
<span class="sd">    while expecting the browser to cache it (only when the browser is IE). This</span>
<span class="sd">    leads to IE not allowing the client to download.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">useragent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;MSIE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">useragent</span> <span class="ow">and</span> <span class="s">&#39;CHROMEFRAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">useragent</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="n">offending_headers</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;no-cache&#39;</span><span class="p">,</span> <span class="s">&#39;no-store&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">has_header</span><span class="p">(</span><span class="s">&#39;Content-Disposition&#39;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Pragma&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">has_header</span><span class="p">(</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">):</span>
            <span class="n">cache_control_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span>
                    <span class="n">response</span><span class="p">[</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">offending_headers</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">cache_control_values</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">response</span><span class="p">[</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_control_values</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">fix_IE_for_vary</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function will fix the bug reported at</span>
<span class="sd">    http://support.microsoft.com/kb/824847/en-us?spid=8722&amp;sid=global</span>
<span class="sd">    by clearing the Vary header whenever the mime-type is not safe</span>
<span class="sd">    enough for Internet Explorer to handle.  Poor thing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">useragent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="s">&#39;MSIE&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">useragent</span> <span class="ow">and</span> <span class="s">&#39;CHROMEFRAME&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">useragent</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">response</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>These mime-types that are decreed "Vary-safe" for IE:</p></td><td class="code"><div class="highlight"><pre>    <span class="n">safe_mime_types</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;text/html&#39;</span><span class="p">,</span> <span class="s">&#39;text/plain&#39;</span><span class="p">,</span> <span class="s">&#39;text/sgml&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>The first part of the Content-Type field will be the MIME type,
everything after ';', such as character-set, can be ignored.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">mime_type</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">mime_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">safe_mime_types</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">response</span><span class="p">[</span><span class="s">&#39;Vary&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">response</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
