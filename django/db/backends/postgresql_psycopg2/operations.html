<!DOCTYPE html>
<html><head><title>joekychen/django » django › db › backends › postgresql_psycopg2 › operations.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>operations.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">from</span> <span class="nn">django.db.backends</span> <span class="kn">import</span> <span class="n">BaseDatabaseOperations</span>


<span class="k">class</span> <span class="nc">DatabaseOperations</span><span class="p">(</span><span class="n">BaseDatabaseOperations</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DatabaseOperations</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">connection</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">date_extract_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>http://www.postgresql.org/docs/8.0/static/functions-datetime.html#FUNCTIONS-DATETIME-EXTRACT</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">lookup_type</span> <span class="o">==</span> <span class="s">&#39;week_day&#39;</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>For consistency across backends, we return Sunday=1, Saturday=7.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">return</span> <span class="s">&quot;EXTRACT(&#39;dow&#39; FROM </span><span class="si">%s</span><span class="s">) + 1&quot;</span> <span class="o">%</span> <span class="n">field_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;EXTRACT(&#39;</span><span class="si">%s</span><span class="s">&#39; FROM </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lookup_type</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">date_interval_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">connector</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        implements the interval functionality for expressions</span>
<span class="sd">        format for Postgres:</span>
<span class="sd">            (datefield + interval &#39;3 days 200 seconds 5 microseconds&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">modifiers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">days</span><span class="p">:</span>
            <span class="n">modifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> days&#39;</span> <span class="o">%</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">seconds</span><span class="p">:</span>
            <span class="n">modifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> seconds&#39;</span> <span class="o">%</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">microseconds</span><span class="p">:</span>
            <span class="n">modifiers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> microseconds&#39;</span> <span class="o">%</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">microseconds</span><span class="p">)</span>
        <span class="n">mods</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modifiers</span><span class="p">)</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s"> &#39;</span> <span class="o">%</span> <span class="n">connector</span>
        <span class="k">return</span> <span class="s">&#39;(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">conn</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">sql</span><span class="p">,</span> <span class="s">&#39;interval </span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">mods</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">date_trunc_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>http://www.postgresql.org/docs/8.0/static/functions-datetime.html#FUNCTIONS-DATETIME-TRUNC</p></td><td class="code"><div class="highlight"><pre>        <span class="k">return</span> <span class="s">&quot;DATE_TRUNC(&#39;</span><span class="si">%s</span><span class="s">&#39;, </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">lookup_type</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">deferrable_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot; DEFERRABLE INITIALLY DEFERRED&quot;</span>

    <span class="k">def</span> <span class="nf">lookup_cast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lookup_type</span><span class="p">):</span>
        <span class="n">lookup</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Cast text lookups to text to allow things like filter(x__contains=4)</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;iexact&#39;</span><span class="p">,</span> <span class="s">&#39;contains&#39;</span><span class="p">,</span> <span class="s">&#39;icontains&#39;</span><span class="p">,</span> <span class="s">&#39;startswith&#39;</span><span class="p">,</span>
                           <span class="s">&#39;istartswith&#39;</span><span class="p">,</span> <span class="s">&#39;endswith&#39;</span><span class="p">,</span> <span class="s">&#39;iendswith&#39;</span><span class="p">):</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">::text&quot;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Use UPPER(x) for case-insensitive lookups; it's faster.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">lookup_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;iexact&#39;</span><span class="p">,</span> <span class="s">&#39;icontains&#39;</span><span class="p">,</span> <span class="s">&#39;istartswith&#39;</span><span class="p">,</span> <span class="s">&#39;iendswith&#39;</span><span class="p">):</span>
            <span class="n">lookup</span> <span class="o">=</span> <span class="s">&#39;UPPER(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="n">lookup</span>

        <span class="k">return</span> <span class="n">lookup</span>

    <span class="k">def</span> <span class="nf">field_cast_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">db_type</span> <span class="o">==</span> <span class="s">&#39;inet&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;HOST(</span><span class="si">%s</span><span class="s">)&#39;</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">&#39;</span>

    <span class="k">def</span> <span class="nf">last_insert_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">pk_name</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Use pg<em>get</em>serial_sequence to get the underlying sequence name
from the table name and column name (available since PostgreSQL 8)</p></td><td class="code"><div class="highlight"><pre>        <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;SELECT CURRVAL(pg_get_serial_sequence(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;))&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">),</span> <span class="n">pk_name</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">no_limit_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">quote_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">name</span> <span class="c"># Quoting once is enough.</span>
        <span class="k">return</span> <span class="s">&#39;&quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">set_time_zone_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;SET TIME ZONE </span><span class="si">%s</span><span class="s">&quot;</span>

    <span class="k">def</span> <span class="nf">sql_flush</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">tables</span><span class="p">,</span> <span class="n">sequences</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tables</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Perform a single SQL 'TRUNCATE x, y, z...;' statement.  It allows
us to truncate tables referenced by a foreign key in any other
table.</p></td><td class="code"><div class="highlight"><pre>            <span class="n">sql</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">;&#39;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;TRUNCATE&#39;</span><span class="p">),</span>
                    <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">]))</span>
            <span class="p">)]</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>'ALTER SEQUENCE sequence_name RESTART WITH 1;'... style SQL statements
to reset sequence indices</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="n">sequence_info</span> <span class="ow">in</span> <span class="n">sequences</span><span class="p">:</span>
                <span class="n">table_name</span> <span class="o">=</span> <span class="n">sequence_info</span><span class="p">[</span><span class="s">&#39;table&#39;</span><span class="p">]</span>
                <span class="n">column_name</span> <span class="o">=</span> <span class="n">sequence_info</span><span class="p">[</span><span class="s">&#39;column&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">column_name</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>This will be the case if it's an m2m using an autogenerated
intermediate table (see BaseDatabaseIntrospection.sequence_list)</p></td><td class="code"><div class="highlight"><pre>                    <span class="n">column_name</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span>
                <span class="n">sql</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> setval(pg_get_serial_sequence(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;), 1, false);&quot;</span> <span class="o">%</span> \
                    <span class="p">(</span><span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;SELECT&#39;</span><span class="p">),</span>
                    <span class="n">style</span><span class="o">.</span><span class="n">SQL_TABLE</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">table_name</span><span class="p">)),</span>
                    <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="n">column_name</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">sql</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">tablespace_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tablespace</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inline</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;USING INDEX TABLESPACE </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">tablespace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;TABLESPACE </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_name</span><span class="p">(</span><span class="n">tablespace</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">sequence_reset_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
        <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">qn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_name</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">model_list</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Use <code>coalesce</code> to set the sequence for each model to the max pk value if there are records,
or 1 if there are none. Set the <code>is_called</code> property (the third argument to <code>setval</code>) to true
if there are records (as the max pk value is already in use), otherwise set it to false.
Use pg<em>get</em>serial_sequence to get the underlying sequence name from the table name
and column name (available since PostgreSQL 8)</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">local_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">AutoField</span><span class="p">):</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> setval(pg_get_serial_sequence(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;), coalesce(max(</span><span class="si">%s</span><span class="s">), 1), max(</span><span class="si">%s</span><span class="s">) </span><span class="si">%s</span><span class="s"> null) </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">;&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;SELECT&#39;</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_TABLE</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">)),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">)),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">)),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;IS NOT&#39;</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;FROM&#39;</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_TABLE</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">db_table</span><span class="p">))))</span>
                    <span class="k">break</span> <span class="c"># Only one AutoField is allowed per model, so don&#39;t bother continuing.</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">many_to_many</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">rel</span><span class="o">.</span><span class="n">through</span><span class="p">:</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> setval(pg_get_serial_sequence(&#39;</span><span class="si">%s</span><span class="s">&#39;,&#39;</span><span class="si">%s</span><span class="s">&#39;), coalesce(max(</span><span class="si">%s</span><span class="s">), 1), max(</span><span class="si">%s</span><span class="s">) </span><span class="si">%s</span><span class="s"> null) </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">;&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;SELECT&#39;</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_TABLE</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">m2m_db_table</span><span class="p">())),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_FIELD</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;IS NOT&#39;</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_KEYWORD</span><span class="p">(</span><span class="s">&#39;FROM&#39;</span><span class="p">),</span>
                        <span class="n">style</span><span class="o">.</span><span class="n">SQL_TABLE</span><span class="p">(</span><span class="n">qn</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">m2m_db_table</span><span class="p">()))))</span>
        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span> <span class="nf">savepoint_create_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;SAVEPOINT </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sid</span>

    <span class="k">def</span> <span class="nf">savepoint_commit_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;RELEASE SAVEPOINT </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sid</span>

    <span class="k">def</span> <span class="nf">savepoint_rollback_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sid</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;ROLLBACK TO SAVEPOINT </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sid</span>

    <span class="k">def</span> <span class="nf">prep_for_iexact_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">check_aggregate_support</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check that the backend fully supports the provided aggregate.</span>

<span class="sd">        The implementation of population statistics (STDDEV_POP and VAR_POP)</span>
<span class="sd">        under Postgres 8.2 - 8.2.4 is known to be faulty. Raise</span>
<span class="sd">        NotImplementedError if this is the database in use.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">sql_function</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;STDDEV_POP&#39;</span><span class="p">,</span> <span class="s">&#39;VAR_POP&#39;</span><span class="p">):</span>
            <span class="n">pg_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">pg_version</span>
            <span class="k">if</span> <span class="n">pg_version</span> <span class="o">&gt;=</span> <span class="mi">80200</span> <span class="ow">and</span> <span class="n">pg_version</span> <span class="o">&lt;=</span> <span class="mi">80204</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&#39;PostgreSQL 8.2 to 8.2.4 is known to have a faulty implementation of </span><span class="si">%s</span><span class="s">. Please upgrade your version of PostgreSQL.&#39;</span> <span class="o">%</span> <span class="n">aggregate</span><span class="o">.</span><span class="n">sql_function</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">max_name_length</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the maximum length of an identifier.</span>

<span class="sd">        Note that the maximum length of an identifier is 63 by default, but can</span>
<span class="sd">        be changed by recompiling PostgreSQL after editing the NAMEDATALEN</span>
<span class="sd">        macro in src/include/pg_config_manual.h .</span>

<span class="sd">        This implementation simply returns 63, but can easily be overridden by a</span>
<span class="sd">        custom database backend that inherits most of its behavior from this one.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="mi">63</span>

    <span class="k">def</span> <span class="nf">distinct_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fields</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;DISTINCT ON (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;DISTINCT&#39;</span>

    <span class="k">def</span> <span class="nf">last_executed_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">sql</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>http://initd.org/psycopg/docs/cursor.html#cursor.query
The query attribute is a Psycopg extension to the DB API 2.0.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">cursor</span><span class="o">.</span><span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cursor</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">return_insert_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;RETURNING </span><span class="si">%s</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">()</span>

    <span class="k">def</span> <span class="nf">bulk_insert_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">num_values</span><span class="p">):</span>
        <span class="n">items_sql</span> <span class="o">=</span> <span class="s">&quot;(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fields</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&quot;VALUES &quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">items_sql</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_values</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
