<!DOCTYPE html>
<html><head><title>joekychen/django » django › db › backends › sqlite3 › creation.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>creation.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">django.db.backends.creation</span> <span class="kn">import</span> <span class="n">BaseDatabaseCreation</span>

<span class="k">class</span> <span class="nc">DatabaseCreation</span><span class="p">(</span><span class="n">BaseDatabaseCreation</span><span class="p">):</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>SQLite doesn't actually support most of these types, but it "does the right
thing" given more verbose field definitions, so leave them as is so that
schema inspection is more useful.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">data_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;AutoField&#39;</span><span class="p">:</span>                    <span class="s">&#39;integer&#39;</span><span class="p">,</span>
        <span class="s">&#39;BooleanField&#39;</span><span class="p">:</span>                 <span class="s">&#39;bool&#39;</span><span class="p">,</span>
        <span class="s">&#39;CharField&#39;</span><span class="p">:</span>                    <span class="s">&#39;varchar(</span><span class="si">%(max_length)s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;CommaSeparatedIntegerField&#39;</span><span class="p">:</span>   <span class="s">&#39;varchar(</span><span class="si">%(max_length)s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;DateField&#39;</span><span class="p">:</span>                    <span class="s">&#39;date&#39;</span><span class="p">,</span>
        <span class="s">&#39;DateTimeField&#39;</span><span class="p">:</span>                <span class="s">&#39;datetime&#39;</span><span class="p">,</span>
        <span class="s">&#39;DecimalField&#39;</span><span class="p">:</span>                 <span class="s">&#39;decimal&#39;</span><span class="p">,</span>
        <span class="s">&#39;FileField&#39;</span><span class="p">:</span>                    <span class="s">&#39;varchar(</span><span class="si">%(max_length)s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;FilePathField&#39;</span><span class="p">:</span>                <span class="s">&#39;varchar(</span><span class="si">%(max_length)s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;FloatField&#39;</span><span class="p">:</span>                   <span class="s">&#39;real&#39;</span><span class="p">,</span>
        <span class="s">&#39;IntegerField&#39;</span><span class="p">:</span>                 <span class="s">&#39;integer&#39;</span><span class="p">,</span>
        <span class="s">&#39;BigIntegerField&#39;</span><span class="p">:</span>              <span class="s">&#39;bigint&#39;</span><span class="p">,</span>
        <span class="s">&#39;IPAddressField&#39;</span><span class="p">:</span>               <span class="s">&#39;char(15)&#39;</span><span class="p">,</span>
        <span class="s">&#39;GenericIPAddressField&#39;</span><span class="p">:</span>        <span class="s">&#39;char(39)&#39;</span><span class="p">,</span>
        <span class="s">&#39;NullBooleanField&#39;</span><span class="p">:</span>             <span class="s">&#39;bool&#39;</span><span class="p">,</span>
        <span class="s">&#39;OneToOneField&#39;</span><span class="p">:</span>                <span class="s">&#39;integer&#39;</span><span class="p">,</span>
        <span class="s">&#39;PositiveIntegerField&#39;</span><span class="p">:</span>         <span class="s">&#39;integer unsigned&#39;</span><span class="p">,</span>
        <span class="s">&#39;PositiveSmallIntegerField&#39;</span><span class="p">:</span>    <span class="s">&#39;smallint unsigned&#39;</span><span class="p">,</span>
        <span class="s">&#39;SlugField&#39;</span><span class="p">:</span>                    <span class="s">&#39;varchar(</span><span class="si">%(max_length)s</span><span class="s">)&#39;</span><span class="p">,</span>
        <span class="s">&#39;SmallIntegerField&#39;</span><span class="p">:</span>            <span class="s">&#39;smallint&#39;</span><span class="p">,</span>
        <span class="s">&#39;TextField&#39;</span><span class="p">:</span>                    <span class="s">&#39;text&#39;</span><span class="p">,</span>
        <span class="s">&#39;TimeField&#39;</span><span class="p">:</span>                    <span class="s">&#39;time&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">sql_for_pending_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">style</span><span class="p">,</span> <span class="n">pending_references</span><span class="p">):</span>
        <span class="s">&quot;SQLite3 doesn&#39;t support constraints&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">sql_remove_table_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">references_to_delete</span><span class="p">,</span> <span class="n">style</span><span class="p">):</span>
        <span class="s">&quot;SQLite3 doesn&#39;t support constraints&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">_get_test_db_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">test_database_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;TEST_NAME&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">test_database_name</span> <span class="ow">and</span> <span class="n">test_database_name</span> <span class="o">!=</span> <span class="s">&#39;:memory:&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">test_database_name</span>
        <span class="k">return</span> <span class="s">&#39;:memory:&#39;</span>

    <span class="k">def</span> <span class="nf">_create_test_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">,</span> <span class="n">autoclobber</span><span class="p">):</span>
        <span class="n">test_database_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_test_db_name</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">test_database_name</span> <span class="o">!=</span> <span class="s">&#39;:memory:&#39;</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Erase the old test database</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="n">verbosity</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Destroying old test database &#39;</span><span class="si">%s</span><span class="s">&#39;...&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">test_database_name</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">autoclobber</span><span class="p">:</span>
                    <span class="n">confirm</span> <span class="o">=</span> <span class="nb">raw_input</span><span class="p">(</span><span class="s">&quot;Type &#39;yes&#39; if you would like to try deleting the test database &#39;</span><span class="si">%s</span><span class="s">&#39;, or &#39;no&#39; to cancel: &quot;</span> <span class="o">%</span> <span class="n">test_database_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">autoclobber</span> <span class="ow">or</span> <span class="n">confirm</span> <span class="o">==</span> <span class="s">&#39;yes&#39;</span><span class="p">:</span>
                  <span class="k">try</span><span class="p">:</span>
                      <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">test_database_name</span><span class="p">)</span>
                  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                      <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Got an error deleting the old test database: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
                      <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Tests cancelled.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">test_database_name</span>

    <span class="k">def</span> <span class="nf">_destroy_test_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_database_name</span><span class="p">,</span> <span class="n">verbosity</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">test_database_name</span> <span class="ow">and</span> <span class="n">test_database_name</span> <span class="o">!=</span> <span class="s">&quot;:memory:&quot;</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Remove the SQLite database file</p></td><td class="code"><div class="highlight"><pre>            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">test_database_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_autocommit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">test_db_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple that uniquely identifies a test database.</span>

<span class="sd">        This takes into account the special cases of &quot;:memory:&quot; and &quot;&quot; for</span>
<span class="sd">        SQLite since the databases will be distinct despite having the same</span>
<span class="sd">        TEST_NAME. See http://www.sqlite.org/inmemorydb.html</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span>
        <span class="n">test_dbname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_test_db_name</span><span class="p">()</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="n">test_dbname</span> <span class="o">==</span> <span class="s">&#39;:memory:&#39;</span><span class="p">:</span>
            <span class="n">sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">alias</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
