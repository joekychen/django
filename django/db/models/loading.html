<!DOCTYPE html>
<html><head><title>joekychen/django » django › db › models › loading.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>loading.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="s">&quot;Utilities for loading models and the modules that contain them.&quot;</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.utils.datastructures</span> <span class="kn">import</span> <span class="n">SortedDict</span>
<span class="kn">from</span> <span class="nn">django.utils.importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">module_has_submodule</span>

<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;get_apps&#39;</span><span class="p">,</span> <span class="s">&#39;get_app&#39;</span><span class="p">,</span> <span class="s">&#39;get_models&#39;</span><span class="p">,</span> <span class="s">&#39;get_model&#39;</span><span class="p">,</span> <span class="s">&#39;register_models&#39;</span><span class="p">,</span>
        <span class="s">&#39;load_app&#39;</span><span class="p">,</span> <span class="s">&#39;app_cache_ready&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">AppCache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A cache that stores installed applications and their models. Used to</span>
<span class="sd">    provide reverse-relations and for app introspection (e.g. admin).</span>
<span class="sd">    &quot;&quot;&quot;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>Use the Borg pattern to share state between all instances. Details at
http://aspn.activestate.com/ASPN/Cookbook/Python/Recipe/66531.</p></td><td class="code"><div class="highlight"><pre>    <span class="n">__shared_state</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Keys of app_store are the model modules for each application.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">app_store</span> <span class="o">=</span> <span class="n">SortedDict</span><span class="p">(),</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Mapping of installed app_labels to model modules for that app.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">app_labels</span> <span class="o">=</span> <span class="p">{},</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Mapping of app_labels to a dictionary of model names to model code.
May contain apps that are not installed.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">app_models</span> <span class="o">=</span> <span class="n">SortedDict</span><span class="p">(),</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>Mapping of app_labels to errors raised when trying to import the app.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">app_errors</span> <span class="o">=</span> <span class="p">{},</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>-- Everything below here is only used when populating the cache --</p></td><td class="code"><div class="highlight"><pre>        <span class="n">loaded</span> <span class="o">=</span> <span class="bp">False</span><span class="p">,</span>
        <span class="n">handled</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">postponed</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">nesting_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">_get_models_cache</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__shared_state</span>

    <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fill in all the cache information. This method is threadsafe, in the</span>
<span class="sd">        sense that every caller will see the same state upon return, and if the</span>
<span class="sd">        cache is already initialised, it does no work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
            <span class="k">return</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Note that we want to use the import lock here - the app loading is
in many cases initiated implicitly by importing, and thus it is
possible to end up in deadlock when one thread initiates loading
without holding the importer lock and another thread then tries to
import something which also launches the app loading. For details of
this situation see #18251.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">imp</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nesting_level</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">postponed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">imp</span><span class="o">.</span><span class="n">release_lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_label_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_mod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return app_label for given models module.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">app_mod</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">load_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">can_postpone</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the app with the provided fully qualified name, and returns the</span>
<span class="sd">        model module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handled</span><span class="p">[</span><span class="n">app_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nesting_level</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">app_module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">models</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;.models&#39;</span><span class="p">,</span> <span class="n">app_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nesting_level</span> <span class="o">-=</span> <span class="mi">1</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>If the app doesn't have a models module, we can just ignore the
ImportError and return no models for it.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">if</span> <span class="ow">not</span> <span class="n">module_has_submodule</span><span class="p">(</span><span class="n">app_module</span><span class="p">,</span> <span class="s">&#39;models&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">None</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>But if the app does have a models module, we need to figure out
whether to suppress or propagate the error. If can<em>postpone is
True then it may be that the package is still being imported by
Python and the models module isn't available yet. So we add the
app to the postponed list and we'll try it again after all the
recursion has finished (in populate). If can</em>postpone is False
then it's time to raise the ImportError.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">can_postpone</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">postponed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nesting_level</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">models</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_store</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app_store</span><span class="p">[</span><span class="n">models</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app_store</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app_labels</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_for</span><span class="p">(</span><span class="n">models</span><span class="p">)]</span> <span class="o">=</span> <span class="n">models</span>
        <span class="k">return</span> <span class="n">models</span>

    <span class="k">def</span> <span class="nf">app_cache_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns true if the model cache is fully populated.</span>

<span class="sd">        Useful for code that wants to cache the results of get_models() for</span>
<span class="sd">        themselves once it is safe to do so.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded</span>

    <span class="k">def</span> <span class="nf">get_apps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns a list of all installed modules that contain models.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Ensure the returned list is always in the same order (with new apps
added at the end). This avoids unstable ordering on the admin app
list page, for example.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">apps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_store</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">apps</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">elt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">elt</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">emptyOK</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the module containing the models for the given app_label. If</span>
<span class="sd">        the app has no models in it and &#39;emptyOK&#39; is True, returns None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">()</span>
        <span class="n">imp</span><span class="o">.</span><span class="n">acquire_lock</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">app_name</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALLED_APPS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">app_label</span> <span class="o">==</span> <span class="n">app_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_app</span><span class="p">(</span><span class="n">app_name</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">emptyOK</span><span class="p">:</span>
                            <span class="k">return</span> <span class="bp">None</span>
                        <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;App with label </span><span class="si">%s</span><span class="s"> is missing a models.py module.&quot;</span> <span class="o">%</span> <span class="n">app_label</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">mod</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span><span class="s">&quot;App with label </span><span class="si">%s</span><span class="s"> could not be found&quot;</span> <span class="o">%</span> <span class="n">app_label</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">imp</span><span class="o">.</span><span class="n">release_lock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_app_errors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s">&quot;Returns the map of known problems with the INSTALLED_APPS.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_errors</span>

    <span class="k">def</span> <span class="nf">get_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_mod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                   <span class="n">include_auto_created</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">include_deferred</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                   <span class="n">only_installed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a module containing models, returns a list of the models.</span>
<span class="sd">        Otherwise returns a list of all installed models.</span>

<span class="sd">        By default, auto-created models (i.e., m2m models without an</span>
<span class="sd">        explicit intermediate table) are not included. However, if you</span>
<span class="sd">        specify include_auto_created=True, they will be.</span>

<span class="sd">        By default, models created to satisfy deferred attribute</span>
<span class="sd">        queries are *not* included in the list of models. However, if</span>
<span class="sd">        you specify include_deferred, they will be.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cache_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">app_mod</span><span class="p">,</span> <span class="n">include_auto_created</span><span class="p">,</span> <span class="n">include_deferred</span><span class="p">,</span> <span class="n">only_installed</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">app_mod</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">app_mod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_store</span><span class="p">:</span>
                <span class="n">app_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_label_for</span><span class="p">(</span><span class="n">app_mod</span><span class="p">),</span>
                                                <span class="n">SortedDict</span><span class="p">())]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">only_installed</span><span class="p">:</span>
                <span class="n">app_list</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">app_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">SortedDict</span><span class="p">())</span>
                            <span class="k">for</span> <span class="n">app_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_labels</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">app_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_models</span><span class="o">.</span><span class="n">itervalues</span><span class="p">()</span>
        <span class="n">model_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">app_list</span><span class="p">:</span>
            <span class="n">model_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">model</span> <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_deferred</span> <span class="ow">or</span> <span class="n">include_deferred</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="ow">not</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">auto_created</span> <span class="ow">or</span> <span class="n">include_auto_created</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_cache</span><span class="p">[</span><span class="n">cache_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_list</span>
        <span class="k">return</span> <span class="n">model_list</span>

    <span class="k">def</span> <span class="nf">get_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span>
                  <span class="n">seed_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">only_installed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the model matching the given app_label and case-insensitive</span>
<span class="sd">        model_name.</span>

<span class="sd">        Returns None if no model is found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">seed_cache</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_populate</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">only_installed</span> <span class="ow">and</span> <span class="n">app_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_labels</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_models</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">SortedDict</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">register_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app_label</span><span class="p">,</span> <span class="o">*</span><span class="n">models</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a set of models as belonging to an app.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">model</span> <span class="ow">in</span> <span class="n">models</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>Store as 'name: model' pair in a dictionary
in the app_models dictionary</p></td><td class="code"><div class="highlight"><pre>            <span class="n">model_name</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">object_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">model_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app_models</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">app_label</span><span class="p">,</span> <span class="n">SortedDict</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">model_name</span> <span class="ow">in</span> <span class="n">model_dict</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>The same model may be imported via different paths (e.g.
appname.models and project.appname.models). We use the source
filename as a means to detect identity.</p></td><td class="code"><div class="highlight"><pre>                <span class="n">fname1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">__module__</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span>
                <span class="n">fname2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">model_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span><span class="o">.</span><span class="n">__module__</span><span class="p">]</span><span class="o">.</span><span class="n">__file__</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Since the filename extension could be .py the first time and
.pyc or .pyo the second time, ignore the extension when
comparing.</p></td><td class="code"><div class="highlight"><pre>                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">continue</span>
            <span class="n">model_dict</span><span class="p">[</span><span class="n">model_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_models_cache</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="n">cache</span> <span class="o">=</span> <span class="n">AppCache</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>These methods were always module level, so are kept that way for backwards
compatibility.</p></td><td class="code"><div class="highlight"><pre><span class="n">get_apps</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_apps</span>
<span class="n">get_app</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_app</span>
<span class="n">get_app_errors</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_app_errors</span>
<span class="n">get_models</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_models</span>
<span class="n">get_model</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get_model</span>
<span class="n">register_models</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">register_models</span>
<span class="n">load_app</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">load_app</span>
<span class="n">app_cache_ready</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">app_cache_ready</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
