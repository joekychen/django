<!DOCTYPE html>
<html><head><title>joekychen/django » django › test › simple.py

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>simple.py</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span> <span class="kn">as</span> <span class="nn">real_unittest</span>

<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.core.exceptions</span> <span class="kn">import</span> <span class="n">ImproperlyConfigured</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">get_app</span><span class="p">,</span> <span class="n">get_apps</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">_doctest</span> <span class="k">as</span> <span class="n">doctest</span>
<span class="kn">from</span> <span class="nn">django.test.utils</span> <span class="kn">import</span> <span class="n">setup_test_environment</span><span class="p">,</span> <span class="n">teardown_test_environment</span>
<span class="kn">from</span> <span class="nn">django.test.testcases</span> <span class="kn">import</span> <span class="n">OutputChecker</span><span class="p">,</span> <span class="n">DocTestRunner</span><span class="p">,</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">unittest</span>
<span class="kn">from</span> <span class="nn">django.utils.importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">django.utils.module_loading</span> <span class="kn">import</span> <span class="n">module_has_submodule</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;DjangoTestSuiteRunner&#39;</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>The module name for tests outside models.py</p></td><td class="code"><div class="highlight"><pre><span class="n">TEST_MODULE</span> <span class="o">=</span> <span class="s">&#39;tests&#39;</span>

<span class="n">doctestOutputChecker</span> <span class="o">=</span> <span class="n">OutputChecker</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_tests</span><span class="p">(</span><span class="n">app_module</span><span class="p">):</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">app_module</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="n">prefix</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">test_module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="p">[</span><span class="n">TEST_MODULE</span><span class="p">]))</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Couldn't import tests.py. Was it due to a missing file, or
due to an import error in a tests.py that actually exists?
app_module either points to a models.py file, or models/<strong>init</strong>.py
Tests are therefore either in same directory, or one level up</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="n">last</span> <span class="o">==</span> <span class="s">&#39;models&#39;</span><span class="p">:</span>
            <span class="n">app_root</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prefix</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">app_root</span> <span class="o">=</span> <span class="n">app_module</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">module_has_submodule</span><span class="p">(</span><span class="n">app_root</span><span class="p">,</span> <span class="n">TEST_MODULE</span><span class="p">):</span>
            <span class="n">test_module</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>The module exists, so there must be an import error in the test
module itself.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">raise</span>
    <span class="k">return</span> <span class="n">test_module</span>


<span class="k">def</span> <span class="nf">build_suite</span><span class="p">(</span><span class="n">app_module</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a complete Django test suite for the provided application module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Load unit and doctests in the models.py module. If module has
a suite() method, use it. Otherwise build the test suite ourselves.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">app_module</span><span class="p">,</span> <span class="s">&#39;suite&#39;</span><span class="p">):</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">app_module</span><span class="o">.</span><span class="n">suite</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">defaultTestLoader</span><span class="o">.</span><span class="n">loadTestsFromModule</span><span class="p">(</span>
            <span class="n">app_module</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">doctest</span><span class="o">.</span><span class="n">DocTestSuite</span><span class="p">(</span><span class="n">app_module</span><span class="p">,</span>
                                               <span class="n">checker</span><span class="o">=</span><span class="n">doctestOutputChecker</span><span class="p">,</span>
                                               <span class="n">runner</span><span class="o">=</span><span class="n">DocTestRunner</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>No doc tests in models.py</p></td><td class="code"><div class="highlight"><pre>            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Check to see if a separate 'tests' module exists parallel to the
models module</p></td><td class="code"><div class="highlight"><pre>    <span class="n">test_module</span> <span class="o">=</span> <span class="n">get_tests</span><span class="p">(</span><span class="n">app_module</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">test_module</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>Load unit and doctests in the tests.py module. If module has
a suite() method, use it. Otherwise build the test suite ourselves.</p></td><td class="code"><div class="highlight"><pre>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">test_module</span><span class="p">,</span> <span class="s">&#39;suite&#39;</span><span class="p">):</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">test_module</span><span class="o">.</span><span class="n">suite</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">defaultTestLoader</span><span class="o">.</span><span class="n">loadTestsFromModule</span><span class="p">(</span>
                <span class="n">test_module</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">doctest</span><span class="o">.</span><span class="n">DocTestSuite</span><span class="p">(</span>
                    <span class="n">test_module</span><span class="p">,</span> <span class="n">checker</span><span class="o">=</span><span class="n">doctestOutputChecker</span><span class="p">,</span>
                    <span class="n">runner</span><span class="o">=</span><span class="n">DocTestRunner</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>No doc tests in tests.py</p></td><td class="code"><div class="highlight"><pre>                <span class="k">pass</span>
    <span class="k">return</span> <span class="n">suite</span>


<span class="k">def</span> <span class="nf">build_test</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct a test case with the specified label. Label should be of the</span>
<span class="sd">    form model.TestClass or model.TestClass.test_method. Returns an</span>
<span class="sd">    instantiated test or test suite corresponding to the label provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Test label &#39;</span><span class="si">%s</span><span class="s">&#39; should be of the form app.TestCase &quot;</span>
                         <span class="s">&quot;or app.TestCase.test_method&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>First, look for TestCase instances with a name that matches</p></td><td class="code"><div class="highlight"><pre>    <span class="n">app_module</span> <span class="o">=</span> <span class="n">get_app</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">test_module</span> <span class="o">=</span> <span class="n">get_tests</span><span class="p">(</span><span class="n">app_module</span><span class="p">)</span>
    <span class="n">TestClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">app_module</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Couldn't find the test class in models.py; look in tests.py</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="n">TestClass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">test_module</span><span class="p">:</span>
            <span class="n">TestClass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">test_module</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">TestClass</span><span class="p">,</span> <span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">,</span> <span class="n">real_unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c"># label is app.TestClass</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">()</span><span class="o">.</span><span class="n">loadTestsFromTestCase</span><span class="p">(</span>
                        <span class="n">TestClass</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s">&quot;Test label &#39;</span><span class="si">%s</span><span class="s">&#39; does not refer to a test class&quot;</span>
                        <span class="o">%</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c"># label is app.TestClass.test_method</span>
                <span class="k">return</span> <span class="n">TestClass</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>TestClass isn't a TestClass - it must be a method or normal class</p></td><td class="code"><div class="highlight"><pre>        <span class="k">pass</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>If there isn't a TestCase, look for a doctest that matches</p></td><td class="code"><div class="highlight"><pre>    <span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">app_module</span><span class="p">,</span> <span class="n">test_module</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doctests</span> <span class="o">=</span> <span class="n">doctest</span><span class="o">.</span><span class="n">DocTestSuite</span><span class="p">(</span><span class="n">module</span><span class="p">,</span>
                                            <span class="n">checker</span><span class="o">=</span><span class="n">doctestOutputChecker</span><span class="p">,</span>
                                            <span class="n">runner</span><span class="o">=</span><span class="n">DocTestRunner</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Now iterate over the suite, looking for doctests whose name
matches the pattern that was given</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">doctests</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">test</span><span class="o">.</span><span class="n">_dt_test</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span>
                        <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:])),</span>
                        <span class="s">&#39;</span><span class="si">%s</span><span class="s">.__test__.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))):</span>
                    <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>No doctests found.</p></td><td class="code"><div class="highlight"><pre>            <span class="k">pass</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>If no tests were found, then we were given a bad test label.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="ow">not</span> <span class="n">tests</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Test label &#39;</span><span class="si">%s</span><span class="s">&#39; does not refer to a test&quot;</span> <span class="o">%</span> <span class="n">label</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Construct a suite out of the tests that matched.</p></td><td class="code"><div class="highlight"><pre>    <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">(</span><span class="n">tests</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">partition_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">bins</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Partitions a test suite by test type.</span>

<span class="sd">    classes is a sequence of types</span>
<span class="sd">    bins is a sequence of TestSuites, one more than classes</span>

<span class="sd">    Tests of type classes[i] are added to bins[i],</span>
<span class="sd">    tests with no match found in classes are place in bins[-1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">suite</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">):</span>
            <span class="n">partition_suite</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                    <span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">reorder_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">classes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reorders a test suite by test type.</span>

<span class="sd">    `classes` is a sequence of types</span>

<span class="sd">    All tests of type classes[0] are placed first, then tests of type</span>
<span class="sd">    classes[1], etc. Tests with no match in classes are placed last.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">class_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span>
    <span class="n">bins</span> <span class="o">=</span> <span class="p">[</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">class_count</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span>
    <span class="n">partition_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">bins</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">class_count</span><span class="p">):</span>
        <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">addTests</span><span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">dependency_ordered</span><span class="p">(</span><span class="n">test_databases</span><span class="p">,</span> <span class="n">dependencies</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reorder test_databases into an order that honors the dependencies</span>
<span class="sd">    described in TEST_DEPENDENCIES.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ordered_test_databases</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">resolved_databases</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Maps db signature to dependencies of all it's aliases</p></td><td class="code"><div class="highlight"><pre>    <span class="n">dependencies_map</span> <span class="o">=</span> <span class="p">{}</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>sanity check - no DB can depend on it's own alias</p></td><td class="code"><div class="highlight"><pre>    <span class="k">for</span> <span class="n">sig</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span> <span class="ow">in</span> <span class="n">test_databases</span><span class="p">:</span>
        <span class="n">all_deps</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
            <span class="n">all_deps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">alias</span><span class="p">,</span> <span class="p">[]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_deps</span><span class="o">.</span><span class="n">isdisjoint</span><span class="p">(</span><span class="n">aliases</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                <span class="s">&quot;Circular dependency: databases </span><span class="si">%r</span><span class="s"> depend on each other, &quot;</span>
                <span class="s">&quot;but are aliases.&quot;</span> <span class="o">%</span> <span class="n">aliases</span><span class="p">)</span>
        <span class="n">dependencies_map</span><span class="p">[</span><span class="n">sig</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_deps</span>

    <span class="k">while</span> <span class="n">test_databases</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">deferred</span> <span class="o">=</span> <span class="p">[]</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Try to find a DB that has all it's dependencies met</p></td><td class="code"><div class="highlight"><pre>        <span class="k">for</span> <span class="n">signature</span><span class="p">,</span> <span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span> <span class="ow">in</span> <span class="n">test_databases</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dependencies_map</span><span class="p">[</span><span class="n">signature</span><span class="p">]</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">resolved_databases</span><span class="p">):</span>
                <span class="n">resolved_databases</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span>
                <span class="n">ordered_test_databases</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">signature</span><span class="p">,</span> <span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)))</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">deferred</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">signature</span><span class="p">,</span> <span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">changed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ImproperlyConfigured</span><span class="p">(</span>
                <span class="s">&quot;Circular dependency in TEST_DEPENDENCIES&quot;</span><span class="p">)</span>
        <span class="n">test_databases</span> <span class="o">=</span> <span class="n">deferred</span>
    <span class="k">return</span> <span class="n">ordered_test_databases</span>


<span class="k">class</span> <span class="nc">DjangoTestSuiteRunner</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbosity</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interactive</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">failfast</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">verbosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="n">interactive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">failfast</span> <span class="o">=</span> <span class="n">failfast</span>

    <span class="k">def</span> <span class="nf">setup_test_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">setup_test_environment</span><span class="p">()</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">unittest</span><span class="o">.</span><span class="n">installHandler</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">build_suite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">extra_tests</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestSuite</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">test_labels</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">test_labels</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">label</span><span class="p">:</span>
                    <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">build_test</span><span class="p">(</span><span class="n">label</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">app</span> <span class="o">=</span> <span class="n">get_app</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                    <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">build_suite</span><span class="p">(</span><span class="n">app</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">app</span> <span class="ow">in</span> <span class="n">get_apps</span><span class="p">():</span>
                <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">build_suite</span><span class="p">(</span><span class="n">app</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">extra_tests</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">extra_tests</span><span class="p">:</span>
                <span class="n">suite</span><span class="o">.</span><span class="n">addTest</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">reorder_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="p">(</span><span class="n">TestCase</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">setup_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">connections</span><span class="p">,</span> <span class="n">DEFAULT_DB_ALIAS</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>First pass -- work out which databases actually need to be created,
and which ones are test mirrors or duplicate entries in DATABASES</p></td><td class="code"><div class="highlight"><pre>        <span class="n">mirrored_aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">test_databases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">:</span>
            <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;TEST_MIRROR&#39;</span><span class="p">]:</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>If the database is marked as a test mirror, save
the alias.</p></td><td class="code"><div class="highlight"><pre>                <span class="n">mirrored_aliases</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;TEST_MIRROR&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Store a tuple with DB parameters that uniquely identify it.
If we have two aliases with the same values for that tuple,
we only need to create the test database once.</p></td><td class="code"><div class="highlight"><pre>                <span class="n">item</span> <span class="o">=</span> <span class="n">test_databases</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">test_db_signature</span><span class="p">(),</span>
                    <span class="p">(</span><span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">],</span> <span class="nb">set</span><span class="p">())</span>
                <span class="p">)</span>
                <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>

                <span class="k">if</span> <span class="s">&#39;TEST_DEPENDENCIES&#39;</span> <span class="ow">in</span> <span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">:</span>
                    <span class="n">dependencies</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;TEST_DEPENDENCIES&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alias</span> <span class="o">!=</span> <span class="n">DEFAULT_DB_ALIAS</span><span class="p">:</span>
                        <span class="n">dependencies</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                            <span class="s">&#39;TEST_DEPENDENCIES&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">DEFAULT_DB_ALIAS</span><span class="p">])</span></pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Second pass -- actually create the databases.</p></td><td class="code"><div class="highlight"><pre>        <span class="n">old_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">mirrors</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">signature</span><span class="p">,</span> <span class="p">(</span><span class="n">db_name</span><span class="p">,</span> <span class="n">aliases</span><span class="p">)</span> <span class="ow">in</span> <span class="n">dependency_ordered</span><span class="p">(</span>
            <span class="n">test_databases</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">dependencies</span><span class="p">):</span>
            <span class="n">test_db_name</span> <span class="o">=</span> <span class="bp">None</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Actually create the database for the first connection</p></td><td class="code"><div class="highlight"><pre>            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="n">connection</span> <span class="o">=</span> <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>
                <span class="n">old_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">connection</span><span class="p">,</span> <span class="n">db_name</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">test_db_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">test_db_name</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">create_test_db</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">autoclobber</span><span class="o">=</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">connection</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test_db_name</span>

        <span class="k">for</span> <span class="n">alias</span><span class="p">,</span> <span class="n">mirror_alias</span> <span class="ow">in</span> <span class="n">mirrored_aliases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mirrors</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">alias</span><span class="p">,</span> <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">]))</span>
            <span class="n">connections</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">connections</span><span class="p">[</span><span class="n">mirror_alias</span><span class="p">]</span><span class="o">.</span><span class="n">settings_dict</span><span class="p">[</span><span class="s">&#39;NAME&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">old_names</span><span class="p">,</span> <span class="n">mirrors</span>

    <span class="k">def</span> <span class="nf">run_suite</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suite</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span>
            <span class="n">verbosity</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">,</span> <span class="n">failfast</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">failfast</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown_databases</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_config</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Destroys all the non-mirror databases.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">old_names</span><span class="p">,</span> <span class="n">mirrors</span> <span class="o">=</span> <span class="n">old_config</span>
        <span class="k">for</span> <span class="n">connection</span><span class="p">,</span> <span class="n">old_name</span><span class="p">,</span> <span class="n">destroy</span> <span class="ow">in</span> <span class="n">old_names</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">destroy</span><span class="p">:</span>
                <span class="n">connection</span><span class="o">.</span><span class="n">creation</span><span class="o">.</span><span class="n">destroy_test_db</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbosity</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">teardown_test_environment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">unittest</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">()</span>
        <span class="n">teardown_test_environment</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">suite_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suite</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_tests</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_labels</span><span class="p">,</span> <span class="n">extra_tests</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the unit tests for all the test labels in the provided list.</span>
<span class="sd">        Labels must be of the form:</span>
<span class="sd">         - app.TestClass.test_method</span>
<span class="sd">            Run a single specific test method</span>
<span class="sd">         - app.TestClass</span>
<span class="sd">            Run all the test methods in a given class</span>
<span class="sd">         - app</span>
<span class="sd">            Search for doctests and unittests in the named application.</span>

<span class="sd">        When looking for tests, the test runner will look in the models and</span>
<span class="sd">        tests modules for the application.</span>

<span class="sd">        A list of &#39;extra&#39; tests may also be provided; these tests</span>
<span class="sd">        will be added to the test suite.</span>

<span class="sd">        Returns the number of tests that failed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_test_environment</span><span class="p">()</span>
        <span class="n">suite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_suite</span><span class="p">(</span><span class="n">test_labels</span><span class="p">,</span> <span class="n">extra_tests</span><span class="p">)</span>
        <span class="n">old_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_databases</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_suite</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teardown_databases</span><span class="p">(</span><span class="n">old_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">teardown_test_environment</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">suite_result</span><span class="p">(</span><span class="n">suite</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/django",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
